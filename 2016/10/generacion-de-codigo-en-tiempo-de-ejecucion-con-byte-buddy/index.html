<!doctype html><html lang=es><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="picodotdev"><meta name=keywords content="java,programacion,software,hardware,tapestry,software libre,gnu,linux,gnu/linux,unix,arch,arch linux,html,css,javascript"><meta name=description content="El tipado seguro y el sistema de tipos es sin duda una de las características más importante del lenguaje de programación Java que han contribuido a su éxito. Cuando no conocemos los tipos en tiempo de compilación el sistema de tipos es una limitación donde los lenguajes dinámicos son capaces de resolver el problema sin necesidad de los tipos pero perdiendo la ayuda del compilador. Usando una librería de generación de código en tiempo de compilación o ejecución tenemos la posibilidad en Java de realizar algunas tareas que los lenguajes dinámicos permiten. &hellip;"><base href=https://picodotdev.github.io/blog-bitix/><title>Generación de código en tiempo de ejecución con Byte Buddy</title><link rel=author type=text/plain href=humans.txt><link rel="shortcut icon" href=assets/favicon.ico><link rel=apple-touch-icon-precomposed sizes=144x144 href=assets/apple-touch-icon-144-precomposed.png><link rel=canonical href=https://picodotdev.github.io/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/><link href=index.xml rel=alternate type=application/rss+xml title="Blog Bitix"><link rel=stylesheet type=text/css href=assets/css/font.css><link rel=stylesheet type=text/css href=assets/libs/bootstrap-4.3.1/css/bootstrap.min.css><link rel=stylesheet type=text/css href=assets/libs/Gallery-2.33.0/css/blueimp-gallery.min.css><link rel=stylesheet type=text/css href=assets/css/syntax.css><link rel=stylesheet type=text/css href=assets/css/main.css><script type=text/javascript src=assets/js/require-config.js data-main=js/main defer></script><script type=text/javascript src=assets/libs/require.js data-main=js/main defer></script><script src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js defer></script><script type=text/javascript defer>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:'ca-pub-3533636310991304',enable_page_level_ads:true});</script><script type=text/javascript defer>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-12874075-4','picodotdev.github.io');ga('send','pageview');</script><script type=text/javascript src="//platform-api.sharethis.com/js/sharethis.js#property=5920c4ce1bd0670011e06acd&product=inline-share-buttons" defer></script><script type=text/javascript src=assets/js/app.js defer></script></head><body><div class=container><div class=row><div class=col-12><header><div class=row><div class="col-12 col-lg-4"></div><div class="col-12 col-lg-4"><h2 class=title><a href=https://picodotdev.github.io/blog-bitix/>Blog Bitix</a></h2><div class=links><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class="col-12 col-lg-4 text-center"><form name=query class="form-inline search" onsubmit="return false;"><div class=input-group><input type=text name=q class=form-control placeholder="Buscar en Blog Bitix">
<span class=input-group-btn><button class="btn btn-secondary" type=submit>Buscar</button></span></div></form><form name=search action=https://duckduckgo.com/ method=get class=hidden data-site=https://picodotdev.github.io/blog-bitix/><input type=hidden name=q></form></div></div><div class=row><div class=col-12><nav class="nav nav-pills nav-fill"><a href=/blog-bitix/tags/java/ class="nav-item nav-link">Java</a>
<a href=/blog-bitix/tags/gnu-linux/ class="nav-item nav-link">GNU/Linux</a>
<a href=/blog-bitix/tags/javascript/ class="nav-item nav-link">JavaScript</a>
<a href=/blog-bitix/tags/tapestry/ class="nav-item nav-link">Tapestry</a>
<a href=/blog-bitix/archive/ class="nav-item nav-link">Archivo y hemeroteca</a>
<a href=/blog-bitix/pages/links/ class="nav-item nav-link">Enlaces</a>
<a href=/blog-bitix/pages/about/ class="nav-item nav-link">Acerca de...</a></nav></div></div></header></div></div><div class=row><div class="col-12 text-center"><ins class=adsbygoogle style=display:inline-block;width:970px;height:250px data-ad-client=ca-pub-3533636310991304 data-ad-slot=2975854584 data-type=billboard></ins></div></div><div class=row><div class=col-12><div class="adblock-sidebar adblock-sidebar-right"><div class=adblock-sidebar-container><ins class="adsbygoogle adblock-sidebar-vertical" style=display:block data-ad-client=ca-pub-3533636310991304 data-ad-slot=9933840986 data-ad-format="vertical, rectangle" data-type=auto></ins></div></div><article itemprop=mainEntity itemscope itemtype=http://schema.org/BlogPosting><meta itemprop=inLanguage content="es"><meta itemprop=keywords content="blog-stack, java, planeta-codigo, programacion"><h1 itemprop=name>Generación de código en tiempo de ejecución con Byte Buddy</h1><p class=information>Escrito por
<span itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>picodotdev</span></span> el <time itemprop=datePublished datetime=2016-10-02>02/10/2016</time>, actualizado el <time itemprop=dateModified datetime=2016-10-07>07/10/2016</time>.<br><a href=tags/blog-stack/>blog-stack</a> <a href=tags/java/>java</a> <a href=tags/planeta-codigo/>planeta-codigo</a> <a href=tags/programacion/>programacion</a><br><a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/ itemprop=url>Enlace permanente</a>
<a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/#comments>Comentarios</a></p><p class=summary itemprop=about>El tipado seguro y el sistema de tipos es sin duda una de las características más importante del lenguaje de programación Java que han contribuido a su éxito. Cuando no conocemos los tipos en tiempo de compilación el sistema de tipos es una limitación donde los lenguajes dinámicos son capaces de resolver el problema sin necesidad de los tipos pero perdiendo la ayuda del compilador. Usando una librería de generación de código en tiempo de compilación o ejecución tenemos la posibilidad en Java de realizar algunas tareas que los lenguajes dinámicos permiten.</p><div><ins class=adsbygoogle style=display:inline-block;width:728px;height:90px data-ad-client=ca-pub-3533636310991304 data-ad-slot=5966819782 data-type=leaderboard></ins></div><div class=content itemprop=articleBody><meta itemprop=wordCount content="1151"><div class=logotypes style=float:right><img src=assets/images/logotipos/bytebuddy.png class=right width=200 alt="Byte Buddy" title="Byte Buddy"></div><div class=logotypes style=float:right;clear:right><img src=assets/images/logotipos/java.svg class=right width=200 alt=Java title=Java></div><p>Java posee un sistema de tipos estricto con el que detectar errores de compilación y hace que el código sea más legible, con un <abbr title="Integrated Development Environment">IDE</abbr> los errores de compilación los detectaremos inmediatamente según escribimos código. Este sistema de tipos estricto es deseable en aplicaciones de negocio y empresariales ya que ayuda a que las aplicaciones tengan menos errores o errores de compilación pasen inadvertidos y ser descubiertos incluso semanas después de haber sido desplegados en producción. Su sistema de tipos es uno de los responsables del éxito de Java. Sin embargo, el sistema de tipos estricto impone restricciones en otro tipo de ámbitos como en una biblioteca de propósito general ya que no se conocerán los tipos en tiempo de compilación y no podrán por tanto ser referenciados o alternativamente hayan ser definidos como interfaces o clases abstractas que posteriormente son implementadas o extendidas.</p><p>Para acceder a propiedades e invocar métodos de tipos desconocidos en tiempo de compilación en Java disponemos de la <a href=https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/package-summary.html>reflection API</a> o API de introspección aunque tiene los siguientes inconvenientes:</p><ul><li>Es lenta: más que la invocación directa de un método. La API de introspección usa <abbr title="Java Native Interface">JNI</abbr> y requiere hacer un análisis del objeto costosa para invocar el método del objeto.</li><li>Inutiliza el tipado seguro: la API de introspección no es <em>type-safe</em>. La comprobación de los tipos de los argumentos en la invocación de un método es retrasada hasta el momento de ejecución.</li></ul><p>Usando la API de introspección perdemos una de las grandes características de Java, el tipado seguro, adicionalmente el rendimiento será menor. Conocidas estas limitaciones hay varias librerías que las palían generando código en tiempo de ejecución, algunas de las más conocidas son <a href=https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Proxy.html>Java Proxy</a> que está incluida en el propio JDK, <a href=https://github.com/cglib/cglib>cglib</a>, <a href=http://www.javassist.org/>Javassists</a> o <a href=https://asm.ow2.io/>ASM</a>.</p><p>Leyendo uno de los artículos de la publicación gratuita <a href=https://www.oracle.com/technetwork/java/javamagazine/index.html>Java Magazine</a> de <a href=http://www.javamagazine.mozaicreader.com/NovDec2015/Twitter>Nov/Dic 2015</a> conocí otra alternativa llamada <a href=https://bytebuddy.net/>Byte Buddy</a> con la que al contrario de otras posibilidades no estamos limitados a generar clases que implementen interfaces conocidas (como en Java proxies), tiene un mantenimiento activo y soporta las nuevas características de las últimas versiones del lenguaje (al contrario de cglib), no está tan limitada (como Javassists) y no hay que tener conocimientos de <em>byte code</em> (como con ASM).</p><p>La generación de código se ha vuelto ubicua en muchas de las librerías más populares de Java y se usa profusamente en <a href=https://spring.io/>Spring</a>, <a href=https://hibernate.org/>Hibernate</a> o <a href=https://tapestry.apache.org/>Apache Tapestry</a> para aplicar seguridad, gestión de transacciones, mapeo modelo relacional-objeto o pruebas unitarias o de integración (<em>mocking</em>, &hellip;) y de manera similar a lo ofrecido por los <a href=http://groovy-lang.org/metaprogramming.html><abbr title="Abstract Syntax Tree">AST</abbr></a> de <a href=https://www.groovy-lang.org/>Groovy</a>. Permite emular algunas propiedades que solo están accesibles al programar con lenguajes dinámicos sin perder las comprobaciones de tipos. Las clases generadas por Byte Buddy no se distinguen de las clases generadas por el compilador.</p><p>Un ejemplo sencillo de la definición de una nueva clase en tiempo de ejecución con el método <a href=https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#toString-->String.toString()</a> que devuelve un valor fijo sería la siguiente:</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// Create a Class
</span><span class=c1></span><span class=n>DynamicType</span><span class=o>.</span><span class=na>Unloaded</span><span class=o>&lt;</span><span class=o>?</span><span class=o>&gt;</span> <span class=n>unloaded</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>(</span><span class=o>)</span>
        <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>Object</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
        <span class=o>.</span><span class=na>name</span><span class=o>(</span><span class=s>&#34;io.github.picodotdev.blobitix.holamundobytebuddy.Object&#34;</span><span class=o>)</span>
        <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>named</span><span class=o>(</span><span class=s>&#34;toString&#34;</span><span class=o>)</span><span class=o>)</span><span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>FixedValue</span><span class=o>.</span><span class=na>value</span><span class=o>(</span><span class=s>&#34;Hello World!&#34;</span><span class=o>)</span><span class=o>)</span>
        <span class=o>.</span><span class=na>make</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>

<span class=n>Class</span><span class=o>&lt;</span><span class=o>?</span><span class=o>&gt;</span> <span class=n>objectClass</span> <span class=o>=</span> <span class=n>unloaded</span><span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>Main</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>ClassLoadingStrategy</span><span class=o>.</span><span class=na>Default</span><span class=o>.</span><span class=na>WRAPPER</span><span class=o>)</span>
        <span class=o>.</span><span class=na>getLoaded</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>

<span class=n>Object</span> <span class=n>object</span> <span class=o>=</span> <span class=n>objectClass</span><span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>
<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;%s: %s\n&#34;</span><span class=o>,</span> <span class=n>object</span><span class=o>.</span><span class=na>getClass</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>getName</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>object</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=o>)</span><span class=o>)</span><span class=o>;</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Main-1.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Main-1.java target=_blank>Main-1.java</a></div></div><p>Con los métodos <a href=http://bytebuddy.net/javadoc/1.4.28/net/bytebuddy/dynamic/DynamicType.html#saveIn-java.io.File->saveIn</a>, <a href=http://bytebuddy.net/javadoc/1.4.28/net/bytebuddy/dynamic/DynamicType.html#inject-java.io.File->inject</a> y <a href=http://bytebuddy.net/javadoc/1.4.28/net/bytebuddy/dynamic/DynamicType.html#toJar-java.io.File->toJar</a> de <a href=http://bytebuddy.net/javadoc/1.4.28/net/bytebuddy/dynamic/DynamicType.Unloaded.html>DynamicType.Unloaded</a> podemos generar las clases en el momento de construcción de la aplicación previo a que sea desplegada y guardarlas en archivos <em>.class</em> o en librerías <em>.jar</em>.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=n>unloaded</span><span class=o>.</span><span class=na>saveIn</span><span class=o>(</span><span class=n>file</span><span class=o>)</span><span class=o>;</span>
<span class=n>unloaded</span><span class=o>.</span><span class=na>inject</span><span class=o>(</span><span class=n>file</span><span class=o>)</span><span class=o>;</span>
<span class=n>unloaded</span><span class=o>.</span><span class=na>toJar</span><span class=o>(</span><span class=n>file</span><span class=o>)</span><span class=o>;</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Main-2.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Main-2.java target=_blank>Main-2.java</a></div></div><p>Usando los selectores adecuados como <em>method</em>, <em>field</em>, <em>constructor</em>, <em>named</em> entre muchos otros de la clase <a href=http://bytebuddy.net/javadoc/1.4.28/net/bytebuddy/matcher/ElementMatchers.html>ElementMatchers</a> seremos capaces de interceptar las llamadas a los métodos y establecerles el comportamiento que deseemos.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// Intercept methods
</span><span class=c1></span><span class=n>Foo</span> <span class=n>foo</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>(</span><span class=o>)</span>
        <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>Foo</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
        <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>isDeclaredBy</span><span class=o>(</span><span class=n>Foo</span><span class=o>.</span><span class=na>class</span><span class=o>)</span><span class=o>)</span><span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>FixedValue</span><span class=o>.</span><span class=na>value</span><span class=o>(</span><span class=s>&#34;One!&#34;</span><span class=o>)</span><span class=o>)</span>
        <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>named</span><span class=o>(</span><span class=s>&#34;foo&#34;</span><span class=o>)</span><span class=o>)</span><span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>FixedValue</span><span class=o>.</span><span class=na>value</span><span class=o>(</span><span class=s>&#34;Two!&#34;</span><span class=o>)</span><span class=o>)</span>
        <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>named</span><span class=o>(</span><span class=s>&#34;foo&#34;</span><span class=o>)</span><span class=o>.</span><span class=na>and</span><span class=o>(</span><span class=n>takesArguments</span><span class=o>(</span><span class=n>1</span><span class=o>)</span><span class=o>)</span><span class=o>)</span><span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>FixedValue</span><span class=o>.</span><span class=na>value</span><span class=o>(</span><span class=s>&#34;Three!&#34;</span><span class=o>)</span><span class=o>)</span>
        <span class=o>.</span><span class=na>make</span><span class=o>(</span><span class=o>)</span>
        <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>Main</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>ClassLoadingStrategy</span><span class=o>.</span><span class=na>Default</span><span class=o>.</span><span class=na>WRAPPER</span><span class=o>)</span>
        <span class=o>.</span><span class=na>getLoaded</span><span class=o>(</span><span class=o>)</span>
        <span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>

<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>
<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;%s.bar(): %s\n&#34;</span><span class=o>,</span> <span class=n>foo</span><span class=o>.</span><span class=na>getClass</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>getName</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>foo</span><span class=o>.</span><span class=na>bar</span><span class=o>(</span><span class=o>)</span><span class=o>)</span><span class=o>;</span>
<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;%s.foo(): %s\n&#34;</span><span class=o>,</span> <span class=n>foo</span><span class=o>.</span><span class=na>getClass</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>getName</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>foo</span><span class=o>.</span><span class=na>foo</span><span class=o>(</span><span class=o>)</span><span class=o>)</span><span class=o>;</span>
<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;%s.foo(Object o): %s\n&#34;</span><span class=o>,</span> <span class=n>foo</span><span class=o>.</span><span class=na>getClass</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>getName</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>foo</span><span class=o>.</span><span class=na>foo</span><span class=o>(</span><span class=s>&#34;¡Hello World!&#34;</span><span class=o>)</span><span class=o>)</span><span class=o>;</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Main-3.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Main-3.java target=_blank>Main-3.java</a></div></div><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>io.github.picodotdev.blogbitix.holamundobytebuddy</span><span class=o>;</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Foo</span> <span class=o>{</span>

    <span class=kd>public</span> <span class=n>String</span> <span class=nf>bar</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span> <span class=k>return</span> <span class=kc>null</span><span class=o>;</span> <span class=o>}</span>
    <span class=kd>public</span> <span class=n>String</span> <span class=nf>foo</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span> <span class=k>return</span> <span class=kc>null</span><span class=o>;</span> <span class=o>}</span>
    <span class=kd>public</span> <span class=n>String</span> <span class=nf>foo</span><span class=o>(</span><span class=n>Object</span> <span class=n>o</span><span class=o>)</span> <span class=o>{</span> <span class=k>return</span> <span class=kc>null</span><span class=o>;</span> <span class=o>}</span>
<span class=o>}</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Foo.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Foo.java target=_blank>Foo.java</a></div></div><p>Byte Buddy permite tres tipos de extensiones:</p><ul><li><em>subclass</em>: crea un nuevo tipo subclase de otro.</li><li><em>redefine</em>: redefine el comportamiento de un tipo existente.</li><li><em>rebase</em>: redefine el comportamiento de un tipo existente y renombra los métodos redefinidos de modo que siguen estando disponibles internamente.</li></ul><p>Devolver valores fijos en un método seguramente no será lo que deseemos en muchos casos pero podemos delegar el comportamiento de un método en otro y esta es una forma muy sencilla de manipular el comportamiento de un método sin conocer absolutamente nada de <em>bytecode</em> ya que todo el código que proporcionamos es código Java. En el método en que se delega la llamada de uno interceptado es posible usar varias anotaciones para obtener diversos parámetros adicionales, <em>@Argument(n)</em>, <em>@AllArguments</em>, <em>@This</em>, <em>@Super</em>, <em>@Origin</em> (Method, Constructor, Executable, Class, MethodHandle, MethodType, String o int), <em>@SuperCall</em>, <em>@RuntimeType</em>, <em>@DefaultCall</em>, <em>@Default</em>. El <a href=http://bytebuddy.net/javadoc/1.4.28/net/bytebuddy/implementation/bind/annotation/package-summary.html>listado completo de anotaciones</a> está disponible en la API Javadoc.</p><p>Podemos proporcionar implementaciones de métodos de la siguiente forma, suponiendo que queremos redefinir el método <em>hello</em> de la clase <em>Source</em> con el comportamiento implementado en la clase <em>Target</em>:</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=c1>// Delegating a method call
</span><span class=c1></span><span class=n>Class</span><span class=o>&lt;</span><span class=o>?</span> <span class=kd>extends</span> <span class=n>Source</span><span class=o>&gt;</span> <span class=n>sourceClass</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteBuddy</span><span class=o>(</span><span class=o>)</span>
        <span class=o>.</span><span class=na>subclass</span><span class=o>(</span><span class=n>Source</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
        <span class=o>.</span><span class=na>method</span><span class=o>(</span><span class=n>named</span><span class=o>(</span><span class=s>&#34;hello&#34;</span><span class=o>)</span><span class=o>)</span><span class=o>.</span><span class=na>intercept</span><span class=o>(</span><span class=n>MethodDelegation</span><span class=o>.</span><span class=na>to</span><span class=o>(</span><span class=n>Target</span><span class=o>.</span><span class=na>class</span><span class=o>)</span><span class=o>)</span>
        <span class=o>.</span><span class=na>make</span><span class=o>(</span><span class=o>)</span>
        <span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>Main</span><span class=o>.</span><span class=na>class</span><span class=o>.</span><span class=na>getClassLoader</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>ClassLoadingStrategy</span><span class=o>.</span><span class=na>Default</span><span class=o>.</span><span class=na>WRAPPER</span><span class=o>)</span>
        <span class=o>.</span><span class=na>getLoaded</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>

<span class=n>String</span> <span class=n>message</span> <span class=o>=</span> <span class=n>sourceClass</span><span class=o>.</span><span class=na>newInstance</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>hello</span><span class=o>(</span><span class=s>&#34;World&#34;</span><span class=o>)</span><span class=o>;</span>
<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>
<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>message</span><span class=o>)</span><span class=o>;</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Main-4.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Main-4.java target=_blank>Main-4.java</a></div></div><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>io.github.picodotdev.blogbitix.holamundobytebuddy</span><span class=o>;</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Source</span> <span class=o>{</span>

    <span class=kd>public</span> <span class=n>String</span> <span class=nf>hello</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=o>{</span> <span class=k>return</span> <span class=kc>null</span><span class=o>;</span> <span class=o>}</span>
<span class=o>}</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Source.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Source.java target=_blank>Source.java</a></div></div><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>io.github.picodotdev.blogbitix.holamundobytebuddy</span><span class=o>;</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Target</span> <span class=o>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=n>String</span> <span class=nf>hello</span><span class=o>(</span><span class=n>String</span> <span class=n>name</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>return</span> <span class=s>&#34;Hello &#34;</span> <span class=o>+</span> <span class=n>name</span> <span class=o>+</span> <span class=s>&#34;!&#34;</span><span class=o>;</span>
        <span class=o>}</span>
<span class=o>}</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Target.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/Target.java target=_blank>Target.java</a></div></div><p>Dicho esto, la generación de código en tiempo de ejecución o compilación nos permite nuevas posibilidades que solo ofrecían lenguajes dinámicos o de resolver problemas con <a href=https://en.wikipedia.org/wiki/Aspect-oriented_programming>programación orientada a aspectos</a>. Aún así hay que tener en cuenta que las clases Java son elementos especiales para la la máquina virtual y nunca son recolectadas por el recolector de basura mientras su <a href=https://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html>ClassLoader</a> este en uso por alguna de las clases que hay cargadas en la aplicación.</p><p>Ejecutando esta pequeña aplicación obtenemos el siguiente resultado en la terminal.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-plaintext data-lang=plaintext>io.github.picodotdev.blobitix.holamundobytebuddy.Object: Hello World!

io.github.picodotdev.blogbitix.holamundobytebuddy.Foo$ByteBuddy$7lxtAhIy.bar(): One!
io.github.picodotdev.blogbitix.holamundobytebuddy.Foo$ByteBuddy$7lxtAhIy.foo(): Two!
io.github.picodotdev.blogbitix.holamundobytebuddy.Foo$ByteBuddy$7lxtAhIy.foo(Object o): Three!

Hello World!</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/System.out target=_blank>view raw</a></span>
<a href=/blog-bitix/2016/10/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy/code/System.out target=_blank>System.out</a></div></div><p>En el <a href=http://bytebuddy.net/#/tutorial>tutorial de Byte Buddy</a> encontraremos más información y más detallada de las posibilidades que nos ofrece esta interesante librería en la plataforma <abbr title="Java Virtual Machine">JVM</abbr> para manipular <em>bytecode</em> y tipos con el lenguaje Java en tiempo de ejecución.</p><p>El <a href=https://github.com/picodotdev/blog-ejemplos/tree/master/HolaMundoByteBuddy>código fuente completo del ejemplo</a> puedes descargarlo del repositorio de ejemplos de Blog Bitix alojado en <a href=https://github.com/>GitHub</a> y probarlo en tu equipo ejecutando el comando <code>./gradlew run</code>.</p><div class=reference>Referencia:<br><ul><li><a href=https://bytebuddy.net/>Byte Buddy</a></li><li><a href=http://bytebuddy.net/#/tutorial>Tutorial de Byte Buddy</a></li><li><a href=http://www.javamagazine.mozaicreader.com/NovDec2015/Twitter>Java Magazine Nov/Dic 2015</a></li></ul></div></div></article><div class="row related"><div class=col-md-12>Artículos relacionados:<ul><li><a href=/blog-bitix/2016/10/cliente-de-un-servicio-rest-autenticado-con-oauth-en-java/>Cliente de un servicio REST autenticado con OAuth en Java</a></li><li><a href=/blog-bitix/2016/09/autenticacion-con-oauth-y-keycloak-en-un-servicio-rest-con-jax-rs-y-spring-boot/>Autenticación con OAuth y Keycloak en un servicio REST con JAX-RS y Spring Boot</a></li><li><a href=/blog-bitix/2016/09/ejemplo-de-api-rest-en-java-con-jax-rs-y-spring-boot/>Ejemplo de API REST en Java con JAX-RS y Spring Boot</a></li><li><a href=/blog-bitix/2016/08/por-que-guardar-las-fechas-en-utc-en-la-base-de-datos/>Por qué guardar las fechas en UTC en la base de datos</a></li><li><a href=/blog-bitix/2016/07/no-un-tag-jsp-o-un-tag-de-grails-no-es-equivalente-a-un-componente-de-tapestry/>No, un tag JSP o un tag de Grails no es equivalente a un componente de Tapestry</a></li></ul></div></div><div class=row><div class=col-md-12><div class=sharethis-inline-share-buttons></div></div></div><div class=row><div class="col-12 text-center"><ins class=adsbygoogle style=display:inline-block;width:970px;height:250px data-ad-client=ca-pub-3533636310991304 data-ad-slot=2975854584 data-type=billboard></ins></div></div><a id=comments></a><div class=row><div class=col-md-12><div id=disqus_thread></div></div></div><script type=text/javascript async>var disqus_shortname='blog-bitix';var disqus_identifier='https:\/\/picodotdev.github.io\/blog-bitix\/2016\/10\/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy\/';var disqus_url='https:\/\/picodotdev.github.io\/blog-bitix\/2016\/10\/generacion-de-codigo-en-tiempo-de-ejecucion-con-byte-buddy\/';var disqus_script='embed.js';(function(){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}());</script></div></div><div class=row><div class=col-12><hr></div></div><footer><div class=row><div class="col-12 col-sm-4"><p><strong>Blog Bitix</strong></p><p>Blog dedicado a la distribución GNU/Linux que uso habitualmente, Arch Linux, a mis andanzas alrededor del software libre, la programación y a otros temas relacionados con la tecnología y la informática.</p><p>Publicando de uno a tres artículos únicos a la semana desde el año 2010.</p></div><div class="col-12 col-sm-4 text-center menu"><ul class=list-unstyled><li><a href=/blog-bitix/tags/java/>Java</a></li><li><a href=/blog-bitix/tags/gnu-linux/>GNU/Linux</a></li><li><a href=/blog-bitix/tags/javascript/>JavaScript</a></li><li><a href=/blog-bitix/tags/tapestry/>Tapestry</a></li><li><a href=/blog-bitix/archive/>Archivo y hemeroteca</a></li><li><a href=/blog-bitix/pages/links/>Enlaces</a></li><li><a href=/blog-bitix/pages/advertising/>Publicidad</a></li><li><a href=/blog-bitix/pages/donate/>Donaciones</a></li><li><a href=/blog-bitix/pages/about/>Acerca de...</a></li></ul></div><div class="col-12 col-sm-4 text-center links"><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class=row><div class=col-12>Copyleft <span class=copyleft>&copy;</span> 2019 - <a href=https://creativecommons.org/licenses/by-sa/4.0/ rel=nofollow rel=license><img alt="Licencia de Creative Commons" title="Licencia de Creative Commons" style=border-width:0 src=https://licensebuttons.net/l/by-sa/4.0/80x15.png class=licencia></a><br><a href=https://twitter.com/blogstackinfo rel=nofollow><img src=https://picodotdev.github.io/blog-bitix/assets/images/blog-stack.png alt="Blog Stack" title="Blog Stack"></a>
<a href=https://www.planetacodigo.com/ rel=nofollow><img src=https://picodotdev.github.io/blog-bitix/assets/images/planeta-codigo.png alt="Planeta código" title="Planeta código"></a><br><span xmlns:dct=http://purl.org/dc/terms/ property="dct:title"><a href=https://picodotdev.github.io/blog-bitix/ rel=nofollow>Blog Bitix</a></span> by <a xmlns:cc=https://creativecommons.org/ns# href=https://picodotdev.github.io/blog-bitix/ property="cc:attributionName" rel=cc:attributionurl>pico.dev</a> is licensed under a <a rel=license href=https://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional License</a>.<br><span class=credit>Powered by <a href=https://gohugo.io/ rel=nofollow title="A fast and modern static website engine">Hugo</a> and <a href=https://pages.github.com/ title="Websites for you and your projects">GitHub Pages</a>.</span>
<span class=credit>Background patterns from <a href=https://www.toptal.com/designers/subtlepatterns/ rel=nofollow>Subtle Patterns</a>.</span></div></div></footer></div><div class=blueimp-gallery-container><div id=blueimp-gallery class="blueimp-gallery blueimp-gallery-controls" data-use-bootstrap-modal=false><div class=slides></div><h3 class=title></h3><a class=prev>‹</a>
<a class=next>›</a>
<a class=close>×</a>
<a class=play-pause></a><ol class=indicator></ol><div class="modal fade"><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close aria-hidden=true>&times;</button><h4 class=modal-title></h4></div><div class="modal-body next"></div><div class=modal-footer><button type=button class="btn btn-default pull-left prev">
<i class="glyphicon glyphicon-chevron-left"></i>Anterior</button>
<button type=button class="btn btn-primary next">
Siguiente
<i class="glyphicon glyphicon-chevron-right"></i></button></div></div></div></div></div></div><script type=text/javascript>window.cookieconsent_options={"message":"Esta bitácora te informa de la obviedad de que utiliza «cookies», propias y de servicios como Google Analytics y Google AdSense entre otros.","dismiss":"Aceptar","learnMore":"Más información","link":null,"theme":"dark-bottom"};</script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js async></script></body></html>