<!doctype html><html lang=es><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="picodotdev"><meta name=keywords content="java,programacion,software,hardware,tapestry,software libre,gnu,linux,gnu/linux,unix,arch,arch linux,html,css,javascript"><meta name=description content="Una de las funcionalidades proporcionada por Vault es generar credenciales dinámicas para la conexión a bases de datos. Generar las credenciales de forma dinámica proporciona varios beneficios: no hay unas credenciales que usen las aplicaciones que tengan un tiempo de vida indefinido, las aplicaciones no necesitan guardar en su configuración las credenciales, las credenciales se rotan de forma automática y los permisos para obtenerlas se pueden revocar de forma centralizada con Vault para cuales quiera bases de datos que se utilicen. Soporta las bases de datos más populares entre ellas postgres. &mldr;"><base href=https://picodotdev.github.io/blog-bitix/><title>Generar credenciales de conexión a base de datos bajo demanda con Vault</title><link rel=author type=text/plain href=humans.txt><link rel="shortcut icon" href=assets/favicon.ico><link rel=apple-touch-icon-precomposed sizes=144x144 href=assets/apple-touch-icon-144-precomposed.png><link rel=canonical href=https://picodotdev.github.io/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/><link href=index.xml rel=alternate type=application/rss+xml title="Blog Bitix"><link rel=stylesheet type=text/css href=assets/css/font.css><link rel=stylesheet type=text/css href=assets/libs/bootstrap-4.3.1/css/bootstrap.min.css><link rel=stylesheet type=text/css href=assets/libs/Gallery-2.33.0/css/blueimp-gallery.min.css><link rel=stylesheet type=text/css href=assets/css/syntax.css><link rel=stylesheet type=text/css href=assets/css/main.css><script type=text/javascript src=assets/js/require-config.js data-main=js/main defer></script><script type=text/javascript src=assets/libs/require.js data-main=js/main defer></script><script src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js defer></script><script type=text/javascript defer>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:'ca-pub-3533636310991304',enable_page_level_ads:true});</script><script type=text/javascript defer>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-12874075-4','picodotdev.github.io');ga('send','pageview');</script><script type=text/javascript src="//platform-api.sharethis.com/js/sharethis.js#property=5920c4ce1bd0670011e06acd&product=inline-share-buttons" defer></script><script type=text/javascript src=assets/js/app.js defer></script></head><body><div class=container><div class=row><div class=col-12><header><div class=row><div class="col-12 col-lg-4"></div><div class="col-12 col-lg-4"><h2 class=title><a href=https://picodotdev.github.io/blog-bitix/>Blog Bitix</a></h2><div class=links><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class="col-12 col-lg-4 text-center"><form name=query class="form-inline search" onsubmit="return false;"><div class=input-group><input type=text name=q class=form-control placeholder="Buscar en Blog Bitix">
<span class=input-group-btn><button class="btn btn-secondary" type=submit>Buscar</button></span></div></form><form name=search action=https://duckduckgo.com/ method=get class=hidden data-site=https://picodotdev.github.io/blog-bitix/><input type=hidden name=q></form></div></div><div class=row><div class=col-12><nav class="nav nav-pills nav-fill"><a href=/blog-bitix/tags/java/ class="nav-item nav-link">Java</a>
<a href=/blog-bitix/tags/gnu-linux/ class="nav-item nav-link">GNU/Linux</a>
<a href=/blog-bitix/tags/javascript/ class="nav-item nav-link">JavaScript</a>
<a href=/blog-bitix/tags/tapestry/ class="nav-item nav-link">Tapestry</a>
<a href=/blog-bitix/archive/ class="nav-item nav-link">Archivo y hemeroteca</a>
<a href=/blog-bitix/pages/links/ class="nav-item nav-link">Enlaces</a>
<a href=/blog-bitix/pages/about/ class="nav-item nav-link">Acerca de...</a></nav></div></div></header></div></div><div class=row><div class="col-12 text-center"><ins class=adsbygoogle style=display:inline-block;width:970px;height:250px data-ad-client=ca-pub-3533636310991304 data-ad-slot=2975854584 data-type=billboard></ins></div></div><div class=row><div class=col-12><div class="adblock-sidebar adblock-sidebar-right"><div class=adblock-sidebar-container><ins class="adsbygoogle adblock-sidebar-vertical" style=display:block data-ad-client=ca-pub-3533636310991304 data-ad-slot=9933840986 data-ad-format="vertical, rectangle" data-type=auto></ins></div></div><article itemprop=mainEntity itemscope itemtype=http://schema.org/BlogPosting><meta itemprop=inLanguage content="es"><meta itemprop=keywords content="programacion, planeta-codigo, software"><h1 itemprop=name>Generar credenciales de conexión a base de datos bajo demanda con Vault</h1><p class=information>Escrito por
<span itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>picodotdev</span></span> el <time itemprop=datePublished datetime=2019-08-15>15/08/2019</time>.<br><a href=tags/programacion/>programacion</a> <a href=tags/planeta-codigo/>planeta-codigo</a> <a href=tags/software/>software</a><br><a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/ itemprop=url>Enlace permanente</a>
<a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/#comments>Comentarios</a></p><p class=summary itemprop=about>Una de las funcionalidades proporcionada por Vault es generar credenciales dinámicas para la conexión a bases de datos. Generar las credenciales de forma dinámica proporciona varios beneficios: no hay unas credenciales que usen las aplicaciones que tengan un tiempo de vida indefinido, las aplicaciones no necesitan guardar en su configuración las credenciales, las credenciales se rotan de forma automática y los permisos para obtenerlas se pueden revocar de forma centralizada con Vault para cuales quiera bases de datos que se utilicen. Soporta las bases de datos más populares entre ellas postgres.</p><div><ins class=adsbygoogle style=display:inline-block;width:728px;height:90px data-ad-client=ca-pub-3533636310991304 data-ad-slot=5966819782 data-type=leaderboard></ins></div><div class=content itemprop=articleBody><meta itemprop=wordCount content="1350"><div class=logotypes style=float:right><img src=/blog-bitix/assets/images/logotipos/vault.svg class=right width=200 alt=Vault title=Vault></div><div class=logotypes style=float:right;clear:right><img src=/blog-bitix/assets/images/logotipos/postgresql.svg class=right width=200 alt=PostgreSQL title=PostgreSQL></div><p>Las base de datos para proteger los datos realizan autenticación del usuario que se conecta. Normalmente utilizando un usuario y contraseña, una vez autenticado el usuario mediante permisos se realiza la autorización de las operaciones que puede realizar, a que bases de datos se puede conectar, que tablas puede acceder y que operaciones puede realizar.</p><p>Este modelo de autenticación tiene algunos inconvenientes. Uno de los inconvenientes es que los usuarios y contraseñas para mayor seguridad han de cambiarse con cierta frecuencia para evitar que si las credenciales quedan comprometidas no puedan utilizarse indefinidamente. Otro problema es que cada aplicación ha de conocer las credenciales de la base de datos, esto hace que haya múltiples posibilidades de que las credenciales queden comprometidas. Por otro lado el uso de las credenciales no queda registrado de forma centralizada que es necesario para saber ante una brecha de seguridad qué datos han sido accedidos y por quien.</p><p>La herramienta <a href=https://www.vaultproject.io/>Vault</a> de <a href=https://www.hashicorp.com/>HashiCorp</a> da solución a estos problemas generando credenciales de acceso a las bases de datos de forma dinámica, bajo demanda y con un tiempo de concesión limitado. Las credenciales tiene un tiempo de vida limitado si no se renueva su concesión y la generación de las credenciales queda registrado. La forma que tiene Vault de generar credenciales de forma dinámica en una base de datos relacional como <a href=https://www.postgresql.org/>postgres</a> es conectarse a la base de datos con un usuario con permisos para generarlas y ejecutar una sentencia SQL que crea las credenciales.</p><p>Para permitir a Vault generar credenciales de conexión hay que activar el <em>backend</em> de bases de datos, configurarlo con la sentencia SQL que se utilizará para generar las credenciales y crear el rol de Vault que genera las credenciales cuando se le solicite. En este ejemplo se muestra para la base de datos postgres pero Vault también soporta otras bases de datos como <a href=https://www.mysql.com/>MySQL</a>. En el ejemplo la base de datos postgres se ejecuta en un contenedor de <a href=https://www.docker.com/>Docker</a> en el que se asignan el usuario y contraseña del usuario <em>root</em> que utiliza Vault para generar las credenciales de forma dinámica.</p><p>Con las siguientes comandos se inicia <a href=https://www.consul.io/>Consul</a> y Vault.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ consul agent -dev
<span class=o>=</span><span class=o>=</span>&gt; Starting Consul agent...
<span class=o>=</span><span class=o>=</span>&gt; Consul agent running!
           Version: <span class=s1>&#39;v1.5.0&#39;</span>
           Node ID: <span class=s1>&#39;38d4f541-0958-6d7d-d49e-a31a15987286&#39;</span>
         Node name: <span class=s1>&#39;archlinux&#39;</span>
        Datacenter: <span class=s1>&#39;dc1&#39;</span> <span class=o>(</span>Segment: <span class=s1>&#39;&lt;all&gt;&#39;</span><span class=o>)</span>
            Server: <span class=nb>true</span> <span class=o>(</span>Bootstrap: <span class=nb>false</span><span class=o>)</span>
       Client Addr: <span class=o>[</span>127.0.0.1<span class=o>]</span> <span class=o>(</span>HTTP: 8500, HTTPS: -1, gRPC: 8502, DNS: 8600<span class=o>)</span>
      Cluster Addr: 127.0.0.1 <span class=o>(</span>LAN: 8301, WAN: 8302<span class=o>)</span>
           Encrypt: Gossip: false, TLS-Outgoing: false, TLS-Incoming: false</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/consul.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/consul.sh target=_blank>consul.sh</a></div></div><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ vault server -dev -config vault.hcl
<span class=o>=</span><span class=o>=</span>&gt; Vault server configuration:

             Api Address: http://127.0.0.1:8200
                     Cgo: disabled
         Cluster Address: https://127.0.0.1:8201
              Listener 1: tcp <span class=o>(</span>addr: <span class=s2>&#34;127.0.0.1:8200&#34;</span>, cluster address: <span class=s2>&#34;127.0.0.1:8201&#34;</span>, max_request_duration: <span class=s2>&#34;1m30s&#34;</span>, max_request_size: <span class=s2>&#34;33554432&#34;</span>, tls: <span class=s2>&#34;disabled&#34;</span><span class=o>)</span>
               Log Level: info
                   Mlock: supported: true, enabled: <span class=nb>false</span>
                 Storage: consul <span class=o>(</span>HA available<span class=o>)</span>
                 Version: Vault v1.1.1
             Version Sha: a3dcd63451cf6da1d04928b601bbe9748d53842e

WARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory
and starts unsealed with a single unseal key. The root token is already
authenticated to the CLI, so you can immediately begin using Vault.

You may need to <span class=nb>set</span> the following environment variable:

    $ <span class=nb>export</span> <span class=nv>VAULT_ADDR</span><span class=o>=</span><span class=s1>&#39;http://127.0.0.1:8200&#39;</span>

The unseal key and root token are displayed below in <span class=k>case</span> you want to
seal/unseal the Vault or re-authenticate.

Unseal Key: <span class=nv>jeW10eak6TxJzH2qFnwk7bWk7HcpDXd3KQOobi1rZTQ</span><span class=o>=</span>
Root Token: s.0YRcRzojVcPG8LbbzyUd1MEA

Development mode should NOT be used in production installations!</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault.sh target=_blank>vault.sh</a></div></div><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-plaintext data-lang=plaintext>ui = true

storage &#34;consul&#34; {
  address = &#34;127.0.0.1:8500&#34;
  path  = &#34;vault&#34;
}</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault.hcl target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault.hcl target=_blank>vault.hcl</a></div></div><p>La base de datos se inicia en un contenedor de Docker, se crea una base de datos y una tabla.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ docker run -it -p <span class=s2>&#34;5432:5432&#34;</span> -e <span class=nv>POSTGRES_USER</span><span class=o>=</span>postgres -e <span class=nv>POSTGRES_PASSWORD</span><span class=o>=</span>postgres postgres:alpine
$ docker ps 
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
2792b13c36c1        postgres:alpine     <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>3</span> minutes ago       Up <span class=m>3</span> minutes        0.0.0.0:5432-&gt;5432/tcp   distracted_keldysh
$ docker <span class=nb>exec</span> -it 2792b13c36c1 bash
bash-5.0# psql -U postgres
psql <span class=o>(</span>11.4<span class=o>)</span>
Type <span class=s2>&#34;help&#34;</span> <span class=k>for</span> help.

<span class=nv>postgres</span><span class=o>=</span><span class=c1># CREATE DATABASE app;</span>
<span class=nv>postgres</span><span class=o>=</span><span class=c1># \connect app</span>
You are now connected to database <span class=s2>&#34;app&#34;</span> as user <span class=s2>&#34;postgres&#34;</span>.
<span class=nv>app</span><span class=o>=</span><span class=c1># CREATE TABLE product (</span>
    id          bigint PRIMARY KEY,
    name       varchar<span class=o>(</span>256<span class=o>)</span> NOT NULL
<span class=o>)</span><span class=p>;</span>
<span class=nv>app</span><span class=o>=</span><span class=c1># \dt</span>
          List of relations
 Schema <span class=p>|</span>  Name   <span class=p>|</span> Type  <span class=p>|</span>  Owner   
--------+---------+-------+----------
 public <span class=p>|</span> product <span class=p>|</span> table <span class=p>|</span> postgres
<span class=o>(</span><span class=m>1</span> row<span class=o>)</span>
$ docker inspect -f <span class=s1>&#39;{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}&#39;</span> 2792b13c36c1
172.17.0.2</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/postgres.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/postgres.sh target=_blank>postgres.sh</a></div></div><p>En Vault hay que crear la configuración para conectarse a la base de datos y un rol que contiene la configuración para generar las credenciales y permitir obtenerlas, básicamente es un sentencia SQL con el nombre del usuario y contraseña, los permisos que se le asignan y el tiempo de concesión.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>export</span> <span class=nv>VAULT_ADDR</span><span class=o>=</span>http://127.0.0.1:8200
$ vault login s.0YRcRzojVcPG8LbbzyUd1MEA
$ vault secrets <span class=nb>enable</span> database</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault-database.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault-database.sh target=_blank>vault-database.sh</a></div></div><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ vault write database/config/app <span class=se>\
</span><span class=se></span>   <span class=nv>plugin_name</span><span class=o>=</span>postgresql-database-plugin <span class=se>\
</span><span class=se></span>   <span class=nv>allowed_roles</span><span class=o>=</span><span class=s2>&#34;app&#34;</span> <span class=se>\
</span><span class=se></span>   <span class=nv>connection_url</span><span class=o>=</span><span class=s2>&#34;postgresql://{{username}}:{{password}}@localhost:5432/?sslmode=disable&#34;</span> <span class=se>\
</span><span class=se></span>   <span class=nv>username</span><span class=o>=</span><span class=s2>&#34;postgres&#34;</span> <span class=se>\
</span><span class=se></span>   <span class=nv>password</span><span class=o>=</span><span class=s2>&#34;postgres&#34;</span>
$ vault write database/roles/app <span class=se>\
</span><span class=se></span>    <span class=nv>db_name</span><span class=o>=</span>app <span class=se>\
</span><span class=se></span>    <span class=nv>creation_statements</span><span class=o>=</span><span class=s2>&#34;CREATE ROLE \&#34;{{name}}\&#34; WITH LOGIN PASSWORD &#39;{{password}}&#39; VALID UNTIL &#39;{{expiration}}&#39;; GRANT SELECT ON ALL TABLES IN SCHEMA public TO \&#34;{{name}}\&#34;;&#34;</span> <span class=se>\
</span><span class=se></span>    <span class=nv>default_ttl</span><span class=o>=</span><span class=s2>&#34;1h&#34;</span> <span class=se>\
</span><span class=se></span>    <span class=nv>max_ttl</span><span class=o>=</span><span class=s2>&#34;24h&#34;</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault-role.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault-role.sh target=_blank>vault-role.sh</a></div></div><p>Las credenciales se generan en el momento de leer una propiedad de Vault.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ vault <span class=nb>read</span> database/roles/app
Key                      Value
---                      -----
creation_statements      <span class=o>[</span>CREATE ROLE <span class=s2>&#34;{{name}}&#34;</span> WITH LOGIN PASSWORD <span class=s1>&#39;{{password}}&#39;</span> VALID UNTIL <span class=s1>&#39;{{expiration}}&#39;</span><span class=p>;</span> GRANT SELECT ON ALL TABLES IN SCHEMA public TO <span class=s2>&#34;{{name}}&#34;</span><span class=p>;</span><span class=o>]</span>
db_name                  app
default_ttl              1h
max_ttl                  24h
renew_statements         <span class=o>[</span><span class=o>]</span>
revocation_statements    <span class=o>[</span><span class=o>]</span>
rollback_statements      <span class=o>[</span><span class=o>]</span>
$ vault <span class=nb>read</span> database/creds/app
Key                Value
---                -----
lease_id           database/creds/app/rFFlNmpNoxezccTVh3WufZOT
lease_duration     1h
lease_renewable    <span class=nb>true</span>
password           A1a-6hRTGNaShFIEGLvp
username           v-root-app-ydbbHqVq1gYQqsUxMuIc-1565857370</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault-credentials.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault-credentials.sh target=_blank>vault-credentials.sh</a></div></div><p>En postgres la conexión desde la máquina local se permiten sin necesidad de credenciales, para simular realizar la conexión desde otra máquina hay que iniciar otro contenedor. En la conexión se utilizan las credenciales que ha proporcionado Vault. Dado que se realiza una operación de red hay que desactivar el <em>firewall</em> del sistema o permitir la conexión al puerto de la base de datos que en postgres es el 5432 si fuera necesario. Listando los usuarios de la base de datos con el comando <em>\du</em> se muestra el creado por Vault y si tiempo de validez.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ docker run -it postgres:alpine bash
bash-5.0# <span class=nv>PGPASSWORD</span><span class=o>=</span>A1a-6hRTGNaShFIEGLvp psql -U v-root-app-ydbbHqVq1gYQqsUxMuIc-1565857370 -h 172.17.0.2 -d app
psql <span class=o>(</span>11.4<span class=o>)</span>
Type <span class=s2>&#34;help&#34;</span> <span class=k>for</span> help.

<span class=nv>app</span><span class=o>=</span>&gt; <span class=se>\d</span>t
          List of relations
 Schema <span class=p>|</span>  Name   <span class=p>|</span> Type  <span class=p>|</span>  Owner   
--------+---------+-------+----------
 public <span class=p>|</span> product <span class=p>|</span> table <span class=p>|</span> postgres
<span class=o>(</span><span class=m>1</span> row<span class=o>)</span>
<span class=nv>app</span><span class=o>=</span><span class=c1># \du</span>
                                                    List of roles
                 Role name                  <span class=p>|</span>                         Attributes                         <span class=p>|</span> Member of 
--------------------------------------------+------------------------------------------------------------+-----------
 postgres                                   <span class=p>|</span> Superuser, Create role, Create DB, Replication, Bypass RLS <span class=p>|</span> <span class=o>{</span><span class=o>}</span>
 v-root-app-ydbbHqVq1gYQqsUxMuIc-1565857370 <span class=p>|</span> Password valid <span class=k>until</span> 2019-08-15 09:22:55+00                <span class=p>|</span> <span class=o>{</span><span class=o>}</span>
<span class=nv>app</span><span class=o>=</span>&gt; quit</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/postgres-connect.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/postgres-connect.sh target=_blank>postgres-connect.sh</a></div></div><p>Si el usuario y contraseña no es correcto no se permite la conexión a la base de datos.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>bash-5.0# <span class=nv>PGPASSWORD</span><span class=o>=</span>tampered psql -U v-root-app-ydbbHqVq1gYQqsUxMuIc-1565857370 -h 172.17.0.2 -d app
psql: FATAL:  password authentication failed <span class=k>for</span> user <span class=s2>&#34;v-root-app-ydbbHqVq1gYQqsUxMuIc-1565857370&#34;</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/postgres-connect-fail.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/postgres-connect-fail.sh target=_blank>postgres-connect-fail.sh</a></div></div><p>En las aplicaciones Java que utilizan <a href=https://spring.io/>Spring</a> el proyecto <a href=https://cloud.spring.io/spring-cloud-vault/>Spring Cloud Vault</a> proporciona las utilidades para simplificar en gran medida la obtención de las credenciales a la base de datos utilizando Vault.</p><p>Esto permite que únicamente Vault conozca la cuenta <em>root</em> de la base de datos o una con suficientes permisos para crear credenciales, las aplicaciones no almacenan en su configuración las credenciales para conectarse la base de datos solo las de Vault que le permiten obtener unas credenciales para la base de datos con un tiempo de vida limitado y que pueden revocarse desde Vault en caso de un problema de seguridad para cuales quiera bases de datos que se utilicen.</p><div class=reference>Referencia:<br><ul><li><a href=https://picodotdev.github.io/blog-bitix/series/docker/>Serie de artículos sobre Docker</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2017/05/introduccion-a-la-base-de-datos-relacional-postgresql/>Introducción a la base de datos relacional PostgreSQL</a></li></ul></div></div></article><div class="row serie"><div class=col-md-12><h3>Este artículo forma parte de la serie <strong>hashicorp</strong>:</h3><ol class=serie-articles><li><a href=https://picodotdev.github.io/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/>Introducción a Nomad para gestionar aplicaciones y microservicios</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/>Estrategias de despliegue para microservicios con Nomad</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/>Servicios con persistencia en el orquestador de microservicos Nomad</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/>Crear de forma sencilla y rápida máquinas virtuales de VirtualBox con Vagrant</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/>Registro y descubrimiento de servicios en contenedores de Docker con Consul y Registrator</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/>Administrar secretos y proteger datos sensibles con Vault</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/>Generar credenciales de conexión a base de datos bajo demanda con Vault</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/>Utilizar credenciales de conexión a la base de datos generadas por Vault en una aplicación de Spring</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/>Microservicios con Spring Cloud, Consul, Nomad y Traefik</a></li></ol></div></div><div class=row><div class=col-md-12><div class=sharethis-inline-share-buttons></div></div></div><div class=row><div class="col-12 text-center"><ins class=adsbygoogle style=display:inline-block;width:970px;height:250px data-ad-client=ca-pub-3533636310991304 data-ad-slot=2975854584 data-type=billboard></ins></div></div><a id=comments></a><div class=row><div class=col-md-12><div id=disqus_thread></div></div></div><script type=text/javascript async>var disqus_shortname='blog-bitix';var disqus_identifier='blog-bitix-428';var disqus_url='https:\/\/picodotdev.github.io\/blog-bitix\/2019\/08\/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault\/';var disqus_script='embed.js';(function(){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}());</script></div></div><div class=row><div class=col-12><hr></div></div><footer><div class=row><div class="col-12 col-sm-4"><p><strong>Blog Bitix</strong></p><p>Blog dedicado a la distribución GNU/Linux que uso habitualmente, Arch Linux, a mis andanzas alrededor del software libre, la programación y a otros temas relacionados con la tecnología y la informática.</p><p>Publicando de uno a tres artículos únicos a la semana desde el año 2010.</p></div><div class="col-12 col-sm-4 text-center menu"><ul class=list-unstyled><li><a href=/blog-bitix/tags/java/>Java</a></li><li><a href=/blog-bitix/tags/gnu-linux/>GNU/Linux</a></li><li><a href=/blog-bitix/tags/javascript/>JavaScript</a></li><li><a href=/blog-bitix/tags/tapestry/>Tapestry</a></li><li><a href=/blog-bitix/archive/>Archivo y hemeroteca</a></li><li><a href=/blog-bitix/pages/links/>Enlaces</a></li><li><a href=/blog-bitix/pages/advertising/>Publicidad</a></li><li><a href=/blog-bitix/pages/donate/>Donaciones</a></li><li><a href=/blog-bitix/pages/about/>Acerca de...</a></li></ul></div><div class="col-12 col-sm-4 text-center links"><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class=row><div class=col-12>Copyleft <span class=copyleft>&copy;</span> 2019 - <a href=https://creativecommons.org/licenses/by-sa/4.0/ rel=nofollow rel=license><img alt="Licencia de Creative Commons" title="Licencia de Creative Commons" style=border-width:0 src=https://licensebuttons.net/l/by-sa/4.0/80x15.png class=licencia></a><br><a href=https://twitter.com/blogstackinfo rel=nofollow><img src=https://picodotdev.github.io/blog-bitix/assets/images/blog-stack.png alt="Blog Stack" title="Blog Stack"></a>
<a href=https://www.planetacodigo.com/ rel=nofollow><img src=https://picodotdev.github.io/blog-bitix/assets/images/planeta-codigo.png alt="Planeta código" title="Planeta código"></a><br><span xmlns:dct=http://purl.org/dc/terms/ property="dct:title"><a href=https://picodotdev.github.io/blog-bitix/ rel=nofollow>Blog Bitix</a></span> by <a xmlns:cc=https://creativecommons.org/ns# href=https://picodotdev.github.io/blog-bitix/ property="cc:attributionName" rel=cc:attributionurl>pico.dev</a> is licensed under a <a rel=license href=https://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional License</a>.<br><span class=credit>Powered by <a href=https://gohugo.io/ rel=nofollow title="A fast and modern static website engine">Hugo</a> and <a href=https://pages.github.com/ title="Websites for you and your projects">GitHub Pages</a>.</span>
<span class=credit>Background patterns from <a href=https://www.toptal.com/designers/subtlepatterns/ rel=nofollow>Subtle Patterns</a>.</span></div></div></footer></div><div class=blueimp-gallery-container><div id=blueimp-gallery class="blueimp-gallery blueimp-gallery-controls" data-use-bootstrap-modal=false><div class=slides></div><h3 class=title></h3><a class=prev>‹</a>
<a class=next>›</a>
<a class=close>×</a>
<a class=play-pause></a><ol class=indicator></ol><div class="modal fade"><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close aria-hidden=true>&#215;</button><h4 class=modal-title></h4></div><div class="modal-body next"></div><div class=modal-footer><button type=button class="btn btn-default pull-left prev">
<i class="glyphicon glyphicon-chevron-left"></i>Anterior</button>
<button type=button class="btn btn-primary next">
Siguiente
<i class="glyphicon glyphicon-chevron-right"></i></button></div></div></div></div></div></div><script type=text/javascript>window.cookieconsent_options={"message":"Esta bitácora te informa de la obviedad de que utiliza «cookies», propias y de servicios como Google Analytics y Google AdSense entre otros.","dismiss":"Aceptar","learnMore":"Más información","link":null,"theme":"dark-bottom"};</script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js async></script></body></html>