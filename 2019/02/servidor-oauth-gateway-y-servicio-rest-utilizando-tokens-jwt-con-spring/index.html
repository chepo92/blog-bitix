<!doctype html><html lang=es><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="picodotdev"><meta name=keywords content="java,programacion,software,hardware,tapestry,software libre,gnu,linux,gnu/linux,unix,arch,arch linux,html,css,javascript"><meta name=description content="Hace unos días encontré un articulo del blog técnido de los desarrolladores de Idealista. En él comentaban que tenían una API para realizar simulaciones hipotecarias usando Spring como framework, Spring Security OAuth como forma de autenticación y autorización y JWT como forma de codificar el token que otorga el servidor OAuth y contiene la información necesaria para que el servidor de recursos permita o no el acceso al recurso que aloja. &mldr;"><base href=https://picodotdev.github.io/blog-bitix/><title>Servidor OAuth, gateway y servicio REST utilizando tokens JWT con Spring</title><link rel=author type=text/plain href=humans.txt><link rel="shortcut icon" href=assets/favicon.ico><link rel=apple-touch-icon-precomposed sizes=144x144 href=assets/apple-touch-icon-144-precomposed.png><link rel=canonical href=https://picodotdev.github.io/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/><link href=index.xml rel=alternate type=application/rss+xml title="Blog Bitix"><link rel=stylesheet type=text/css href=assets/css/font.css><link rel=stylesheet type=text/css href=assets/libs/bootstrap-4.3.1/css/bootstrap.min.css><link rel=stylesheet type=text/css href=assets/libs/Gallery-2.33.0/css/blueimp-gallery.min.css><link rel=stylesheet type=text/css href=assets/css/syntax.css><link rel=stylesheet type=text/css href=assets/css/main.css><script type=text/javascript src=assets/js/require-config.js data-main=js/main defer></script><script type=text/javascript src=assets/libs/require.js data-main=js/main defer></script><script src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js defer></script><script type=text/javascript defer>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:'ca-pub-3533636310991304',enable_page_level_ads:true});</script><script type=text/javascript defer>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-12874075-4','picodotdev.github.io');ga('send','pageview');</script><script type=text/javascript src="//platform-api.sharethis.com/js/sharethis.js#property=5920c4ce1bd0670011e06acd&product=inline-share-buttons" defer></script><script type=text/javascript src=assets/js/app.js defer></script></head><body><div class=container><div class=row><div class=col-12><header><div class=row><div class="col-12 col-lg-4"></div><div class="col-12 col-lg-4"><h2 class=title><a href=https://picodotdev.github.io/blog-bitix/>Blog Bitix</a></h2><div class=links><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class="col-12 col-lg-4 text-center"><form name=query class="form-inline search" onsubmit="return false;"><div class=input-group><input type=text name=q class=form-control placeholder="Buscar en Blog Bitix">
<span class=input-group-btn><button class="btn btn-secondary" type=submit>Buscar</button></span></div></form><form name=search action=https://duckduckgo.com/ method=get class=hidden data-site=https://picodotdev.github.io/blog-bitix/><input type=hidden name=q></form></div></div><div class=row><div class=col-12><nav class="nav nav-pills nav-fill"><a href=/blog-bitix/tags/java/ class="nav-item nav-link">Java</a>
<a href=/blog-bitix/tags/gnu-linux/ class="nav-item nav-link">GNU/Linux</a>
<a href=/blog-bitix/tags/javascript/ class="nav-item nav-link">JavaScript</a>
<a href=/blog-bitix/tags/tapestry/ class="nav-item nav-link">Tapestry</a>
<a href=/blog-bitix/archive/ class="nav-item nav-link">Archivo y hemeroteca</a>
<a href=/blog-bitix/pages/links/ class="nav-item nav-link">Enlaces</a>
<a href=/blog-bitix/pages/about/ class="nav-item nav-link">Acerca de...</a></nav></div></div></header></div></div><div class=row><div class="col-12 text-center"><ins class=adsbygoogle style=display:inline-block;width:970px;height:250px data-ad-client=ca-pub-3533636310991304 data-ad-slot=2975854584 data-type=billboard></ins></div></div><div class=row><div class=col-12><div class="adblock-sidebar adblock-sidebar-right"><div class=adblock-sidebar-container><ins class="adsbygoogle adblock-sidebar-vertical" style=display:block data-ad-client=ca-pub-3533636310991304 data-ad-slot=9933840986 data-ad-format="vertical, rectangle" data-type=auto></ins></div></div><article itemprop=mainEntity itemscope itemtype=http://schema.org/BlogPosting><meta itemprop=inLanguage content="es"><meta itemprop=keywords content="java, planeta-codigo, programacion, software, spring"><h1 itemprop=name>Servidor OAuth, gateway y servicio REST utilizando tokens JWT con Spring</h1><p class=information>Escrito por
<span itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>picodotdev</span></span> el <time itemprop=datePublished datetime=2019-02-08>08/02/2019</time>.<br><a href=tags/java/>java</a> <a href=tags/planeta-codigo/>planeta-codigo</a> <a href=tags/programacion/>programacion</a> <a href=tags/software/>software</a> <a href=tags/spring/>spring</a><br><a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/ itemprop=url>Enlace permanente</a>
<a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/#comments>Comentarios</a></p><div class=content itemprop=articleBody><meta itemprop=wordCount content="1883"><div class=logotypes><img src=/blog-bitix/assets/images/logotipos/spring.svg class=right width=200 alt=Spring title=Spring></div><div class=logotypes><img src=/blog-bitix/assets/images/logotipos/java.svg class=right width=200 alt=Java title=Java></div><p>Hace unos días encontré un <a href=https://www.idealista.com/labs/blog/spring-framework/autenticando-el-api-de-idealista-hipotecas-con-spring-oauth2-y-zuul/>articulo del blog técnido de los desarrolladores de Idealista</a>. En él comentaban que tenían una API para realizar simulaciones hipotecarias usando <a href=https://spring.io/>Spring</a> como <em>framework</em>, <a href=https://spring.io/projects/spring-security-oauth>Spring Security OAuth</a> como forma de autenticación y autorización y JWT como forma de codificar el <em>token</em> que otorga el servidor OAuth y contiene la información necesaria para que el servidor de recursos permita o no el acceso al recurso que aloja.</p><p>Ya había oído mencionar JWT pero este artículo me ha permitido conocer su utilidad, y no es poca. Como se menciona en el artículo JWT tiene la ventaja de que que no es necesario persistirlo en una base de datos y contiene toda la información que el servidor de recursos necesita para realizar la autorización ya que es capaz de cargar con información arbitraria que el servicio desee en el momento de la emisión, la autenticación y comprobación de que ha sido emitido por el servidor OAuth la realiza sabiendo que el <em>token</em> está firmado.</p><p>Los <em>tokens</em> son una serie de caracteres aparentemente sin sentido al estar <em>hasheados</em> y firmados con una clave compartida entre servidor OAuth y el servidor de recurso o para mayor seguridad mediante clave privada en el servidor OAuth y su clave pública asociada en el servidor de recursos, con la firma el servidor de recursos el capaz de comprobar la autenticidad del <em>token</em> sin necesidad de comunicarse con él. Los <em>tokens</em> de OAuth son más cortos, los <em>tokens</em> JWT con más largos ya que contienen información adicional. Se componen de tres partes separadas por un punto, una cabecera con el algoritmo <em>hash</em> utilizado y tipo de <em>token</em>, un documento JSON con datos y una firma de verificación.</p><p>El hecho de que los <em>tokens</em> JWT no sea necesario persistirlos en base de datos elimina la necesidad de tener su infraestructura, como desventaja es que no es tan fácil de revocar el acceso a un <em>token</em> JWT y por ello se les concede un tiempo de expiración corto. En el articulo se analizaba su infraestructura y hay varios elementos configurables de diferentes formas, son:</p><ul><li>El servidor OAuth que proporciona los tokens, realiza la autenticación y proporciona las autorizaciones.</li><li>El servidor del recurso al que se le envía el <em>token</em>, en base a las autorizaciones otorgadas por el servidor OAuth al token y las autorizaciones necesarias para acceder al recurso concedo o no acceso al recurso.</li><li>En el caso de múltiples servicios con múltiples recursos es conveniente un <em>gateway</em> para que sea el punto de entrada de todos los servicios, de esta forma los clientes solo necesitarán conocer el <em>gateway</em> en vez de los múltiples servicios individuales. El <em>gateway</em> se encarga de hacer de <em>proxy</em> en base a información en la petición como ruta, <em>host</em>, parámetros, cabeceras, &mldr; de redirigir la petición al servicio encargado de atenderla y devolver la respuesta. Un ejemplo de <em>gateway</em> es <a href=https://github.com/Netflix/zuul>Zuul</a> como ya he mostrado en el artículo <a href=https://picodotdev.github.io/blog-bitix/2018/10/proxy-para-microservicios-con-spring-cloud-netflix-y-zuul/>Proxy para microservicios con Spring Cloud Netflix y Zuul</a>.</li></ul><p>Puede haber más elementos en la infraestructura y quizá sea el caso de un sistema real como sería un servidor de descubrimiento con <a href=https://github.com/Netflix/eureka>Eureka</a> o un servidor de configuración con <a href=https://cloud.spring.io/spring-cloud-config/>Spring Cloud Config</a>, en la <a href=https://picodotdev.github.io/blog-bitix/series/spring-cloud/>serie de artículos sobre Spring Cloud</a> los muestro. Para este ejemplo obvio estos otros servidores y me centro en los más relacionados con el artículo. Aunque lógicamente son diferentes servicios se puede crear uno que proporcione varios de ellos al mismo tiempo, por ejemplo, un servicio que haga al mismo tiempo de servidor de OAuth y de <em>gateway</em> que es una de las posibles cambios que dejan al final en el artículo de Idealista.</p><p>Spring ha creado su propio proyecto de <em>gateway</em> para sustituir a Zuul, <a href=https://spring.io/projects/spring-cloud-gateway>Spring Cloud Gateway</a> y será el que use en este artículo. Soporta <a href=https://projects.spring.io/spring-boot/>Spring Boot</a> 2, <a href=https://projects.spring.io/spring-framework/>Spring Framework</a> 5, coincidencia por cualquier parámetro de la petición, filtros y transformaciones o predicados, el patrón <em>circuit breaker</em>, limitación de peticiones y reescritura de rutas.</p><p>Los servicios los mantengo separados ya que al combinarlos pueden surgir problemas de integración al usar diferentes versiones de librerías de Spring aún cuando todos los proyectos son de Spring. Por ejemplo, Spring Cloud Gateway utiliza Spring WebFlux que puede ser diferente del lo que utilice Spring Security OAuth y la integración puede no estar exenta de problemas.</p><div class=media><img src=assets/images/logotipos/oauth.svg alt=OAuth title=OAuth width=200>
<img src=assets/images/logotipos/jwt.svg alt=JWT title=JWT width=300></div><h3 id=servidor-oauth>Servidor OAuth</h3><p>Empezando por el servidor OAuth y las dependencias que necesita, son <em>spring-security-oauth2</em> y para generar <em>tokens</em> JWT <em>spring-security-jwt</em>, el resto son dependencias necesarias de Spring Boot</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span><span class=lnt>13&#10;</span><span class=lnt>14&#10;</span><span class=lnt>15&#10;</span><span class=lnt>16&#10;</span><span class=lnt>17&#10;</span><span class=lnt>18&#10;</span><span class=lnt>19&#10;</span><span class=lnt>20&#10;</span><span class=lnt>21&#10;</span><span class=lnt>22&#10;</span><span class=lnt>23&#10;</span><span class=lnt>24&#10;</span><span class=lnt>25&#10;</span><span class=lnt>26&#10;</span><span class=lnt>27&#10;</span><span class=lnt>28&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>plugins</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>id</span> <span class=s1>&#39;application&#39;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>id</span> <span class=s1>&#39;org.springframework.boot&#39;</span> <span class=n>version</span> <span class=s1>&#39;2.0.8.RELEASE&#39;</span>&#10;<span class=o>}</span>&#10;&#10;<span class=n>mainClassName</span> <span class=o>=</span> <span class=s1>&#39;io.github.picodotdev.blogbitix.springoauth.oauth.Main&#39;</span>&#10;&#10;<span class=n>dependencies</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>implementation</span> <span class=nf>platform</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-dependencies:2.0.8.RELEASE&#39;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>implementation</span> <span class=nf>platform</span><span class=o>(</span><span class=s1>&#39;org.springframework.cloud:spring-cloud-dependencies:Finchley.SR2&#39;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kt>def</span> <span class=n>excludeSpringBootStarterLogging</span> <span class=o>=</span> <span class=o>{</span> <span class=n>exclude</span><span class=o>(</span><span class=nl>group:</span> <span class=s1>&#39;org.springframework.boot&#39;</span><span class=o>,</span> <span class=nl>module:</span> <span class=s1>&#39;spring-boot-starter-logging&#39;</span><span class=o>)</span> <span class=o>}</span>&#10;	<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter-web&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter-security&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter-log4j2&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&nbsp;&nbsp;&nbsp;&nbsp;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.security.oauth:spring-security-oauth2:2.3.4.RELEASE&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.security:spring-security-jwt:1.0.10.RELEASE&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;com.google.code.gson:gson:2.8.5&#39;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;com.fasterxml.jackson.core:jackson-databind:2.9.6&#39;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;com.fasterxml.jackson.dataformat:jackson-dataformat-yaml:2.9.6&#39;</span><span class=o>)</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;javax.xml.bind:jaxb-api:2.3.0&#39;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;com.sun.xml.bind:jaxb-impl:2.3.0&#39;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;org.glassfish.jaxb:jaxb-runtime:2.3.0&#39;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;javax.activation:activation:1.1.1&#39;</span><span class=o>)</span>&#10;<span class=o>}</span>&#10;</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/build.gradle target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/build.gradle target=_blank>oauth/build.gradle</a></div></div><p>La clase principal de Spring Boot y que inicia la aplicación no tiene nada especial salvo la necesaria anotación <em>@EnableAuthorizationServer</em> para habilitar el servidor OAuth.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>io.github.picodotdev.blogbitix.springoauth.oauth</span><span class=o>;</span>&#10;&#10;<span class=o>.</span><span class=o>.</span><span class=o>.</span>&#10;&#10;<span class=nd>@SpringBootApplication</span>&#10;<span class=nd>@EnableAuthorizationServer</span>&#10;<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Main</span> <span class=o>{</span>&#10;&#10;	<span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[</span><span class=o>]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>&#10;		<span class=n>SpringApplication</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>Main</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>args</span><span class=o>)</span><span class=o>;</span>&#10;	<span class=o>}</span>&#10;<span class=o>}</span>&#10;</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/Main.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/Main.java target=_blank>oauth/Main.java</a></div></div><p>La parte importante está en la clase de configuración. La clase <em>JwtAccessTokenConverter</em> se encarga de codificar el token, la clase <em>TokenStore</em> de generarlos, <em>DefaultTokenServices</em> contiene referencias a ambos, los métodos heredados <em>configure()</em> configuran diferentes aspectos del servicio como los requisitos para acceder a los <em>endpoint</em> para ver el contenido de un <em>token</em> o los clientes OAuth que reconoce. Para cada cliente se necesita proporcionar el identificativo del cliente, su clave privada o <em>secret</em>, identificativo del recurso, que tipos de concesiones, <em>grants</em>, formas o flujos de obtener el <em>token</em>, que autoridades y ámbitos o <em>scopes</em> se le asigna al token.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span><span class=lnt>13&#10;</span><span class=lnt>14&#10;</span><span class=lnt>15&#10;</span><span class=lnt>16&#10;</span><span class=lnt>17&#10;</span><span class=lnt>18&#10;</span><span class=lnt>19&#10;</span><span class=lnt>20&#10;</span><span class=lnt>21&#10;</span><span class=lnt>22&#10;</span><span class=lnt>23&#10;</span><span class=lnt>24&#10;</span><span class=lnt>25&#10;</span><span class=lnt>26&#10;</span><span class=lnt>27&#10;</span><span class=lnt>28&#10;</span><span class=lnt>29&#10;</span><span class=lnt>30&#10;</span><span class=lnt>31&#10;</span><span class=lnt>32&#10;</span><span class=lnt>33&#10;</span><span class=lnt>34&#10;</span><span class=lnt>35&#10;</span><span class=lnt>36&#10;</span><span class=lnt>37&#10;</span><span class=lnt>38&#10;</span><span class=lnt>39&#10;</span><span class=lnt>40&#10;</span><span class=lnt>41&#10;</span><span class=lnt>42&#10;</span><span class=lnt>43&#10;</span><span class=lnt>44&#10;</span><span class=lnt>45&#10;</span><span class=lnt>46&#10;</span><span class=lnt>47&#10;</span><span class=lnt>48&#10;</span><span class=lnt>49&#10;</span><span class=lnt>50&#10;</span><span class=lnt>51&#10;</span><span class=lnt>52&#10;</span><span class=lnt>53&#10;</span><span class=lnt>54&#10;</span><span class=lnt>55&#10;</span><span class=lnt>56&#10;</span><span class=lnt>57&#10;</span><span class=lnt>58&#10;</span><span class=lnt>59&#10;</span><span class=lnt>60&#10;</span><span class=lnt>61&#10;</span><span class=lnt>62&#10;</span><span class=lnt>63&#10;</span><span class=lnt>64&#10;</span><span class=lnt>65&#10;</span><span class=lnt>66&#10;</span><span class=lnt>67&#10;</span><span class=lnt>68&#10;</span><span class=lnt>69&#10;</span><span class=lnt>70&#10;</span><span class=lnt>71&#10;</span><span class=lnt>72&#10;</span><span class=lnt>73&#10;</span><span class=lnt>74&#10;</span><span class=lnt>75&#10;</span><span class=lnt>76&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>io.github.picodotdev.blogbitix.springoauth.oauth</span><span class=o>;</span>&#10;&#10;<span class=o>.</span><span class=o>.</span><span class=o>.</span>&#10;&#10;<span class=nd>@Configuration</span>&#10;<span class=nd>@EnableAuthorizationServer</span>&#10;<span class=kd>public</span> <span class=kd>class</span> <span class=nc>AuthorizationServerConfiguration</span> <span class=kd>extends</span> <span class=n>AuthorizationServerConfigurerAdapter</span> <span class=o>{</span>&#10;&#10;	<span class=nd>@Autowired</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>private</span> <span class=n>ClientDetailsService</span> <span class=n>clientDetailsService</span><span class=o>;</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Autowired</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>private</span> <span class=n>JwtAccessTokenConverter</span> <span class=n>tokenConverter</span><span class=o>;</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Autowired</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>private</span> <span class=n>TokenStore</span> <span class=n>tokenStore</span><span class=o>;</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Autowired</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>private</span> <span class=n>DefaultTokenServices</span> <span class=n>tokenServices</span><span class=o>;</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Bean</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>public</span> <span class=n>JwtAccessTokenConverter</span> <span class=nf>tokenConverter</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>JwtAccessTokenConverter</span> <span class=n>converter</span> <span class=o>=</span> <span class=k>new</span> <span class=n>JwtAccessTokenConverter</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>converter</span><span class=o>.</span><span class=na>setSigningKey</span><span class=o>(</span><span class=s>&#34;1234567890&#34;</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=k>return</span> <span class=n>converter</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Bean</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>public</span> <span class=n>TokenStore</span> <span class=nf>tokenStore</span><span class=o>(</span><span class=n>JwtAccessTokenConverter</span> <span class=n>tokenConverter</span><span class=o>)</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=k>return</span> <span class=k>new</span> <span class=n>JwtTokenStore</span><span class=o>(</span><span class=n>tokenConverter</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Bean</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>DefaultTokenServices</span> <span class=nf>tokenServices</span><span class=o>(</span><span class=n>TokenStore</span> <span class=n>tokenStore</span><span class=o>,</span> <span class=n>JwtAccessTokenConverter</span> <span class=n>tokenConverter</span><span class=o>)</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>DefaultTokenServices</span> <span class=n>tokenServices</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultTokenServices</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>tokenServices</span><span class=o>.</span><span class=na>setTokenStore</span><span class=o>(</span><span class=n>tokenStore</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>tokenServices</span><span class=o>.</span><span class=na>setTokenEnhancer</span><span class=o>(</span><span class=n>tokenConverter</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=k>return</span> <span class=n>tokenServices</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Bean</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>public</span> <span class=n>TokenStoreUserApprovalHandler</span> <span class=nf>userApprovalHandler</span><span class=o>(</span><span class=n>TokenStore</span> <span class=n>tokenStore</span><span class=o>,</span> <span class=n>ClientDetailsService</span> <span class=n>clientDetailsService</span><span class=o>)</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>TokenStoreUserApprovalHandler</span> <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TokenStoreUserApprovalHandler</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>handler</span><span class=o>.</span><span class=na>setTokenStore</span><span class=o>(</span><span class=n>tokenStore</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>handler</span><span class=o>.</span><span class=na>setRequestFactory</span><span class=o>(</span><span class=k>new</span> <span class=n>DefaultOAuth2RequestFactory</span><span class=o>(</span><span class=n>clientDetailsService</span><span class=o>)</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>handler</span><span class=o>.</span><span class=na>setClientDetailsService</span><span class=o>(</span><span class=n>clientDetailsService</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=k>return</span> <span class=n>handler</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10; &#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Bean</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>public</span> <span class=n>ApprovalStore</span> <span class=nf>approvalStore</span><span class=o>(</span><span class=n>TokenStore</span> <span class=n>tokenStore</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>TokenApprovalStore</span> <span class=n>store</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TokenApprovalStore</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>store</span><span class=o>.</span><span class=na>setTokenStore</span><span class=o>(</span><span class=n>tokenStore</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=k>return</span> <span class=n>store</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Override</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>AuthorizationServerSecurityConfigurer</span> <span class=n>security</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>security</span><span class=o>.</span><span class=na>allowFormAuthenticationForClients</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>tokenKeyAccess</span><span class=o>(</span><span class=s>&#34;isAuthenticated()&#34;</span><span class=o>)</span><span class=o>.</span><span class=na>checkTokenAccess</span><span class=o>(</span><span class=s>&#34;isAuthenticated()&#34;</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Override</span>&#10;	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>AuthorizationServerEndpointsConfigurer</span> <span class=n>endpoints</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>endpoints</span><span class=o>.</span><span class=na>tokenServices</span><span class=o>(</span><span class=n>tokenServices</span><span class=o>)</span><span class=o>;</span>&#10;	<span class=o>}</span>&#10;&#10;	<span class=nd>@Override</span>&#10;	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>ClientDetailsServiceConfigurer</span> <span class=n>clients</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>&#10;		<span class=n>clients</span><span class=o>.</span><span class=na>inMemory</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>withClient</span><span class=o>(</span><span class=s>&#34;client&#34;</span><span class=o>)</span>&#10;				<span class=o>.</span><span class=na>secret</span><span class=o>(</span><span class=s>&#34;{noop}1234567890&#34;</span><span class=o>)</span>&#10;				<span class=o>.</span><span class=na>resourceIds</span><span class=o>(</span><span class=s>&#34;service&#34;</span><span class=o>)</span>&#10;				<span class=o>.</span><span class=na>authorizedGrantTypes</span><span class=o>(</span><span class=s>&#34;client_credentials&#34;</span><span class=o>)</span>&#10;				<span class=o>.</span><span class=na>authorities</span><span class=o>(</span><span class=s>&#34;CLIENT&#34;</span><span class=o>)</span>&#10;				<span class=o>.</span><span class=na>scopes</span><span class=o>(</span><span class=s>&#34;read&#34;</span><span class=o>)</span><span class=o>;</span>&#10;	<span class=o>}</span>&#10;<span class=o>}</span>&#10;</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/AuthorizationServerConfiguration.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/AuthorizationServerConfiguration.java target=_blank>oauth/AuthorizationServerConfiguration.java</a></div></div><p>El servidor OAuth de ejemplo se inicia con el comando <em>./gradlew oauth:run</em>. Para obtener un <em>token</em> se realiza con las siguientes peticiones. Por defecto, se solicita autenticación <em>basic</em> pero la invocación al método <em>allowFormAuthenticationForClients()</em> hace que los parámetros de las credenciales se puedan indicar por parámetros.</p><p>Con el <em>endpoint</em> <em>/oauth/check_token</em> se decodifica el <em>token</em>. En la página de JWT hay una herramienta para decodificar el token y verificar de la firma introduciendo clave de firma en la casilla.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1&#10;</span><span class=lnt>2&#10;</span><span class=lnt>3&#10;</span><span class=lnt>4&#10;</span><span class=lnt>5&#10;</span><span class=lnt>6&#10;</span><span class=lnt>7&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ curl -X POST -u <span class=s2>&#34;client:1234567890&#34;</span> -d <span class=s2>&#34;grant_type=client_credentials&#34;</span> <span class=s2>&#34;http://localhost:8095/oauth/token&#34;</span>&#10;<span class=o>{</span><span class=s2>&#34;access_token&#34;</span>:<span class=s2>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ0MSwiYXV0aG9yaXRpZXMiOlsiQ0xJRU5UIl0sImp0aSI6IjEwMzE0NTk4LTRjZDctNDRmNi1hMmM4LTNjYjA5MGE1MjUxZSIsImNsaWVudF9pZCI6ImNsaWVudCJ9.n8Dwcd8YTms2Hl0YgTho9QdBWD1hAnOEmkcS-Wefy6c&#34;</span>,<span class=s2>&#34;token_type&#34;</span>:<span class=s2>&#34;bearer&#34;</span>,<span class=s2>&#34;expires_in&#34;</span>:43199,<span class=s2>&#34;scope&#34;</span>:<span class=s2>&#34;read&#34;</span>,<span class=s2>&#34;jti&#34;</span>:<span class=s2>&#34;10314598-4cd7-44f6-a2c8-3cb090a5251e&#34;</span><span class=o>}</span>&#10;$ curl -X POST <span class=s2>&#34;http://localhost:8095/oauth/token?grant_type=client_credentials&amp;client_id=client&amp;client_secret=1234567890&#34;</span>&#10;<span class=o>{</span><span class=s2>&#34;access_token&#34;</span>:<span class=s2>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ1OCwiYXV0aG9yaXRpZXMiOlsiQ0xJRU5UIl0sImp0aSI6IjEzYjM1M2Q2LTQwODUtNDdiMS1hYzkyLTRiZDJhNDg3MzFhOCIsImNsaWVudF9pZCI6ImNsaWVudCJ9.CueMcwrD7pTp3pj37_BzzcUODG7PcjCacSa14-l5_Hw&#34;</span>,<span class=s2>&#34;token_type&#34;</span>:<span class=s2>&#34;bearer&#34;</span>,<span class=s2>&#34;expires_in&#34;</span>:43199,<span class=s2>&#34;scope&#34;</span>:<span class=s2>&#34;read&#34;</span>,<span class=s2>&#34;jti&#34;</span>:<span class=s2>&#34;13b353d6-4085-47b1-ac92-4bd2a48731a8&#34;</span><span class=o>}</span>&#10;&#10;$ curl -X POST -u <span class=s2>&#34;client:1234567890&#34;</span> -d <span class=s2>&#34;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ1OCwiYXV0aG9yaXRpZXMiOlsiQ0xJRU5UIl0sImp0aSI6IjEzYjM1M2Q2LTQwODUtNDdiMS1hYzkyLTRiZDJhNDg3MzFhOCIsImNsaWVudF9pZCI6ImNsaWVudCJ9.CueMcwrD7pTp3pj37_BzzcUODG7PcjCacSa14-l5_Hw&#34;</span> http://localhost:8095/oauth/check_token&#10;<span class=o>{</span><span class=s2>&#34;aud&#34;</span>:<span class=o>[</span><span class=s2>&#34;service&#34;</span><span class=o>]</span>,<span class=s2>&#34;scope&#34;</span>:<span class=o>[</span><span class=s2>&#34;read&#34;</span><span class=o>]</span>,<span class=s2>&#34;active&#34;</span>:true,<span class=s2>&#34;exp&#34;</span>:1549692458,<span class=s2>&#34;authorities&#34;</span>:<span class=o>[</span><span class=s2>&#34;CLIENT&#34;</span><span class=o>]</span>,<span class=s2>&#34;jti&#34;</span>:<span class=s2>&#34;13b353d6-4085-47b1-ac92-4bd2a48731a8&#34;</span>,<span class=s2>&#34;client_id&#34;</span>:<span class=s2>&#34;client&#34;</span><span class=o>}</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/curl.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/curl.sh target=_blank>oauth/curl.sh</a></div></div><div class=media><figure><a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/images/encoded-decoded-jwt_hu1ab378b072a97342bd947994d891fa06_108022_2560x1440_fit_box_2.png title="Token JWT codificado y decodificado" data-gallery=data-gallery><img data-src=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/images/encoded-decoded-jwt_hu1ab378b072a97342bd947994d891fa06_108022_600x450_fit_box_2.png width=494 height=450 class=lozad></a><figcaption>Token JWT codificado y decodificado</figcaption></figure></div><h3 id=servidor-gateway>Servidor Gateway</h3><p>El servidor <em>gateway</em> en realidad no interviene en la lógica de OAuth porque la autorización se delega en cada servicio que contiene el recurso. Como se indicaba en Idealista estaría bien que el <em>gateway</em> librase de la responsabilidad de autorización a los servicios de los recursos para hacerlos más sencillos, creo que Spring Security en el momento del artículo no está soportado en Spring WebFlux que utiliza el <em>gateway</em>.</p><p>Lo único necesario par definir el <em>gateway</em> son las dependencias del proyecto, poco más que <em>spring-cloud-starter-gateway</em>, y la configuración de enrutado que <em>matchea</em> peticiones según el parámetro <em>predicates</em>, reescribe la URL hacia el servicio según el filtro <em>RewritePath</em> y finalmente redirige la petición a la ubicación del servicio indicada en <em>uri</em>. Se inicia con <em>./gradlew gateway:run</em>.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span><span class=lnt>13&#10;</span><span class=lnt>14&#10;</span><span class=lnt>15&#10;</span><span class=lnt>16&#10;</span><span class=lnt>17&#10;</span><span class=lnt>18&#10;</span><span class=lnt>19&#10;</span><span class=lnt>20&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>plugins</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>id</span> <span class=s1>&#39;application&#39;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>id</span> <span class=s1>&#39;org.springframework.boot&#39;</span> <span class=n>version</span> <span class=s1>&#39;2.0.8.RELEASE&#39;</span>&#10;<span class=o>}</span>&#10;&#10;<span class=n>mainClassName</span> <span class=o>=</span> <span class=s1>&#39;io.github.picodotdev.blogbitix.springoauth.gateway.Main&#39;</span>&#10;&#10;<span class=n>dependencies</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>implementation</span> <span class=nf>platform</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-dependencies:2.0.8.RELEASE&#39;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>implementation</span> <span class=nf>platform</span><span class=o>(</span><span class=s1>&#39;org.springframework.cloud:spring-cloud-dependencies:Finchley.SR2&#39;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kt>def</span> <span class=n>excludeSpringBootStarterLogging</span> <span class=o>=</span> <span class=o>{</span> <span class=n>exclude</span><span class=o>(</span><span class=nl>group:</span> <span class=s1>&#39;org.springframework.boot&#39;</span><span class=o>,</span> <span class=nl>module:</span> <span class=s1>&#39;spring-boot-starter-logging&#39;</span><span class=o>)</span> <span class=o>}</span>&#10;	<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter-log4j2&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.cloud:spring-cloud-starter-gateway&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;com.google.code.gson:gson:2.8.5&#39;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;com.fasterxml.jackson.core:jackson-databind:2.9.6&#39;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;com.fasterxml.jackson.dataformat:jackson-dataformat-yaml:2.9.6&#39;</span><span class=o>)</span>&#10;<span class=o>}</span>&#10;</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/gateway/build.gradle target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/gateway/build.gradle target=_blank>gateway/build.gradle</a></div></div><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-Yaml data-lang=Yaml>server.port<span class=p>:</span><span class=w> </span><span class=m>8090</span><span class=w>&#10;</span><span class=w>&#10;</span><span class=w></span>spring<span class=p>:</span><span class=w>&#10;</span><span class=w>  </span>cloud<span class=p>:</span><span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;</span>gateway<span class=p>:</span><span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;  </span>routes<span class=p>:</span><span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;  </span>-<span class=w> </span>id<span class=p>:</span><span class=w> </span>path_route<span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>uri<span class=p>:</span><span class=w> </span>http<span class=p>:</span>//localhost<span class=p>:</span><span class=m>8080</span>/<span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>predicates<span class=p>:</span><span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class=w> </span>Path=/service/<span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>filters<span class=p>:</span><span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>-<span class=w> </span>RewritePath=/service/<span class=p>,</span><span class=w> </span>/</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/gateway/application.yml target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/gateway/application.yml target=_blank>gateway/application.yml</a></div></div><h3 id=servicio-servidor-de-recurso>Servicio, servidor de recurso</h3><p>Dado que el servicio interpreta los <em>tokens</em> JWT y aplica reglas de seguridad necesita las mismas dependencias que utiliza el servidor OAuth.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span><span class=lnt>13&#10;</span><span class=lnt>14&#10;</span><span class=lnt>15&#10;</span><span class=lnt>16&#10;</span><span class=lnt>17&#10;</span><span class=lnt>18&#10;</span><span class=lnt>19&#10;</span><span class=lnt>20&#10;</span><span class=lnt>21&#10;</span><span class=lnt>22&#10;</span><span class=lnt>23&#10;</span><span class=lnt>24&#10;</span><span class=lnt>25&#10;</span><span class=lnt>26&#10;</span><span class=lnt>27&#10;</span><span class=lnt>28&#10;</span><span class=lnt>29&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-groovy data-lang=groovy><span class=n>plugins</span> <span class=o>{</span>&#10;	<span class=n>id</span> <span class=s1>&#39;application&#39;</span>&#10;	<span class=n>id</span> <span class=s1>&#39;org.springframework.boot&#39;</span> <span class=n>version</span> <span class=s1>&#39;2.0.8.RELEASE&#39;</span>&#10;<span class=o>}</span>&#10;&#10;<span class=n>mainClassName</span> <span class=o>=</span> <span class=s1>&#39;io.github.picodotdev.blogbitix.springoauth.service.Main&#39;</span>&#10;&#10;<span class=n>dependencies</span> <span class=o>{</span>&#10;	<span class=n>implementation</span> <span class=nf>platform</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-dependencies:2.0.8.RELEASE&#39;</span><span class=o>)</span>&#10;	<span class=n>implementation</span> <span class=nf>platform</span><span class=o>(</span><span class=s1>&#39;org.springframework.cloud:spring-cloud-dependencies:Finchley.SR2&#39;</span><span class=o>)</span>&#10;&#10;	<span class=kt>def</span> <span class=n>excludeSpringBootStarterLogging</span> <span class=o>=</span> <span class=o>{</span> <span class=n>exclude</span><span class=o>(</span><span class=nl>group:</span> <span class=s1>&#39;org.springframework.boot&#39;</span><span class=o>,</span> <span class=nl>module:</span> <span class=s1>&#39;spring-boot-starter-logging&#39;</span><span class=o>)</span> <span class=o>}</span>&#10;	<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;	<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter-web&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;	<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter-log4j2&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;	<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter-security&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;	<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.cloud:spring-cloud-starter-oauth2&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;	<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.security.oauth:spring-security-oauth2:2.3.4.RELEASE&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;	<span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.security:spring-security-jwt:1.0.10.RELEASE&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&#10;	<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;com.google.code.gson:gson:2.8.5&#39;</span><span class=o>)</span>&#10;	<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;com.fasterxml.jackson.core:jackson-databind:2.9.6&#39;</span><span class=o>)</span>&#10;	<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;com.fasterxml.jackson.dataformat:jackson-dataformat-yaml:2.9.6&#39;</span><span class=o>)</span>&#10;&#10;	<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;javax.xml.bind:jaxb-api:2.3.0&#39;</span><span class=o>)</span>&#10;	<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;com.sun.xml.bind:jaxb-impl:2.3.0&#39;</span><span class=o>)</span>&#10;	<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;org.glassfish.jaxb:jaxb-runtime:2.3.0&#39;</span><span class=o>)</span>&#10;	<span class=n>runtime</span><span class=o>(</span><span class=s1>&#39;javax.activation:activation:1.1.1&#39;</span><span class=o>)</span>&#10;<span class=o>}</span>&#10;</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/build.gradle target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/build.gradle target=_blank>service/build.gradle</a></div></div><p>El recurso es muy simple, solo devuelve un mensaje.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span><span class=lnt>13&#10;</span><span class=lnt>14&#10;</span><span class=lnt>15&#10;</span><span class=lnt>16&#10;</span><span class=lnt>17&#10;</span><span class=lnt>18&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>io.github.picodotdev.blogbitix.springoauth.service</span><span class=o>;</span>&#10;&#10;<span class=o>.</span><span class=o>.</span><span class=o>.</span>&#10;&#10;<span class=nd>@RestController</span>&#10;<span class=kd>public</span> <span class=kd>class</span> <span class=nc>DefaultController</span> <span class=o>{</span>&#10;&#10;	<span class=kd>private</span> <span class=n>Random</span> <span class=n>random</span><span class=o>;</span>&#10;&#10;	<span class=kd>public</span> <span class=nf>DefaultController</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span>&#10;		<span class=k>this</span><span class=o>.</span><span class=na>random</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>&#10;	<span class=o>}</span>&#10;&#10;	<span class=nd>@RequestMapping</span><span class=o>(</span><span class=s>&#34;/&#34;</span><span class=o>)</span>&#10;	<span class=kd>public</span> <span class=n>String</span> <span class=nf>home</span><span class=o>(</span><span class=n>HttpServletRequest</span> <span class=n>request</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>&#10;		<span class=k>return</span> <span class=n>String</span><span class=o>.</span><span class=na>format</span><span class=o>(</span><span class=s>&#34;Hello world (%s)&#34;</span><span class=o>,</span> <span class=n>request</span><span class=o>.</span><span class=na>getRequestURL</span><span class=o>(</span><span class=o>)</span><span class=o>)</span><span class=o>;</span>&#10;	<span class=o>}</span>&#10;<span class=o>}</span>&#10;</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/DefaultController.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/DefaultController.java target=_blank>service/DefaultController.java</a></div></div><p>El servicio comparte configuración similar al servidor de Ouath par el <em>JwtAccessTokenConverter</em>, <em>TokenStore</em> y <em>DefaultTokenServices</em>. En el método configure se define que el <em>endpoint</em> <em>/</em> requiere el rol <em>CLIENT</em> que se obtiene del token JWT enviado. Hay que utilizar la anotación <em>@EnableResourceServer</em>, se inicia con el comando <em>./gradlew service:run</em>.</p><p>Hay que recalcar que el servicio para verificar el <em>token</em> y comprobar la autorización no necesita comunicarse con el servidor OAuth toda la información que necesita está en el <em>token</em>.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span><span class=lnt>13&#10;</span><span class=lnt>14&#10;</span><span class=lnt>15&#10;</span><span class=lnt>16&#10;</span><span class=lnt>17&#10;</span><span class=lnt>18&#10;</span><span class=lnt>19&#10;</span><span class=lnt>20&#10;</span><span class=lnt>21&#10;</span><span class=lnt>22&#10;</span><span class=lnt>23&#10;</span><span class=lnt>24&#10;</span><span class=lnt>25&#10;</span><span class=lnt>26&#10;</span><span class=lnt>27&#10;</span><span class=lnt>28&#10;</span><span class=lnt>29&#10;</span><span class=lnt>30&#10;</span><span class=lnt>31&#10;</span><span class=lnt>32&#10;</span><span class=lnt>33&#10;</span><span class=lnt>34&#10;</span><span class=lnt>35&#10;</span><span class=lnt>36&#10;</span><span class=lnt>37&#10;</span><span class=lnt>38&#10;</span><span class=lnt>39&#10;</span><span class=lnt>40&#10;</span><span class=lnt>41&#10;</span><span class=lnt>42&#10;</span><span class=lnt>43&#10;</span><span class=lnt>44&#10;</span><span class=lnt>45&#10;</span><span class=lnt>46&#10;</span><span class=lnt>47&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>io.github.picodotdev.blogbitix.springoauth.service</span><span class=o>;</span>&#10;&#10;<span class=o>.</span><span class=o>.</span><span class=o>.</span>&#10;&#10;<span class=nd>@Configuration</span>&#10;<span class=nd>@EnableResourceServer</span>&#10;<span class=kd>public</span> <span class=kd>class</span> <span class=nc>ResourceServerConfiguration</span> <span class=kd>extends</span> <span class=n>ResourceServerConfigurerAdapter</span> <span class=o>{</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Autowired</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>private</span> <span class=n>JwtAccessTokenConverter</span> <span class=n>tokenConverter</span><span class=o>;</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Autowired</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>private</span> <span class=n>TokenStore</span> <span class=n>tokenStore</span><span class=o>;</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Autowired</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>private</span> <span class=n>DefaultTokenServices</span> <span class=n>tokenServices</span><span class=o>;</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Bean</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>public</span> <span class=n>JwtAccessTokenConverter</span> <span class=nf>tokenConverter</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>JwtAccessTokenConverter</span> <span class=n>converter</span> <span class=o>=</span> <span class=k>new</span> <span class=n>JwtAccessTokenConverter</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>converter</span><span class=o>.</span><span class=na>setSigningKey</span><span class=o>(</span><span class=s>&#34;1234567890&#34;</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=k>return</span> <span class=n>converter</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Bean</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>public</span> <span class=n>TokenStore</span> <span class=nf>tokenStore</span><span class=o>(</span><span class=n>JwtAccessTokenConverter</span> <span class=n>tokenConverter</span><span class=o>)</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=k>return</span> <span class=k>new</span> <span class=n>JwtTokenStore</span><span class=o>(</span><span class=n>tokenConverter</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Bean</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>DefaultTokenServices</span> <span class=nf>tokenServices</span><span class=o>(</span><span class=n>TokenStore</span> <span class=n>tokenStore</span><span class=o>,</span> <span class=n>JwtAccessTokenConverter</span> <span class=n>tokenConverter</span><span class=o>)</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>DefaultTokenServices</span> <span class=n>tokenServices</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DefaultTokenServices</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>tokenServices</span><span class=o>.</span><span class=na>setTokenStore</span><span class=o>(</span><span class=n>tokenStore</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>tokenServices</span><span class=o>.</span><span class=na>setTokenEnhancer</span><span class=o>(</span><span class=n>tokenConverter</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=k>return</span> <span class=n>tokenServices</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Override</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>ResourceServerSecurityConfigurer</span> <span class=n>resources</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>resources</span><span class=o>.</span><span class=na>tokenServices</span><span class=o>(</span><span class=n>tokenServices</span><span class=o>)</span><span class=o>.</span><span class=na>resourceId</span><span class=o>(</span><span class=s>&#34;service&#34;</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Override</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>public</span> <span class=kt>void</span> <span class=nf>configure</span><span class=o>(</span><span class=n>HttpSecurity</span> <span class=n>http</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>http</span><span class=o>.</span><span class=na>authorizeRequests</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>antMatchers</span><span class=o>(</span><span class=s>&#34;/&#34;</span><span class=o>)</span><span class=o>.</span><span class=na>hasAuthority</span><span class=o>(</span><span class=s>&#34;CLIENT&#34;</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;<span class=o>}</span>&#10;</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/ResourceServerConfiguration.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/ResourceServerConfiguration.java target=_blank>service/ResourceServerConfiguration.java</a></div></div><p>Si no se envía el <em>token</em> JWT se produce un error de autenticación con código de error <em>401 Unauthorized</em>, si se envía un token correcto y la autoridad requerida del recurso la petición se devuelve el mensaje u el código de estado <em>200 OK</em>, si se envía un <em>token</em> JWT con una autoridad que no corresponde con la necesaria para el recurso, en el ejemplo una autoridad <em>DUMMY</em>, se devuelve un código de estado <em>403 Forbbiden</em>.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span><span class=lnt>13&#10;</span><span class=lnt>14&#10;</span><span class=lnt>15&#10;</span><span class=lnt>16&#10;</span><span class=lnt>17&#10;</span><span class=lnt>18&#10;</span><span class=lnt>19&#10;</span><span class=lnt>20&#10;</span><span class=lnt>21&#10;</span><span class=lnt>22&#10;</span><span class=lnt>23&#10;</span><span class=lnt>24&#10;</span><span class=lnt>25&#10;</span><span class=lnt>26&#10;</span><span class=lnt>27&#10;</span><span class=lnt>28&#10;</span><span class=lnt>29&#10;</span><span class=lnt>30&#10;</span><span class=lnt>31&#10;</span><span class=lnt>32&#10;</span><span class=lnt>33&#10;</span><span class=lnt>34&#10;</span><span class=lnt>35&#10;</span><span class=lnt>36&#10;</span><span class=lnt>37&#10;</span><span class=lnt>38&#10;</span><span class=lnt>39&#10;</span><span class=lnt>40&#10;</span><span class=lnt>41&#10;</span><span class=lnt>42&#10;</span><span class=lnt>43&#10;</span><span class=lnt>44&#10;</span><span class=lnt>45&#10;</span><span class=lnt>46&#10;</span><span class=lnt>47&#10;</span><span class=lnt>48&#10;</span><span class=lnt>49&#10;</span><span class=lnt>50&#10;</span><span class=lnt>51&#10;</span><span class=lnt>52&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ curl -v http://localhost:8090/service/&#10;*   Trying ::1...&#10;* TCP_NODELAY <span class=nb>set</span>&#10;* Connected to localhost <span class=o>(</span>::1<span class=o>)</span> port <span class=m>8090</span> <span class=o>(</span><span class=c1>#0)</span>&#10;&gt; GET /service/ HTTP/1.1&#10;&gt; Host: localhost:8090&#10;&gt; User-Agent: curl/7.63.0&#10;&gt; Accept: */*&#10;&gt;&#10;&lt; HTTP/1.1 <span class=m>401</span> Unauthorized&#10;&lt; transfer-encoding: chunked&#10;&lt; Cache-Control: no-store&#10;&lt; Pragma: no-cache&#10;&lt; WWW-Authenticate: Bearer <span class=nv>realm</span><span class=o>=</span><span class=s2>&#34;service&#34;</span>, <span class=nv>error</span><span class=o>=</span><span class=s2>&#34;unauthorized&#34;</span>, <span class=nv>error_description</span><span class=o>=</span><span class=s2>&#34;Full authentication is required to access this resource&#34;</span>&#10;&lt; X-Content-Type-Options: nosniff&#10;&lt; X-XSS-Protection: 1<span class=p>;</span> <span class=nv>mode</span><span class=o>=</span>block&#10;&lt; X-Frame-Options: DENY&#10;&lt; Content-Type: application/json<span class=p>;</span><span class=nv>charset</span><span class=o>=</span>UTF-8&#10;&lt; Date: Fri, <span class=m>08</span> Feb <span class=m>2019</span> 18:58:03 GMT&#10;&lt;&#10;* Connection <span class=c1>#0 to host localhost left intact</span>&#10;<span class=o>{</span><span class=s2>&#34;error&#34;</span>:<span class=s2>&#34;unauthorized&#34;</span>,<span class=s2>&#34;error_description&#34;</span>:<span class=s2>&#34;Full authentication is required to access this resource&#34;</span><span class=o>}</span>&#10;&#10;$ curl -H <span class=s2>&#34;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ1OCwiYXV0aG9yaXRpZXMiOlsiQ0xJRU5UIl0sImp0aSI6IjEzYjM1M2Q2LTQwODUtNDdiMS1hYzkyLTRiZDJhNDg3MzFhOCIsImNsaWVudF9pZCI6ImNsaWVudCJ9.CueMcwrD7pTp3pj37_BzzcUODG7PcjCacSa14-l5_Hw&#34;</span> http://localhost:8090/service/&#10;Hello world <span class=o>(</span>http://localhost:8080/<span class=o>)</span>&#10;&#10;$ curl -X POST -u <span class=s2>&#34;client:1234567890&#34;</span> -d <span class=s2>&#34;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ1OCwiYXV0aG9yaXRpZXMiOlsiRFVNTVkiXSwianRpIjoiMTNiMzUzZDYtNDA4NS00N2IxLWFjOTItNGJkMmE0ODczMWE4IiwiY2xpZW50X2lkIjoiY2xpZW50In0.RaeQYdukn8Xr8S9ld5Vy2UnYboUjPyMkutNgyfVN-Bc&#34;</span> http://localhost:8095/oauth/check_token&#10;<span class=o>{</span><span class=s2>&#34;aud&#34;</span>:<span class=o>[</span><span class=s2>&#34;service&#34;</span><span class=o>]</span>,<span class=s2>&#34;scope&#34;</span>:<span class=o>[</span><span class=s2>&#34;read&#34;</span><span class=o>]</span>,<span class=s2>&#34;active&#34;</span>:true,<span class=s2>&#34;exp&#34;</span>:1549692458,<span class=s2>&#34;authorities&#34;</span>:<span class=o>[</span><span class=s2>&#34;DUMMY&#34;</span><span class=o>]</span>,<span class=s2>&#34;jti&#34;</span>:<span class=s2>&#34;13b353d6-4085-47b1-ac92-4bd2a48731a8&#34;</span>,<span class=s2>&#34;client_id&#34;</span>:<span class=s2>&#34;client&#34;</span><span class=o>}</span>&#10;$ curl -v -H <span class=s2>&#34;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ1OCwiYXV0aG9yaXRpZXMiOlsiRFVNTVkiXSwianRpIjoiMTNiMzUzZDYtNDA4NS00N2IxLWFjOTItNGJkMmE0ODczMWE4IiwiY2xpZW50X2lkIjoiY2xpZW50In0.RaeQYdukn8Xr8S9ld5Vy2UnYboUjPyMkutNgyfVN-Bc&#34;</span> http://localhost:8090/service/&#10;<span class=o>{</span><span class=s2>&#34;error&#34;</span>:<span class=s2>&#34;access_denied&#34;</span>,<span class=s2>&#34;error_description&#34;</span>:<span class=s2>&#34;Access is denied&#34;</span><span class=o>}</span>&#10;*   Trying ::1...&#10;* TCP_NODELAY <span class=nb>set</span>&#10;* Connected to localhost <span class=o>(</span>::1<span class=o>)</span> port <span class=m>8090</span> <span class=o>(</span><span class=c1>#0)</span>&#10;&gt; GET /service/ HTTP/1.1&#10;&gt; Host: localhost:8090&#10;&gt; User-Agent: curl/7.63.0&#10;&gt; Accept: */*&#10;&gt; Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ1OCwiYXV0aG9yaXRpZXMiOlsiRFVNTVkiXSwianRpIjoiMTNiMzUzZDYtNDA4NS00N2IxLWFjOTItNGJkMmE0ODczMWE4IiwiY2xpZW50X2lkIjoiY2x&#10;pZW50In0.RaeQYdukn8Xr8S9ld5Vy2UnYboUjPyMkutNgyfVN-Bc&#10;&gt;&#10;&lt; HTTP/1.1 <span class=m>403</span> Forbidden&#10;&lt; transfer-encoding: chunked&#10;&lt; Cache-Control: no-store&#10;&lt; Pragma: no-cache&#10;&lt; X-Content-Type-Options: nosniff&#10;&lt; X-XSS-Protection: 1<span class=p>;</span> <span class=nv>mode</span><span class=o>=</span>block&#10;&lt; X-Frame-Options: DENY&#10;&lt; Content-Type: application/json<span class=p>;</span><span class=nv>charset</span><span class=o>=</span>UTF-8&#10;&lt; Date: Fri, <span class=m>08</span> Feb <span class=m>2019</span> 19:02:14 GMT&#10;&lt;&#10;* Connection <span class=c1>#0 to host localhost left intact</span>&#10;<span class=o>{</span><span class=s2>&#34;error&#34;</span>:<span class=s2>&#34;access_denied&#34;</span>,<span class=s2>&#34;error_description&#34;</span>:<span class=s2>&#34;Access is denied&#34;</span><span class=o>}</span>&#10;</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/curl.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/curl.sh target=_blank>service/curl.sh</a></div></div><p>Los <em>tokens</em> JWT además de firmar se pueden cifrar, en el ejemplo se usa una conexión no segura con el protocolo HTTP usando una conexión segura HTTPS ya se proporcionaría confidencialidad para los <em>tokens</em> y es lo recomendado.</p><p>El <a href=https://github.com/picodotdev/blog-ejemplos/tree/master/SpringOauth>código fuente completo del ejemplo</a> puedes descargarlo del repositorio de ejemplos de Blog Bitix alojado en <a href=https://github.com/>GitHub</a> y probarlo en tu equipo ejecutando el comando <code>./gradlew oauth:run, ./gradlew gateway:run, ./gradlew service:run</code>.</p><div class=reference>Referencia:<br><ul><li><a href=https://www.baeldung.com/spring-security-oauth-jwt>Using JWT with Spring Security OAuth</a></li><li><a href=http://websystique.com/spring-security/secure-spring-rest-api-using-oauth2/>Secure Spring REST API using OAuth2</a></li><li><a href=https://www.devglan.com/spring-security/spring-boot-oauth2-jwt-example>Spring Boot Security OAuth2 Jwt Auth Example</a></li><li><a href=https://www.jorgehernandezramirez.com/2017/04/17/spring-boot-oauth-server/>Spring Boot – OAuth Server</a></li><li><a href=https://stackoverflow.com/questions/23950068/spring-oauth2-full-authentication-is-required-to-access-this-resource>Spring OAuth2 &ldquo;Full authentication is required to access this resource&rdquo;</a></li><li><a href=https://stackoverflow.com/questions/52606720/issue-with-having-multiple-websecurityconfigureradapter-in-spring-boot>Issue with having multiple WebSecurityConfigurerAdapter in spring-boot</a></li><li><a href=https://stackoverflow.com/questions/49654143/spring-security-5-there-is-no-passwordencoder-mapped-for-the-id-null>Spring Security 5: There is no PasswordEncoder mapped for the id &ldquo;null&rdquo;</a></li></ul></div></div></article><div class="row serie"><div class=col-md-12><h3>Este artículo forma parte de la serie <strong>spring-cloud</strong>:</h3><ol class=serie-articles><li><a href=https://picodotdev.github.io/blog-bitix/2015/03/datos-de-sesion-externalizados-con-spring-session/>Datos de sesión externalizados con Spring Session</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2015/10/aplicacion-java-autocontenida-con-spring-boot/>Aplicación Java autocontenida con Spring Boot</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2015/11/configuracion-de-una-aplicacion-en-diferentes-entornos-con-spring-cloud-config/>Configuración de una aplicación en diferentes entornos con Spring Cloud Config</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2015/12/informacion-y-metricas-de-la-aplicacion-con-spring-boot-actuator/>Información y métricas de la aplicación con Spring Boot Actuator</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2017/01/registro-y-descubrimiento-de-servicios-con-spring-cloud-y-consul/>Registro y descubrimiento de servicios con Spring Cloud y Consul</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/08/aplicaciones-basadas-en-microservicios/>Aplicaciones basadas en microservicios</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/09/registro-y-descubrimiento-de-servicios-con-spring-cloud-netflix/>Registro y descubrimiento de servicios con Spring Cloud Netflix</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/09/servicio-de-configuracion-para-microservicios-con-spring-cloud-config/>Servicio de configuración para microservicios con Spring Cloud Config</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/09/recargar-sin-reiniciar-la-configuracion-de-una-aplicacion-spring-boot-con-spring-cloud-config/>Recargar sin reiniciar la configuración de una aplicación Spring Boot con Spring Cloud Config</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/09/almacenar-cifrados-los-valores-de-configuracion-sensibles-en-spring-cloud-config/>Almacenar cifrados los valores de configuración sensibles en Spring Cloud Config</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/10/tolerancia-a-fallos-en-un-cliente-de-microservicio-con-spring-cloud-netflix-y-hystrix/>Tolerancia a fallos en un cliente de microservicio con Spring Cloud Netflix y Hystrix</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/10/balanceo-de-carga-y-resilencia-en-un-microservicio-con-spring-cloud-netflix-y-ribbon/>Balanceo de carga y resilencia en un microservicio con Spring Cloud Netflix y Ribbon</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/10/proxy-para-microservicios-con-spring-cloud-netflix-y-zuul/>Proxy para microservicios con Spring Cloud Netflix y Zuul</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/12/monitorizar-una-aplicacion-java-de-spring-boot-con-micrometer-prometheus-y-grafana/>Monitorizar una aplicación Java de Spring Boot con Micrometer, Prometheus y Grafana</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/12/exponer-las-metricas-de-hystrix-en-grafana-con-prometheus-de-una-aplicacion-spring-boot/>Exponer las métricas de Hystrix en Grafana con Prometheus de una aplicación Spring Boot</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/>Servidor OAuth, gateway y servicio REST utilizando tokens JWT con Spring</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/04/trazabilidad-en-microservicios-con-spring-cloud-sleuth/>Trazabilidad en microservicios con Spring Cloud Sleuth</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/implementar-tolerancia-a-fallos-con-resilience4j/>Implementar tolerancia a fallos con Resilience4j</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/iniciar-una-aplicacion-de-spring-boot-en-un-puerto-aleatorio/>Iniciar una aplicación de Spring Boot en un puerto aleatorio</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/>Utilizar credenciales de conexión a la base de datos generadas por Vault en una aplicación de Spring</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/>Microservicios con Spring Cloud, Consul, Nomad y Traefik</a></li></ol></div></div><div class=row><div class=col-md-12><div class=sharethis-inline-share-buttons></div></div></div><div class=row><div class="col-12 text-center"><ins class=adsbygoogle style=display:inline-block;width:970px;height:250px data-ad-client=ca-pub-3533636310991304 data-ad-slot=2975854584 data-type=billboard></ins></div></div><a id=comments></a><div class=row><div class=col-md-12><div id=disqus_thread></div></div></div><script type=text/javascript async>var disqus_shortname='blog-bitix';var disqus_identifier='blog-bitix-382';var disqus_url='https:\/\/picodotdev.github.io\/blog-bitix\/2019\/02\/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring\/';var disqus_script='embed.js';</script></div></div><div class=row><div class=col-12><hr></div></div><footer><div class=row><div class="col-12 col-sm-4"><p><strong>Blog Bitix</strong></p><p>Blog dedicado a la distribución GNU/Linux que uso habitualmente, Arch Linux, a mis andanzas alrededor del software libre, la programación y a otros temas relacionados con la tecnología y la informática.</p><p>Publicando de uno a tres artículos únicos a la semana desde el año 2010.</p></div><div class="col-12 col-sm-4 text-center menu"><ul class=list-unstyled><li><a href=/blog-bitix/tags/java/>Java</a></li><li><a href=/blog-bitix/tags/gnu-linux/>GNU/Linux</a></li><li><a href=/blog-bitix/tags/javascript/>JavaScript</a></li><li><a href=/blog-bitix/tags/tapestry/>Tapestry</a></li><li><a href=/blog-bitix/archive/>Archivo y hemeroteca</a></li><li><a href=/blog-bitix/pages/links/>Enlaces</a></li><li><a href=/blog-bitix/pages/advertising/>Publicidad</a></li><li><a href=/blog-bitix/pages/donate/>Donaciones</a></li><li><a href=/blog-bitix/pages/about/>Acerca de...</a></li></ul></div><div class="col-12 col-sm-4 text-center links"><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class=row><div class=col-12>Copyleft <span class=copyleft>&copy;</span> 2019 - <a href=https://creativecommons.org/licenses/by-sa/4.0/ rel=nofollow rel=license><img alt="Licencia de Creative Commons" title="Licencia de Creative Commons" style=border-width:0 src=https://licensebuttons.net/l/by-sa/4.0/80x15.png class=licencia></a><br><a href=https://twitter.com/blogstackinfo rel=nofollow><img src=https://picodotdev.github.io/blog-bitix/assets/images/blog-stack.png alt="Blog Stack" title="Blog Stack"></a>
<a href=https://www.planetacodigo.com/ rel=nofollow><img src=https://picodotdev.github.io/blog-bitix/assets/images/planeta-codigo.png alt="Planeta código" title="Planeta código"></a><br><span xmlns:dct=http://purl.org/dc/terms/ property="dct:title"><a href=https://picodotdev.github.io/blog-bitix/ rel=nofollow>Blog Bitix</a></span> by <a xmlns:cc=https://creativecommons.org/ns# href=https://picodotdev.github.io/blog-bitix/ property="cc:attributionName" rel=cc:attributionurl>pico.dev</a> is licensed under a <a rel=license href=https://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional License</a>.<br><span class=credit>Powered by <a href=https://gohugo.io/ rel=nofollow title="A fast and modern static website engine">Hugo</a> and <a href=https://pages.github.com/ title="Websites for you and your projects">GitHub Pages</a>.</span>
<span class=credit>Background patterns from <a href=https://www.toptal.com/designers/subtlepatterns/ rel=nofollow>Subtle Patterns</a>.</span></div></div></footer></div><div class=blueimp-gallery-container><div id=blueimp-gallery class="blueimp-gallery blueimp-gallery-controls" data-use-bootstrap-modal=false><div class=slides></div><h3 class=title></h3><a class=prev>‹</a>
<a class=next>›</a>
<a class=close>×</a>
<a class=play-pause></a><ol class=indicator></ol><div class="modal fade"><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close aria-hidden=true>&#215;</button><h4 class=modal-title></h4></div><div class="modal-body next"></div><div class=modal-footer><button type=button class="btn btn-default pull-left prev">
<i class="glyphicon glyphicon-chevron-left"></i>Anterior</button>
<button type=button class="btn btn-primary next">
Siguiente
<i class="glyphicon glyphicon-chevron-right"></i></button></div></div></div></div></div></div><script type=text/javascript>window.cookieconsent_options={"message":"Esta bitácora te informa de la obviedad de que utiliza «cookies», propias y de servicios como Google Analytics y Google AdSense entre otros.","dismiss":"Aceptar","learnMore":"Más información","link":null,"theme":"dark-bottom"};</script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js async></script></body></html>