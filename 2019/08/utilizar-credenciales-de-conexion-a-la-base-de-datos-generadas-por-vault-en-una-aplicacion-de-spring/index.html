<!doctype html><html lang=es><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="picodotdev"><meta name=keywords content="java,programacion,software,hardware,tapestry,software libre,gnu,linux,gnu/linux,unix,arch,arch linux,html,css,javascript"><meta name=description content="Spring Cloud Vault facilita la integración con Vault, una de sus usos es utilizarlo para obtener unas credenciales de conexión a la base de datos generadas bajo demanda y con un tiempo de vida limitado en vez de embeberlas en la configuración de la aplicación y con u tiempo de vida indefinido. &mldr;"><base href=https://picodotdev.github.io/blog-bitix/><title>Utilizar credenciales de conexión a la base de datos generadas por Vault en una aplicación de Spring</title><link rel=author type=text/plain href=humans.txt><link rel="shortcut icon" href=assets/favicon.ico><link rel=apple-touch-icon-precomposed sizes=144x144 href=assets/apple-touch-icon-144-precomposed.png><link rel=canonical href=https://picodotdev.github.io/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/><link href=index.xml rel=alternate type=application/rss+xml title="Blog Bitix"><link rel=stylesheet type=text/css href=assets/css/font.css><link rel=stylesheet type=text/css href=assets/libs/bootstrap-4.3.1/css/bootstrap.min.css><link rel=stylesheet type=text/css href=assets/libs/Gallery-2.33.0/css/blueimp-gallery.min.css><link rel=stylesheet type=text/css href=assets/css/syntax.css><link rel=stylesheet type=text/css href=assets/css/main.css><script type=text/javascript src=assets/js/require-config.js data-main=js/main defer></script><script type=text/javascript src=assets/libs/require.js data-main=js/main defer></script><script src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js defer></script><script type=text/javascript defer>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:'ca-pub-3533636310991304',enable_page_level_ads:true});</script><script type=text/javascript defer>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-12874075-4','picodotdev.github.io');ga('send','pageview');</script><script type=text/javascript src="//platform-api.sharethis.com/js/sharethis.js#property=5920c4ce1bd0670011e06acd&product=inline-share-buttons" defer></script><script type=text/javascript src=assets/js/app.js defer></script></head><body><div class=container><div class=row><div class=col-12><header><div class=row><div class="col-12 col-lg-4"></div><div class="col-12 col-lg-4"><h2 class=title><a href=https://picodotdev.github.io/blog-bitix/>Blog Bitix</a></h2><div class=links><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class="col-12 col-lg-4 text-center"><form name=query class="form-inline search" onsubmit="return false;"><div class=input-group><input type=text name=q class=form-control placeholder="Buscar en Blog Bitix">
<span class=input-group-btn><button class="btn btn-secondary" type=submit>Buscar</button></span></div></form><form name=search action=https://duckduckgo.com/ method=get class=hidden data-site=https://picodotdev.github.io/blog-bitix/><input type=hidden name=q></form></div></div><div class=row><div class=col-12><nav class="nav nav-pills nav-fill"><a href=/blog-bitix/tags/java/ class="nav-item nav-link">Java</a>
<a href=/blog-bitix/tags/gnu-linux/ class="nav-item nav-link">GNU/Linux</a>
<a href=/blog-bitix/tags/javascript/ class="nav-item nav-link">JavaScript</a>
<a href=/blog-bitix/tags/tapestry/ class="nav-item nav-link">Tapestry</a>
<a href=/blog-bitix/archive/ class="nav-item nav-link">Archivo y hemeroteca</a>
<a href=/blog-bitix/pages/links/ class="nav-item nav-link">Enlaces</a>
<a href=/blog-bitix/pages/about/ class="nav-item nav-link">Acerca de...</a></nav></div></div></header></div></div><div class=row><div class="col-12 text-center"><ins class=adsbygoogle style=display:inline-block;width:970px;height:250px data-ad-client=ca-pub-3533636310991304 data-ad-slot=2975854584 data-type=billboard></ins></div></div><div class=row><div class=col-12><div class="adblock-sidebar-container adblock-sidebar-container-right"><div class="adblock-sidebar adblock-sidebar-right"><ins class="adsbygoogle adblock-sidebar-vertical" style=display:inline-block data-ad-client=ca-pub-3533636310991304 data-ad-slot=9933840986 data-ad-format="vertical, rectangle" data-type=auto></ins></div></div><article itemprop=mainEntity itemscope itemtype=http://schema.org/BlogPosting><meta itemprop=inLanguage content="es"><meta itemprop=keywords content="java, planeta-codigo, programacion"><h1 itemprop=name>Utilizar credenciales de conexión a la base de datos generadas por Vault en una aplicación de Spring</h1><p class=information>Escrito por
<span itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>picodotdev</span></span> el <time itemprop=datePublished datetime=2019-08-23>23/08/2019</time>.<br><a href=tags/java/>java</a> <a href=tags/planeta-codigo/>planeta-codigo</a> <a href=tags/programacion/>programacion</a><br><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/ itemprop=url>Enlace permanente</a>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/#comments>Comentarios</a></p><p class=summary itemprop=about>Spring Cloud Vault facilita la integración con Vault, una de sus usos es utilizarlo para obtener unas credenciales de conexión a la base de datos generadas bajo demanda y con un tiempo de vida limitado en vez de embeberlas en la configuración de la aplicación y con u tiempo de vida indefinido.</p><div><ins class=adsbygoogle style=display:inline-block;width:728px;height:90px data-ad-client=ca-pub-3533636310991304 data-ad-slot=5966819782 data-type=leaderboard></ins></div><div class=content itemprop=articleBody><meta itemprop=wordCount content="1045"><div class=logotypes><img src=/blog-bitix/assets/images/logotipos/spring.svg class=right width=200 alt=Spring title=Spring></div><div class=logotypes><img src=/blog-bitix/assets/images/logotipos/vault.svg class=right width=200 alt=Vault title=Vault></div><p>La herramienta <a href=https://www.vaultproject.io/>Vault</a> de <a href=https://www.hashicorp.com/>HashiCorp</a> permite almacenar secretos, otra de sus funcionalidad es ser capaz de generar credenciales de forma dinámica. Habitualmente una aplicación para conectarse a una base de datos incluye en su configuración las credenciales, usuario y contraseña, para autenticarse y crear las conexiones, estas credenciales tiene un tiempo de vida indefinido y comprometidas proporcionan acceso a la base de datos.</p><p>Vault permite centralizar la seguridad, otorgar a cada aplicación los permisos para conectarse a una base de datos a través de la obtención de credenciales (usuario y contraseña), auditar su uso y limitar el tiempo de validez de las credenciales a unas horas en vez de forma indefinida.</p><p><a href=https://cloud.spring.io/spring-cloud-vault/>Spring Cloud Vault</a> permite a una aplicación <a href=https://spring.io/>Spring</a> simplificar la integración con Vault para obtener unas credenciales generadas dinámicamente.</p><p>En el archivo de contrucción de la aplicación hay que incluir las dependencias de Spring para la integración con Vault.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1&#10;</span><span class=lnt>2&#10;</span><span class=lnt>3&#10;</span><span class=lnt>4&#10;</span><span class=lnt>5&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-groovy data-lang=groovy><span class=o>.</span><span class=o>.</span><span class=o>.</span>&#10;<span class=n>implementation</span><span class=o>(</span><span class=s1>&#39;org.springframework.cloud:spring-cloud-starter-config&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;<span class=n>implementation</span><span class=o>(</span><span class=s1>&#39;org.springframework.cloud:spring-cloud-starter-vault-config&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;<span class=n>implementation</span><span class=o>(</span><span class=s1>&#39;org.springframework.cloud:spring-cloud-vault-config-databases&#39;</span><span class=o>,</span> <span class=n>excludeSpringBootStarterLogging</span><span class=o>)</span>&#10;<span class=o>.</span><span class=o>.</span><span class=o>.</span>&#10;</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/build.gradle target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/build.gradle target=_blank>build.gradle</a></div></div><p>Obtener la credenciales de conexión a la base de datos es transparente para el código de la aplicación, lo único que se necesita es el usuario y contraseña además de la URL de conexión.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span><span class=lnt>13&#10;</span><span class=lnt>14&#10;</span><span class=lnt>15&#10;</span><span class=lnt>16&#10;</span><span class=lnt>17&#10;</span><span class=lnt>18&#10;</span><span class=lnt>19&#10;</span><span class=lnt>20&#10;</span><span class=lnt>21&#10;</span><span class=lnt>22&#10;</span><span class=lnt>23&#10;</span><span class=lnt>24&#10;</span><span class=lnt>25&#10;</span><span class=lnt>26&#10;</span><span class=lnt>27&#10;</span><span class=lnt>28&#10;</span><span class=lnt>29&#10;</span><span class=lnt>30&#10;</span><span class=lnt>31&#10;</span><span class=lnt>32&#10;</span><span class=lnt>33&#10;</span><span class=lnt>34&#10;</span><span class=lnt>35&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>io.github.picodotdev.blogbitix.springcloudvault</span><span class=o>;</span>&#10;&#10;<span class=o>.</span><span class=o>.</span><span class=o>.</span>&#10;&#10;<span class=nd>@SpringBootApplication</span>&#10;<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Main</span> <span class=kd>implements</span> <span class=n>CommandLineRunner</span> <span class=o>{</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Value</span><span class=o>(</span><span class=s>&#34;${spring.datasource.username}&#34;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>private</span> <span class=n>String</span> <span class=n>username</span><span class=o>;</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Value</span><span class=o>(</span><span class=s>&#34;${spring.datasource.password}&#34;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>private</span> <span class=n>String</span> <span class=n>password</span><span class=o>;</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=nd>@Override</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>(</span><span class=n>String</span><span class=o>.</span><span class=o>.</span><span class=o>.</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;Username: %s%n&#34;</span><span class=o>,</span> <span class=n>username</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;Password: %s%n&#34;</span><span class=o>,</span> <span class=n>password</span><span class=o>)</span><span class=o>;</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=k>try</span> <span class=o>(</span><span class=n>Connection</span> <span class=n>connection</span> <span class=o>=</span> <span class=n>DriverManager</span><span class=o>.</span><span class=na>getConnection</span><span class=o>(</span><span class=s>&#34;jdbc:postgresql://127.0.0.1:5432/app&#34;</span><span class=o>,</span> <span class=n>username</span><span class=o>,</span> <span class=n>password</span><span class=o>)</span><span class=o>)</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=k>if</span> <span class=o>(</span><span class=n>connection</span> <span class=o>!</span><span class=o>=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Connected to the database!&#34;</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span> <span class=k>else</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Failed to make connection!&#34;</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>SQLException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>System</span><span class=o>.</span><span class=na>err</span><span class=o>.</span><span class=na>format</span><span class=o>(</span><span class=s>&#34;SQL State: %s\n%s&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>.</span><span class=na>getSQLState</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>(</span><span class=o>)</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[</span><span class=o>]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=n>SpringApplication</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>Main</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>args</span><span class=o>)</span><span class=o>;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>}</span>&#10;<span class=o>}</span>&#10;</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/Main.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/Main.java target=_blank>Main.java</a></div></div><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1&#10;</span><span class=lnt>2&#10;</span><span class=lnt>3&#10;</span><span class=lnt>4&#10;</span><span class=lnt>5&#10;</span><span class=lnt>6&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-plaintext data-lang=plaintext>...&#10;10:37:47.013 [main] INFO  io.github.picodotdev.blogbitix.springcloudvault.Main - Started Main in 1.368 seconds (JVM running for 1.784)&#10;Username: v-approle-app-gRlHQlNyPF8qJ3DCUz9U-1566549466&#10;Passowrd: A1a-MPPFfvMD3OQUC00H&#10;Connected to the database!&#10;...</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/System.out target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/System.out target=_blank>System.out</a></div></div><p>La parte más relevante está en la configuración necesaria de la aplicación. Hay que añadir como configuración la ubicación del servidor Vault, es necesario configurar un método de autenticación para Vault, para el caso de aplicaciones el recomendado es <em>AppRole</em>. Con <em>AppRole</em> cada aplicación necesita de un <em>role-id</em> y un <em>secret-id</em> que hay que generar previamente. Y el rol del que obtener las credenciales, <em>app</em>.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span><span class=lnt>13&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-YAML data-lang=YAML>spring.application.name<span class=p>:</span><span class=w> </span>app<span class=w>&#10;</span><span class=w></span>spring.cloud.vault<span class=p>:</span><span class=w>&#10;</span><span class=w>  </span>uri<span class=p>:</span><span class=w> </span>http<span class=p>:</span>//<span class=m>127.0</span><span class=m>.0</span><span class=m>.1</span><span class=p>:</span><span class=m>8200</span><span class=w>&#10;</span><span class=w>  </span>authentication<span class=p>:</span><span class=w> </span>APPROLE<span class=w>&#10;</span><span class=w>  </span>app-role<span class=p>:</span><span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;</span>role-id<span class=p>:</span><span class=w> </span>a248529d-882c-ef5f-f7e6-6a9d349afa57<span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;</span>secret-id<span class=p>:</span><span class=w> </span>13b6c224-dc18<span class=m>-0404</span>-7bc1-7c258c4c5a48<span class=w>&#10;</span><span class=w>  </span>database<span class=p>:</span><span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;</span>enabled<span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;</span>role<span class=p>:</span><span class=w> </span>app<span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;</span>backend<span class=p>:</span><span class=w> </span>database<span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;</span>username-property<span class=p>:</span><span class=w> </span>spring.datasource.username<span class=w>&#10;</span><span class=w>&nbsp;&nbsp;&nbsp;&nbsp;</span>password-property<span class=p>:</span><span class=w> </span>spring.datasource.password</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/bootstrap.yml target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/bootstrap.yml target=_blank>bootstrap.yml</a></div></div><p>Para probarlo hay que iniciar en este caso el servidor <a href=https://www.consul.io/>Consul</a> ya que en el ejemplo se utiliza como el lugar donde se guardan los secretos. También hay que iniciar Vault.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ consul agent -dev&#10;<span class=o>=</span><span class=o>=</span>&gt; Starting Consul agent...&#10;<span class=o>=</span><span class=o>=</span>&gt; Consul agent running!&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Version: <span class=s1>&#39;v1.5.0&#39;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Node ID: <span class=s1>&#39;2f523068-b196-e3bb-0b09-dc34e20989d2&#39;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Node name: <span class=s1>&#39;archlinux&#39;</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Datacenter: <span class=s1>&#39;dc1&#39;</span> <span class=o>(</span>Segment: <span class=s1>&#39;&lt;all&gt;&#39;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Server: <span class=nb>true</span> <span class=o>(</span>Bootstrap: <span class=nb>false</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;   Client Addr: <span class=o>[</span>127.0.0.1<span class=o>]</span> <span class=o>(</span>HTTP: 8500, HTTPS: -1, gRPC: 8502, DNS: 8600<span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;  Cluster Addr: 127.0.0.1 <span class=o>(</span>LAN: 8301, WAN: 8302<span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Encrypt: Gossip: false, TLS-Outgoing: false, TLS-Incoming: false</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/consul.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/consul.sh target=_blank>consul.sh</a></div></div><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span><span class=lnt>13&#10;</span><span class=lnt>14&#10;</span><span class=lnt>15&#10;</span><span class=lnt>16&#10;</span><span class=lnt>17&#10;</span><span class=lnt>18&#10;</span><span class=lnt>19&#10;</span><span class=lnt>20&#10;</span><span class=lnt>21&#10;</span><span class=lnt>22&#10;</span><span class=lnt>23&#10;</span><span class=lnt>24&#10;</span><span class=lnt>25&#10;</span><span class=lnt>26&#10;</span><span class=lnt>27&#10;</span><span class=lnt>28&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ vault server -dev -config vault.hcl&#10;<span class=o>=</span><span class=o>=</span>&gt; Vault server configuration:&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Api Address: http://127.0.0.1:8200&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Cgo: disabled&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Cluster Address: https://127.0.0.1:8201&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Listener 1: tcp <span class=o>(</span>addr: <span class=s2>&#34;127.0.0.1:8200&#34;</span>, cluster address: <span class=s2>&#34;127.0.0.1:8201&#34;</span>, max_request_duration: <span class=s2>&#34;1m30s&#34;</span>, max_request_size: <span class=s2>&#34;33554432&#34;</span>, tls: <span class=s2>&#34;disabled&#34;</span><span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Log Level: info&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Mlock: supported: true, enabled: <span class=nb>false</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Storage: consul <span class=o>(</span>HA available<span class=o>)</span>&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Version: Vault v1.1.1&#10;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Version Sha: a3dcd63451cf6da1d04928b601bbe9748d53842e&#10;&#10;WARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory&#10;and starts unsealed with a single unseal key. The root token is already&#10;authenticated to the CLI, so you can immediately begin using Vault.&#10;&#10;You may need to <span class=nb>set</span> the following environment variable:&#10;&#10;&nbsp;&nbsp;&nbsp;&nbsp;$ <span class=nb>export</span> <span class=nv>VAULT_ADDR</span><span class=o>=</span><span class=s1>&#39;http://127.0.0.1:8200&#39;</span>&#10;&#10;The unseal key and root token are displayed below in <span class=k>case</span> you want to&#10;seal/unseal the Vault or re-authenticate.&#10;&#10;Unseal Key: <span class=nv>jsBAedtA88Lm7uU1pCSYOBK1980Ervf9GSky4usmEdQ</span><span class=o>=</span>&#10;Root Token: s.8wwm4fRuRRVFm1cbBUMgdNtE&#10;&#10;Development mode should NOT be used in production installations!</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault.sh target=_blank>vault.sh</a></div></div><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1&#10;</span><span class=lnt>2&#10;</span><span class=lnt>3&#10;</span><span class=lnt>4&#10;</span><span class=lnt>5&#10;</span><span class=lnt>6&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-plaintext data-lang=plaintext>ui = true&#10;&#10;storage &#34;consul&#34; {&#10; address = &#34;127.0.0.1:8500&#34;&#10; path  = &#34;vault&#34;&#10;}</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault.hcl target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault.hcl target=_blank>vault.hcl</a></div></div><p>La base de datos postgres se inicia como un contenedor de <a href=https://www.docker.com/>Docker</a>.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span><span class=lnt>13&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ docker run --rm -it -p <span class=s2>&#34;5432:5432&#34;</span> -e <span class=nv>POSTGRES_USER</span><span class=o>=</span>postgres -e <span class=nv>POSTGRES_PASSWORD</span><span class=o>=</span>postgres postgres:alpine&#10;docker ps&#10;CONTAINER ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   COMMAND&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  CREATED&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  PORTS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NAMES&#10;8fedf0ef1342&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;postgres:alpine&nbsp;&nbsp;&nbsp;&nbsp; <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>22</span> seconds ago&nbsp;&nbsp;&nbsp;&nbsp;  Up <span class=m>20</span> seconds&nbsp;&nbsp;&nbsp;&nbsp;   0.0.0.0:5432-&gt;5432/tcp   serene_leavitt&#10;&#10;$ docker <span class=nb>exec</span> -it 8fedf0ef1342 bash&#10;bash-5.0# psql -U postgres&#10;psql <span class=o>(</span>11.4<span class=o>)</span>&#10;Type <span class=s2>&#34;help&#34;</span> <span class=k>for</span> help.&#10;&#10;<span class=nv>postgres</span><span class=o>=</span><span class=c1># CREATE DATABASE app;</span>&#10;CREATE DATABASE&#10;<span class=nv>postgres</span><span class=o>=</span>#</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/postgres.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/postgres.sh target=_blank>postgres.sh</a></div></div><p>Para realizar la configuración de Vault primero hay que iniciar sesión, en el modo desarrollo del ejemplo utilizando el <em>token root</em> que es generado y emitido en la salida al iniciarlo.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1&#10;</span><span class=lnt>2&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>export</span> <span class=nv>VAULT_ADDR</span><span class=o>=</span><span class=s1>&#39;http://127.0.0.1:8200&#39;</span>&#10;$ vault login s.8wwm4fRuRRVFm1cbBUMgdNtE</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault-login.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault-login.sh target=_blank>vault-login.sh</a></div></div><p>Como en el artículo <a href=https://picodotdev.github.io/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/>Generar credenciales de conexión a base de datos bajo demanda con Vault</a> hay que activar el <em>backend</em> de <em>database</em> para generar credenciales de bases de datos, en las que básicamente se especifica la cadena de conexión a la base de datos de postgres con un usuario y contraseña con permisos suficientes para crear usuarios y la sentencia SQL que los crea. Se habilita y configura el <em>backend database</em> del que obtener las credenciales.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ vault secrets <span class=nb>enable</span> database&#10;$ vault write database/config/app <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class=nv>plugin_name</span><span class=o>=</span>postgresql-database-plugin <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class=nv>allowed_roles</span><span class=o>=</span><span class=s2>&#34;app&#34;</span> <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class=nv>connection_url</span><span class=o>=</span><span class=s2>&#34;postgresql://{{username}}:{{password}}@localhost:5432/?sslmode=disable&#34;</span> <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class=nv>username</span><span class=o>=</span><span class=s2>&#34;postgres&#34;</span> <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class=nv>password</span><span class=o>=</span><span class=s2>&#34;postgres&#34;</span>&#10;$ vault write database/roles/app <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp; <span class=nv>db_name</span><span class=o>=</span>app <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp; <span class=nv>creation_statements</span><span class=o>=</span><span class=s2>&#34;CREATE ROLE \&#34;{{name}}\&#34; WITH LOGIN PASSWORD &#39;{{password}}&#39; VALID UNTIL &#39;{{expiration}}&#39;; GRANT SELECT ON ALL TABLES IN SCHEMA public TO \&#34;{{name}}\&#34;;&#34;</span> <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp; <span class=nv>default_ttl</span><span class=o>=</span><span class=s2>&#34;1h&#34;</span> <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp; <span class=nv>max_ttl</span><span class=o>=</span><span class=s2>&#34;24h&#34;</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault-database.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault-database.sh target=_blank>vault-database.sh</a></div></div><p>Para que la aplicación de Spring Boot obtenga las credenciales ha de autenticarse en Vault en este caso utilizando el método recomendado para las aplicaciones que es utilizando en mecanismo de autenticación <em>AppRole</em> que básicamente es un usuario y contraseña para las aplicaciones.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span><span class=lnt>12&#10;</span><span class=lnt>13&#10;</span><span class=lnt>14&#10;</span><span class=lnt>15&#10;</span><span class=lnt>16&#10;</span><span class=lnt>17&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ vault auth <span class=nb>enable</span> approle&#10;$ vault write auth/approle/role/app <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class=nv>secret_id_ttl</span><span class=o>=</span>10m <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class=nv>token_num_uses</span><span class=o>=</span><span class=m>10</span> <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class=nv>token_ttl</span><span class=o>=</span>20m <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class=nv>token_max_ttl</span><span class=o>=</span>30m <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class=nv>secret_id_num_uses</span><span class=o>=</span><span class=m>40</span> <span class=se>\&#10;</span><span class=se></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class=nv>policies</span><span class=o>=</span>database-app&#10;$ vault <span class=nb>read</span> auth/approle/role/app/role-id&#10;Key&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&#10;---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-----&#10;role_id&nbsp;&nbsp;&nbsp;&nbsp;a248529d-882c-ef5f-f7e6-6a9d349afa57&#10;$ vault write -f auth/approle/role/app/secret-id&#10;Key&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   Value&#10;---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   -----&#10;secret_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 13b6c224-dc18-0404-7bc1-7c258c4c5a48&#10;secret_id_accessor&nbsp;&nbsp;&nbsp;&nbsp;fd9a0915-af6e-b0a8-4e6c-dbb6ee587903</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault-approle.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault-approle.sh target=_blank>vault-approle.sh</a></div></div><p>En Vault los permisos se otorgan con las <em>policy</em>, los secretos se organiza en una estructura jerárquica de directorios y a cada una de los contextos se le otorga los permisos deseados. Spring obtiene las credenciales para la base de datos del contexto <em>database/creds/app</em> por lo que al rol utilizando para obtener las credenciales hay que asocialer un <em>policy</em> con permisos de lectura para este contexto.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ vault policy write database-app database-app.hcl</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault-policy.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault-policy.sh target=_blank>vault-policy.sh</a></div></div><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-plaintext data-lang=plaintext>path &#34;secret/application&#34; {&#10;  capabilities = [&#34;read&#34;]&#10;}&#10;&#10;path &#34;secret/app&#34; {&#10;  capabilities = [&#34;read&#34;]&#10;}&#10;&#10;path &#34;database/creds/app&#34; {&#10;  capabilities = [&#34;read&#34;]&#10;}&#10;</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/database-app.hcl target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/database-app.hcl target=_blank>database-app.hcl</a></div></div><p>Obtenido un <em>role-id</em> y un <em>secret-id</em> so observa los <em>policies</em> asociados además de otras propiedades.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1&#10;</span><span class=lnt> 2&#10;</span><span class=lnt> 3&#10;</span><span class=lnt> 4&#10;</span><span class=lnt> 5&#10;</span><span class=lnt> 6&#10;</span><span class=lnt> 7&#10;</span><span class=lnt> 8&#10;</span><span class=lnt> 9&#10;</span><span class=lnt>10&#10;</span><span class=lnt>11&#10;</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ vault write auth/approle/login <span class=nv>role_id</span><span class=o>=</span>a248529d-882c-ef5f-f7e6-6a9d349afa57 <span class=nv>secret_id</span><span class=o>=</span>13b6c224-dc18-0404-7bc1-7c258c4c5a48&#10;Key&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Value&#10;---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -----&#10;token&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   s.yAKbv8Qz5tfXpc8n7C8oND01&#10;token_accessor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  GPHO70D2NFRHFFdsiNiftmzO&#10;token_duration&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  20m&#10;token_renewable&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class=nb>true</span>&#10;token_policies&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <span class=o>[</span><span class=s2>&#34;database-app&#34;</span> <span class=s2>&#34;default&#34;</span><span class=o>]</span>&#10;identity_policies&nbsp;&nbsp;&nbsp;&nbsp;   <span class=o>[</span><span class=o>]</span>&#10;policies&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=o>[</span><span class=s2>&#34;database-app&#34;</span> <span class=s2>&#34;default&#34;</span><span class=o>]</span>&#10;token_meta_role_name&nbsp;&nbsp;&nbsp;&nbsp;app</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault-role-id.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/code/vault-role-id.sh target=_blank>vault-role-id.sh</a></div></div><p>En este caso la aplicación de Spring incluye en su configuración las credenciales del <em>AppRole</em>, también se puede proporcionar como variables de entorno y propiedades del sistema.</p><p>El <a href=https://github.com/picodotdev/blog-ejemplos/tree/master/SpringCloudVault>código fuente completo del ejemplo</a> puedes descargarlo del repositorio de ejemplos de Blog Bitix alojado en <a href=https://github.com/>GitHub</a>.</p><div class=reference>Referencia:<br><ul><li><a href=https://www.baeldung.com/spring-cloud-vault>An Intro to Spring Cloud Vault</a></li><li><a href=https://cloud.spring.io/spring-cloud-vault/reference/html/#_approle_authentication>Spring Cloud Vault AppRole authentication</a></li><li><a href=https://cloud.spring.io/spring-cloud-vault/reference/html/#vault.config.backends.database-backends>Spring Cloud Vault Database backends</a></li></ul></div></div></article><div class="row serie"><div class=col-md-12><h3>Este artículo forma parte de la serie <strong>hashicorp</strong>:</h3><ol class=serie-articles><li><a href=https://picodotdev.github.io/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/>Introducción a Nomad para gestionar aplicaciones y microservicios</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/>Estrategias de despliegue para microservicios con Nomad</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/>Servicios con persistencia en el orquestador de microservicos Nomad</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/>Crear de forma sencilla y rápida máquinas virtuales de VirtualBox con Vagrant</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/>Registro y descubrimiento de servicios en contenedores de Docker con Consul y Registrator</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/>Administrar secretos y proteger datos sensibles con Vault</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/>Generar credenciales de conexión a base de datos bajo demanda con Vault</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/>Utilizar credenciales de conexión a la base de datos generadas por Vault en una aplicación de Spring</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/>Microservicios con Spring Cloud, Consul, Nomad y Traefik</a></li></ol><h3>Este artículo forma parte de la serie <strong>spring-cloud</strong>:</h3><ol class=serie-articles><li><a href=https://picodotdev.github.io/blog-bitix/2015/03/datos-de-sesion-externalizados-con-spring-session/>Datos de sesión externalizados con Spring Session</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2015/10/aplicacion-java-autocontenida-con-spring-boot/>Aplicación Java autocontenida con Spring Boot</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2015/11/configuracion-de-una-aplicacion-en-diferentes-entornos-con-spring-cloud-config/>Configuración de una aplicación en diferentes entornos con Spring Cloud Config</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2015/12/informacion-y-metricas-de-la-aplicacion-con-spring-boot-actuator/>Información y métricas de la aplicación con Spring Boot Actuator</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2017/01/registro-y-descubrimiento-de-servicios-con-spring-cloud-y-consul/>Registro y descubrimiento de servicios con Spring Cloud y Consul</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/08/aplicaciones-basadas-en-microservicios/>Aplicaciones basadas en microservicios</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/09/registro-y-descubrimiento-de-servicios-con-spring-cloud-netflix/>Registro y descubrimiento de servicios con Spring Cloud Netflix</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/09/servicio-de-configuracion-para-microservicios-con-spring-cloud-config/>Servicio de configuración para microservicios con Spring Cloud Config</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/09/recargar-sin-reiniciar-la-configuracion-de-una-aplicacion-spring-boot-con-spring-cloud-config/>Recargar sin reiniciar la configuración de una aplicación Spring Boot con Spring Cloud Config</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/09/almacenar-cifrados-los-valores-de-configuracion-sensibles-en-spring-cloud-config/>Almacenar cifrados los valores de configuración sensibles en Spring Cloud Config</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/10/tolerancia-a-fallos-en-un-cliente-de-microservicio-con-spring-cloud-netflix-y-hystrix/>Tolerancia a fallos en un cliente de microservicio con Spring Cloud Netflix y Hystrix</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/10/balanceo-de-carga-y-resilencia-en-un-microservicio-con-spring-cloud-netflix-y-ribbon/>Balanceo de carga y resilencia en un microservicio con Spring Cloud Netflix y Ribbon</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/10/proxy-para-microservicios-con-spring-cloud-netflix-y-zuul/>Proxy para microservicios con Spring Cloud Netflix y Zuul</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/12/monitorizar-una-aplicacion-java-de-spring-boot-con-micrometer-prometheus-y-grafana/>Monitorizar una aplicación Java de Spring Boot con Micrometer, Prometheus y Grafana</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/12/exponer-las-metricas-de-hystrix-en-grafana-con-prometheus-de-una-aplicacion-spring-boot/>Exponer las métricas de Hystrix en Grafana con Prometheus de una aplicación Spring Boot</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/>Servidor OAuth, gateway y servicio REST utilizando tokens JWT con Spring</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/04/trazabilidad-en-microservicios-con-spring-cloud-sleuth/>Trazabilidad en microservicios con Spring Cloud Sleuth</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/implementar-tolerancia-a-fallos-con-resilience4j/>Implementar tolerancia a fallos con Resilience4j</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/iniciar-una-aplicacion-de-spring-boot-en-un-puerto-aleatorio/>Iniciar una aplicación de Spring Boot en un puerto aleatorio</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/>Utilizar credenciales de conexión a la base de datos generadas por Vault en una aplicación de Spring</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/>Microservicios con Spring Cloud, Consul, Nomad y Traefik</a></li></ol></div></div><div class=row><div class=col-md-12><div class=sharethis-inline-share-buttons></div></div></div><div class=row><div class="col-12 text-center"><a id=pageBottom></a><ins class=adsbygoogle style=display:inline-block;width:970px;height:250px data-ad-client=ca-pub-3533636310991304 data-ad-slot=2975854584 data-type=billboard></ins></div></div><div class=row><div class=col-md-12><a id=comments></a><div id=disqus_thread></div></div></div><script type=text/javascript async>var disqus_shortname='blog-bitix';var disqus_identifier='blog-bitix-429';var disqus_url='https:\/\/picodotdev.github.io\/blog-bitix\/2019\/08\/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring\/';var disqus_script='embed.js';</script></div></div><div class=row><div class=col-12><hr></div></div><footer><div class=row><div class="col-12 col-sm-4"><p><strong>Blog Bitix</strong></p><p>Blog dedicado a la distribución GNU/Linux que uso habitualmente, Arch Linux, a mis andanzas alrededor del software libre, la programación y a otros temas relacionados con la tecnología y la informática.</p><p>Publicando de uno a tres artículos únicos a la semana desde el año 2010.</p></div><div class="col-12 col-sm-4 text-center menu"><ul class=list-unstyled><li><a href=/blog-bitix/tags/java/>Java</a></li><li><a href=/blog-bitix/tags/gnu-linux/>GNU/Linux</a></li><li><a href=/blog-bitix/tags/javascript/>JavaScript</a></li><li><a href=/blog-bitix/tags/tapestry/>Tapestry</a></li><li><a href=/blog-bitix/archive/>Archivo y hemeroteca</a></li><li><a href=/blog-bitix/pages/links/>Enlaces</a></li><li><a href=/blog-bitix/pages/advertising/>Publicidad</a></li><li><a href=/blog-bitix/pages/donate/>Donaciones</a></li><li><a href=/blog-bitix/pages/about/>Acerca de...</a></li></ul></div><div class="col-12 col-sm-4 text-center links"><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class=row><div class=col-12>Copyleft <span class=copyleft>&copy;</span> 2019 - <a href=https://creativecommons.org/licenses/by-sa/4.0/ rel=nofollow rel=license><img alt="Licencia de Creative Commons" title="Licencia de Creative Commons" style=border-width:0 src=https://licensebuttons.net/l/by-sa/4.0/80x15.png class=licencia></a><br><a href=https://www.planetacodigo.com/ rel=nofollow><img src=https://picodotdev.github.io/blog-bitix/assets/images/planeta-codigo.png alt="Planeta código" title="Planeta código"></a><br><span xmlns:dct=http://purl.org/dc/terms/ property="dct:title"><a href=https://picodotdev.github.io/blog-bitix/ rel=nofollow>Blog Bitix</a></span> by <a xmlns:cc=https://creativecommons.org/ns# href=https://picodotdev.github.io/blog-bitix/ property="cc:attributionName" rel=cc:attributionurl>pico.dev</a> is licensed under a <a rel=license href=https://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional License</a>.<br><span class=credit>Powered by <a href=https://gohugo.io/ rel=nofollow title="A fast and modern static website engine">Hugo</a> and <a href=https://pages.github.com/ title="Websites for you and your projects">GitHub Pages</a>.</span>
<span class=credit>Background patterns from <a href=https://www.toptal.com/designers/subtlepatterns/ rel=nofollow>Subtle Patterns</a>.</span></div></div></footer></div><div class=blueimp-gallery-container><div id=blueimp-gallery class="blueimp-gallery blueimp-gallery-controls" data-use-bootstrap-modal=false><div class=slides></div><h3 class=title></h3><a class=prev>‹</a>
<a class=next>›</a>
<a class=close>×</a>
<a class=play-pause></a><ol class=indicator></ol><div class="modal fade"><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close aria-hidden=true>&#215;</button><h4 class=modal-title></h4></div><div class="modal-body next"></div><div class=modal-footer><button type=button class="btn btn-default pull-left prev">
<i class="glyphicon glyphicon-chevron-left"></i>Anterior</button>
<button type=button class="btn btn-primary next">
Siguiente
<i class="glyphicon glyphicon-chevron-right"></i></button></div></div></div></div></div></div><script type=text/javascript>window.cookieconsent_options={"message":"Esta bitácora te informa de la obviedad de que utiliza «cookies», propias y de servicios como Google Analytics y Google AdSense entre otros.","dismiss":"Aceptar","learnMore":"Más información","link":null,"theme":"dark-bottom"};</script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js async></script></body></html>