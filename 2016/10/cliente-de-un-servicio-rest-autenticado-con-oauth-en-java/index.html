<!doctype html><html lang=es><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=picodotdev><meta name=keywords content="java,programacion,software,hardware,tapestry,software libre,gnu,linux,gnu/linux,unix,arch,arch linux,html,css,javascript"><meta name=description content="Explicaba como llamar a un servicio REST autenticado con OAuth2 en el artículo autenticación con OAuth y Keycloak en un servicio REST con JAX-RS y Spring Boot. Para ello usaba la utilidad curl para hacer las peticiones HTTP get y post necesarias tanto para obtener el access token usando el flujo client_credentials como para una vez obtenido el access token llamar al servicio REST. En una aplicación usaremos un lenguaje de programación para llmar al servicio, en este ejemplo mostraré como llamarlo usando un cliente programado en lenguaje Java que hará las mismas peticiones get y post pero usando la librería HttComponents en vez de curl. &hellip;"><base href=https://picodotdev.github.io/blog-bitix/><title>Cliente de un servicio REST autenticado con OAuth en Java</title><link rel=author type=text/plain href=humans.txt><link rel="shortcut icon" href=assets/favicon.ico><link rel=apple-touch-icon-precomposed sizes=144x144 href=assets/apple-touch-icon-144-precomposed.png><link rel=canonical href=https://picodotdev.github.io/blog-bitix/2016/10/cliente-de-un-servicio-rest-autenticado-con-oauth-en-java/><link href=index.xml rel=alternate type=application/rss+xml title="Blog Bitix"><link rel=stylesheet type=text/css href="//fonts.googleapis.com/css?family=PT+Serif:400,700italic,700,400italic"><link rel=stylesheet type=text/css href=assets/libs/bootstrap-4.2.1/css/bootstrap.min.css><link rel=stylesheet type=text/css href=assets/libs/Gallery-2.33.0/css/blueimp-gallery.min.css><link rel=stylesheet type=text/css href=assets/css/syntax.css><link rel=stylesheet type=text/css href=assets/css/main.css><script src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js defer></script><script type=text/javascript defer>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:'ca-pub-3533636310991304',enable_page_level_ads:true});</script><script type=text/javascript defer>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-12874075-4','picodotdev.github.io');ga('send','pageview');</script><script type=text/javascript defer>var require={baseUrl:'assets',paths:{'jquery':'libs/jquery.slim.min','bootstrap':'libs/bootstrap-4.2.1/js/bootstrap.min','blueimp-helper':'libs/Gallery-2.33.0/js/blueimp-helper','blueimp-gallery':'libs/Gallery-2.33.0/js/blueimp-gallery','blueimp-gallery-indicator':'libs/Gallery-2.33.0/js/blueimp-gallery-indicator','blueimp-gallery-video':'libs/Gallery-2.33.0/js/blueimp-gallery-video','blueimp-gallery-vimeo':'libs/Gallery-2.33.0/js/blueimp-gallery-vimeo','blueimp-gallery-youtube':'libs/Gallery-2.33.0/js/blueimp-gallery-youtube','jquery-blueimp-gallery':'libs/Gallery-2.33.0/js/jquery.blueimp-gallery'},shim:{'jquery':{exports:'jquery'},'blueimp-gallery':{exports:'blueimp'}}};</script><script type=text/javascript src=assets/libs/require.js data-main=js/main defer></script><script type=text/javascript src="//platform-api.sharethis.com/js/sharethis.js#property=5920c4ce1bd0670011e06acd&product=inline-share-buttons" defer></script><script type=text/javascript src=assets/js/app.js defer></script></head><body><div class=container><div class=row><div class=col><header><div class=row><div class="col-12 col-lg-4"></div><div class="col-12 col-lg-4"><h2 class=title><a href=https://picodotdev.github.io/blog-bitix/>Blog Bitix</a></h2><div class=links><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class="col-12 col-lg-4 text-center"><form name=query class="form-inline search" onsubmit="return false;"><div class=input-group><input type=text name=q class=form-control placeholder="Buscar en Blog Bitix">
<span class=input-group-btn><button class="btn btn-secondary" type=submit>Buscar</button></span></div></form><form name=search action=https://duckduckgo.com/ method=get class=hidden data-site=https://picodotdev.github.io/blog-bitix/><input type=hidden name=q></form></div></div><div class=row><div class=col-12><nav class="nav nav-pills nav-fill"><a href=/blog-bitix/tags/java/ class="nav-item nav-link">Java</a>
<a href=/blog-bitix/tags/gnu-linux/ class="nav-item nav-link">GNU/Linux</a>
<a href=/blog-bitix/tags/javascript/ class="nav-item nav-link">JavaScript</a>
<a href=/blog-bitix/tags/tapestry/ class="nav-item nav-link">Tapestry</a>
<a href=/blog-bitix/archive/ class="nav-item nav-link">Archivo y hemeroteca</a>
<a href=/blog-bitix/pages/links/ class="nav-item nav-link">Enlaces</a>
<a href=/blog-bitix/pages/about/ class="nav-item nav-link">Acerca de...</a></nav></div></div></header></div></div><div class=row><div class="col-12 col-lg-8"><div class=row><div class=col-12><article itemscope itemtype=http://schema.org/BlogPosting><meta itemprop=inLanguage content=es><meta itemprop=keywords content="blog-stack, java, planeta-codigo, programacion"><h1 itemprop=name>Cliente de un servicio REST autenticado con OAuth en Java</h1><p class=information>Escrito por
<span itemscope itemtype=http://schema.org/Person><span itemprop=name>picodotdev</span></span> el <time itemprop=datePublished datetime=2016-10-01>01/10/2016</time>.<br><a href=tags/blog-stack/>blog-stack</a> <a href=tags/java/>java</a> <a href=tags/planeta-codigo/>planeta-codigo</a> <a href=tags/programacion/>programacion</a><br><a href=/blog-bitix/2016/10/cliente-de-un-servicio-rest-autenticado-con-oauth-en-java/ itemprop=url>Enlace permanente</a>
<a href=/blog-bitix/2016/10/cliente-de-un-servicio-rest-autenticado-con-oauth-en-java/#comments>Comentarios</a></p><p class=summary itemprop=about>Teniendo un servicio REST securizado con OAuth2 al invocarlo deberemos realizar el flujo necesario para obtener un <em>access token</em> y posteriormente enviarlo al servicio REST como forma de autenticación y autorización. Usando un cliente programado en el lenguaje Java y usando la librería HttpClient podemos hacer las peticiones HTTP necesarias para la invocación del servicio.</p><ins class=adsbygoogle style=display:inline-block;width:728px;height:90px data-ad-client=ca-pub-3533636310991304 data-ad-slot=5966819782 data-type=leaderboard></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script><div class=content itemprop=articleBody><meta itemprop=wordCount content=804><div class=logotypes style=float:right><img src=assets/images/logotipos/java.svg class=right width=200 alt=Java title=Java></div><p>Explicaba como llamar a un servicio REST autenticado con OAuth2 en el artículo <a href=https://picodotdev.github.io/blog-bitix/2016/09/autenticacion-con-oauth-y-keycloak-en-un-servicio-rest-con-jax-rs-y-spring-boot/>autenticación con OAuth y Keycloak en un servicio REST con JAX-RS y Spring Boot</a>. Para ello usaba la utilidad <em>curl</em> para hacer las peticiones HTTP <em>get</em> y <em>post</em> necesarias tanto para obtener el <em>access token</em> usando el flujo <em>client_credentials</em> como para una vez obtenido el <em>access token</em> llamar al servicio REST. En una aplicación usaremos un lenguaje de programación para llmar al servicio, en este ejemplo mostraré como llamarlo usando un cliente programado en lenguaje Java que hará las mismas peticiones <em>get</em> y <em>post</em> pero usando la librería <a href=https://hc.apache.org/>HttComponents</a> en vez de <em>curl</em>.</p><p>Primero añadiremos como dependencia del proyecto la librería HttComponents. Como en las diferentes llamadas el intercambio de datos se realiza mediante el <a href=http://json.org/>formato JSON</a> añadiremos otro par dependencias para procesar los datos en este formato, en este caso usando la API de <a href=https://javaee.github.io/jsonp/>JSON-P</a> y una implementación.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-Groovy data-lang=Groovy><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-Groovy data-lang=Groovy><span class=n>dependencies</span> <span class=o>{</span>
    <span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter-web&#39;</span><span class=o>)</span>
    <span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter-jersey&#39;</span><span class=o>)</span>

    <span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.keycloak:keycloak-spring-boot-adapter:2.2.0.Final&#39;</span><span class=o>)</span>
    <span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.keycloak:keycloak-tomcat8-adapter:2.2.0.Final&#39;</span><span class=o>)</span>
    <span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.keycloak:keycloak-core:2.2.0.Final&#39;</span><span class=o>)</span>

    <span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.apache.httpcomponents:httpcomponents-client:4.5.2&#39;</span><span class=o>)</span>
    <span class=n>compile</span><span class=o>(</span><span class=s1>&#39;javax.json:javax.json-api:1.0&#39;</span><span class=o>)</span>
    <span class=n>compile</span><span class=o>(</span><span class=s1>&#39;org.glassfish:javax.json:1.0.4&#39;</span><span class=o>)</span>

    <span class=n>testCompile</span><span class=o>(</span><span class=s1>&#39;org.springframework.boot:spring-boot-starter-test&#39;</span><span class=o>)</span>
<span class=o>}</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2016/10/cliente-de-un-servicio-rest-autenticado-con-oauth-en-java/code/build.gradle target=_blank>view raw</a></span>
<a href=/blog-bitix/2016/10/cliente-de-un-servicio-rest-autenticado-con-oauth-en-java/code/build.gradle target=_blank>build.gradle</a></div></div><p>Este sencillo cliente realiza varias peticiones <em>get</em> y <em>post</em>. Una para obtener la configuración de los <em>endpoints</em>, el que nos interesa es el de obtener un <em>access token</em>, otra petición para obtener el <em>access token</em> y finalmente con el <em>access token</em> invocar al servicio mediante otra petición.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-Java data-lang=Java><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-Java data-lang=Java><span class=kn>package</span> <span class=nn>io.github.picodotdev.blogbitix.springbootjaxrsoauth</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>org.apache.http.NameValuePair</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.http.client.entity.UrlEncodedFormEntity</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.http.client.methods.CloseableHttpResponse</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.http.client.methods.HttpGet</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.http.client.methods.HttpPost</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.http.conn.ssl.NoopHostnameVerifier</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.http.conn.ssl.SSLConnectionSocketFactory</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.http.conn.ssl.TrustSelfSignedStrategy</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.http.impl.client.CloseableHttpClient</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.http.impl.client.HttpClients</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.http.message.BasicNameValuePair</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.http.ssl.SSLContexts</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>javax.json.Json</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>javax.json.JsonObject</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.util.ArrayList</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>java.util.List</span><span class=o>;</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>ClientMain</span> <span class=o>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
        <span class=n>CloseableHttpClient</span> <span class=n>client</span> <span class=o>=</span> <span class=n>HttpClients</span><span class=o>.</span><span class=na>custom</span><span class=o>()</span>
                <span class=o>.</span><span class=na>setSSLSocketFactory</span><span class=o>(</span><span class=k>new</span> <span class=n>SSLConnectionSocketFactory</span><span class=o>(</span><span class=n>SSLContexts</span><span class=o>.</span><span class=na>custom</span><span class=o>().</span><span class=na>loadTrustMaterial</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=k>new</span> <span class=n>TrustSelfSignedStrategy</span><span class=o>()).</span><span class=na>build</span><span class=o>(),</span> <span class=n>NoopHostnameVerifier</span><span class=o>.</span><span class=na>INSTANCE</span><span class=o>))</span>
                <span class=o>.</span><span class=na>build</span><span class=o>();</span>

        <span class=c1>// curl -i http://localhost:9080/auth/realms/springbootjaxrs/.well-known/openid-configuration
</span><span class=c1></span>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Getting configuration...&#34;</span><span class=o>);</span>
        <span class=n>HttpGet</span> <span class=n>configurationRequest</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HttpGet</span><span class=o>(</span><span class=s>&#34;http://localhost:9080/auth/realms/springbootjaxrs/.well-known/openid-configuration&#34;</span><span class=o>);</span>
        <span class=n>CloseableHttpResponse</span> <span class=n>configurationResponse</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>configurationRequest</span><span class=o>);</span>

        <span class=n>JsonObject</span> <span class=n>configurarionObject</span> <span class=o>=</span> <span class=n>Json</span><span class=o>.</span><span class=na>createReader</span><span class=o>(</span><span class=n>configurationResponse</span><span class=o>.</span><span class=na>getEntity</span><span class=o>().</span><span class=na>getContent</span><span class=o>()).</span><span class=na>readObject</span><span class=o>();</span>
        <span class=n>String</span> <span class=n>tokenEndpoint</span> <span class=o>=</span> <span class=n>configurarionObject</span><span class=o>.</span><span class=na>getString</span><span class=o>(</span><span class=s>&#34;token_endpoint&#34;</span><span class=o>);</span>
        <span class=n>configurationResponse</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>

        <span class=c1>// curl -i http://localhost:9080/auth/realms/springbootjaxrs/protocol/openid-connect/token -d &#34;grant_type=client_credentials&amp;client_id=client&amp;client_secret=06212c72-8734-4cd7-898d-7c4afb17e0a2&#34;
</span><span class=c1></span>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Getting an access token...&#34;</span><span class=o>);</span>
        <span class=n>HttpPost</span> <span class=n>tokenRequest</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HttpPost</span><span class=o>(</span><span class=n>tokenEndpoint</span><span class=o>);</span>
        <span class=n>List</span><span class=o>&lt;</span><span class=n>NameValuePair</span><span class=o>&gt;</span> <span class=n>data</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>NameValuePair</span><span class=o>&gt;();</span>
        <span class=n>data</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>BasicNameValuePair</span><span class=o>(</span><span class=s>&#34;grant_type&#34;</span><span class=o>,</span> <span class=s>&#34;client_credentials&#34;</span><span class=o>));</span>
        <span class=n>data</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>BasicNameValuePair</span><span class=o>(</span><span class=s>&#34;client_id&#34;</span><span class=o>,</span> <span class=s>&#34;client&#34;</span><span class=o>));</span>
        <span class=n>data</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>BasicNameValuePair</span><span class=o>(</span><span class=s>&#34;client_secret&#34;</span><span class=o>,</span> <span class=s>&#34;06212c72-8734-4cd7-898d-7c4afb17e0a2&#34;</span><span class=o>));</span>
        <span class=n>tokenRequest</span><span class=o>.</span><span class=na>setEntity</span><span class=o>(</span><span class=k>new</span> <span class=n>UrlEncodedFormEntity</span><span class=o>(</span><span class=n>data</span><span class=o>));</span>
        <span class=n>CloseableHttpResponse</span> <span class=n>tokenResponse</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>tokenRequest</span><span class=o>);</span>

        <span class=n>JsonObject</span> <span class=n>tokenObject</span> <span class=o>=</span> <span class=n>Json</span><span class=o>.</span><span class=na>createReader</span><span class=o>(</span><span class=n>tokenResponse</span><span class=o>.</span><span class=na>getEntity</span><span class=o>().</span><span class=na>getContent</span><span class=o>()).</span><span class=na>readObject</span><span class=o>();</span>
        <span class=n>String</span> <span class=n>accessToken</span> <span class=o>=</span> <span class=n>tokenObject</span><span class=o>.</span><span class=na>getString</span><span class=o>(</span><span class=s>&#34;access_token&#34;</span><span class=o>);</span>
        <span class=n>Integer</span> <span class=n>expiresIn</span> <span class=o>=</span> <span class=n>tokenObject</span><span class=o>.</span><span class=na>getInt</span><span class=o>(</span><span class=s>&#34;expires_in&#34;</span><span class=o>);</span>
        <span class=n>Integer</span> <span class=n>refreshExpires</span> <span class=o>=</span> <span class=n>tokenObject</span><span class=o>.</span><span class=na>getInt</span><span class=o>(</span><span class=s>&#34;refresh_expires_in&#34;</span><span class=o>);</span>
        <span class=n>String</span> <span class=n>refreshToken</span> <span class=o>=</span> <span class=n>tokenObject</span><span class=o>.</span><span class=na>getString</span><span class=o>(</span><span class=s>&#34;refresh_token&#34;</span><span class=o>);</span>

        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;Access token: %s%n&#34;</span><span class=o>,</span> <span class=n>accessToken</span><span class=o>);</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;Expires in: %d%n&#34;</span><span class=o>,</span> <span class=n>expiresIn</span><span class=o>);</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;Refresh expires in: %d%n&#34;</span><span class=o>,</span> <span class=n>refreshExpires</span><span class=o>);</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;Refresh token: %s%n&#34;</span><span class=o>,</span> <span class=n>refreshToken</span><span class=o>);</span>

        <span class=c1>// curl -ik -H &#34;Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ3THpCZ20tcUZTdmlOUFA3V0RwYlF0N0tpaHhvM2t3dmxiTTNXODRuTVFnIn0.eyJqdGkiOiI5YTg0NzI5MS05MDkzLTRmNzMtOGIyMC0yZjIyY2NjN2FiMmQiLCJleHAiOjE0NzUzMDg5NzQsIm5iZiI6MCwiaWF0IjoxNDc1MzA4Njc0LCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjkwODAvYXV0aC9yZWFsbXMvc3ByaW5nYm9vdGpheHJzIiwiYXVkIjoiY2xpZW50Iiwic3ViIjoiYzE4ZWExOGMtMDVlYS00MjE5LTg4YjEtMDIyNjU0ZDUzMWYxIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiY2xpZW50IiwiYXV0aF90aW1lIjowLCJzZXNzaW9uX3N0YXRlIjoiNDI4NDZlYjgtN2MxZS00NzM1LWFhMTYtMDdjYjY1Zjg4NWM4IiwiYWNyIjoiMSIsImNsaWVudF9zZXNzaW9uIjoiYjlhYzcwZDQtMThlOS00Mjk1LThmMWYtNDQ0ZGVhNGUwNTJiIiwiYWxsb3dlZC1vcmlnaW5zIjpbXSwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbImFwaSJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImNsaWVudCI6eyJyb2xlcyI6WyJhcGkiXX0sImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJ2aWV3LXByb2ZpbGUiXX19LCJjbGllbnRIb3N0IjoiMTcyLjE3LjAuMSIsImNsaWVudElkIjoiY2xpZW50IiwibmFtZSI6IiIsInByZWZlcnJlZF91c2VybmFtZSI6InNlcnZpY2UtYWNjb3VudC1hcGkiLCJjbGllbnRBZGRyZXNzIjoiMTcyLjE3LjAuMSIsImVtYWlsIjoic2VydmljZS1hY2NvdW50LWFwaUBwbGFjZWhvbGRlci5vcmcifQ.flw8cW1isddPqDGZVDQOrbtx6K1r-4Fzz5M39JmRsJkEyVyrNOWC5V1i5ks0zfEIzO9OED0vMFgQF7D2aAMgdCMsulGdGoeg0yi4ErI5-FNzAYYxRidKixmYOWo_fBSUSCoxEmzSkr-NJT6zHBwvx71bLZmeLCXHkuj0FegTVY09rh76isj4xmnPhVj2AgazGvbAIajX7YxMtPMevBs-SrxjoYZ_8w40VI1wV49lOAHCPhHANFqUJKdUytfONOq61PsEnzn_N7fXHNsJlHZ5Otduh--AjsGN0S5K4WmcIJlSgCJsABwp4FjU11sDzOpoAI3_Ktqs0uT_ka8wndhKKQ&#34; https://localhost:8443/api/message?message=Hola
</span><span class=c1></span>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Calling oauth secured service...&#34;</span><span class=o>);</span>
        <span class=n>HttpGet</span> <span class=n>serviceRequest</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HttpGet</span><span class=o>(</span><span class=s>&#34;https://localhost:8443/api/message?message=Hola&#34;</span><span class=o>);</span>
        <span class=n>serviceRequest</span><span class=o>.</span><span class=na>addHeader</span><span class=o>(</span><span class=s>&#34;Authorization&#34;</span><span class=o>,</span> <span class=s>&#34;Bearer &#34;</span> <span class=o>+</span> <span class=n>accessToken</span><span class=o>);</span>
        <span class=n>CloseableHttpResponse</span> <span class=n>serviceResponse</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>serviceRequest</span><span class=o>);</span>

        <span class=n>JsonObject</span> <span class=n>serviceObject</span> <span class=o>=</span> <span class=n>Json</span><span class=o>.</span><span class=na>createReader</span><span class=o>(</span><span class=n>serviceResponse</span><span class=o>.</span><span class=na>getEntity</span><span class=o>().</span><span class=na>getContent</span><span class=o>()).</span><span class=na>readObject</span><span class=o>();</span>

        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;Result: %s%n&#34;</span><span class=o>,</span> <span class=n>serviceObject</span><span class=o>.</span><span class=na>toString</span><span class=o>());</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2016/10/cliente-de-un-servicio-rest-autenticado-con-oauth-en-java/code/ClientMain.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2016/10/cliente-de-un-servicio-rest-autenticado-con-oauth-en-java/code/ClientMain.java target=_blank>ClientMain.java</a></div></div><p>Iniciado <a href=https://www.keycloak.org/>Keycloak</a> con <a href=https://www.docker.com/>Docker</a>, configurado el <em>realm</em> y creado un cliente junto con un rol e iniciado el servicio REST podemos ejecutar el cliente que invoque al servicio. El resultado de las trazas que obtendremos en la terminal será el siguiente.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-Plaintext data-lang=Plaintext><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-Plaintext data-lang=Plaintext>Getting configuration...
...
Getting an access token...
...
Access token: eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ3THpCZ20tcUZTdmlOUFA3V0RwYlF0N0tpaHhvM2t3dmxiTTNXODRuTVFnIn0.eyJqdGkiOiI5YTg0NzI5MS05MDkzLTRmNzMtOGIyMC0yZjIyY2NjN2FiMmQiLCJleHAiOjE0NzUzMDg5NzQsIm5iZiI6MCwiaWF0IjoxNDc1MzA4Njc0LCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjkwODAvYXV0aC9yZWFsbXMvc3ByaW5nYm9vdGpheHJzIiwiYXVkIjoiY2xpZW50Iiwic3ViIjoiYzE4ZWExOGMtMDVlYS00MjE5LTg4YjEtMDIyNjU0ZDUzMWYxIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiY2xpZW50IiwiYXV0aF90aW1lIjowLCJzZXNzaW9uX3N0YXRlIjoiNDI4NDZlYjgtN2MxZS00NzM1LWFhMTYtMDdjYjY1Zjg4NWM4IiwiYWNyIjoiMSIsImNsaWVudF9zZXNzaW9uIjoiYjlhYzcwZDQtMThlOS00Mjk1LThmMWYtNDQ0ZGVhNGUwNTJiIiwiYWxsb3dlZC1vcmlnaW5zIjpbXSwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbImFwaSJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImNsaWVudCI6eyJyb2xlcyI6WyJhcGkiXX0sImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJ2aWV3LXByb2ZpbGUiXX19LCJjbGllbnRIb3N0IjoiMTcyLjE3LjAuMSIsImNsaWVudElkIjoiY2xpZW50IiwibmFtZSI6IiIsInByZWZlcnJlZF91c2VybmFtZSI6InNlcnZpY2UtYWNjb3VudC1hcGkiLCJjbGllbnRBZGRyZXNzIjoiMTcyLjE3LjAuMSIsImVtYWlsIjoic2VydmljZS1hY2NvdW50LWFwaUBwbGFjZWhvbGRlci5vcmcifQ.flw8cW1isddPqDGZVDQOrbtx6K1r-4Fzz5M39JmRsJkEyVyrNOWC5V1i5ks0zfEIzO9OED0vMFgQF7D2aAMgdCMsulGdGoeg0yi4ErI5-FNzAYYxRidKixmYOWo_fBSUSCoxEmzSkr-NJT6zHBwvx71bLZmeLCXHkuj0FegTVY09rh76isj4xmnPhVj2AgazGvbAIajX7YxMtPMevBs-SrxjoYZ_8w40VI1wV49lOAHCPhHANFqUJKdUytfONOq61PsEnzn_N7fXHNsJlHZ5Otduh--AjsGN0S5K4WmcIJlSgCJsABwp4FjU11sDzOpoAI3_Ktqs0uT_ka8wndhKKQ
Expires in: 300
Refresh expires in: 1800
Refresh token: eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ3THpCZ20tcUZTdmlOUFA3V0RwYlF0N0tpaHhvM2t3dmxiTTNXODRuTVFnIn0.eyJqdGkiOiIwNWEyZDcxZC0wMDIyLTQ5MGMtYTQ5NC00YWFlNjYzNGQ2NTciLCJleHAiOjE0NzUzMTA0NzQsIm5iZiI6MCwiaWF0IjoxNDc1MzA4Njc0LCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjkwODAvYXV0aC9yZWFsbXMvc3ByaW5nYm9vdGpheHJzIiwiYXVkIjoiY2xpZW50Iiwic3ViIjoiYzE4ZWExOGMtMDVlYS00MjE5LTg4YjEtMDIyNjU0ZDUzMWYxIiwidHlwIjoiUmVmcmVzaCIsImF6cCI6ImNsaWVudCIsImF1dGhfdGltZSI6MCwic2Vzc2lvbl9zdGF0ZSI6IjQyODQ2ZWI4LTdjMWUtNDczNS1hYTE2LTA3Y2I2NWY4ODVjOCIsImNsaWVudF9zZXNzaW9uIjoiYjlhYzcwZDQtMThlOS00Mjk1LThmMWYtNDQ0ZGVhNGUwNTJiIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbImFwaSJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImNsaWVudCI6eyJyb2xlcyI6WyJhcGkiXX0sImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJ2aWV3LXByb2ZpbGUiXX19fQ.LE9odwHMNeFVxIcW7ZT8hu37LeHObThTyQtefsE_iTk0BPGxv4B2rcZT4Ayxrg32QNRuJxFtlQQJP_JVcHoSxFmEw8k-vKi1hlMFYUzzYeDUD7a6CNYgQyoLNVwGvuUtqz8UgulPBfxwFDB_cjmDMBRTGTv_M-OXe4og97WuXSSjjas2A4NJrxDHRgM7r8QBcyCNsVYQC3tSHNsCrh1tKuUZpAKgStW0RXbsXrlbuTsSCnSLji0Z9Va8pTW99KkLv1qeaPmbJ2Q0B0nCfMakI-o5j7HpI5sJnSHpvDxV2IJ9Jay0H5RM2E30XXski7zC-ZuVod6zBzOqYI65aSz12A
Calling oauth secured service...
...
Result: {&#34;message&#34;:&#34;Hola&#34;,&#34;date&#34;:1475308675870}</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2016/10/cliente-de-un-servicio-rest-autenticado-con-oauth-en-java/code/System.out target=_blank>view raw</a></span>
<a href=/blog-bitix/2016/10/cliente-de-un-servicio-rest-autenticado-con-oauth-en-java/code/System.out target=_blank>System.out</a></div></div><p>En las trazas vemos el <em>endpoint</em> para obtener <em>access token</em>, el <em>access token</em> obtenido, <em>refresh token</em> y tiempos de expiración de los mismos, finalmente los datos devueltos por el servicio. Como se observa los <em>access token</em> son una cadena opaca bastante larga de caracteres, y es que está cifrada, firmada digitalmente y contiene información como el rol y tiempos de expiración. Enviado el <em>access token</em> al servicio REST el <a href=https://keycloak.gitbooks.io/securing-client-applications-guide/content/v/2.2/topics/oidc/java/java-adapters.html>adaptador de Keycloak para Spring Boot</a> validará la firma digital del <em>token</em>, descifrará la información, validará su tiempo de expiración y se comprobará si tiene el rol necesario para acceder al <em>endpoint</em> del servicio REST. Notar que con la información incluida en el token y el hecho de que está firmado digitalmente no es necesario que el servicio REST se comunique con el proveedor de OAuth para hacer la validación.</p><p>El cliente no tiene más salvo que usando la clase <a href=https://hc.apache.org/httpcomponents-client-ga/httpclient/apidocs/org/apache/http/client/HttpClient.html>HttpClient</a> y haciendo una petición HTTPS con un certificado autofirmado en el servidor deberemos ignorar las comprobaciones de seguridad. Para ello se usan un <a href=https://hc.apache.org/httpcomponents-client-ga/httpclient/apidocs/org/apache/http/conn/ssl/SSLConnectionSocketFactory.html>SSLConnectionSocketFactory</a> que las ignore.</p><p>Un buen libro sobre OAuth que he leído es <a href=https://amzn.to/2cUkF9d>Mastering OAuth 2.0</a> que explica detalladamente el protocolo OAuth junto con el resto de formas de obtener un <em>token</em> además del mostrado en este artículo usando las credenciales del cliente.</p><div class=media-amazon style=text-align:center><iframe style=width:120px;height:240px marginwidth=0 marginheight=0 scrolling=no frameborder=0 src="//rcm-eu.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=blobit-21&o=30&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=1784395404&linkId=726dc0d3e4914bc672e6b127da045db2&internal=1"></iframe></div><p>El <a href=https://github.com/picodotdev/blog-ejemplos/tree/master/SpringBootJaxrsOauth>código fuente completo del ejemplo</a> puedes descargarlo del repositorio de ejemplos de Blog Bitix alojado en <a href=https://github.com/>GitHub</a>.</p></div></article></div></div><div class="row related"><div class=col-md-12><h3>Artículos relacionados:</h3><ul><li><a href=/blog-bitix/2016/09/autenticacion-con-oauth-y-keycloak-en-un-servicio-rest-con-jax-rs-y-spring-boot/>Autenticación con OAuth y Keycloak en un servicio REST con JAX-RS y Spring Boot</a></li><li><a href=/blog-bitix/2016/09/ejemplo-de-api-rest-en-java-con-jax-rs-y-spring-boot/>Ejemplo de API REST en Java con JAX-RS y Spring Boot</a></li><li><a href=/blog-bitix/2016/08/por-que-guardar-las-fechas-en-utc-en-la-base-de-datos/>Por qué guardar las fechas en UTC en la base de datos</a></li><li><a href=/blog-bitix/2016/07/no-un-tag-jsp-o-un-tag-de-grails-no-es-equivalente-a-un-componente-de-tapestry/>No, un tag JSP o un tag de Grails no es equivalente a un componente de Tapestry</a></li><li><a href=/blog-bitix/2016/07/hemeroteca-9/>Hemeroteca #9</a></li></ul></div></div><div class=row><div class=col-md-12><div class=sharethis-inline-share-buttons></div></div></div><div class=row><div class=col-12><ins class=adsbygoogle style=display:inline-block;width:728px;height:90px data-ad-client=ca-pub-3533636310991304 data-ad-slot=5966819782 data-type=leaderboard></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><a id=comments></a><div class=row><div class=col-md-12><div id=disqus_thread></div></div></div><script type=text/javascript async>var disqus_shortname='blog-bitix';var disqus_identifier='https:\/\/picodotdev.github.io\/blog-bitix\/2016\/10\/cliente-de-un-servicio-rest-autenticado-con-oauth-en-java\/';var disqus_url='https:\/\/picodotdev.github.io\/blog-bitix\/2016\/10\/cliente-de-un-servicio-rest-autenticado-con-oauth-en-java\/';var disqus_script='embed.js';(function(){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}());</script></div><div class="col-12 col-lg-4"><div class=row><div class="col-md-12 text-center"><ins class=adsbygoogle style=display:inline-block;width:300px;height:600px data-ad-client=ca-pub-3533636310991304 data-ad-slot=9559414587 data-type=large-skycraper></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><div class=row><div class="col-md-12 text-center"><ins class=adsbygoogle style=display:inline-block;width:336px;height:280px data-ad-client=ca-pub-3533636310991304 data-ad-slot=2873752587 data-type=large-rectangle></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><div class="row text-center banner"><div class=col-12><a href=https://picodotdev.github.io/blog-bitix/2015/12/yo-apoyo-al-software-libre-tu-tambien/><img src=assets/images/i-support-fs_red-bg-es.png alt="Yo apoyo al software libre"></a></div></div><div class=row><div class=col-md-12><hr></div></div><div class=row><div class=col-md-12><ul class="list-unstyled recents"><li><span class="glyphicon glyphicon-hand-right"></span><a href=archive/>Más artículos recientes en el archivo</a></li></ul></div></div></div></div><div class=row><div class=col-12><hr></div></div><footer><div class=row><div class="col-12 col-sm-4"><p><strong>Blog Bitix</strong></p><p>Blog dedicado a la distribución GNU/Linux que uso habitualmente, Arch Linux, a mis andanzas alrededor del software libre, la programación y a otros temas relacionados con la tecnología y la informática.</p><p>Publicando de uno a tres artículos únicos a la semana desde el año 2010.</p></div><div class="col-12 col-sm-4 text-center menu"><ul class=list-unstyled><li><a href=/blog-bitix/tags/java/>Java</a></li><li><a href=/blog-bitix/tags/gnu-linux/>GNU/Linux</a></li><li><a href=/blog-bitix/tags/javascript/>JavaScript</a></li><li><a href=/blog-bitix/tags/tapestry/>Tapestry</a></li><li><a href=/blog-bitix/archive/>Archivo y hemeroteca</a></li><li><a href=/blog-bitix/pages/links/>Enlaces</a></li><li><a href=/blog-bitix/pages/advertising/>Publicidad</a></li><li><a href=/blog-bitix/pages/donate/>Donaciones</a></li><li><a href=/blog-bitix/pages/about/>Acerca de...</a></li></ul></div><div class="col-12 col-sm-4 text-center links"><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class=row><div class=col-12>Copyleft <span class=copyleft>&copy;</span> 2019 - <a href=https://creativecommons.org/licenses/by-sa/4.0/ rel=nofollow rel=license><img alt="Licencia de Creative Commons" title="Licencia de Creative Commons" style=border-width:0 src=https://licensebuttons.net/l/by-sa/4.0/80x15.png class=licencia></a><br><a href=https://twitter.com/blogstackinfo rel=nofollow><img src=https://picodotdev.github.io/blog-bitix/assets/images/blog-stack.png alt="Blog Stack" title="Blog Stack"></a>
<a href=https://www.planetacodigo.com/ rel=nofollow><img src=https://picodotdev.github.io/blog-bitix/assets/images/planeta-codigo.png alt="Planeta código" title="Planeta código"></a><br><span xmlns:dct=http://purl.org/dc/terms/ property=dct:title><a href=https://picodotdev.github.io/blog-bitix/ rel=nofollow>Blog Bitix</a></span> by <a xmlns:cc=https://creativecommons.org/ns# href=https://picodotdev.github.io/blog-bitix/ property=cc:attributionName rel=cc:attributionurl>pico.dev</a> is licensed under a <a rel=license href=https://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional License</a>.<br><span class=credit>Powered by <a href=https://gohugo.io/ rel=nofollow title="A fast and modern static website engine">Hugo</a> and <a href=https://pages.github.com/ title="Websites for you and your projects">GitHub Pages</a>.</span>
<span class=credit>Background patterns from <a href=https://www.toptal.com/designers/subtlepatterns/ rel=nofollow>Subtle Patterns</a>.</span></div></div></footer></div><div class=blueimp-gallery-container><div id=blueimp-gallery class="blueimp-gallery blueimp-gallery-controls" data-use-bootstrap-modal=false><div class=slides></div><h3 class=title></h3><a class=prev>‹</a>
<a class=next>›</a>
<a class=close>×</a>
<a class=play-pause></a><ol class=indicator></ol><div class="modal fade"><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close aria-hidden=true>&times;</button><h4 class=modal-title></h4></div><div class="modal-body next"></div><div class=modal-footer><button type=button class="btn btn-default pull-left prev">
<i class="glyphicon glyphicon-chevron-left"></i>Anterior</button>
<button type=button class="btn btn-primary next">
Siguiente
<i class="glyphicon glyphicon-chevron-right"></i></button></div></div></div></div></div></div><script type=text/javascript>window.cookieconsent_options={"message":"Esta bitácora te informa de la obviedad de que utiliza «cookies», propias y de servicios como Google Analytics y Google AdSense entre otros.","dismiss":"Aceptar","learnMore":"Más información","link":null,"theme":"dark-bottom"};</script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js async></script></body></html>