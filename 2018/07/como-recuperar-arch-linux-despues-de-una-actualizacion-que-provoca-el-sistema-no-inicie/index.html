<!doctype html><html lang=es><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=picodotdev><meta name=keywords content="java,programacion,software,hardware,tapestry,software libre,gnu,linux,gnu/linux,unix,arch,arch linux,html,css,javascript"><meta name=description content="Estás contento con Arch Linux y en gran medida despreocupado de las versiones de las aplicaciones ya que sabes que al ser una distribución rolling release, siempre tienes la última versión de todos los paquetes cada vez que haces una actualización completa del sistema. Un día realizas la periódica actualización o has visto una nueva versión de un paquete ya sea una nueva versión del kernel o mesa que pueden contener importante mejoras en el sistema gráfico que quieres aprovechar o una nueva versión de una aplicación con nuevas características relevantes como podría se LibreOffice o VLC. &hellip;"><base href=https://picodotdev.github.io/blog-bitix/><title>Como recuperar Arch Linux después de una actualización que provoca el sistema no inicie</title><link rel=author type=text/plain href=humans.txt><link rel="shortcut icon" href=assets/favicon.ico><link rel=apple-touch-icon-precomposed sizes=144x144 href=assets/apple-touch-icon-144-precomposed.png><link rel=canonical href=https://picodotdev.github.io/blog-bitix/2018/07/como-recuperar-arch-linux-despues-de-una-actualizacion-que-provoca-el-sistema-no-inicie/><link href=index.xml rel=alternate type=application/rss+xml title="Blog Bitix"><link rel=stylesheet type=text/css href="//fonts.googleapis.com/css?family=PT+Serif:400,700italic,700,400italic"><link rel=stylesheet type=text/css href=assets/libs/bootstrap-4.0.0/css/bootstrap.min.css><link rel=stylesheet type=text/css href=assets/libs/Gallery-2.30.0/css/blueimp-gallery.min.css><link rel=stylesheet type=text/css href=assets/css/syntax.css><link rel=stylesheet type=text/css href=assets/css/main.css><script src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js async></script><script type=text/javascript>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:'ca-pub-3533636310991304',enable_page_level_ads:true});</script><script type=text/javascript async>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-12874075-4','picodotdev.github.io');ga('send','pageview');</script><script type=text/javascript src=assets/libs/require.js></script><script type=text/javascript src=assets/js/main.js></script><script type=text/javascript src=assets/js/theme.js async></script><script type=text/javascript src="//platform-api.sharethis.com/js/sharethis.js#property=5920c4ce1bd0670011e06acd&product=inline-share-buttons" async></script><script type=text/javascript src=assets/js/app.js async></script></head><body><div class=container><div class=row><div class=col><header><div class=row><div class="col-12 col-lg-4"></div><div class="col-12 col-lg-4"><h2 class=title><a href=https://picodotdev.github.io/blog-bitix/>Blog Bitix</a></h2><div class=links><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class="col-12 col-lg-4 text-center"><form name=query class="form-inline search" onsubmit="return false;"><div class=input-group><input type=text name=q class=form-control placeholder="Buscar en Blog Bitix">
<span class=input-group-btn><button class="btn btn-secondary" type=submit>Buscar</button></span></div></form><form name=search action=https://duckduckgo.com/ method=get class=hidden data-site=https://picodotdev.github.io/blog-bitix/><input type=hidden name=q></form></div></div><div class=row><div class=col-12><nav class="nav nav-pills nav-fill"><a href=/blog-bitix/tags/java/ class="nav-item nav-link">Java</a>
<a href=/blog-bitix/tags/gnu-linux/ class="nav-item nav-link">GNU/Linux</a>
<a href=/blog-bitix/tags/javascript/ class="nav-item nav-link">JavaScript</a>
<a href=/blog-bitix/tags/tapestry/ class="nav-item nav-link">Tapestry</a>
<a href=/blog-bitix/archive/ class="nav-item nav-link">Archivo y hemeroteca</a>
<a href=/blog-bitix/pages/links/ class="nav-item nav-link">Enlaces</a>
<a href=/blog-bitix/pages/about/ class="nav-item nav-link">Acerca de...</a></nav></div></div></header></div></div><div class=row><div class="col-12 col-lg-8"><div class=row><div class=col-12><article itemscope itemtype=http://schema.org/BlogPosting><meta itemprop=inLanguage content=es><meta itemprop=keywords content="gnu-linux, planeta-codigo, software-libre"><h1 itemprop=name>Como recuperar Arch Linux después de una actualización que provoca el sistema no inicie</h1><p class=information>Escrito por <span itemscope itemtype=http://schema.org/Person><span itemprop=name>picodotdev</span></span> el <time itemprop=datePublished datetime=2018-07-27>27/07/2018</time>.<br><a href=tags/gnu-linux/>gnu-linux</a> <a href=tags/planeta-codigo/>planeta-codigo</a> <a href=tags/software-libre/>software-libre</a><br><a href=/blog-bitix/2018/07/como-recuperar-arch-linux-despues-de-una-actualizacion-que-provoca-el-sistema-no-inicie/ itemprop=url>Enlace permanente</a>
<a href=/blog-bitix/2018/07/como-recuperar-arch-linux-despues-de-una-actualizacion-que-provoca-el-sistema-no-inicie/#comments>Comentarios</a></p><p class=summary itemprop=about>Instalar un sistema GNU/Linux es sencillo y está muy bien, también es importante saber como intentar recuperarlo cuando una actualización de software provoca que el sistema no se inicie con normalidad hasta el entorno de escritorio gráfico, el motivo puede ser incluso un <em>kernel panic</em>. El objetivo de la recuperación es corregir el problema del inicio, si no es posible, recuperar los valiosos documentos, imágenes, vídeos u otros archivos antes de finalmente llegar al punto de reinstalar el sistema para devolverlo a un estado correcto aunque quizá perdiendo los datos que tuviese.</p><ins class=adsbygoogle style=display:inline-block;width:728px;height:90px data-ad-client=ca-pub-3533636310991304 data-ad-slot=5966819782 data-type=leaderboard></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script><div class=content itemprop=articleBody><meta itemprop=wordCount content=2089><div class=logotypes style=float:right><img src=assets/images/logotipos/archlinux.svg class=right width=250 alt="Arch Linux" title="Arch Linux"></div><p>Estás contento con <a href=https://www.archlinux.org/>Arch Linux</a> y en gran medida despreocupado de las versiones de las aplicaciones ya que sabes que al ser una distribución <em>rolling release</em>, siempre tienes la última versión de todos los paquetes cada vez que haces una actualización completa del sistema. Un día realizas la periódica actualización o has visto una nueva versión de un paquete ya sea una nueva versión del <a href=https://www.archlinux.org/packages/core/x86_64/linux/>kernel</a> o <a href=https://www.archlinux.org/packages/extra/x86_64/mesa/>mesa</a> que pueden contener importante mejoras en el sistema gráfico que quieres aprovechar o una nueva versión de una aplicación con nuevas características relevantes como podría se <a href=https://www.archlinux.org/packages/extra/x86_64/libreoffice-fresh/>LibreOffice</a> o <a href=https://www.archlinux.org/packages/extra/x86_64/vlc/>VLC</a>. Inicias la actualización del sistema como tantas otras veces has hecho. Termina aparentemente bien con todos los paquetes actualizados y sin ningún mensaje de error. Reinicias el equipo para que la actualización de algunos paquetes tengan efecto como el caso del <em>kernel</em>. Sin embargo, ¡sorpresa! el sistema no inicia como normalmente, no llega al inicio de sesión del entorno de escritorio ni siquiera tienes acceso a una terminal basada en consola, el error parece un <a href=https://es.wikipedia.org/wiki/Kernel_panic><em>kernel panic</em></a>. Reinicias una segunda vez, el mismo error. Parece que está todo perdido, piensas en los importantes archivos que tienes en el sistema de almacenamiento persistente, disco duro o SSD, ¡no tienes una copia completamente reciente!, el corazón te empieza a latir con fuerza.</p><p>Por suerte, habiendo estado usando Arch Linux de forma ininterrumpida durante los 8 años esto solo me ha pasado una vez y por culpa mía después de actualizar <a href=https://www.archlinux.org/packages/core/x86_64/grub/>Grub</a> al ejecutar un comando erróneo, durante todos esos años he tenido importantes actualizaciones como varias versiones de <a href=https://www.archlinux.org/groups/x86_64/gnome/>GNOME</a>, <a href=https://www.archlinux.org/packages/core/x86_64/systemd/>systemd</a> y el <em>kernel</em>. El caso era el que he descrito anteriormente, el sistema no iniciaba dado que Grub es de las primeras cosas necesarias para iniciar el sistema cualquier problema en él origina esta situación. Otros paquetes de especial importancia son el <em>kernel</em>, los controladores gráficos, <em>mesa</em>, systemd, una nueva versión del entorno de escritorio, &hellip; Por una actualización a una nueva versión de VLC el sistema no va a dejar de iniciarse al lo sumo será VLC el que no inicie y es de más sencillo de solucionar volviendo a una versión anterior correcta con <a href=https://picodotdev.github.io/blog-bitix/2015/02/como-hacer-un-downgrade-de-un-paquete-en-arch-linux/>un simple <em>downgrade</em> de paquete</a>.</p><p>Antes de una actualización conviene revisar los paquetes que se van a actualizar y fijarse en los especialmente sensibles como he comentado, también conviene estar suscrito al <a href=https://www.archlinux.org/feeds/news/><em>feed</em> de noticias de Arch</a>, a veces la actualización del sistema requiere una intervención manual y en ese <em>feed</em> siempre comentan los detalles y en qué consiste la intervención manual incluso ponen los comandos necesarios a ejecutar. Para que el daño sea el menor posible en caso de completo desastre es imprescindible hacer copias de seguridad de forma regular, una cosa es un fallo de software otra es un fallo de hardware que si se produce en la unidad de almacenamiento los datos es muy posible que queden irrecuperables. Los fallos en el hardware no son tan extraños, el hardware es reemplazable por un módico precio pero los datos no, por todo ¡haz copias de seguridad regularmente! Avisado estás.</p><p>De modo que saber cómo recuperar el sistema es algo necesario llegado el caso. En Arch Linux la forma que conozco es usando una imagen de instalación de Arch Linux y montar el sistema de archivos para hacer las modificaciones necesarias para recuperar el sistema que es probable que consistan en desactualizar paquetes por versiones anteriores. Dependiendo de los mensajes de error que proporcione el sistema en el inicio fallido las acciones a realizar para arreglarlo serán unas u otras, seguramente en los <a href=https://bbs.archlinux.org/>foros de Arch Linux</a> otros usuarios ya hayan pedido ayuda con el mismo o parecido error.</p><p>Los comandos concretos para montar el sistema de archivos depende de la configuración propia: de las particiones creadas, de si se está utilizando LVM o de si se está usando cifrado. Cuando escribí el <a href=https://picodotdev.github.io/blog-bitix/2017/01/script-de-instalacion-de-arch-linux-desatendido-automatizado-y-personalizable/><em>script</em> de instalación desatendido, automatizado y personalizable para Arch Linux</a> pensé al mismo tiempo en el caso de uso de una hipotética recuperación, escribí un <a href=https://github.com/picodotdev/alis/blob/master/alis-recovery.sh><em>script</em> para iniciar la recuperación</a>.</p><p>Una vez iniciado el sistema con la imagen ISO de instalación de Arch Linux este <em>script</em> contiene los comandos para iniciar la recuperación, los pasos de su uso son los siguientes:</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-Bash data-lang=Bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-Bash data-lang=Bash><span class=c1># loadkeys es</span>
<span class=c1># curl -sL https://bit.ly/2F3CATp</span>
<span class=c1># vim alis-recovery.conf</span>
<span class=c1># ./alis-recovery.sh</span>
<span class=c1># arch-chroot /mnt</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2018/07/como-recuperar-arch-linux-despues-de-una-actualizacion-que-provoca-el-sistema-no-inicie/code/alis-recovery-start.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2018/07/como-recuperar-arch-linux-despues-de-una-actualizacion-que-provoca-el-sistema-no-inicie/code/alis-recovery-start.sh target=_blank>alis-recovery-start.sh</a></div></div><p>En el paso <em>vim alis-recovery.conf</em> se modifica la configuración según el sistema a recuperar. Básicamente se dice en qué unidad está el sistema de archivos de Arch Linux, si utiliza LVM y está cifrado. El <em>script</em> de recuperación está adaptado al propio <em>script</em> de instalación, no cubre la infinidad de casos personalizados que cada usuario por su cuenta puede realizar o existir pero sirve en cualquier caso como guía de cómo iniciar la recuperación.</p><p>El contenido completo del propio <em>script</em> de recuperación es el siguiente, no es más que un <em>script</em> de <a href=https://es.wikipedia.org/wiki/Bash>bash</a> con los mismos comandos que serían necesarios para realizar la recuperación manualmente de forma interactiva.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-Bash data-lang=Bash><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-Bash data-lang=Bash><span class=cp>#!/usr/bin/env bash
</span><span class=cp></span><span class=nb>set</span> -e

<span class=c1># Arch Linux Install Script Recovery (alis-recovery) start a recovery for an</span>
<span class=c1># failed installation or broken system.</span>
<span class=c1># Copyright (C) 2018 picodotdev</span>

<span class=c1># This program is free software: you can redistribute it and/or modify</span>
<span class=c1># it under the terms of the GNU General Public License as published by</span>
<span class=c1># the Free Software Foundation, either version 3 of the License, or</span>
<span class=c1># (at your option) any later version.</span>
#
<span class=c1># This program is distributed in the hope that it will be useful,</span>
<span class=c1># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class=c1># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class=c1># GNU General Public License for more details.</span>
#
<span class=c1># You should have received a copy of the GNU General Public License</span>
<span class=c1># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class=c1># This script is hosted at https://github.com/picodotdev/alis. For new features,</span>
<span class=c1># improvements and bugs fill an issue in GitHub or make a pull request.</span>
<span class=c1># Pull Request are welcome!</span>
#
<span class=c1># If you test it in real hardware please send me an email to pico.dev@gmail.com with</span>
<span class=c1># the machine description and tell me if somethig goes wrong or all works fine.</span>
#
<span class=c1># Please, don&#39;t ask for support for this script in Arch Linux forums, first read</span>
<span class=c1># the Arch Linux wiki [1], the Installation Guide [2] and the General</span>
<span class=c1># Recomendations [3], later compare the commands with those of this script.</span>
#
<span class=c1># [1] https://wiki.archlinux.org</span>
<span class=c1># [2] https://wiki.archlinux.org/index.php/Installation_guide</span>
<span class=c1># [3] https://wiki.archlinux.org/index.php/General_recommendations</span>

<span class=c1># Reference:</span>
<span class=c1># * [Change root](https://wiki.archlinux.org/index.php/Change_root)</span>
<span class=c1># * [Deactivate volume group](https://wiki.archlinux.org/index.php/LVM#Deactivate_volume_group)</span>

<span class=c1># Usage:</span>
<span class=c1># # loadkeys es</span>
<span class=c1># # curl https://raw.githubusercontent.com/picodotdev/alis/master/download.sh | bash, or with URL shortener curl -sL https://bit.ly/2F3CATp | bash</span>
<span class=c1># # vim alis-recovery.conf</span>
<span class=c1># # ./alis-recovery.sh</span>

<span class=c1># global variables (no configuration, don&#39;t edit)</span>
<span class=nv>ASCIINEMA</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>BIOS_TYPE</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>PARTITION_BIOS</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>PARTITION_BOOT</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>PARTITION_ROOT</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>DEVICE_ROOT</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>LVM_VOLUME_PHISICAL</span><span class=o>=</span><span class=s2>&#34;lvm&#34;</span>
<span class=nv>LVM_VOLUME_GROUP</span><span class=o>=</span><span class=s2>&#34;vg&#34;</span>
<span class=nv>LVM_VOLUME_LOGICAL</span><span class=o>=</span><span class=s2>&#34;root&#34;</span>
<span class=nv>BOOT_DIRECTORY</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>ESP_DIRECTORY</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=c1>#PARTITION_BOOT_NUMBER=0</span>
<span class=nv>UUID_BOOT</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>UUID_ROOT</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>PARTUUID_BOOT</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>PARTUUID_ROOT</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>DEVICE_SATA</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>DEVICE_NVME</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>CPU_INTEL</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>VIRTUALBOX</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>CMDLINE_LINUX_ROOT</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>CMDLINE_LINUX</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>ADDITIONAL_USER_NAMES_ARRAY</span><span class=o>=()</span>
<span class=nv>ADDITIONAL_USER_PASSWORDS_ARRAY</span><span class=o>=()</span>

<span class=nv>RED</span><span class=o>=</span><span class=s1>&#39;\033[0;31m&#39;</span>
<span class=nv>GREEN</span><span class=o>=</span><span class=s1>&#39;\033[0;32m&#39;</span>
<span class=nv>LIGHT_BLUE</span><span class=o>=</span><span class=s1>&#39;\033[1;34m&#39;</span>
<span class=nv>NC</span><span class=o>=</span><span class=s1>&#39;\033[0m&#39;</span>

<span class=k>function</span> configuration_install<span class=o>()</span> <span class=o>{</span>
    <span class=nb>source</span> alis-recovery.conf
<span class=o>}</span>

<span class=k>function</span> sanitize_variables<span class=o>()</span> <span class=o>{</span>
    <span class=nv>DEVICE</span><span class=o>=</span><span class=k>$(</span>sanitize_variable <span class=s2>&#34;</span><span class=nv>$DEVICE</span><span class=s2>&#34;</span><span class=k>)</span>
<span class=o>}</span>

<span class=k>function</span> sanitize_variable<span class=o>()</span> <span class=o>{</span>
    <span class=nv>VARIABLE</span><span class=o>=</span><span class=nv>$1</span>
    <span class=nv>VARIABLE</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$VARIABLE</span> <span class=p>|</span> sed <span class=s2>&#34;s/![^ ]*//g&#34;</span><span class=k>)</span> <span class=c1># remove disabled</span>
    <span class=nv>VARIABLE</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$VARIABLE</span> <span class=p>|</span> sed <span class=s2>&#34;s/ {2,}/ /g&#34;</span><span class=k>)</span> <span class=c1># remove unnecessary white spaces</span>
    <span class=nv>VARIABLE</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$VARIABLE</span> <span class=p>|</span> sed <span class=s1>&#39;s/^[[:space:]]*//&#39;</span><span class=k>)</span> <span class=c1># trim leading</span>
    <span class=nv>VARIABLE</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$VARIABLE</span> <span class=p>|</span> sed <span class=s1>&#39;s/[[:space:]]*$//&#39;</span><span class=k>)</span> <span class=c1># trim trailing</span>
    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$VARIABLE</span><span class=s2>&#34;</span>
<span class=o>}</span>

<span class=k>function</span> check_variables<span class=o>()</span> <span class=o>{</span>
    check_variables_value <span class=s2>&#34;KEYS&#34;</span> <span class=s2>&#34;</span><span class=nv>$KEYS</span><span class=s2>&#34;</span>
    check_variables_value <span class=s2>&#34;DEVICE&#34;</span> <span class=s2>&#34;</span><span class=nv>$DEVICE</span><span class=s2>&#34;</span>
    check_variables_boolean <span class=s2>&#34;LVM&#34;</span> <span class=s2>&#34;</span><span class=nv>$LVM</span><span class=s2>&#34;</span>
    check_variables_equals <span class=s2>&#34;PARTITION_ROOT_ENCRYPTION_PASSWORD&#34;</span> <span class=s2>&#34;PARTITION_ROOT_ENCRYPTION_PASSWORD_RETYPE&#34;</span> <span class=s2>&#34;</span><span class=nv>$PARTITION_ROOT_ENCRYPTION_PASSWORD</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$PARTITION_ROOT_ENCRYPTION_PASSWORD_RETYPE</span><span class=s2>&#34;</span>
    check_variables_value <span class=s2>&#34;PING_HOSTNAME&#34;</span> <span class=s2>&#34;</span><span class=nv>$PING_HOSTNAME</span><span class=s2>&#34;</span>
<span class=o>}</span>

<span class=k>function</span> check_variables_value<span class=o>()</span> <span class=o>{</span>
    <span class=nv>NAME</span><span class=o>=</span><span class=nv>$1</span>
    <span class=nv>VALUE</span><span class=o>=</span><span class=nv>$2</span>
    <span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$VALUE</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$NAME</span><span class=s2> environment variable must have a value.&#34;</span>
        <span class=nb>exit</span>
    <span class=k>fi</span>
<span class=o>}</span>

<span class=k>function</span> check_variables_boolean<span class=o>()</span> <span class=o>{</span>
    <span class=nv>NAME</span><span class=o>=</span><span class=nv>$1</span>
    <span class=nv>VALUE</span><span class=o>=</span><span class=nv>$2</span>
    check_variables_list <span class=s2>&#34;</span><span class=nv>$NAME</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$VALUE</span><span class=s2>&#34;</span> <span class=s2>&#34;true false&#34;</span>
<span class=o>}</span>

<span class=k>function</span> check_variables_list<span class=o>()</span> <span class=o>{</span>
    <span class=nv>NAME</span><span class=o>=</span><span class=nv>$1</span>
    <span class=nv>VALUE</span><span class=o>=</span><span class=nv>$2</span>
    <span class=nv>VALUES</span><span class=o>=</span><span class=nv>$3</span>
    <span class=nv>REQUIRED</span><span class=o>=</span><span class=nv>$4</span>
    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$REQUIRED</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;&#34;</span> -o <span class=s2>&#34;</span><span class=nv>$REQUIRED</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        check_variables_value <span class=s2>&#34;</span><span class=nv>$NAME</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$VALUE</span><span class=s2>&#34;</span>
    <span class=k>fi</span>

    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$VALUE</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;&#34;</span> -a -z <span class=s2>&#34;</span><span class=k>$(</span><span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$VALUES</span><span class=s2>&#34;</span> <span class=p>|</span> grep -F -w <span class=s2>&#34;</span><span class=nv>$VALUE</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$NAME</span><span class=s2> environment variable value [</span><span class=nv>$VALUE</span><span class=s2>] must be in [</span><span class=nv>$VALUES</span><span class=s2>].&#34;</span>
        <span class=nb>exit</span>
    <span class=k>fi</span>
<span class=o>}</span>

<span class=k>function</span> check_variables_equals<span class=o>()</span> <span class=o>{</span>
    <span class=nv>NAME1</span><span class=o>=</span><span class=nv>$1</span>
    <span class=nv>NAME2</span><span class=o>=</span><span class=nv>$2</span>
    <span class=nv>VALUE1</span><span class=o>=</span><span class=nv>$3</span>
    <span class=nv>VALUE2</span><span class=o>=</span><span class=nv>$4</span>
    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$VALUE1</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;</span><span class=nv>$VALUE2</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$NAME1</span><span class=s2> and </span><span class=nv>$NAME2</span><span class=s2> must be equal [</span><span class=nv>$VALUE1</span><span class=s2>, </span><span class=nv>$VALUE2</span><span class=s2>].&#34;</span>
        <span class=nb>exit</span>
    <span class=k>fi</span>
<span class=o>}</span>

<span class=k>function</span> check_variables_size<span class=o>()</span> <span class=o>{</span>
    <span class=nv>NAME</span><span class=o>=</span><span class=nv>$1</span>
    <span class=nv>SIZE_EXPECT</span><span class=o>=</span><span class=nv>$2</span>
    <span class=nv>SIZE</span><span class=o>=</span><span class=nv>$3</span>
    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$SIZE_EXPECT</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;</span><span class=nv>$SIZE</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$NAME</span><span class=s2> array size [</span><span class=nv>$SIZE</span><span class=s2>] must be [</span><span class=nv>$SIZE_EXPECT</span><span class=s2>].&#34;</span>
        <span class=nb>exit</span>
    <span class=k>fi</span>
<span class=o>}</span>

<span class=k>function</span> warning<span class=o>()</span> <span class=o>{</span>
    <span class=nb>echo</span> -e <span class=s2>&#34;</span><span class=si>${</span><span class=nv>LIGHT_BLUE</span><span class=si>}</span><span class=s2>Welcome to Arch Linux Install Script Recovery</span><span class=si>${</span><span class=nv>NC</span><span class=si>}</span><span class=s2>&#34;</span>
    <span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
    <span class=nb>echo</span> <span class=s2>&#34;Once finalized recovery tasks execute following commands: exit, umount -R /mnt, reboot.&#34;</span>
    <span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
    <span class=nb>read</span> -p <span class=s2>&#34;Do you want to continue? [y/N] &#34;</span> yn
    <span class=k>case</span> <span class=nv>$yn</span> in
        <span class=o>[</span>Yy<span class=o>]</span>* <span class=o>)</span>
            <span class=p>;;</span>
        <span class=o>[</span>Nn<span class=o>]</span>* <span class=o>)</span>
            <span class=nb>exit</span>
            <span class=p>;;</span>
        * <span class=o>)</span>
            <span class=nb>exit</span>
            <span class=p>;;</span>
    <span class=k>esac</span>
<span class=o>}</span>

<span class=k>function</span> init<span class=o>()</span> <span class=o>{</span>
    init_log
    loadkeys <span class=nv>$KEYS</span>
<span class=o>}</span>

<span class=k>function</span> init_log<span class=o>()</span> <span class=o>{</span>
    <span class=nb>set</span> -o xtrace
<span class=o>}</span>

<span class=k>function</span> facts<span class=o>()</span> <span class=o>{</span>
    <span class=k>if</span> <span class=o>[</span> -d /sys/firmware/efi <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nv>BIOS_TYPE</span><span class=o>=</span><span class=s2>&#34;uefi&#34;</span>
    <span class=k>else</span>
        <span class=nv>BIOS_TYPE</span><span class=o>=</span><span class=s2>&#34;bios&#34;</span>
    <span class=k>fi</span>

    <span class=nv>DEVICE_SATA</span><span class=o>=</span><span class=s2>&#34;false&#34;</span>
    <span class=nv>DEVICE_NVME</span><span class=o>=</span><span class=s2>&#34;false&#34;</span>
    <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$DEVICE</span> <span class=p>|</span> grep <span class=s2>&#34;^/dev/sda&#34;</span><span class=k>)</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nv>DEVICE_SATA</span><span class=o>=</span><span class=s2>&#34;true&#34;</span>
    <span class=k>elif</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$DEVICE</span> <span class=p>|</span> grep <span class=s2>&#34;^/dev/nvme&#34;</span><span class=k>)</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nv>DEVICE_NVME</span><span class=o>=</span><span class=s2>&#34;true&#34;</span>
    <span class=k>fi</span>

    <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=k>$(</span>lscpu <span class=p>|</span> grep GenuineIntel<span class=k>)</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nv>CPU_INTEL</span><span class=o>=</span><span class=s2>&#34;true&#34;</span>
    <span class=k>fi</span>

    <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=k>$(</span>lspci <span class=p>|</span> grep -i virtualbox<span class=k>)</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nv>VIRTUALBOX</span><span class=o>=</span><span class=s2>&#34;true&#34;</span>
    <span class=k>fi</span>
<span class=o>}</span>

<span class=k>function</span> prepare<span class=o>()</span> <span class=o>{</span>
    prepare_partition
<span class=o>}</span>

<span class=k>function</span> prepare_partition<span class=o>()</span> <span class=o>{</span>
    <span class=k>if</span> <span class=o>[</span> -d /mnt/boot <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        umount /mnt/boot
        umount /mnt
    <span class=k>fi</span>
    <span class=k>if</span> <span class=o>[</span> -e <span class=s2>&#34;/dev/mapper/</span><span class=nv>$LVM_VOLUME_LOGICAL</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$PARTITION_ROOT_ENCRYPTION_PASSWORD</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
            cryptsetup close <span class=nv>$LVM_VOLUME_LOGICAL</span>
        <span class=k>fi</span>
    <span class=k>fi</span>
    <span class=k>if</span> <span class=o>[</span> -e <span class=s2>&#34;/dev/mapper/</span><span class=nv>$LVM_VOLUME_PHISICAL</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$PARTITION_ROOT_ENCRYPTION_PASSWORD</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
            cryptsetup close <span class=nv>$LVM_VOLUME_PHISICAL</span>
        <span class=k>fi</span>
    <span class=k>fi</span>
<span class=o>}</span>

<span class=k>function</span> configure_network<span class=o>()</span> <span class=o>{</span>
    <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$WIFI_INTERFACE</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        cp /etc/netctl/examples/wireless-wpa /etc/netctl
        chmod <span class=m>600</span> /etc/netctl

        sed -i <span class=s1>&#39;s/^Interface=.*/Interface=&#39;</span><span class=s2>&#34;</span><span class=nv>$WIFI_INTERFACE</span><span class=s2>&#34;</span><span class=s1>&#39;/&#39;</span> /etc/netctl
        sed -i <span class=s1>&#39;s/^ESSID=.*/ESSID=&#39;</span><span class=s2>&#34;</span><span class=nv>$WIFI_ESSID</span><span class=s2>&#34;</span><span class=s1>&#39;/&#39;</span> /etc/netctl
        sed -i <span class=s1>&#39;s/^Key=.*/Key=&#39;</span><span class=se>\&#39;</span><span class=s1>&#39;$WIFI_KEY&#39;</span><span class=se>\&#39;</span><span class=s1>&#39;/&#39;</span> /etc/netctl
        <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$WIFI_HIDDEN</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
            sed -i <span class=s1>&#39;s/^#Hidden=.*/Hidden=yes/&#39;</span> /etc/netctl
        <span class=k>fi</span>

        netctl start wireless-wpa
    <span class=k>fi</span>

    ping -c <span class=m>5</span> <span class=nv>$PING_HOSTNAME</span>
    <span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -ne <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nb>echo</span> <span class=s2>&#34;Network ping check failed.&#34;</span>
    <span class=k>fi</span>
<span class=o>}</span>

<span class=k>function</span> partition<span class=o>()</span> <span class=o>{</span>
    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$BIOS_TYPE</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;uefi&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$DEVICE_SATA</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
            <span class=nv>PARTITION_BOOT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>1&#34;</span>
            <span class=nv>PARTITION_ROOT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>2&#34;</span>
            <span class=c1>#PARTITION_BOOT_NUMBER=1</span>
            <span class=nv>DEVICE_ROOT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>2&#34;</span>
        <span class=k>fi</span>
        
        <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$DEVICE_NVME</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
            <span class=nv>PARTITION_BOOT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>p1&#34;</span>
            <span class=nv>PARTITION_ROOT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>p2&#34;</span>
            <span class=c1>#PARTITION_BOOT_NUMBER=1</span>
            <span class=nv>DEVICE_ROOT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>p2&#34;</span>
        <span class=k>fi</span>
    <span class=k>fi</span>

    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$BIOS_TYPE</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;bios&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$DEVICE_SATA</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
            <span class=nv>PARTITION_BIOS</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>1&#34;</span>
            <span class=nv>PARTITION_BOOT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>2&#34;</span>
            <span class=nv>PARTITION_ROOT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>3&#34;</span>
            <span class=c1>#PARTITION_BOOT_NUMBER=2</span>
            <span class=nv>DEVICE_ROOT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>3&#34;</span>
        <span class=k>fi</span>
        
        <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$DEVICE_NVME</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
            <span class=nv>PARTITION_BIOS</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>p1&#34;</span>
            <span class=nv>PARTITION_BOOT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>p2&#34;</span>
            <span class=nv>PARTITION_ROOT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>p3&#34;</span>
            <span class=c1>#PARTITION_BOOT_NUMBER=2</span>
            <span class=nv>DEVICE_ROOT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEVICE</span><span class=si>}</span><span class=s2>p3&#34;</span>
        <span class=k>fi</span>
    <span class=k>fi</span>

    <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$PARTITION_ROOT_ENCRYPTION_PASSWORD</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nb>echo</span> -n <span class=s2>&#34;</span><span class=nv>$PARTITION_ROOT_ENCRYPTION_PASSWORD</span><span class=s2>&#34;</span> <span class=p>|</span> cryptsetup --key-file<span class=o>=</span>- open <span class=nv>$PARTITION_ROOT</span> <span class=nv>$LVM_VOLUME_PHISICAL</span>
        sleep <span class=m>5</span>
    <span class=k>fi</span>

    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$LVM</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nv>DEVICE_ROOT_MAPPER</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$LVM_VOLUME_GROUP</span><span class=s2>-</span><span class=nv>$LVM_VOLUME_LOGICAL</span><span class=s2>&#34;</span>
        <span class=nv>DEVICE_ROOT</span><span class=o>=</span><span class=s2>&#34;/dev/mapper/</span><span class=nv>$DEVICE_ROOT_MAPPER</span><span class=s2>&#34;</span>
    <span class=k>fi</span>

    <span class=nv>PARTITION_OPTIONS</span><span class=o>=</span><span class=s2>&#34;&#34;</span>

    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$DEVICE_TRIM</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
        <span class=nv>PARTITION_OPTIONS</span><span class=o>=</span><span class=s2>&#34;defaults,noatime&#34;</span>
    <span class=k>fi</span>

    mount -o <span class=s2>&#34;</span><span class=nv>$PARTITION_OPTIONS</span><span class=s2>&#34;</span> <span class=nv>$DEVICE_ROOT</span> /mnt
    mount -o <span class=s2>&#34;</span><span class=nv>$PARTITION_OPTIONS</span><span class=s2>&#34;</span> <span class=nv>$PARTITION_BOOT</span> /mnt/boot
<span class=o>}</span>

<span class=k>function</span> recovery<span class=o>()</span> <span class=o>{</span>
    arch-chroot /mnt
<span class=o>}</span>

<span class=k>function</span> main<span class=o>()</span> <span class=o>{</span>
    configuration_install
    sanitize_variables
    check_variables
    warning
    init
    facts
    prepare
    partition
    <span class=c1>#recovery</span>
<span class=o>}</span>

main</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2018/07/como-recuperar-arch-linux-despues-de-una-actualizacion-que-provoca-el-sistema-no-inicie/code/alis-recovery.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2018/07/como-recuperar-arch-linux-despues-de-una-actualizacion-que-provoca-el-sistema-no-inicie/code/alis-recovery.sh target=_blank>alis-recovery.sh</a></div></div><p>El <a href=https://github.com/picodotdev/alis/tree/master/>código fuente completo del ejemplo</a> puedes descargarlo del repositorio de ejemplos de Blog Bitix alojado en <a href=https://github.com/>GitHub</a>.</p></div></article></div></div><div class="row related"><div class=col-md-12><h3>Artículos relacionados:</h3><ul><li><a href=/blog-bitix/2018/06/hemeroteca-13/>Hemeroteca #13</a></li><li><a href=/blog-bitix/2018/02/consola-de-juegos-retro-con-lakka-y-una-raspberry-pi/>Consola de juegos retro con Lakka y una Raspberry Pi</a></li><li><a href=/blog-bitix/2017/12/hemeroteca-12/>Hemeroteca #12</a></li><li><a href=/blog-bitix/2017/12/como-eliminar-metainformacion-de-las-fotos-en-gnu-linux/>Como eliminar metainformación de las fotos en GNU/Linux</a></li><li><a href=/blog-bitix/2017/06/hemeroteca-11/>Hemeroteca #11</a></li></ul></div></div><div class=row><div class=col-md-12><div class=sharethis-inline-share-buttons></div></div></div><div class=row><div class=col-12><ins class=adsbygoogle style=display:inline-block;width:728px;height:90px data-ad-client=ca-pub-3533636310991304 data-ad-slot=5966819782 data-type=leaderboard></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><a id=comments></a><div class=row><div class=col-md-12><div id=disqus_thread></div></div></div><script type=text/javascript async>var disqus_shortname='blog-bitix';var disqus_identifier='https:\/\/picodotdev.github.io\/blog-bitix\/2018\/07\/como-recuperar-arch-linux-despues-de-una-actualizacion-que-provoca-el-sistema-no-inicie\/';var disqus_url='https:\/\/picodotdev.github.io\/blog-bitix\/2018\/07\/como-recuperar-arch-linux-despues-de-una-actualizacion-que-provoca-el-sistema-no-inicie\/';var disqus_script='embed.js';(function(){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}());</script></div><div class="col-12 col-lg-4"><div class=row><div class="col-md-12 text-center"><ins class=adsbygoogle style=display:inline-block;width:300px;height:600px data-ad-client=ca-pub-3533636310991304 data-ad-slot=9559414587 data-type=large-skycraper></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><div class=row><div class="col-md-12 text-center"><ins class=adsbygoogle style=display:inline-block;width:336px;height:280px data-ad-client=ca-pub-3533636310991304 data-ad-slot=2873752587 data-type=large-rectangle></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></div><div class="row text-center banner"><div class=col-12><a href=https://picodotdev.github.io/blog-bitix/2015/12/yo-apoyo-al-software-libre-tu-tambien/><img src=//static.fsf.org/nosvn/images/badges/badges_es/i-support-fs_red-bg-es.png alt="Yo apoyo al software libre"></a></div></div><div class=row><div class=col-md-12><hr></div></div><div class=row><div class=col-md-12><ul class="list-unstyled recents"><li><span class="glyphicon glyphicon-hand-right"></span><a href=archive/>Más artículos recientes en el archivo</a></li></ul></div></div></div></div><div class=row><div class=col-12><hr></div></div><footer><div class=row><div class="col-12 col-sm-4"><p><strong>Blog Bitix</strong></p><p>Blog dedicado a la distribución GNU/Linux que uso habitualmente, Arch Linux, a mis andanzas alrededor del software libre, la programación y a otros temas relacionados con la tecnología y la informática.</p><p>Publicando de uno a tres artículos únicos a la semana desde el año 2010.</p></div><div class="col-12 col-sm-4 text-center menu"><ul class=list-unstyled><li><a href=/blog-bitix/tags/java/>Java</a></li><li><a href=/blog-bitix/tags/gnu-linux/>GNU/Linux</a></li><li><a href=/blog-bitix/tags/javascript/>JavaScript</a></li><li><a href=/blog-bitix/tags/tapestry/>Tapestry</a></li><li><a href=/blog-bitix/archive/>Archivo y hemeroteca</a></li><li><a href=/blog-bitix/pages/links/>Enlaces</a></li><li><a href=/blog-bitix/pages/advertising/>Publicidad</a></li><li><a href=/blog-bitix/pages/donate/>Donaciones</a></li><li><a href=/blog-bitix/pages/about/>Acerca de...</a></li></ul></div><div class="col-12 col-sm-4 text-center links"><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class=row><div class=col-12>Copyleft <span class=copyleft>&copy;</span> 2019 - <a href=https://creativecommons.org/licenses/by-sa/4.0/ rel=nofollow rel=license><img alt="Licencia de Creative Commons" title="Licencia de Creative Commons" style=border-width:0 src=https://licensebuttons.net/l/by-sa/4.0/80x15.png class=licencia></a><br><a href=https://twitter.com/blogstackinfo rel=nofollow><img src=https://picodotdev.github.io/blog-bitix/assets/images/blog-stack.png alt="Blog Stack" title="Blog Stack"></a>
<a href=https://www.planetacodigo.com/ rel=nofollow><img src=https://picodotdev.github.io/blog-bitix/assets/images/planeta-codigo.png alt="Planeta código" title="Planeta código"></a><br><span xmlns:dct=http://purl.org/dc/terms/ property=dct:title><a href=https://picodotdev.github.io/blog-bitix/ rel=nofollow>Blog Bitix</a></span> by <a xmlns:cc=https://creativecommons.org/ns# href=https://picodotdev.github.io/blog-bitix/ property=cc:attributionName rel=cc:attributionurl>pico.dev</a> is licensed under a <a rel=license href=https://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional License</a>.<br><span class=credit>Powered by <a href=https://gohugo.io/ rel=nofollow title="A fast and modern static website engine">Hugo</a> and <a href=https://pages.github.com/ title="Websites for you and your projects">GitHub Pages</a>.</span>
<span class=credit>Background patterns from <a href=https://www.toptal.com/designers/subtlepatterns/ rel=nofollow>Subtle Patterns</a>.</span></div></div></footer></div><div class=blueimp-gallery-container><div id=blueimp-gallery class="blueimp-gallery blueimp-gallery-controls" data-use-bootstrap-modal=false><div class=slides></div><h3 class=title></h3><a class=prev>‹</a>
<a class=next>›</a>
<a class=close>×</a>
<a class=play-pause></a><ol class=indicator></ol><div class="modal fade"><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close aria-hidden=true>&times;</button><h4 class=modal-title></h4></div><div class="modal-body next"></div><div class=modal-footer><button type=button class="btn btn-default pull-left prev">
<i class="glyphicon glyphicon-chevron-left"></i>Anterior</button>
<button type=button class="btn btn-primary next">
Siguiente
<i class="glyphicon glyphicon-chevron-right"></i></button></div></div></div></div></div></div><script type=text/javascript>window.cookieconsent_options={"message":"Esta bitácora te informa de la obviedad de que utiliza «cookies», propias y de servicios como Google Analytics y Google AdSense entre otros.","dismiss":"Aceptar","learnMore":"Más información","link":null,"theme":"dark-bottom"};</script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js async></script></body></html>