<?xml version="1.0" encoding="utf-8"?><feed version="2.0" xmlns="http://www.w3.org/2005/Atom"><id>https://picodotdev.github.io/blog-bitix/tags/software/</id><title type="text">Blog Bitix</title><subtitle>Recent content on Blog Bitix</subtitle><updated>2019-12-11T17:00:00+01:00</updated><author><name>picodotdev</name></author><generator>Hugo</generator><icon>https://picodotdev.github.io/blog-bitix/assets/images/logotipos/hugo.png</icon><logo>https://picodotdev.github.io/blog-bitix/assets/images/logotipos/hugo.png</logo><rights>https://creativecommons.org/licenses/by-sa/4.0/</rights><entry><id>https://picodotdev.github.io/blog-bitix/2019/12/buscar-en-el-historial-desde-la-barra-de-direcciones-inteligente-de-firefox/</id><title>Buscar en el historial desde la barra de direcciones inteligente de Firefox</title><updated>2019-12-11T17:00:00+01:00</updated><published>2019-12-11T17:00:00+01:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/12/buscar-en-el-historial-desde-la-barra-de-direcciones-inteligente-de-firefox/"/><author><name>picodotdev</name></author><content type="html">
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/firefox.svg" class="right " width="200" alt="Firefox" title="Firefox"/>
&lt;/div>
&lt;p>Los navegadores web guardan un historial de todas las páginas a las que se acceden, además de los marcadores que los usuarios creen. Este historial en Firefox se guarda en orden cronológico pudiendo consultar todas las páginas accedidas en el día actual, el de ayer y anteriores fechas. También es posible realizar búsquedas para encontrar una cierta página. En Firefox al historial se accede desde en menú con la opción &lt;em>Historial &amp;gt; Mostrar todo el historial&lt;/em>. El historial se muestra en una ventana.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/buscar-en-el-historial-desde-la-barra-de-direcciones-inteligente-de-firefox/images/historial-firefox_hu8e4acabccff9b392d67dbcd9fd35362b_46073_2560x1440_fit_box_2.png" title="Historial de páginas en Firefox" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/buscar-en-el-historial-desde-la-barra-de-direcciones-inteligente-de-firefox/images/historial-firefox_hu8e4acabccff9b392d67dbcd9fd35362b_46073_650x450_fit_box_2.png" width="650"/>&lt;/a>
&lt;figcaption>Historial de páginas en Firefox&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>Acceder al historial requiere abrir una ventana y luego hacer una búsqueda pero sin necesidad de abrir la ventana del historial desde la barra de direcciones inteligente también pueden hacerse búsquedas, no solo para las páginas del historial sino también entre los marcadores, pestañas abiertas, por títulos de página o por coincidencias en la dirección web. Con ciertos caracteres especiales se determina el comportamiento de la búsqueda.&lt;/p>
&lt;ul>
&lt;li>&lt;code>^&lt;/code>: para buscar coincidencias en el historial de búsqueda.&lt;/li>
&lt;li>&lt;code>*&lt;/code>: para buscar coincidencias en los marcadores.&lt;/li>
&lt;li>&lt;code>+&lt;/code>: para buscar coincidencias en las etiquetas de las páginas.&lt;/li>
&lt;li>&lt;code>%&lt;/code>: para buscar entre las pestañas abiertas actualmente.&lt;/li>
&lt;li>&lt;code>#&lt;/code>: Para buscar coincidencias en usando los títulos de página.&lt;/li>
&lt;li>&lt;code>$&lt;/code>: para buscar coincidencias en la dirección web.&lt;/li>
&lt;/ul>
&lt;p>En esta captura de hace una búsqueda por el título de las páginas en el historial.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/buscar-en-el-historial-desde-la-barra-de-direcciones-inteligente-de-firefox/images/barra-de-busqueda-firefox_hufb7f7aca827def1e2599d9007bb1937d_57409_2560x1440_fit_box_2.png" title="Barra de búsqueda inteligente de Firefox" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/buscar-en-el-historial-desde-la-barra-de-direcciones-inteligente-de-firefox/images/barra-de-busqueda-firefox_hufb7f7aca827def1e2599d9007bb1937d_57409_650x450_fit_box_2.png" width="650"/>&lt;/a>
&lt;figcaption>Barra de búsqueda inteligente de Firefox&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;div class="reference">
Referencia:&lt;br>
&lt;ul>
&lt;li>&lt;a href="https://support.mozilla.org/en-US/kb/address-bar-autocomplete-firefox?redirectlocale=en-US&amp;amp;redirectslug=awesome-bar-search-firefox-bookmarks-history-tabs">Address bar autocomplete in Firefox - Search your bookmarks, history and tabs&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div></content><category term="planeta-codigo"/><category term="software"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/</id><title>Nube privada para documentos personales con Nextcloud y OnlyOffice</title><updated>2019-12-05T12:00:00+01:00</updated><published>2019-12-05T12:00:00+01:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/"/><author><name>picodotdev</name></author><content type="html">
&lt;p>&lt;strong>Empresas como Google ofrecen servicios gratuitos que los usuarios pueden utilizar, algunos de ellos a cambio de entregrarles documentos con información personal con la consiguiente potencial pérdida de privacidad. Algunos de estos servicios son sustituibles con alternativas como Nextcloud y OnlyOffice que permiten a sus usuarios ser dueños de su información ya sea utilizando una Raspberry Pi como servidor que debe ser administrada o incluso en la nube con servicios como DigitalOcean o AWS.&lt;/strong>&lt;/p>
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/nextcloud.svg" class="right " width="200" alt="Nextcloud" title="Nextcloud"/>
&lt;/div>
&lt;div class="logotypes" style="float: right; clear: right;">
&lt;img src="assets/images/logotipos/onlyoffice.svg" class="right " width="200" alt="OnlyOffice" title="OnlyOffice"/>
&lt;/div>
&lt;p>Una cuenta de Google da acceso a múltiples servicios gratuitos, útiles y con un servicio más que correcto. Algunas de estos servicios está el de correo electrónico de &lt;a href="https://www.google.com/intl/es/gmail/about/">GMail&lt;/a>, la sincronización y unidad de documentos de &lt;a href="https://www.google.es/drive/apps.html">Google Drive&lt;/a>, calendario para apuntar citas y recordatorios con &lt;a href="https://www.google.com/calendar/about/">Google Calendar&lt;/a>, el acceso a la &lt;em>suite&lt;/em> ofimática colaborativa &lt;a href="https://www.google.es/intl/es/docs/about/">Google Docs&lt;/a> o fotos con &lt;a href="https://www.google.com/photos/about/">Google Photos&lt;/a>. Estos son los servicios que uso de Google por su comodidad.&lt;/p>
&lt;p>Los servicios en la nube permiten guardar los documentos e información fuera del dispositivo donde se usen, esto permite tener sincronizados y compartir todos los documentos entre varios dispositivos como el ordenador personal en casa, tener disponibles los documentos en el ordenador del trabajo y en un dispositivo móvil como un &lt;em>smartphone&lt;/em> en cualquier lugar. El problema de los servicios en la nube es que no somos realmente propietarios de nuestra información y documentos, son entregados a esos servicios como los de Google, esto genera una pérdida de privacidad sin ser conscientes de los usos que le pueda dar Google. Para proteger nuestra privacidad hay alternativas para disponer de nuestra propia nube que proporcione la mayoría de estos servicios.&lt;/p>
&lt;p>&lt;a href="https://nextcloud.com/">Nextcloud&lt;/a> es un software que permite alojar en nuestro propio servidor nuestros documentos sustituyendo a varios de los servicios de Google. Nextcloud permite almacenar archivos y documentos ofimáticos, fotos, música, calendarios, un visor de PDF, editor de &lt;em>markdown&lt;/em>, gestor de tareas o nuestros contactos. Permite complementos con los que añadir las funcionalidad que necesitemos como un reproductor de música o un paquete ofimático con &lt;a href="https://www.onlyoffice.com/es/">OnlyOffice&lt;/a> que sustituya a Google Docs.&lt;/p>
&lt;p>Una &lt;a href="https://www.raspberrypi.org/">Raspberry Pi 4&lt;/a> o una de sus &lt;a href="https://picodotdev.github.io/blog-bitix/2018/03/7-plus-computadoras-baratas-del-tamano-de-una-tarjeta-de-credito-basadas-en-gnu-linux-y-arm/">7 computadoras alternativas&lt;/a> similares es una buena opción como servidor por su pequeño tamaño, bajo consumo, totalmente silencioso con un recomendable disipador pasivo y suficiente para ejecutar con normalidad Nexcloud con los 4 GiB de memoria del modelo con más capacidad. Hay &lt;a href="https://picodotdev.github.io/blog-bitix/2018/03/7-plus-computadoras-baratas-del-tamano-de-una-tarjeta-de-credito-basadas-en-gnu-linux-y-arm/">otras placas similares&lt;/a> o incluso se puede utilizar un &lt;a href="https://picodotdev.github.io/blog-bitix/2018/11/desempaquetado-intel-nuc-nuc8i5bek-bean-canyon-hyperx-impact-ram-y-samsung-970-evo-nvme-ssd/">Intel NUC&lt;/a> que permiten más cantidad de memoria y sus procesadores son más capaces. Para una nube privada una Raspberry Pi es interesante por su pequeño tamaño y bajo consumo eléctrico dado que su funcionamiento sería constante.&lt;/p>
&lt;div class="media-amazon" style="text-align: center;">
&lt;iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-eu.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=blobit-21&amp;language=es_ES&amp;o=30&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=as_ss_li_til&amp;asins=B07TC2BK1X&amp;linkId=6e87726b77e92056e7ac168add1bc747">&lt;/iframe>
&lt;iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-eu.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=blobit-21&amp;language=es_ES&amp;o=30&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=as_ss_li_til&amp;asins=B07XNVPK8X&amp;linkId=bef0fad42b2cc046799c66f7fa220c0f">&lt;/iframe>
&lt;iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-eu.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=blobit-21&amp;language=es_ES&amp;o=30&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=as_ss_li_til&amp;asins=B073JWXGNT&amp;linkId=d64d66fda7d25defd2018c4119aa7e46">&lt;/iframe>
&lt;iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-eu.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=blobit-21&amp;language=es_ES&amp;o=30&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=as_ss_li_til&amp;asins=B014I8U33I&amp;linkId=df5c52be4ca21b9991d26145edb0b642">&lt;/iframe>
&lt;iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-eu.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=blobit-21&amp;language=es_ES&amp;o=30&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=as_ss_li_til&amp;asins=B07VMXHJ4Q&amp;linkId=39ee0802cdc202ce8259d463b59224ed">&lt;/iframe>
&lt;/div>
&lt;p>Usando &lt;a href="https://www.docker.com/">Docker&lt;/a> y el &lt;a href="https://github.com/ONLYOFFICE/docker-onlyoffice-nextcloud">repositorio de GitHub&lt;/a> es sencillo iniciar el servidor de Nextcloud realizando los siguientes pasos.&lt;/p>
&lt;ul>
&lt;li>Instalar Docker.&lt;/li>
&lt;li>Descargar o clonar el repositorio de GitHub.&lt;/li>
&lt;li>Iniciar con Docker Compose los contenedores de Nextcloud y OnlyOffice.&lt;/li>
&lt;li>Acceder &lt;em>http://localhost&lt;/em> y realizar la configuración incial, introducir el usuario y contraseña de administrador.&lt;/li>
&lt;li>Ejecutar _bash set&lt;em>configuration.sh&lt;/em>.&lt;/li>
&lt;li>Añadir el complemento de OnlyOffice.&lt;/li>
&lt;li>Acceder a &lt;em>http://localhost&lt;/em>.&lt;/li>
&lt;/ul>
&lt;p>Este archivo de Docker Compose incluye Nextcloud con OnlyOffice sin usar una base de datos externa.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-yaml" data-lang="yaml">version&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;3&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>services&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>app&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>container_name&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>app-server&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>image&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>nextcloud&lt;span class="p">:&lt;/span>fpm&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>stdin_open&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>tty&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>restart&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>always&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>expose&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;80&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;9000&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>volumes&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>app_data&lt;span class="p">:&lt;/span>/var/www/html&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>onlyoffice-document-server&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>container_name&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>onlyoffice-document-server&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>image&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>onlyoffice/documentserver&lt;span class="p">:&lt;/span>latest&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>stdin_open&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>tty&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>restart&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>always&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>expose&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;80&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;443&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>volumes&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>document_data&lt;span class="p">:&lt;/span>/var/www/onlyoffice/Data&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>document_log&lt;span class="p">:&lt;/span>/var/log/onlyoffice&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>nginx&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>container_name&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>nginx-server&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>image&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>nginx&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>stdin_open&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>tty&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>restart&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>always&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>ports&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>&lt;span class="m">443&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">443&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>volumes&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>./nginx.conf&lt;span class="p">:&lt;/span>/etc/nginx/nginx.conf&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>app_data&lt;span class="p">:&lt;/span>/var/www/html&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>volumes&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>document_data&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>document_log&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>app_data&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>mysql_data&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/code/docker-compose.yml" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/code/docker-compose.yml" target="_blank">docker-compose.yml&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ docker-compose up&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/code/docker-compose-up.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/code/docker-compose-up.sh" target="_blank">docker-compose-up.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-configuracion_hu71be4eb84aafb9ce7fab3e64376aea28_604659_2560x1440_fit_box_2.png" title="Configuración de Nextcloud" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-configuracion_hu71be4eb84aafb9ce7fab3e64376aea28_604659_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-inicio_hub6e4ffc90cc2af7ccefcc81e262cb7bf_499248_2560x1440_fit_box_2.png" title="Inicio de Nextcluod" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-inicio_hub6e4ffc90cc2af7ccefcc81e262cb7bf_499248_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-archivos_hu006c070563ecaf608f00bed346476229_74410_2560x1440_fit_box_2.png" title="Archivos en Nextcloud" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-archivos_hu006c070563ecaf608f00bed346476229_74410_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;figcaption>Configuración y archivos en Nextcloud&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>&lt;a href="https://picodotdev.github.io/blog-bitix/2016/05/4-opciones-ofimaticas-alternativas-gratuitas-a-microsoft-office/">OnlyOffice es un paquete ofimático alternativa a Microsoft Office&lt;/a> que ofrece un editor de documentos de texto, una hoja de cálculo y una aplicación para realizar presentaciones integrables en Nextcloud. Son aplicaciones con menos opciones que las ofrecidas por Microsoft Office pero suficientes para un uso sencillo, también dispone de una versión como aplicaciones de escritorio.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-onlyoffice-documento_hufcda4a8a1c5c00c77b1b7b42f2d3b42d_79818_2560x1440_fit_box_2.png" title="Documento con OnlyOffice" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-onlyoffice-documento_hufcda4a8a1c5c00c77b1b7b42f2d3b42d_79818_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-onlyoffice-hoja-de-calculo_hu65fe01024147f6fcc8c8c26bba3cdc3c_86656_2560x1440_fit_box_2.png" title="Hola de cálculo con OnlyOffice" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-onlyoffice-hoja-de-calculo_hu65fe01024147f6fcc8c8c26bba3cdc3c_86656_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-onlyoffice-presentacion_hu15085961136d67ecfbeeaeba5c3c2983_86221_2560x1440_fit_box_2.png" title="Presentación con OnlyOffice" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-onlyoffice-presentacion_hu15085961136d67ecfbeeaeba5c3c2983_86221_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;figcaption>Ofimática con OnlyOffice y Nextcloud alternativa a Google Docs&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>Otras utilidades es un reproductor de música, calendario o galería de fotos, hay un complemento para añadir estas funcionalidades.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-visor-pdf_hu62130f9d3c07d7e46a0c489ebe2b6e6c_244097_2560x1440_fit_box_2.png" title="Visor de documento PDF" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-visor-pdf_hu62130f9d3c07d7e46a0c489ebe2b6e6c_244097_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-calendario_huf8c4556665395f6bc2afa76ffb4f08e4_53030_2560x1440_fit_box_2.png" title="Calendario" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-calendario_huf8c4556665395f6bc2afa76ffb4f08e4_53030_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-visor-fotos_hu4af076e4e429082c673bed4949d6ce39_528032_2560x1440_fit_box_2.png" title="Vidor de fotos" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-visor-fotos_hu4af076e4e429082c673bed4949d6ce39_528032_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;figcaption>Aplicaciones y complementos&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>Con &lt;a href="https://en.wikipedia.org/wiki/WebDAV">WebDAV&lt;/a> los documentos son accesibles como si fuese una unidad local proporcionando la misma funcionalidad de Google Drive. En GNOME con el explorador de archivos Nautilus es posible conectarse a dispositivo WebDAV, en el caso de Nextcloud la dirección es &lt;em>dav://localhost/remote.php/dav/files/admin&lt;/em>.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-webdav_hue4d74c1fb67c603f196cd9b05513d73e_55315_2560x1440_fit_box_2.png" title="Archivos en el explorador de archivos Nautilus con WebDAV" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-webdav_hue4d74c1fb67c603f196cd9b05513d73e_55315_300x200_fit_box_2.png" width="282"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-administracion_huddaddb2ca687512b9813c796514dfc7c_108110_2560x1440_fit_box_2.png" title="Opciones de administración" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/12/nube-privada-para-documentos-personales-con-nextcloud-y-onlyoffice/images/nextcloud-administracion_huddaddb2ca687512b9813c796514dfc7c_108110_300x200_fit_box_2.png" width="251"/>&lt;/a>
&lt;figcaption>Archivos en el explorador de archivos Nautilus con WebDAV y opciones de administración&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>Con las &lt;a href="https://nextcloud.com/install/#">aplicaciones para &lt;em>smatphone&lt;/em>&lt;/a> los documentos quedan accesibles en cualquier lugar teniendo un dispositivo móvil, &lt;em>smartphone&lt;/em> o tableta. Tener una nube propia que esté accesible en internet hace necesario tener un dominio propio, añadir seguridad para lo que es necesario configurar Nextcloud de modo que utilice el protocolo seguro que cifre las comunicaciones con TLS, esto requiere obtener &lt;a href="https://picodotdev.github.io/blog-bitix/2014/02/generar-y-convertir-claves-y-certificados-con-openssl/">un certificado autofirmado&lt;/a> al menos o mejor obteniendolo de &lt;a href="https://letsencrypt.org/">Let&amp;rsquo;s Encrypt&lt;/a>, que proporciona certificados de forma automatizada y gratuita. Otra medida para aumentar la seguridad es utilizar un segundo factor de autenticación o &lt;em>2FA&lt;/em>.&lt;/p>
&lt;p>Hay &lt;a href="https://github.com/nextcloud/docker/blob/master/.examples/docker-compose/with-nginx-proxy/postgres/fpm/docker-compose.yml">ejemplo de archivo de Docker Compose para tener Nexcloud con un certificado&lt;/a> creado y renovado de forma automática con Let&amp;rsquo;s Encrypt a través del contenedor &lt;a href="https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion">jrcs/letsencrypt-nginx-proxy-companion&lt;/a> y configurando las variables de entorno &lt;em>LETSENCRYPT_HOST&lt;/em>, &lt;em>LETSENCRYPT_EMAIL&lt;/em> con el dominio propio para Nexcloud y un correo electrónico.&lt;/p>
&lt;div class="reference">
Referencia:&lt;br>
&lt;ul>
&lt;li>&lt;a href="https://picodotdev.github.io/blog-bitix/series/docker/">Serie de artículos sobre Docker&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div></content><category term="planeta-codigo"/><category term="software"/><category term="software-libre"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/11/gestionar-biblioteca-y-convertir-entre-formatos-de-libros-electronicos-con-calibre/</id><title>Gestionar biblioteca y convertir entre formatos de libros electrónicos con Calibre</title><updated>2019-11-22T16:00:00+01:00</updated><published>2019-11-22T16:00:00+01:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/11/gestionar-biblioteca-y-convertir-entre-formatos-de-libros-electronicos-con-calibre/"/><author><name>picodotdev</name></author><content type="html">
&lt;p>&lt;strong>Dado que los libros electrónicos ocupan muy poco se puede llegar a tener una biblioteca grande de libros que necesitan de una herramienta para ser catalogados y para realizar conversión entre formatos si es necesario para uno de entre los que soporte el dispositivo de libros electrónicos. Calibre es una aplicación que ofrece estas dos principales funciones.&lt;/strong>&lt;/p>
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/calibre.png" class="right " width="200" alt="Calibre" title="Calibre"/>
&lt;/div>
&lt;p>Hace ya unos años que tengo un lector de libros electrónicos y estoy muy contento con él, el popular &lt;a href="https://amzn.to/2EZao5W">Amazon Kindle&lt;/a> aún echando de menos la luz integrada y el modelo &lt;em>paperwhite&lt;/em> que tiene la pantalla más blanca de los modelos más recientes que el mío. Una de las ventajas de los libros electrónicos es que una vez leídos no ocupan espacio físico con lo que no hay que tener varias baldas de libros ocupando espacio, al ser electrónicos no son más que un archivo de ordenador que ocupan muy poco no llegando muchos de ellos al megabyte de espacio. Teniendo una gran cantidad de libros según se obtienen o se empiezan a leer un libro se puede añadir a la biblioteca para tenerlo catalogado. Para gestionar la biblioteca de libros una de las mejores opciones sino la mejor es &lt;a href="https://calibre-ebook.com/">Calibre&lt;/a> no solo por su completa funcionalidad sino porque es software libre.&lt;/p>
&lt;p>Calibre permite organizar los libros por autor y muestra las portadas de los mismos, además permite convertir entre formatos de libros electrónicos. Dos de los formatos mayormente soportados por los lectores de libros electrónicos son el &lt;em>EPUB&lt;/em> y &lt;em>MOBI&lt;/em>. Los Amazon Kindle soportan &lt;em>MOBI&lt;/em>, &lt;em>AZW&lt;/em>, &lt;em>AZW3&lt;/em> y muchas de otras marcas soportan &lt;em>EPUB&lt;/em>, dependiendo del dispositivo en que vayan a ser leídos los libros y el formato en el que se tenga el libro puede ser necesaria una conversión.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/11/gestionar-biblioteca-y-convertir-entre-formatos-de-libros-electronicos-con-calibre/images/calibre_hu3e341aee3376c85fc08f0bb76a7e3125_1938310_2560x1440_fit_box_2.png" title="Bibliteca y conversor de libros electrónicos Calibre" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/11/gestionar-biblioteca-y-convertir-entre-formatos-de-libros-electronicos-con-calibre/images/calibre_hu3e341aee3376c85fc08f0bb76a7e3125_1938310_300x200_fit_box_2.png" width="291"/>&lt;/a>
&lt;figcaption>Biblioteca y conversor de libros electrónicos Calibre&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>La conversión entre formatos no tarda muchos y en ningún momento me he encontrado que el resultado sea malo si el original está correctamente formateado. Como los libros electrónicos son archivos pequeños la conversión se realiza en unos pocos decenas de segundos. Además, Calibre permite realizar la conversión de forma masiva sobre varios libros guardando los libros en diferentes formatos en la biblioteca.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/11/gestionar-biblioteca-y-convertir-entre-formatos-de-libros-electronicos-con-calibre/images/calibre-convertir_huc970496c07526a18eb8547bf224cef99_821319_2560x1440_fit_box_2.png" title="Convertir un libro electrónico a otro formato con Calibre" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/11/gestionar-biblioteca-y-convertir-entre-formatos-de-libros-electronicos-con-calibre/images/calibre-convertir_huc970496c07526a18eb8547bf224cef99_821319_300x200_fit_box_2.png" width="215"/>&lt;/a>
&lt;figcaption>Convertir un libro electrónico a otro formato&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>La biblioteca se guarda en el sistema de archivos del ordenador en una estructura de directorios organizados por autor, títulos del libro y en los formatos en los que se haya realizado la conversión.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/11/gestionar-biblioteca-y-convertir-entre-formatos-de-libros-electronicos-con-calibre/images/calibre-biblioteca-autores_hu76171edc462d96d2244a51aa6f0015db_93574_2560x1440_fit_box_2.png" title="Organización por autores de los archivos en la biblioteca" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/11/gestionar-biblioteca-y-convertir-entre-formatos-de-libros-electronicos-con-calibre/images/calibre-biblioteca-autores_hu76171edc462d96d2244a51aa6f0015db_93574_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/11/gestionar-biblioteca-y-convertir-entre-formatos-de-libros-electronicos-con-calibre/images/calibre-biblioteca-libros_hua04f952e7767210ff982c74cea8c2f93_66243_2560x1440_fit_box_2.png" title="Organización por autor de los archivos en la biblioteca" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/11/gestionar-biblioteca-y-convertir-entre-formatos-de-libros-electronicos-con-calibre/images/calibre-biblioteca-libros_hua04f952e7767210ff982c74cea8c2f93_66243_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;figcaption>Organización de los archivos en la biblioteca&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>Quizá algunos de los libros no tenga los metadatos correctos como el título, nombre del autor o el número del libro si forma parte de una serie de libros relacionados, mediante otro diálogo se puede editar y catalogar correctamente el libro.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/11/gestionar-biblioteca-y-convertir-entre-formatos-de-libros-electronicos-con-calibre/images/calibre-metadatos_hu885484b55919ef89326003b03b2828c4_744720_2560x1440_fit_box_2.png" title="Convertir un libro electrónico a otro formato con Calibre" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/11/gestionar-biblioteca-y-convertir-entre-formatos-de-libros-electronicos-con-calibre/images/calibre-metadatos_hu885484b55919ef89326003b03b2828c4_744720_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;figcaption>Metadatos de un libro electrónico&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>Calibre tiene más funciones pero la catalogar los libros en una biblioteca digital y la realizar la conversión entre formatos para diferentes dispositivos son las dos principales. Está &lt;a href="https://calibre-ebook.com/download">disponible para los principales sistemas operativos&lt;/a> como &lt;a href="https://www.gnu.org/">GNU&lt;/a>/&lt;a href="https://www.linux.com/">Linux&lt;/a> en forma de paquete proporcionado por la distribución o como &lt;a href="https://flathub.org/apps/details/com.calibre_ebook.calibre">aplicación Flatpak universal para cualquier distribución&lt;/a>, &lt;a href="https://www.microsoft.com/es-es/windows/">Windows&lt;/a> y &lt;a href="https://www.apple.com/macos/">macOS&lt;/a>. Puedes conocer la &lt;a href="https://calibre-ebook.com/about#history">historia de Calibre&lt;/a> y cmo surgió como una necesidad de su autor.&lt;/p>
&lt;div class="reference">
Referencia:&lt;br>
&lt;ul>
&lt;li>&lt;a href="https://picodotdev.github.io/blog-bitix/2018/11/flatpak-distribucion-e-instalacion-de-programas-de-escritorio-en-las-distribuciones-gnu-linux/">Flatpak, distribución e instalación de programas de escritorio en las distribuciones GNU/Linux&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div></content><category term="gnu-linux"/><category term="software"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/</id><title>Microservicios con Spring Cloud, Consul, Nomad y Traefik</title><updated>2019-10-12T02:30:00+02:00</updated><published>2019-10-12T02:30:00+02:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/"/><author><name>picodotdev</name></author><content type="html">
&lt;p>&lt;strong>Sin entrar a si los microservicios son adecuados o no son adecuados en una aplicación, está claro que si se utilizan estos tienen varias necesidades. Un servicio de registro y descubrimiento, configuración centralizada, tolerancia a fallos, &lt;em>gateway/load balancer/reverse proxy&lt;/em>, trazabilidad y métricas, autenticación, orquestación, &amp;hellip; Los microservicios quiza no sean un gran monolito, quizá mas pequeños y con funcinalidad más acotada, pero el hecho de que se comuniquen a través de un medio más complejo y menos fiable como la red en vez de una llamada a un método y sean más numerosos hacen que la complejidad sea incluso mayor. Este artículo propone un ejemplo con Spring Cloud para los servicios, Consul para el registro y descubrimiento, Nomad para la orquestación y Traefik como &lt;em>gateway&lt;/em>.&lt;/strong>&lt;/p>
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/java.svg" class="right " width="200" alt="Java" title="Java"/>
&lt;/div>
&lt;div class="logotypes" style="float: right; clear: right;">
&lt;img src="assets/images/logotipos/spring.svg" class="right " width="200" alt="Spring" title="Spring"/>
&lt;/div>
&lt;p>En otro artículo mostraba un ejemplo de &lt;a href="https://picodotdev.github.io/blog-bitix/2018/09/registro-y-descubrimiento-de-servicios-con-spring-cloud-netflix/">microservicios con Spring Cloud&lt;/a> usando únicamente herramientas de &lt;a href="https://spring.io/">Spring&lt;/a>. Cada una de esas herramientas cubren una funcionalidad que necesitan los microservicios. Entre ellas:&lt;/p>
&lt;ul>
&lt;li>Registro y descubrimiento, con &lt;a href="https://github.com/Netflix/eureka">Eureka&lt;/a>. Los microservicios son numerosos, de vida efímera creándose y destruyéndose en diferentes ubicaciones por lo tanto necesitan una forma de localizarse unos a otros, la forma para encontrarse es acudiendo a un servicio donde se registran cuando se inician y se descubren cuando necesitan la ubicación de otro servicio.&lt;/li>
&lt;li>Configuración centralizada, con &lt;a href="https://cloud.spring.io/spring-cloud-config/">Spring Cloud Config&lt;/a>. Dado el número de microservicios actualizar la configuración de cada uno de ellos puede ser un problema, además dado que se pueden iniciar en diferentes ubicaciones aprovisionarles la configuración adecuada es un reto. En vez de aprovisionar la configuración otra técnica es hacer que cuando se inicien la obtengan de un servicio donde queda centralizada la configuración.&lt;/li>
&lt;li>Tolerancia a fallos, con &lt;a href="https://github.com/Netflix/Hystrix">Hyxtrix&lt;/a> y &lt;a href="https://github.com/resilience4j/resilience4j">Resilience4j&lt;/a>. El medio de comunicación de los microservicios es a través de la red un medio mucho menos confiable que una llamada a un método en un lenguaje de programación en una aplicación monolítica. De modo que los microservicios han de estar preparados para tolerar fallos en sus comunicaciones con otros servicios.&lt;/li>
&lt;li>&lt;em>Gateway&lt;/em>, &lt;em>load balancer&lt;/em> y &lt;em>reverse proxy&lt;/em> con tolerancia a fallos, con &lt;a href="https://github.com/Netflix/zuul">Zuul&lt;/a>. Para aumentar la disponibilidad, escalabilidad y tolerar fallos en algunos servicios se suelen crear varias instancias de cada microservicio pero tener varias instancias hace que sea necesario balancear la carga entre cada una de las instancias. Para que los clientes sean agnósticos del número de instancias se emplea un &lt;em>gateway&lt;/em> que proporciona balanceo de carga e implementa a su vez patrones de tolerancia a fallos.&lt;/li>
&lt;li>Trazabilidad y correlación de trazas entre diferentes servicios, con &lt;a href="https://spring.io/projects/spring-cloud-sleuth">Spring Cloud Sleuth&lt;/a>. Una petición puede desencadenar una cadena de peticiones entre diferentes servicios ubicados en múltiples nodos, para tareas de diagnóstico en caso de querer investigar un &lt;em>bug&lt;/em> o que ha ocurrido es necesario correlacionar todas las trazas que ha desencadenado una petición, se implementa asignado un identificativo global a la petición que es transmitido en las llamadas de microservicio a microservicio.&lt;/li>
&lt;/ul>
&lt;p>En otro &lt;a href="https://picodotdev.github.io/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/">ejemplo sobre OAuth con Spring&lt;/a> mostraba otra funcionalidad:&lt;/p>
&lt;ul>
&lt;li>&lt;em>Gateway&lt;/em>, con &lt;a href="https://spring.io/projects/spring-cloud-gateway">Spring Cloud Gateway&lt;/a>.&lt;/li>
&lt;li>Autenticación y autorización, con &lt;a href="https://spring.io/projects/spring-security-oauth">Spring Security OAuth&lt;/a>.&lt;/li>
&lt;/ul>
&lt;p>Los microservicios también necesitan monitorización y métricas, en el ejemplo &lt;a href="https://picodotdev.github.io/blog-bitix/2018/12/monitorizar-una-aplicacion-java-de-spring-boot-con-micrometer-prometheus-y-grafana/">Monitorizar una aplicación Java de Spring Boot con Micrometer, Prometheus y Grafana&lt;/a>:&lt;/p>
&lt;ul>
&lt;li>Con &lt;a href="https://prometheus.io/">Prometheus&lt;/a> y &lt;a href="https://grafana.com/">Grafana&lt;/a>. Nuevamente el número de instancias que requiere una arquitectura orientada a microservicios origina la necesidad en mayor medida de conocer el estado del sistema, ya sean métricas de los sistemas como uso de CPU, memoria o almacenamiento o de la aplicación como peticiones por segundo y porcentaje de correctas e incorrectas.&lt;/li>
&lt;/ul>
&lt;p>En esta lista falta un orquestador para el despliegue de los microservicios, que se encargue de su ciclo de vida, escalado de instancias y despliegue con estrategias &lt;em>rolling&lt;/em>, &lt;em>blue/green&lt;/em> y &lt;em>canary&lt;/em>. Es una cosa que le faltaba al ejemplo de microservicios con Spring Cloud.&lt;/p>
&lt;ul>
&lt;li>Orquestador de servicios, con &lt;a href="https://www.nomadproject.io/">Nomad&lt;/a>. &lt;a href="https://picodotdev.github.io/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/">Introducción a Nomad para gestionar aplicaciones y microservicios&lt;/a>, &lt;a href="https://picodotdev.github.io/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/">Estrategias de despliegue para microservicios con Nomad&lt;/a>.&lt;/li>
&lt;/ul>
&lt;p>Además, en este ejemplo reemplazo varias de estas herramientas de Spring. Sustituyo el servicio de registro y descubrimiento proporcionado por Eureka por &lt;a href="https://www.consul.io/">Consul&lt;/a>, el &lt;em>gateway&lt;/em>, &lt;em>load balancer&lt;/em> y &lt;em>reverse proxy&lt;/em> proporcionado por Zuul por &lt;a href="https://traefik.io/">Traefik&lt;/a> y añado el orquestador de microservicios &lt;a href="https://www.nomadproject.io/">Nomad&lt;/a>.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;img src="assets/images/logotipos/consul.svg" alt="Consul" title="Consul" width="200"/>
&lt;img src="assets/images/logotipos/nomad.svg" alt="Nomad" title="Nomad" width="200"/>
&lt;img src="assets/images/logotipos/traefik.svg" alt="Traefik" title="Traefik" width="200"/>
&lt;/div>
&lt;p>Traefik se configura con los servicios iniciados en los contenedores de Docker utilizando junto con los bloques o &lt;em>stanzas&lt;/em> de &lt;em>config&lt;/em> y &lt;em>labels&lt;/em> en la definición de los servicios de Nomad. Según el criterio definido por el servicio Traefik es capaz de redirigir el tráfico que le llegue al servicio apropiado, entre las posibilidades que puede realizar Traefik es balanceo de carga entre las múltiples instancias que se hayan definido pero también implementa patrones de tolerancia a fallos con reintentos, el patrón &lt;em>circuit breaker&lt;/em> o limitar el tráfico para evitar saturar a un servicio con demasiadas peticiones.&lt;/p>
&lt;p>El esquema de servicios sería el siguiente. Los &lt;em>job&lt;/em> son enviados a Nomad desde la linea de comandos que inicia los contenedores en Docker y registra los servicios en Consul, Traefik monitoriza los contenedores que se inician en Docker y se autoconfigura según las propiedades de los &lt;em>labels&lt;/em> definidos para los contenedores. Una vez iniciados los servicios desde la terminal con un &lt;em>curl&lt;/em> o desde la aplicación cliente que accede a Consul para conocer la ubicación del servicio de Traefik envían una petición a Traefik que haciendo balanceo de carga la reenvía a una de las instancias del servicio, el servicio responde y Traefik envía la respuesta al cliente. Para ser más funcional Traefik debería configurarse a partir de Consul en vez de Docker para posibilitar que los contenedores pudieran estar en varios nodos.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/esquema-arquitectura_hud9745ca4e3e6c708b4af1c72fc0d4ff7_167252_2560x1440_fit_box_2.png" title="Esquema arquitectura" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/esquema-arquitectura_hud9745ca4e3e6c708b4af1c72fc0d4ff7_167252_600x450_fit_box_2.png" width="600"/>&lt;/a>
&lt;figcaption>Esquema arquitectura&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>La ejecución del ejemplo requiere &lt;a href="https://www.docker.com/">Docker&lt;/a> ya que es en este caso el &lt;em>driver&lt;/em> empleado en Nomad para ejecutar los servicios del servicio de configuración, el &lt;em>gateway&lt;/em>, el servicio y el cliente del servicio. Nomad además se encarga de registrar los servicios en el servicio de registro y descubrimiento de Consul.&lt;/p>
&lt;p>Los contenedores de Docker se añade a una misma red para que puedan comunicarse entre ellos, ha de ser así hasta que no se resuelva una &lt;a href="https://github.com/docker/for-linux/issues/264">petición de Docker para que los contenedores puedan comunicarse con la máquina &lt;em>host&lt;/em>&lt;/a> que los alberga.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ docker network create --subnet 172.30.0.0/16 nomad
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/docker-network-create.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/docker-network-create.sh" target="_blank">docker-network-create.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Poteriormente hay que ejecutar Consul y Nomad tras lo cual se puede acceder a sus consolas de estado.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ consul agent -dev -ui -client&lt;span class="o">=&lt;/span>0.0.0.0
$ nomad agent -dev&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/nomad-consul-run.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/nomad-consul-run.sh" target="_blank">nomad-consul-run.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Enviar a Nomad los &lt;em>job&lt;/em> de Traefik tras lo cual se puede acceder a su consola de estado. El siguiente paso es enviar el &lt;em>job&lt;/em> del servicio que proporciona la configuración a los microservicios. Lo anterior únicamente es infraestructura aún no hay ningún servicio que proporcione alguna funcionalidad, la funcionalidad que proporciona el servicio implementado con Spring es simplemente devolver un mensaje como respuesta a la petición que se le realice, se envía el &lt;em>job&lt;/em> del servicio a Nomad. Finalmente, el servicio es consumido por un cliente que realiza una petición al servicio cada 1 segundo.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ ./gradlew assemble
$ nomad job run nomad/traefik.nomad
$ nomad job run nomad/configserver.nomad
$ nomad job run nomad/service.nomad
$ nomad job run nomad/client.nomad&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/nomad-job-run.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/nomad-job-run.sh" target="_blank">nomad-job-run.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Definición de un servicio en un &lt;em>job&lt;/em> para Nomad. &lt;em>count&lt;/em> define cuantas instancias del servicio se inicia, la &lt;em>stanza&lt;/em> &lt;em>update&lt;/em> define como será la actualización cuando se actualice el servicio, la &lt;em>stanza&lt;/em> &lt;em>labels&lt;/em> contiene la configuración para Traefik, &lt;em>check&lt;/em> define los parámetros para la monitorización.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-HCL" data-lang="HCL">&lt;span class="k">job&lt;/span> &lt;span class="s2">&amp;#34;service&amp;#34;&lt;/span> {
&lt;span class="n"> datacenters&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;dc1&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="k">group&lt;/span> &lt;span class="s2">&amp;#34;service&amp;#34;&lt;/span> {
&lt;span class="n"> count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">2&lt;/span>
&lt;span class="k">update&lt;/span> {
&lt;span class="n"> max_parallel&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;span class="n"> health_check&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;checks&amp;#34;&lt;/span>
&lt;span class="n"> min_healthy_time&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;20s&amp;#34;&lt;/span>
&lt;span class="n"> healthy_deadline&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;10m&amp;#34;&lt;/span>
&lt;span class="n"> progress_deadline&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;20m&amp;#34;&lt;/span>
&lt;span class="n"> canary&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
&lt;span class="n"> stagger&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;15s&amp;#34;&lt;/span>
}
&lt;span class="k">task&lt;/span> &lt;span class="s2">&amp;#34;service&amp;#34;&lt;/span> {
&lt;span class="n"> driver&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;docker&amp;#34;&lt;/span>
&lt;span class="k">config&lt;/span> {
&lt;span class="n"> image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;openjdk:11-jdk&amp;#34;&lt;/span>
&lt;span class="n"> args&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="s2">&amp;#34;bash&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="s2">&amp;#34;-c&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n"> &amp;#34;(cd /app &amp;amp;&amp;amp; java -jar /app/service/build/libs/service-1.0.jar --port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">8080&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="err">&amp;#34;&lt;/span>
&lt;span class="p">]&lt;/span>
&lt;span class="k">port_map&lt;/span> {
&lt;span class="n"> http&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;8080&amp;#34;&lt;/span>
}
&lt;span class="n"> network_mode&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;nomad&amp;#34;&lt;/span>
&lt;span class="n"> extra_hosts&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="s2">&amp;#34;traefik:172.30.0.3&amp;#34;&lt;/span>
&lt;span class="p">]&lt;/span>
&lt;span class="n"> volumes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="s2">&amp;#34;/home/picodotdev/Software/personal/blog-ejemplos/SpringCloudConsulNomadTraefik/:/app&amp;#34;&lt;/span>
&lt;span class="p">]&lt;/span>
&lt;span class="k">labels&lt;/span> {
&lt;span class="n"> traefik.http.middlewares.service1-stripprefix.stripprefix.prefixes&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;/service&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n"> traefik.http.middlewares.service1-retry.retry.attempts&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;10&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n"> traefik.http.routers.service1.middlewares&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;service1-stripprefix,service1-retry&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n"> traefik.http.routers.service1.rule&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;PathPrefix(`/service`)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="n"> traefik.http.services.service1.loadbalancer.server.port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;8080&amp;#34;&lt;/span>
}
}
&lt;span class="k">service&lt;/span> {
&lt;span class="n"> name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;service&amp;#34;&lt;/span>
&lt;span class="n"> port&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span>
&lt;span class="k">check&lt;/span> {
&lt;span class="n"> type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span>
&lt;span class="n"> port&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span>
&lt;span class="n"> path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;/actuator/health&amp;#34;&lt;/span>
&lt;span class="n"> interval&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;5s&amp;#34;&lt;/span>
&lt;span class="n"> timeout&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;2s&amp;#34;&lt;/span>
}
}
&lt;span class="k">resources&lt;/span> {
&lt;span class="n"> cpu&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">200&lt;/span>
&lt;span class="n"> memory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">1024&lt;/span>
&lt;span class="k">network&lt;/span> {
&lt;span class="n"> mbits&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">20&lt;/span>
&lt;span class="k">port&lt;/span> &lt;span class="s2">&amp;#34;http&amp;#34;&lt;/span> {}
}
}
}
}
}&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/service.nomad" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/service.nomad" target="_blank">service.nomad&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Tanto Consul, Nomad como Traefik ofrecen una consola para ver su estado ubicadas en las siguientes direcciones respectivamente accesibles con el navegador &lt;em>http://127.0.0.1:8500&lt;/em>, &lt;em>http://127.0.0.1:4646&lt;/em>, &lt;em>http://127.0.0.1:8092&lt;/em>.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/consul_hudc42d06e92419bb68cedcf920ffbb9e1_66952_2560x1440_fit_box_2.png" title="Consul" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/consul_hudc42d06e92419bb68cedcf920ffbb9e1_66952_200x150_fit_box_2.png" width="200"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/nomad-1_hu236530498253a3dba6bcdeea43b58303_63779_2560x1440_fit_box_2.png" title="Nomad" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/nomad-1_hu236530498253a3dba6bcdeea43b58303_63779_200x150_fit_box_2.png" width="200"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/nomad-2_huf614ca5d87e91f36d0a6f0dc0f7e1da1_112167_2560x1440_fit_box_2.png" title="Nomad" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/nomad-2_huf614ca5d87e91f36d0a6f0dc0f7e1da1_112167_200x150_fit_box_2.png" width="200"/>&lt;/a>
&lt;/figure>
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/traefik-1_hu752c6a0b248029866df45cca04eee0f1_104793_2560x1440_fit_box_2.png" title="Traefik" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/traefik-1_hu752c6a0b248029866df45cca04eee0f1_104793_200x150_fit_box_2.png" width="200"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/traefik-2_hu3d23c9c51ffc17299ed33c1319107a0c_130051_2560x1440_fit_box_2.png" title="Traefik" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/traefik-2_hu3d23c9c51ffc17299ed33c1319107a0c_130051_200x150_fit_box_2.png" width="200"/>&lt;/a>
&lt;figcaption>Consolas de administración de Consul, Nomad y Traefik&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>El código del servicio, del cliente implementados con Spring y la salida del cliente son los siguientes.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">package&lt;/span> &lt;span class="nn">io.github.picodotdev.blogbitix.springcloud.service&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="o">.&lt;/span>
&lt;span class="nd">@RestController&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">DefaultController&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">DefaultConfiguration&lt;/span> &lt;span class="n">configuration&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">Tracing&lt;/span> &lt;span class="n">tracing&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">Tracer&lt;/span> &lt;span class="n">tracer&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">Random&lt;/span> &lt;span class="n">random&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">Counter&lt;/span> &lt;span class="n">counter&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="nf">DefaultController&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">MeterRegistry&lt;/span> &lt;span class="n">registry&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">random&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Random&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">counter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Counter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;service.invocations&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">description&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Total service invocations&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">register&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">registry&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@RequestMapping&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">home&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">HttpServletRequest&lt;/span> &lt;span class="n">request&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">counter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">increment&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="c1">// Timeout simulation
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//Thread.sleep(random.nextInt(4000));
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="n">TraceContext&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Extractor&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">HttpServletRequest&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">extractor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tracing&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">propagation&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">extractor&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">HttpServletRequest&lt;/span> &lt;span class="n">carrier&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">carrier&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getHeader&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="o">}&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">Span&lt;/span> &lt;span class="n">span&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tracer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">nextSpan&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">extractor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">extract&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Service Span (traceId: %s, spanId: %s)%n&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">span&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">context&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">traceIdString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">span&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">context&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">spanIdString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">format&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Hello world (url: %s, remoteAddress_%s, localAddress: %s, traceId: %s, spanId: %s, key: %s)&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getRequestURL&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">,&lt;/span>
&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getRemoteAddr&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getLocalAddr&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">span&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">context&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">traceIdString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">span&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">context&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">spanIdString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">configuration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getKey&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/DefaultController.java" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/DefaultController.java" target="_blank">DefaultController.java&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">package&lt;/span> &lt;span class="nn">io.github.picodotdev.blogbitix.springcloud.client&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="o">.&lt;/span>
&lt;span class="nd">@Component&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ProxyService&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">LoadBalancerClient&lt;/span> &lt;span class="n">loadBalancer&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">Tracing&lt;/span> &lt;span class="n">tracing&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">Tracer&lt;/span> &lt;span class="n">tracer&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">CircuitBreakerConfig&lt;/span> &lt;span class="n">circuitBreakerConfiguration&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">TimeLimiterConfig&lt;/span> &lt;span class="n">timeLimiterConfiguration&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">HttpClient&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="nf">ProxyService&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">circuitBreakerConfiguration&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">CircuitBreakerConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">custom&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">failureRateThreshold&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">50&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">recordExceptions&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">IOException&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">TimeoutException&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">timeLimiterConfiguration&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TimeLimiterConfig&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">custom&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">timeoutDuration&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Duration&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ofMillis&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">2500&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">cancelRunningFuture&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">client&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">HttpClient&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newBuilder&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">version&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">HttpClient&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Version&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">HTTP_2&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">ServiceInstance&lt;/span> &lt;span class="n">instance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">loadBalancer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">choose&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;traefik&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">URI&lt;/span> &lt;span class="n">uri&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getUri&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">String&lt;/span> &lt;span class="n">resource&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">format&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;%s%s&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">uri&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">toString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">replace&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;127.0.0.1&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;traefik&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="s">&amp;#34;/service&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">HttpRequest&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Builder&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">null&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">HttpRequest&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newBuilder&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">URI&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">resource&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">GET&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">getFallback&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">final&lt;/span> &lt;span class="n">HttpRequest&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Builder&lt;/span> &lt;span class="n">request&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">Span&lt;/span> &lt;span class="n">span&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tracer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">newTrace&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">start&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">TraceContext&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Injector&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">HttpRequest&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Builder&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">injector&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tracing&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">propagation&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">injector&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">HttpRequest&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Builder&lt;/span> &lt;span class="n">carrier&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="n">carrier&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">header&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span> &lt;span class="o">}&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">injector&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">inject&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">span&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">context&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">request&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">System&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">printf&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Client Span (traceId: %s, spanId: %s)%n&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">span&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">context&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">traceIdString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">span&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">context&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">spanIdString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">CircuitBreaker&lt;/span> &lt;span class="n">circuitBreaker&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">CircuitBreaker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">of&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;resilience4jCircuitBreakerProxyService&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">circuitBreakerConfiguration&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">TimeLimiter&lt;/span> &lt;span class="n">timeLimiter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TimeLimiter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">of&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">timeLimiterConfiguration&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">Supplier&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">CompletableFuture&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">get&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">CompletableFuture&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">supplyAsync&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">try&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">HttpResponse&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">response&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">client&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">send&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">HttpResponse&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">BodyHandlers&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">ofString&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">body&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span> &lt;span class="k">catch&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="n">Exception&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">getFallback&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">Callable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">getLimiter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TimeLimiter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">decorateFutureSupplier&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">timeLimiter&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">get&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">Callable&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">getCircuitBreaker&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">CircuitBreaker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">decorateCallable&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">circuitBreaker&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">getLimiter&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">Try&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">of&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">getCircuitBreaker&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="n">call&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">recover&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">throwable&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">getFallback&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">get&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">getFallback&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;Fallback&amp;#34;&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/ProxyService.java" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/ProxyService.java" target="_blank">ProxyService.java&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Como hay 2 instancias del servicio y Traefik realiza balanceo de carga utilizando el algoritmo &lt;em>round robbin&lt;/em> se observa en la salida con las respuestas que la dirección IP que ha atendido la petición es alternativamente una de las dos instancias del servicio.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">...
Service response: Hello world (url: http://172.30.0.3/, remoteAddress_172.30.0.3, localAddress: 172.30.0.4, traceId: 63afa4d0cd4f466c, spanId: 4719dfcc16b6104e, key: value)
Client Span (traceId: 57eeaa436aa09238, spanId: 57eeaa436aa09238)
Service response: Hello world (url: http://172.30.0.3/, remoteAddress_172.30.0.3, localAddress: 172.30.0.5, traceId: 57eeaa436aa09238, spanId: 26dc213be2d933ac, key: value)
Client Span (traceId: 23c748bf222052a6, spanId: 23c748bf222052a6)
Service response: Hello world (url: http://172.30.0.3/, remoteAddress_172.30.0.3, localAddress: 172.30.0.4, traceId: 23c748bf222052a6, spanId: 0404d949c6e04c18, key: value)
Client Span (traceId: c45d66a4ec9cf14c, spanId: c45d66a4ec9cf14c)
Service response: Hello world (url: http://172.30.0.3/, remoteAddress_172.30.0.3, localAddress: 172.30.0.5, traceId: c45d66a4ec9cf14c, spanId: e7f6ccf2efb8234b, key: value)
Client Span (traceId: 2fdb3b71a682d2e6, spanId: 2fdb3b71a682d2e6)
Service response: Hello world (url: http://172.30.0.3/, remoteAddress_172.30.0.3, localAddress: 172.30.0.4, traceId: 2fdb3b71a682d2e6, spanId: 24ac2a8d2bfb1e6e, key: value)
Client Span (traceId: a33b010e02709c6a, spanId: a33b010e02709c6a)
Service response: Hello world (url: http://172.30.0.3/, remoteAddress_172.30.0.3, localAddress: 172.30.0.5, traceId: a33b010e02709c6a, spanId: 0abe6074fc277af6, key: value)
...&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/System.out" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/System.out" target="_blank">System.out&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>En un momento posterior si surge la necesidad de querer desplegar una nueva versión del microservicio basta con generar de nuevo el artefacto del microservicio, cambiando la versión en el archivo &lt;em>build.gradle&lt;/em>. El despliegue de la nueva versión se realizan mediante la estrategia &lt;em>canary&lt;/em>, manteniendo las instancias con la versión anterior del servicio y añadiendo una nueva con la nueva versión. Si se descubre algún error en la instancia &lt;em>canary&lt;/em> se puede revertir el estado a la versión anterior, que consiste en detener la instancia &lt;em>canary&lt;/em>. Una vez se comprueba que la instancia con la nueva versión funciona correctamente analizando sus trazas y métricas se envía la order a Nomad de promocionar las instancias de forma progresiva con la versión antigua a la nueva versión.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ nomad job run nomad/service.nomad
$ nomad job promote service
$ nomad job revert service &lt;span class="m">0&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/nomad-job-promote.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/nomad-job-promote.sh" target="_blank">nomad-job-promote.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>El servicio exporta métricas en formato para Prometheus que con Grafana. Según se realizan peticiones al servicio el valor de métrica de contador de llamadas al servicio aumenta de forma progresiva.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ curl http://127.0.0.1:8093/service/actuator/prometheus &lt;span class="p">|&lt;/span> grep &lt;span class="s2">&amp;#34;service.invocations&amp;#34;&lt;/span>
&lt;span class="c1"># HELP service_invocations_total Total service invocations&lt;/span>
&lt;span class="c1"># TYPE service_invocations_total counter&lt;/span>
service_invocations_total 20.0
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/service-prometheus.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/service-prometheus.sh" target="_blank">service-prometheus.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>
El &lt;a href="https://github.com/picodotdev/blog-ejemplos/tree/master/SpringCloudConsulNomadTraefik">código fuente completo del ejemplo&lt;/a> puedes descargarlo del repositorio de ejemplos de Blog Bitix alojado en &lt;a href="https://github.com/">GitHub&lt;/a> y probarlo en tu equipo ejecutando el comando &lt;code>./run.sh&lt;/code>.
&lt;/p></content><category term="java"/><category term="planeta-codigo"/><category term="programacion"/><category term="software"/><category term="software-libre"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/10/guia-de-inicio-del-gestor-de-terminales-y-sesiones-tmux/</id><title>Guía de inicio del gestor de terminales y sesiones tmux</title><updated>2019-10-04T18:00:00+02:00</updated><published>2019-10-04T18:00:00+02:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/10/guia-de-inicio-del-gestor-de-terminales-y-sesiones-tmux/"/><author><name>picodotdev</name></author><content type="html">
&lt;p>&lt;strong>Las personas que usan de forma intensiva la terminal seguramente usando un mutiplexador de terminales como tmux su trabajo es facilitado. Tmux permite dividir una terminal en paneles, ventanas independiente y sesiones. Usando sus múltiples combinaciones de teclas se divide una terminal o una ventana de forma horizontal y vertical en paneles del tamaño que se desee pudiendo de esta forma visualizar al mismo tiempo varias terminales ubicadas en cada panel. También se puede crear una configuración para iniciar tmux con la misma disposición de paneles, ventanas y sesiones.&lt;/strong>&lt;/p>
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/gnu.svg" class="right " width="200" alt="GNU" title="GNU"/>
&lt;/div>
&lt;div class="logotypes" style="float: right; clear: right;">
&lt;img src="assets/images/logotipos/linux.svg" class="right " width="200" alt="Linux" title="Linux"/>
&lt;/div>
&lt;p>Las terminales gráficas como &lt;a href="https://www.gnome.org/">GNOME&lt;/a> Terminal y &lt;a href="https://www.kde.org/">KDE&lt;/a> Konsole soportan pestañas e incluso desde un entorno gráfico en GNU/Linux están disponibles según la distribución varias terminales de texto accesibles con la combinación de teclas &lt;kbd>Ctrl+Alt+F3&lt;/kbd> y &lt;kbd>Ctrl+Alt+F4&lt;/kbd>, con &lt;kbd>Ctrl+Alt+F2&lt;/kbd> se puede retornar a la interfaz gráfica. Sin embargo, ninguna de estas opciones permite dividir la misma terminal en varias ventanas o paneles para realizar operaciones y ver los resultados al mismo tiempo. Por otro lado cuando realizamos una sesión SSH y esta finaliza o termina abruptamente por un fallo en la conexión los procesos que se hayan iniciado desde ella son terminados lo que es especialmente grave si se está realizando una operación importante que puede ocasionar problemas.&lt;/p>
&lt;p>&lt;a href="https://github.com/tmux/tmux/wiki">Tmux&lt;/a> es un multiplexador de terminales con soporte para iniciar sesiones. Con tmux en una misma terminal o sesión SSH es posible dividirla en varios paneles y ventanas. También permite iniciar sesiones y salir de ellas sin que los procesos que están corriendo sean terminados lo que permite iniciar una sesión por ejemplo en el trabajo, dejarla suspendida y luego continuarla desde otro equipo, ubicación o ser iniciada por una persona y continuada por otra.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/guia-de-inicio-del-gestor-de-terminales-y-sesiones-tmux/images/tmux_hu77ea831290e4496781697c4e09451f28_32101_2560x1440_fit_box_2.png" title="Sesión de tmux en la terminal de GNOME" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/guia-de-inicio-del-gestor-de-terminales-y-sesiones-tmux/images/tmux_hu77ea831290e4496781697c4e09451f28_32101_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;figcaption>Sesión de tmux en la terminal de GNOME&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>Tmux al ser un programa de la terminal todas sus opciones se realizan con el teclado, y no son pocas &lt;a href="https://tmuxcheatsheet.com/">las combinaciones de teclas de su &lt;em>cheatsheet&lt;/em> o chuleta&lt;/a>. Algunas opciones básicas necesario conocer con son:&lt;/p>
&lt;ul>
&lt;li>Dividir una terminal en paneles verticales y horizontales, &lt;kbd>Ctrl-b &amp;ldquo;&lt;/kbd>, &lt;kbd>Ctrl-b %&lt;/kbd>.&lt;/li>
&lt;li>Cambiar entre paneles, &lt;kbd>Ctrl-b q 0..9&lt;/kbd>.&lt;/li>
&lt;li>Cambiar tamaño de un panel, &lt;kbd>Ctrl-b Up&lt;/kbd>, &lt;kbd>Ctrl-b Down&lt;/kbd>, &lt;kbd>Ctrl-b Left&lt;/kbd>, &lt;kbd>Ctrl-b Right&lt;/kbd>. Una panel se maximiza y minimiza con &lt;kbd>Ctrl-b z&lt;/kbd>.&lt;/li>
&lt;li>Cerrar un panel, &lt;kbd>Ctrl-b x&lt;/kbd>.&lt;/li>
&lt;li>Cerrar una sesión &lt;kbd>Ctrl-b :, kill-session&lt;/kbd>.&lt;/li>
&lt;li>Crear, moverse a otra ventana y cerrar una ventana, &lt;kbd>Ctrl-b c&lt;/kbd>, &lt;kbd>Ctrl-b 0..9&lt;/kbd>, &lt;kbd>Ctrl-b ,&lt;/kbd>.&lt;/li>
&lt;li>Hacer &lt;em>scroll&lt;/em> en las ventanas, &lt;kbd>Ctrl-b [&lt;/kbd>.&lt;/li>
&lt;/ul>
&lt;p>Para facilitar un poco su uso y poder cambiar entre paneles y hacer &lt;em>scroll&lt;/em> si se usa en un entorno gráfico se pueden habilitar las funciones del ratón. Basta editar el archivo de configuración &lt;em>~/.tmux.conf&lt;/em> o introducir la opción con &lt;kbd>Ctrl-b :&lt;/kbd>. En un entorno gráfico habilitar el soporte para el ratón cambia el comportamiento de copiar y pegar, para seleccionar texto hay que hacer uso de la tecla &lt;kbd>Shift&lt;/kbd> a la vez que se selecciona el texto con el botón izquierdo del ratón.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">set-option -g mouse on
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/guia-de-inicio-del-gestor-de-terminales-y-sesiones-tmux/code/tmux.conf" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/guia-de-inicio-del-gestor-de-terminales-y-sesiones-tmux/code/tmux.conf" target="_blank">tmux.conf&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Para automatizar la configuración inicial de tmux soporta un archivo para personalizarlo a través de un &lt;em>script&lt;/em> con comandos. Así por ejemplo si siempre se desea una misma configuración de paneles y ventanas con la misma disposición es posible realizarlo con un &lt;em>script&lt;/em> como el siguiente.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="cp">#!/usr/bin/env bash
&lt;/span>&lt;span class="cp">&lt;/span>tmux new-session -s &lt;span class="s2">&amp;#34;Session&amp;#34;&lt;/span> -d
tmux set-option -g mouse on
tmux split-window -h
tmux split-window -v
tmux attach-session -t &lt;span class="s2">&amp;#34;Session&amp;#34;&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/guia-de-inicio-del-gestor-de-terminales-y-sesiones-tmux/code/tmux.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/10/guia-de-inicio-del-gestor-de-terminales-y-sesiones-tmux/code/tmux.sh" target="_blank">tmux.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>En el &lt;a href="http://man.openbsd.org/OpenBSD-current/man1/tmux.1">manpage de tmux&lt;/a> y los enlaces de referencia hay guías con una lista más completa que las operaciones básicas que incluyo en este artículo.&lt;/p>
&lt;div class="reference">
Referencia:&lt;br>
&lt;ul>
&lt;li>&lt;a href="https://robots.thoughtbot.com/a-tmux-crash-course">A tmux Crash Course&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.hamvocke.com/blog/a-quick-and-easy-guide-to-tmux/">A Quick and Easy Guide to tmux&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.linode.com/docs/networking/ssh/persistent-terminal-sessions-with-tmux/">How to Use tmux the Terminal Multiplexer&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://wiki.archlinux.org/index.php/Tmux">Archlinux Wiki tmux&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://leanpub.com/the-tao-of-tmux/read">The Tao of tmux&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.sromero.org/wiki/linux/aplicaciones/tmux">tmux: Multiplexador de terminal&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://askubuntu.com/questions/830484/how-to-start-tmux-with-several-panes-open-at-the-same-time">How to start tmux with several panes open at the same time?&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://superuser.com/questions/209437/how-do-i-scroll-in-tmux#209608">How do I scroll in tmux?&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div></content><category term="gnu-linux"/><category term="planeta-codigo"/><category term="software"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/</id><title>Generar credenciales de conexión a base de datos bajo demanda con Vault</title><updated>2019-08-15T09:00:00+02:00</updated><published>2019-08-15T09:00:00+02:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/"/><author><name>picodotdev</name></author><content type="html">
&lt;p>&lt;strong>Una de las funcionalidades proporcionada por Vault es generar credenciales dinámicas para la conexión a bases de datos. Generar las credenciales de forma dinámica proporciona varios beneficios: no hay unas credenciales que usen las aplicaciones que tengan un tiempo de vida indefinido, las aplicaciones no necesitan guardar en su configuración las credenciales, las credenciales se rotan de forma automática y los permisos para obtenerlas se pueden revocar de forma centralizada con Vault para cuales quiera bases de datos que se utilicen. Soporta las bases de datos más populares entre ellas postgres.&lt;/strong>&lt;/p>
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/vault.svg" class="right " width="200" alt="Vault" title="Vault"/>
&lt;/div>
&lt;div class="logotypes" style="float: right; clear: right;">
&lt;img src="assets/images/logotipos/postgresql.svg" class="right " width="200" alt="PostgreSQL" title="PostgreSQL"/>
&lt;/div>
&lt;p>Las base de datos para proteger los datos realizan autenticación del usuario que se conecta. Normalmente utilizando un usuario y contraseña, una vez autenticado el usuario mediante permisos se realiza la autorización de las operaciones que puede realizar, a que bases de datos se puede conectar, que tablas puede acceder y que operaciones puede realizar.&lt;/p>
&lt;p>Este modelo de autenticación tiene algunos inconvenientes. Uno de los inconvenientes es que los usuarios y contraseñas para mayor seguridad han de cambiarse con cierta frecuencia para evitar que si las credenciales quedan comprometidas no puedan utilizarse indefinidamente. Otro problema es que cada aplicación ha de conocer las credenciales de la base de datos, esto hace que haya múltiples posibilidades de que las credenciales queden comprometidas. Por otro lado el uso de las credenciales no queda registrado de forma centralizada que es necesario para saber ante una brecha de seguridad qué datos han sido accedidos y por quien.&lt;/p>
&lt;p>La herramienta &lt;a href="https://www.vaultproject.io/">Vault&lt;/a> de &lt;a href="https://www.hashicorp.com/">HashiCorp&lt;/a> da solución a estos problemas generando credenciales de acceso a las bases de datos de forma dinámica, bajo demanda y con un tiempo de concesión limitado. Las credenciales tiene un tiempo de vida limitado si no se renueva su concesión y la generación de las credenciales queda registrado. La forma que tiene Vault de generar credenciales de forma dinámica en una base de datos relacional como &lt;a href="https://www.postgresql.org/">postgres&lt;/a> es conectarse a la base de datos con un usuario con permisos para generarlas y ejecutar una sentencia SQL que crea las credenciales.&lt;/p>
&lt;p>Para permitir a Vault generar credenciales de conexión hay que activar el &lt;em>backend&lt;/em> de bases de datos, configurarlo con la sentencia SQL que se utilizará para generar las credenciales y crear el rol de Vault que genera las credenciales cuando se le solicite. En este ejemplo se muestra para la base de datos postgres pero Vault también soporta otras bases de datos como &lt;a href="https://www.mysql.com/">MySQL&lt;/a>. En el ejemplo la base de datos postgres se ejecuta en un contenedor de &lt;a href="https://www.docker.com/">Docker&lt;/a> en el que se asignan el usuario y contraseña del usuario &lt;em>root&lt;/em> que utiliza Vault para generar las credenciales de forma dinámica.&lt;/p>
&lt;p>Con las siguientes comandos se inicia &lt;a href="https://www.consul.io/">Consul&lt;/a> y Vault.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ consul agent -dev
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Starting Consul agent...
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Consul agent running!
Version: &lt;span class="s1">&amp;#39;v1.5.0&amp;#39;&lt;/span>
Node ID: &lt;span class="s1">&amp;#39;38d4f541-0958-6d7d-d49e-a31a15987286&amp;#39;&lt;/span>
Node name: &lt;span class="s1">&amp;#39;archlinux&amp;#39;&lt;/span>
Datacenter: &lt;span class="s1">&amp;#39;dc1&amp;#39;&lt;/span> &lt;span class="o">(&lt;/span>Segment: &lt;span class="s1">&amp;#39;&amp;lt;all&amp;gt;&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
Server: &lt;span class="nb">true&lt;/span> &lt;span class="o">(&lt;/span>Bootstrap: &lt;span class="nb">false&lt;/span>&lt;span class="o">)&lt;/span>
Client Addr: &lt;span class="o">[&lt;/span>127.0.0.1&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>HTTP: 8500, HTTPS: -1, gRPC: 8502, DNS: 8600&lt;span class="o">)&lt;/span>
Cluster Addr: 127.0.0.1 &lt;span class="o">(&lt;/span>LAN: 8301, WAN: 8302&lt;span class="o">)&lt;/span>
Encrypt: Gossip: false, TLS-Outgoing: false, TLS-Incoming: false&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/consul.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/consul.sh" target="_blank">consul.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ vault server -dev -config vault.hcl
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Vault server configuration:
Api Address: http://127.0.0.1:8200
Cgo: disabled
Cluster Address: https://127.0.0.1:8201
Listener 1: tcp &lt;span class="o">(&lt;/span>addr: &lt;span class="s2">&amp;#34;127.0.0.1:8200&amp;#34;&lt;/span>, cluster address: &lt;span class="s2">&amp;#34;127.0.0.1:8201&amp;#34;&lt;/span>, max_request_duration: &lt;span class="s2">&amp;#34;1m30s&amp;#34;&lt;/span>, max_request_size: &lt;span class="s2">&amp;#34;33554432&amp;#34;&lt;/span>, tls: &lt;span class="s2">&amp;#34;disabled&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
Log Level: info
Mlock: supported: true, enabled: &lt;span class="nb">false&lt;/span>
Storage: consul &lt;span class="o">(&lt;/span>HA available&lt;span class="o">)&lt;/span>
Version: Vault v1.1.1
Version Sha: a3dcd63451cf6da1d04928b601bbe9748d53842e
WARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory
and starts unsealed with a single unseal key. The root token is already
authenticated to the CLI, so you can immediately begin using Vault.
You may need to &lt;span class="nb">set&lt;/span> the following environment variable:
$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">VAULT_ADDR&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;http://127.0.0.1:8200&amp;#39;&lt;/span>
The unseal key and root token are displayed below in &lt;span class="k">case&lt;/span> you want to
seal/unseal the Vault or re-authenticate.
Unseal Key: &lt;span class="nv">jeW10eak6TxJzH2qFnwk7bWk7HcpDXd3KQOobi1rZTQ&lt;/span>&lt;span class="o">=&lt;/span>
Root Token: s.0YRcRzojVcPG8LbbzyUd1MEA
Development mode should NOT be used in production installations!&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault.sh" target="_blank">vault.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">ui = true
storage &amp;#34;consul&amp;#34; {
address = &amp;#34;127.0.0.1:8500&amp;#34;
path = &amp;#34;vault&amp;#34;
}&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault.hcl" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault.hcl" target="_blank">vault.hcl&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>La base de datos se inicia en un contenedor de Docker, se crea una base de datos y una tabla.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ docker run -it -p &lt;span class="s2">&amp;#34;5432:5432&amp;#34;&lt;/span> -e &lt;span class="nv">POSTGRES_USER&lt;/span>&lt;span class="o">=&lt;/span>postgres -e &lt;span class="nv">POSTGRES_PASSWORD&lt;/span>&lt;span class="o">=&lt;/span>postgres postgres:alpine
$ docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
2792b13c36c1 postgres:alpine &lt;span class="s2">&amp;#34;docker-entrypoint.s…&amp;#34;&lt;/span> &lt;span class="m">3&lt;/span> minutes ago Up &lt;span class="m">3&lt;/span> minutes 0.0.0.0:5432-&amp;gt;5432/tcp distracted_keldysh
$ docker &lt;span class="nb">exec&lt;/span> -it 2792b13c36c1 bash
bash-5.0# psql -U postgres
psql &lt;span class="o">(&lt;/span>11.4&lt;span class="o">)&lt;/span>
Type &lt;span class="s2">&amp;#34;help&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> help.
&lt;span class="nv">postgres&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="c1"># CREATE DATABASE app;&lt;/span>
&lt;span class="nv">postgres&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="c1"># \connect app&lt;/span>
You are now connected to database &lt;span class="s2">&amp;#34;app&amp;#34;&lt;/span> as user &lt;span class="s2">&amp;#34;postgres&amp;#34;&lt;/span>.
&lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="c1"># CREATE TABLE product (&lt;/span>
id bigint PRIMARY KEY,
name varchar&lt;span class="o">(&lt;/span>256&lt;span class="o">)&lt;/span> NOT NULL
&lt;span class="o">)&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="c1"># \dt&lt;/span>
List of relations
Schema &lt;span class="p">|&lt;/span> Name &lt;span class="p">|&lt;/span> Type &lt;span class="p">|&lt;/span> Owner
--------+---------+-------+----------
public &lt;span class="p">|&lt;/span> product &lt;span class="p">|&lt;/span> table &lt;span class="p">|&lt;/span> postgres
&lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> row&lt;span class="o">)&lt;/span>
$ docker inspect -f &lt;span class="s1">&amp;#39;{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}&amp;#39;&lt;/span> 2792b13c36c1
172.17.0.2&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/postgres.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/postgres.sh" target="_blank">postgres.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>En Vault hay que crear la configuración para conectarse a la base de datos y un rol que contiene la configuración para generar las credenciales y permitir obtenerlas, básicamente es un sentencia SQL con el nombre del usuario y contraseña, los permisos que se le asignan y el tiempo de concesión.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">VAULT_ADDR&lt;/span>&lt;span class="o">=&lt;/span>http://127.0.0.1:8200
$ vault login s.0YRcRzojVcPG8LbbzyUd1MEA
$ vault secrets &lt;span class="nb">enable&lt;/span> database&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault-database.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault-database.sh" target="_blank">vault-database.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ vault write database/config/app &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">plugin_name&lt;/span>&lt;span class="o">=&lt;/span>postgresql-database-plugin &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">allowed_roles&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;app&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">connection_url&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;postgresql://{{username}}:{{password}}@localhost:5432/?sslmode=disable&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">username&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;postgres&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">password&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;postgres&amp;#34;&lt;/span>
$ vault write database/roles/app &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">db_name&lt;/span>&lt;span class="o">=&lt;/span>app &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">creation_statements&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;CREATE ROLE \&amp;#34;{{name}}\&amp;#34; WITH LOGIN PASSWORD &amp;#39;{{password}}&amp;#39; VALID UNTIL &amp;#39;{{expiration}}&amp;#39;; GRANT SELECT ON ALL TABLES IN SCHEMA public TO \&amp;#34;{{name}}\&amp;#34;;&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">default_ttl&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;1h&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">max_ttl&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;24h&amp;#34;&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault-role.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault-role.sh" target="_blank">vault-role.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Las credenciales se generan en el momento de leer una propiedad de Vault.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ vault &lt;span class="nb">read&lt;/span> database/roles/app
Key Value
--- -----
creation_statements &lt;span class="o">[&lt;/span>CREATE ROLE &lt;span class="s2">&amp;#34;{{name}}&amp;#34;&lt;/span> WITH LOGIN PASSWORD &lt;span class="s1">&amp;#39;{{password}}&amp;#39;&lt;/span> VALID UNTIL &lt;span class="s1">&amp;#39;{{expiration}}&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span> GRANT SELECT ON ALL TABLES IN SCHEMA public TO &lt;span class="s2">&amp;#34;{{name}}&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="o">]&lt;/span>
db_name app
default_ttl 1h
max_ttl 24h
renew_statements &lt;span class="o">[&lt;/span>&lt;span class="o">]&lt;/span>
revocation_statements &lt;span class="o">[&lt;/span>&lt;span class="o">]&lt;/span>
rollback_statements &lt;span class="o">[&lt;/span>&lt;span class="o">]&lt;/span>
$ vault &lt;span class="nb">read&lt;/span> database/creds/app
Key Value
--- -----
lease_id database/creds/app/rFFlNmpNoxezccTVh3WufZOT
lease_duration 1h
lease_renewable &lt;span class="nb">true&lt;/span>
password A1a-6hRTGNaShFIEGLvp
username v-root-app-ydbbHqVq1gYQqsUxMuIc-1565857370&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault-credentials.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/vault-credentials.sh" target="_blank">vault-credentials.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>En postgres la conexión desde la máquina local se permiten sin necesidad de credenciales, para simular realizar la conexión desde otra máquina hay que iniciar otro contenedor. En la conexión se utilizan las credenciales que ha proporcionado Vault. Dado que se realiza una operación de red hay que desactivar el &lt;em>firewall&lt;/em> del sistema o permitir la conexión al puerto de la base de datos que en postgres es el 5432 si fuera necesario. Listando los usuarios de la base de datos con el comando &lt;em>\du&lt;/em> se muestra el creado por Vault y si tiempo de validez.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ docker run -it postgres:alpine bash
bash-5.0# &lt;span class="nv">PGPASSWORD&lt;/span>&lt;span class="o">=&lt;/span>A1a-6hRTGNaShFIEGLvp psql -U v-root-app-ydbbHqVq1gYQqsUxMuIc-1565857370 -h 172.17.0.2 -d app
psql &lt;span class="o">(&lt;/span>11.4&lt;span class="o">)&lt;/span>
Type &lt;span class="s2">&amp;#34;help&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> help.
&lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; &lt;span class="se">\d&lt;/span>t
List of relations
Schema &lt;span class="p">|&lt;/span> Name &lt;span class="p">|&lt;/span> Type &lt;span class="p">|&lt;/span> Owner
--------+---------+-------+----------
public &lt;span class="p">|&lt;/span> product &lt;span class="p">|&lt;/span> table &lt;span class="p">|&lt;/span> postgres
&lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> row&lt;span class="o">)&lt;/span>
&lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="c1"># \du&lt;/span>
List of roles
Role name &lt;span class="p">|&lt;/span> Attributes &lt;span class="p">|&lt;/span> Member of
--------------------------------------------+------------------------------------------------------------+-----------
postgres &lt;span class="p">|&lt;/span> Superuser, Create role, Create DB, Replication, Bypass RLS &lt;span class="p">|&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="o">}&lt;/span>
v-root-app-ydbbHqVq1gYQqsUxMuIc-1565857370 &lt;span class="p">|&lt;/span> Password valid &lt;span class="k">until&lt;/span> 2019-08-15 09:22:55+00 &lt;span class="p">|&lt;/span> &lt;span class="o">{&lt;/span>&lt;span class="o">}&lt;/span>
&lt;span class="nv">app&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; quit&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/postgres-connect.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/postgres-connect.sh" target="_blank">postgres-connect.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Si el usuario y contraseña no es correcto no se permite la conexión a la base de datos.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">bash-5.0# &lt;span class="nv">PGPASSWORD&lt;/span>&lt;span class="o">=&lt;/span>tampered psql -U v-root-app-ydbbHqVq1gYQqsUxMuIc-1565857370 -h 172.17.0.2 -d app
psql: FATAL: password authentication failed &lt;span class="k">for&lt;/span> user &lt;span class="s2">&amp;#34;v-root-app-ydbbHqVq1gYQqsUxMuIc-1565857370&amp;#34;&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/postgres-connect-fail.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/code/postgres-connect-fail.sh" target="_blank">postgres-connect-fail.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>En las aplicaciones Java que utilizan &lt;a href="https://spring.io/">Spring&lt;/a> el proyecto &lt;a href="https://cloud.spring.io/spring-cloud-vault/">Spring Cloud Vault&lt;/a> proporciona las utilidades para simplificar en gran medida la obtención de las credenciales a la base de datos utilizando Vault.&lt;/p>
&lt;p>Esto permite que únicamente Vault conozca la cuenta &lt;em>root&lt;/em> de la base de datos o una con suficientes permisos para crear credenciales, las aplicaciones no almacenan en su configuración las credenciales para conectarse la base de datos solo las de Vault que le permiten obtener unas credenciales para la base de datos con un tiempo de vida limitado y que pueden revocarse desde Vault en caso de un problema de seguridad para cuales quiera bases de datos que se utilicen.&lt;/p>
&lt;div class="reference">
Referencia:&lt;br>
&lt;ul>
&lt;li>&lt;a href="https://picodotdev.github.io/blog-bitix/series/docker/">Serie de artículos sobre Docker&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://picodotdev.github.io/blog-bitix/2017/05/introduccion-a-la-base-de-datos-relacional-postgresql/">Introducción a la base de datos relacional PostgreSQL&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div></content><category term="programacion"/><category term="planeta-codigo"/><category term="software"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/</id><title>Administrar secretos y proteger datos sensibles con Vault</title><updated>2019-07-27T23:00:00+02:00</updated><published>2019-07-27T18:30:00+02:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/"/><author><name>picodotdev</name></author><content type="html">
&lt;p>&lt;strong>Herramientas de aprovisionamiento como Chef, Puppet y Ansible solucionan el problema de la seguridad de los secretos de forma similar, utilizando una única clave de cifrado. Los datos cifrados están siempre a un secreto (contraseña, clave, &amp;hellip;) de ser descifrados y generalmente no está bien protegidos dado que en un entorno elástico cada servidor necesita disponer de este secreto para descifrar los datos. Adicionalmente el acceso a los datos cifrados no está registrado de modo que si hay una intrusión no está claro que dato ha sido accedido y por quien. Utilizar variables de entorno para proporcionar secretos tampoco es seguro, y en entornos Docker suele usarse.&lt;/strong>&lt;/p>
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/vault.svg" class="right " width="200" alt="Vault" title="Vault"/>
&lt;/div>
&lt;div class="logotypes" style="float: right; clear: right;">
&lt;img src="assets/images/logotipos/hashicorp.svg" class="right " width="200" alt="HashiCorp" title="HashiCorp"/>
&lt;/div>
&lt;p>La seguridad es un aspecto muy importante de los sistemas informáticos, no darle la consideración necesaria puede dar lugar a caídas de servicio y robo de datos potencialmente ocasionando importantes pérdidas de dinero, sanciones y pérdida de confianza de los clientes y proveedores de una organización.&lt;/p>
&lt;p>La seguridad se mantiene mediante mecanismos de autenticación identifican al solicitante solicitante, de autorización permitiendo realiza únicamente las acciones para las que se tienen permisos y mediante firma y cifrado para impedir la modificación de los datos y el acceso a la información sin las credenciales y autorización requerida.&lt;/p>
&lt;p>La infraestructura informática de los sistemas actuales es cada vez más compleja por el número y tipo de las distintas de piezas que emplean como bases de datos, sistemas de mensajes u otros servicios, también por el aspecto efímero en la tendencia actual de microservicios como por la utilización de entornos en la nube con una infraestructura no confiable al estar fuera del control de una organización y estar compartida con otras organizaciones.&lt;/p>
&lt;p>No es seguro utilizar archivos sin cifrar aún utilizando los permisos del sistema de archivos dado que una intrusión en el sistema posibilita el acceso al secreto. Cifrarlos los archivos es el mismo caso de herramientas como &lt;a href="https://www.getchef.com/">Chef&lt;/a>, &lt;a href="https://puppet.com/">Puppet&lt;/a> y &lt;a href="https://www.ansible.com/">Ansible&lt;/a>. Utilizar variables de entorno para proporcionar secretos tampoco es seguro ya que aunque los secretos no están en el sistema de archivos se pueden inspeccionar las variables de entorno de un proceso.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ env &lt;span class="p">|&lt;/span> grep SECRET
$ docker inspect
$ sudo cat /proc/&lt;span class="nv">$pid&lt;/span>/environ&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/code/commands.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/code/commands.sh" target="_blank">commands.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Por otra parte las contraseñas y claves han de rotarse regularmente para limitar en el tiempo el acceso ante el filtrado de las credenciales en un sistema o para denegar el acceso a una persona que en algún momento haya tenido credenciales de acceso como un empleado que ya no pertenece a la compañía.&lt;/p>
&lt;h3 id="vault">Vault&lt;/h3>
&lt;p>&lt;a href="https://www.vaultproject.io/">Vault&lt;/a> es una herramienta para acceder de forma segura a secretos. Un secreto es cualquier cosa a la que se quiera tener severamente controlado como claves de API, contraseñas y certificados. Vault proporciona una interfaz para cualquier secreto a la vez que mantiene un control de acceso y un &lt;em>log&lt;/em> de acceso detallado.&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.vaultproject.io/docs/what-is-vault/index.html">Introduction to Vault&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vaultproject.io/docs/use-cases/index.html">Use Cases&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>Las características principales de Vault se engloban en tres aspectos de la seguridad: cifrado, control de acceso y ciclo de vida.&lt;/p>
&lt;ul>
&lt;li>Almacenamiento seguro de secretos: se pueden almacenar secretos arbitrarios clave/valor. Los secretos son cifrados previamente a ser almacenados en el almacenamiento persistente de modo que obtener acceso al almacenamiento persistente no es suficiente para acceder a los secretos. Vault puede almacenar los secretos en disco, &lt;a href="https://www.consul.io/">Consul&lt;/a> y más.&lt;/li>
&lt;li>Secretos dinámicos: puede &lt;a href="https://picodotdev.github.io/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/">generar secretos bajo demanda para bases de datos&lt;/a> o algunos sistemas como AWS. Por ejemplo, cuando una aplicación necesita acceso a una base de datos SQL solicita a Vault unas credenciales, Vault genera unas credenciales con los permisos adecuados. Después de crear estos secretos dinámicos también los revoca automáticamente una vez pasado su tiempo de concesión.&lt;/li>
&lt;li>Cifrado de datos: puede cifrar y descifrar datos sin almacenarlos. Esto permite definir parámetros de seguridad y los desarrolladores almacenar los datos cifrados en localizaciones como bases de datos sin tener que diseñar sus propios métodos de cifrado.&lt;/li>
&lt;li>Concesión y renovación: todos los secretos en Vault tienen un tiempo de concesión asociado. Al finalizar la concesión Vault los revoca automáticamente, los clientes pueden solicitar renovar las concesiones mediante las API disponibles de Vault.&lt;/li>
&lt;li>Revocación: integra la funcionalidad de revocación, no solo secretos individuales sino jerarquías de secretos. La revocación asiste en la rotación de las claves así como cerrar el sistema en caso de intrusión.&lt;/li>
&lt;/ul>
&lt;h3 id="conceptos">Conceptos&lt;/h3>
&lt;p>Los motores de secretos son uno de los conceptos en el ámbito de Vault. Son componentes que permite almacenar, generar o cifrar datos. Algunos motores de secretos simplemente almacenan y leen datos, otros se conectan a otros servicios y generan credenciales dinámicamente bajo demanda. Otros motores de secretos proporcionan el cifrado como servicio, &lt;em>tokens&lt;/em> de un solo uso, certificados y mucho más.&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.vaultproject.io/api/secret/index.html">Secrets Engines&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vaultproject.io/docs/secrets/kv/index.html">KV Secrets Engine&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vaultproject.io/docs/secrets/databases/index.html">Databases Secrets Engine&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vaultproject.io/docs/secrets/rabbitmq/index.html">RabbitMQ Secrets Engine&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vaultproject.io/docs/secrets/pki/index.html">PKI Secrets Engine&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vaultproject.io/docs/secrets/ssh/index.html">SSH Secrets Engine&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>Otro concepto es la &lt;a href="https://www.vaultproject.io/docs/auth/index.html">autenticación&lt;/a>. Permiten realizar la autenticación y son responsables de asignar una identidad y un conjunto de &lt;em>policies&lt;/em> a un usuario. Por ejemplo, para los desarrolladores el método de autenticación de GitHub es fácil de usar pero para servidores el método &lt;em>AppRole&lt;/em> es el recomendado&lt;/p>
&lt;p>Los secretos necesitan &lt;a href="https://www.vaultproject.io/docs/configuration/storage/index.html">almacenamiento&lt;/a>. Algunos tipos de almacenamiento son mejores para la alta disponibilidad y otros facilitan la copia de seguridad y la restauración. Puede ser en memoria, sistema de archivos, una herramienta como Consul o varias bases de datos entre ellas bases de datos relacionales.&lt;/p>
&lt;p>La &lt;a href="(https://www.vaultproject.io/docs/audit/index.html)">auditoria&lt;/a> permite obtener una trazabilidad de las operaciones que se han realizado, dado que todas las operaciones se realizan mediante una API el &lt;em>log&lt;/em> de auditoría es simplemente cada interacción autenticada con Vault, incluidas los errores. Puede ser un archivo o un &lt;em>socket&lt;/em>.&lt;/p>
&lt;p>Todo en Vault está basado en &lt;em>paths&lt;/em>. Las &lt;a href="(https://www.vaultproject.io/docs/concepts/policies.html)">&lt;em>policies&lt;/em>&lt;/a> permiten o deniegan el acceso a ciertos &lt;em>paths&lt;/em>. Poseen la siguiente sintaxis, donde las &lt;em>capabilities&lt;/em> son las operaciones CRUD permitidas.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">path &amp;#34;secret/*&amp;#34; {
capabilities = [&amp;#34;create&amp;#34;, &amp;#34;read&amp;#34;, &amp;#34;update&amp;#34;, &amp;#34;delete&amp;#34;, &amp;#34;list&amp;#34;]
}&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/code/policy.hcl" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/code/policy.hcl" target="_blank">policy.hcl&lt;/a>
&lt;/div>
&lt;/div>
&lt;h3 id="instalación-y-un-caso-de-uso">Instalación y un caso de uso&lt;/h3>
&lt;p>La &lt;a href="https://www.vaultproject.io/docs/install/index.html">instalación de Vault&lt;/a> es muy sencilla ya que es un único binario sin más dependencias. En una distribución &lt;a href="https://www.gnu.org/">GNU&lt;/a>/&lt;a href="https://www.linux.com/">Linux&lt;/a> estará en los repositorios oficiales. En &lt;a href="https://www.archlinux.org/">Arch Linux&lt;/a> se instala con el comando.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ sudo pacman -S vault&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/code/install.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/code/install.sh" target="_blank">install.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>En el siguiente ejemplo en modo desarrollo de uso de Vault se inicia, se realiza la autenticación con el &lt;em>token&lt;/em> &lt;em>root&lt;/em> de superusuario y se crea un secreto. Aquí solo se muestra el caso de uso de guardar y recuperar secretos, otros son generar credenciales para conectarse a una base de datos y proporcionar cifrado y descifrado como servicio.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ vault server -dev
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Vault server configuration:
Api Address: http://127.0.0.1:8200
Cgo: disabled
Cluster Address: https://127.0.0.1:8201
Listener 1: tcp &lt;span class="o">(&lt;/span>addr: &lt;span class="s2">&amp;#34;127.0.0.1:8200&amp;#34;&lt;/span>, cluster address: &lt;span class="s2">&amp;#34;127.0.0.1:8201&amp;#34;&lt;/span>, max_request_duration: &lt;span class="s2">&amp;#34;1m30s&amp;#34;&lt;/span>, max_request_size: &lt;span class="s2">&amp;#34;33554432&amp;#34;&lt;/span>, tls: &lt;span class="s2">&amp;#34;disabled&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
Log Level: info
Mlock: supported: true, enabled: &lt;span class="nb">false&lt;/span>
Storage: inmem
Version: Vault v1.1.1
Version Sha: a3dcd63451cf6da1d04928b601bbe9748d53842e
WARNING! dev mode is enabled! In this mode, Vault runs entirely in-memory
and starts unsealed with a single unseal key. The root token is already
authenticated to the CLI, so you can immediately begin using Vault.
You may need to &lt;span class="nb">set&lt;/span> the following environment variable:
$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">VAULT_ADDR&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;http://127.0.0.1:8200&amp;#39;&lt;/span>
The unseal key and root token are displayed below in &lt;span class="k">case&lt;/span> you want to
seal/unseal the Vault or re-authenticate.
Unseal Key: &lt;span class="nv">R6MKrMxcJtTTUuIjeQjwDxnv4sHbKtjmuRn0Fok98zk&lt;/span>&lt;span class="o">=&lt;/span>
Root Token: s.hQoeIivTHHgl1AtsoVz1UF1G
Development mode should NOT be used in production installations!&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/code/vault.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/code/vault.sh" target="_blank">vault.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">VAULT_ADDR&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;http://127.0.0.1:8200&amp;#39;&lt;/span>
$ vault kv put secret/key &lt;span class="nv">key&lt;/span>&lt;span class="o">=&lt;/span>s3cr3t
Key Value
--- -----
created_time 2019-07-27T17:30:29.559274833Z
deletion_time n/a
destroyed &lt;span class="nb">false&lt;/span>
version &lt;span class="m">1&lt;/span>
$ vault kv get secret/key
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="nv">Metadata&lt;/span> &lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>
Key Value
--- -----
created_time 2019-07-27T17:30:29.559274833Z
deletion_time n/a
destroyed &lt;span class="nb">false&lt;/span>
version &lt;span class="nv">1&lt;/span>
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span> &lt;span class="nv">Data&lt;/span> &lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>
Key Value
--- -----
key s3cr3t&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/code/secret.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/code/secret.sh" target="_blank">secret.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Vault al igual que otras de las herramientas de &lt;a href="https://www.hashicorp.com/">HashiCorp&lt;/a> como Consul y &lt;a href="https://www.nomadproject.io/">Nomad&lt;/a> posee una interfaz gráfica accesible mediante el navegador que permite realizar las mismas operaciones que a través de la API o desde la linea de comandos.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/images/vault-ui-1_hu835606e7b9de313fbe556011bb61b531_35945_2560x1440_fit_box_2.png" title="Interfaz gráfica de Vault" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/images/vault-ui-1_hu835606e7b9de313fbe556011bb61b531_35945_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/images/vault-ui-2_hu643c4f275edb6aabb6ede21353b42f5b_36609_2560x1440_fit_box_2.png" title="" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/images/vault-ui-2_hu643c4f275edb6aabb6ede21353b42f5b_36609_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;figcaption>Interfaz gráfica de Vault&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>Vault a igual que otras de las herramientas de HashiCorp tiene una muy buena documentación en formato de &lt;a href="https://learn.hashicorp.com/vault">guía&lt;/a> y en formato de &lt;a href="https://www.vaultproject.io/docs/">documentación&lt;/a>. En una aplicación Java el proyecto &lt;a href="https://spring.io/">Spring&lt;/a> facilita su uso con &lt;a href="https://projects.spring.io/spring-vault/">Spring Vault&lt;/a> y &lt;a href="https://cloud.spring.io/spring-cloud-vault/">Spring Cloud Vault&lt;/a>.&lt;/p>
&lt;div class="reference">
Referencia:&lt;br>
&lt;ul>
&lt;li>&lt;a href="https://www.baeldung.com/vault">An Intro to Vault&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div></content><category term="planeta-codigo"/><category term="programacion"/><category term="software"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/06/comprobar-la-seguridad-de-un-sitio-web-que-use-ssl-tls/</id><title>Comprobar la seguridad de un sitio web que use SSL/TLS</title><updated>2019-06-23T12:00:00+02:00</updated><published>2019-06-23T12:00:00+02:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/06/comprobar-la-seguridad-de-un-sitio-web-que-use-ssl-tls/"/><author><name>picodotdev</name></author><content type="html">
&lt;p>Aunque un sitio web no trate datos sensibles como tarjetas de crédito o datos personales es muy recomendable que use el protocolo seguro HTTPS para proporcionar cifrado entre el servidor y el navegador del usuario para dotar de confidencialidad a las comunicaciones a la vez que evitar modificaciones por terceras personas de los datos transmitidos. Además, el buscador Google lo tiene en cuenta para el SEO o posicionamiento en su buscador.&lt;/p>
&lt;p>Para usar HTTPS lo difícil era conseguir un certificado firmado por una autoridad de confianza que los navegadores tengan instalada, la obtención y renovación de un certificado tenía un coste. Desde hace un tiempo la autoridad &lt;a href="https://letsencrypt.org/">Let&amp;rsquo;s encrypt&lt;/a> emite certificados digitales gratuitamente que proporciona uno en pocos minutos y de forma automatizada incluida la renovación para usar un protocolo seguro. &lt;a href="https://picodotdev.github.io/blog-bitix/2017/08/instalar-y-renovar-un-certificado-de-lets-encrypt-en-nginx/">Usar un certificado de Let&amp;rsquo;s encrypt en el servidor web nginx&lt;/a> no es complicado.&lt;/p>
&lt;p>Sin embargo, usar HTTPS simplemente no es suficiente y ha de configurarse el servidor web para que utilice algoritmos de cifrado fuertes y que no tengan problemas seguridad conocidos o hoy estén ya considerados débiles. Para analizar el nivel de seguridad proporcionado en las conexiones HTTPS de un servidor web se puede utilizar la herramienta &lt;a href="https://www.ssllabs.com/">Qualys SSL Labs&lt;/a>. Por ejemplo, analizando la seguridad del protocolo HTTPS ofrecido por &lt;a href="https://pages.github.com/">GitHub Pages&lt;/a> basta con introducir el dominio a analizar.&lt;/p>
&lt;p>El informe que proporciona incluye información sobre el certificado del servidor entre ella su tiempo de validadez y fecha de expiración, y si es de confianza para los navegadores y plataformas como Mozilla, Apple, Android, Java o Windows. Los datos de configuración como protocolos soportados, &lt;em>cipher suites&lt;/em> y una simulación de &lt;em>handshake&lt;/em> con una gran variedad de versiones de navegadores en diferentes plataformas y versiones incluyendo dispositivos móviles y de escritorio que permite conocer si algún dipositivo pudiera tener algún problema con la configuración de TLS en la conexión, también otros detalle del protocolo.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/06/comprobar-la-seguridad-de-un-sitio-web-que-use-ssl-tls/images/ssllabs_hu45897026cba3d1771fd184de0c40861a_124032_2560x1440_fit_box_2.png" title="Informe de seguridad TLS" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/06/comprobar-la-seguridad-de-un-sitio-web-que-use-ssl-tls/images/ssllabs_hu45897026cba3d1771fd184de0c40861a_124032_650x450_fit_box_2.png" width="373"/>&lt;/a>
&lt;figcaption>Informe de seguridad TLS&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>La herramienta proporciona una nota entre A y F siendo la A la mejor calificación posible. Como se observa en la captura para GitHub Pages la herramienta proporciona una calificación de A.&lt;/p>
&lt;p>Hay múltiples combinaciones de algoritmos de cifrado o &lt;em>cipher suites&lt;/em> usados en una conexión SSL/TLS. La primera parte de los siguientes se refieren a TLS, está el tamaño de la clave y el modo y el algoritmo de autenticación del mensaje. Algunas recomendaciones de uso es usar tamaños de clave de más de 128 bits, evitar usar RC4, DES y 3DES, preferir ECDHE y DHE ya que ofrecen &lt;em>forward secrecy&lt;/em> que protege las comunicaciones pasadas aún habiéndose comprometida la clave privada del servidor.&lt;/p>
&lt;ul>
&lt;li>TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384&lt;/li>
&lt;li>TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384&lt;/li>
&lt;li>TLS_RSA_WITH_AES_256_CBC_SHA256&lt;/li>
&lt;li>TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA384&lt;/li>
&lt;li>TLS_ECDH_RSA_WITH_AES_256_CBC_SHA384&lt;/li>
&lt;li>TLS_DHE_RSA_WITH_AES_256_CBC_SHA256&lt;/li>
&lt;li>TLS_DHE_DSS_WITH_AES_256_CBC_SHA256&lt;/li>
&lt;li>TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA&lt;/li>
&lt;li>TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA&lt;/li>
&lt;li>TLS_RSA_WITH_AES_256_CBC_SHA&lt;/li>
&lt;li>TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA&lt;/li>
&lt;li>TLS_ECDH_RSA_WITH_AES_256_CBC_SHA&lt;/li>
&lt;li>TLS_DHE_RSA_WITH_AES_256_CBC_SHA&lt;/li>
&lt;li>TLS_DHE_DSS_WITH_AES_256_CBC_SHA&lt;/li>
&lt;li>TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256&lt;/li>
&lt;/ul>
&lt;p>Y algunas propiedades de los servidores web &lt;a href="https://httpd.apache.org/">Apache HTTP&lt;/a> y &lt;a href="https://nginx.org/">nginx&lt;/a> que afectan a los algoritmos de cifrado soportados son las siguientes. Algunos navegadores antiguos puede que no soporten los últimos algoritmos de cifrado por lo que hay que permitir en el servidor web unos que sean considerados como seguros pero que también soporten los navegadores de los usuarios del sitio web.&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://httpd.apache.org/docs/current/mod/mod_ssl.html">Apache Module mod_ssl&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html">Nginx Module ngx_http_ssl_module&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>Uan vez configurada la seguridad con TLS/SSL es recomendable &lt;a href="https://picodotdev.github.io/blog-bitix/2016/06/como-redirigir-peticiones-de-http-a-https-en-nginx-apache-tomcat-jetty-y-wildfly/">redirigir el tráfico del protocolo HTTP no seguro al protocolo HTTPS seguro&lt;/a>.&lt;/p></content><category term="planeta-codigo"/><category term="seguridad"/><category term="software"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/06/pruebas-de-carga-y-rendimiento-de-un-servicio-web-con-apache-bench/</id><title>Pruebas de carga y rendimiento de un servicio web con Apache Bench</title><updated>2019-06-14T17:00:00+02:00</updated><published>2019-06-14T17:00:00+02:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/06/pruebas-de-carga-y-rendimiento-de-un-servicio-web-con-apache-bench/"/><author><name>picodotdev</name></author><content type="html">
&lt;p>&lt;strong>En algunos que un servicio devuelva los datos esperados no es suficiente, otros requisitos no funcionales o de términos de servicio son que sus tiempos de respuesta sean menores al especificado en sus requisitos, que sea capaz de soportar cierto número de peticiones concurrentes o de atender un número de peticiones por minuto. Para asegurar que el servicio es capaz de cumplir estos requisitos funcionales hay que utilizar herramientas que permitan evaluar su desempeño, una de ellas muy fácil de utilizar y que proporciona valiosa información es Apache Bench.&lt;/strong>&lt;/p>
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/apache.svg" class="right " width="200" alt="Apache" title="Apache"/>
&lt;/div>
&lt;p>Para hacer pruebas de carga o medir el rendimiento de cualquier servicio que funcione mediante el protocolo HTTP hay multitud de herramientas. Una de las más sencillas de utilizar y con un informe con información interesante es &lt;a href="https://httpd.apache.org/docs/current/programs/ab.html">Apache Bench&lt;/a> o simplemente &lt;em>ab&lt;/em>. Este comando se puede utilizar con simplemente tres parámetros el &lt;em>endpoint&lt;/em> a probar, el número de peticiones en total a realizar (&lt;em>-n&lt;/em>) y cuantas peticiones concurrentes al mismo tiempo (&lt;em>-c&lt;/em>). Otos parámetros son los datos POST a enviar, cabeceras (&lt;em>-H&lt;/em>) y &lt;em>cookies&lt;/em> (&lt;em>-C&lt;/em>) de las peticiones, tiempos de &lt;em>timeout&lt;/em> (&lt;em>-s&lt;/em>) o cerficado de cliente (&lt;em>-E&lt;/em>) entre algunos otros. En vez limitar las pruebas a un número de peticiones las pruebas se pueden limitar a un tiempo determinado por ejemplo 60 segundos (&lt;em>-t&lt;/em>).&lt;/p>
&lt;p>Es una herramienta que se utiliza para medir el rendimiento de el servidor Apache pero utilizable para cualquier otro servicio por ejemplo una web o una API REST o &lt;a href="https://graphql.org/">GraphQL&lt;/a>. Está disponible por supuesto para &lt;a href="https://www.gnu.org/">GNU&lt;/a>/&lt;a href="https://www.linux.com/">Linux&lt;/a> pero también para &lt;a href="https://www.apple.com/macos/">macOS&lt;/a> y para &lt;a href="https://www.microsoft.com/es-es/windows/">Windows&lt;/a>.&lt;/p>
&lt;p>Si quisiese medir el rendimiento en mi blog alojado en &lt;a href="https://pages.github.com/">GitHub Pages&lt;/a> podría hacerlo lanzando 1000 peticiones para que sea una muestra suficientemente amplia con 20 usuarios de forma concurrente que son los que en los momentos de más tráfico tiene mi blog. Mi conexión de internet es un ADSL que no llega a 1 MB/s de subida por lo que la conexión en cierta medida limite el test.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ ab -n &lt;span class="m">1000&lt;/span> -c &lt;span class="m">20&lt;/span> https://picodotdev.github.io/blog-bitix/
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/06/pruebas-de-carga-y-rendimiento-de-un-servicio-web-con-apache-bench/code/ab.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/06/pruebas-de-carga-y-rendimiento-de-un-servicio-web-con-apache-bench/code/ab.sh" target="_blank">ab.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>El informe de resultado que ofrece &lt;em>ab&lt;/em> al finalizar la prueba incluye el tiempo dedicado en la conexión, en el procesado, esperando y en total con los valores para cada uno de ellos con mínimo y máximo, de media y la mediana. El tiempo total empleado por la prueba, el protocolo SSL/TLS usado, los bytes devueltos en la petición, el número de peticiones servidas por segundo, el tiempo de media empleado de media por cada petición y de media teniendo en cuenta la concurrencia, la tasa de transferencia en la respuesta y finalmente el tiempo de respuesta según percentil que van que desde el 50 al 100, es decir, que el 50% de las peticiones se han respondido en el tiempo en milisegundos indicado. Si las hubiera también muestra las peticiones fallidas y las que han devuelto un código de respuesta distinto de 200.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">This is ApacheBench, Version 2.3 &amp;lt;$Revision: 1843412 $&amp;gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/
Benchmarking picodotdev.github.io (be patient)
Completed 100 requests
Completed 200 requests
Completed 300 requests
Completed 400 requests
Completed 500 requests
Completed 600 requests
Completed 700 requests
Completed 800 requests
Completed 900 requests
Completed 1000 requests
Finished 1000 requests
Server Software: GitHub.com
Server Hostname: picodotdev.github.io
Server Port: 443
SSL/TLS Protocol: TLSv1.2,ECDHE-RSA-AES128-GCM-SHA256,2048,128
Server Temp Key: X25519 253 bits
TLS Server Name: picodotdev.github.io
Document Path: /blog-bitix/
Document Length: 28389 bytes
Concurrency Level: 20
Time taken for tests: 29.220 seconds
Complete requests: 1000
Failed requests: 0
Total transferred: 29007394 bytes
HTML transferred: 28389000 bytes
Requests per second: 34.22 [#/sec] (mean)
Time per request: 584.404 [ms] (mean)
Time per request: 29.220 [ms] (mean, across all concurrent requests)
Transfer rate: 969.45 [Kbytes/sec] received
Connection Times (ms)
min mean[+/-sd] median max
Connect: 149 349 149.7 303 1361
Processing: 122 225 75.5 207 586
Waiting: 53 122 68.8 108 481
Total: 329 574 174.0 512 1612
Percentage of the requests served within a certain time (ms)
50% 512
66% 534
75% 555
80% 744
90% 832
95% 915
98% 1104
99% 1171
100% 1612 (longest request)&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/06/pruebas-de-carga-y-rendimiento-de-un-servicio-web-con-apache-bench/code/ab.out" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/06/pruebas-de-carga-y-rendimiento-de-un-servicio-web-con-apache-bench/code/ab.out" target="_blank">ab.out&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Esta herramienta puede ser utilizada para par medir el rendimiento de cualquier servicio web. Un blog de &lt;a href="https://wordpress.org/">Wordpress&lt;/a>, una página de una organización, un &lt;em>endpoint&lt;/em> de un servicio REST o GraphQL, etc&amp;hellip; Es muy sencilla de utilizar y genera un informe corto pero con interesante información sobre el rendimiento. Si se hacen cambios se puede medir el antes y el después y comparar los resultados para observar de que modo han afectado al redimiento si de forma positiva o negativa y en que grado.&lt;/p></content><category term="planeta-codigo"/><category term="software"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/</id><title>Registro y descubrimiento de servicios en contenedores de Docker con Consul y Registrator</title><updated>2019-05-26T11:30:00+02:00</updated><published>2019-05-26T11:30:00+02:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/"/><author><name>picodotdev</name></author><content type="html">
&lt;p>&lt;strong>En los microservicios se hace necesario un servicio de registro y descubrimiento como Eureka o Consul que permita conocer la ubicación de las instancias en cada momento. Las instancias de los servicios se pueden registrar ellas mismas o esta tarea se puede delegar en una en otro servicio. Al usar contenedores de Docker una herramienta que permite delegar el registro y desregistro en Consul de los servicios es GliderLabs Registrator.&lt;/strong>&lt;/p>
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/consul.svg" class="right " width="200" alt="Consul" title="Consul"/>
&lt;/div>
&lt;div class="logotypes" style="float: right; clear: right;">
&lt;img src="assets/images/logotipos/docker.svg" class="right " width="200" alt="Docker" title="Docker"/>
&lt;/div>
&lt;p>El registro y descubrimiento de servicios permite a los servicios registrase y a los clientes descubrir la ubicación de otros servicios, la ubicación consiste en la dirección IP y el puerto en el que contactarles. Dado la naturaleza efímera de los servicios donde nuevas instancias de servicios se inician y se detienen en diferentes máquinas y puertos el servicio de descubrimiento es esencial.&lt;/p>
&lt;p>La funcionalidad de registro y descubrimiento consiste en dos partes, por un lado cuando se inicia una instancia de un servicio se registra su ubicación en el servicio de registro y descubrimiento y por otro lado los clientes cuando requieren una instancia de un servicio la buscan en el servicio de descubrimiento.&lt;/p>
&lt;p>El registro en el servicio de descubrimiento puede hacerse de dos formas, que sea el propio servicio el que se registra en el servicio de descubrimiento o que se sea otro servicio el que lo registra. Para el primer caso escribí un artículo con &lt;a href="https://www.consul.io/">Consul&lt;/a> como servicio de descubrimiento en una aplicación de &lt;a href="https://projects.spring.io/spring-boot/">Spring Boot&lt;/a> que se registra al iniciarse. La ventaja es que es autosuficiente pero adquiere la tarea de autoregistrarse. Por el contrario delegar la trea de registro permite extraerla de los servicios y ofrecer esa funcionalidad por un servicio con esa misión específicamente.&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://picodotdev.github.io/blog-bitix/2017/01/registro-y-descubrimiento-de-servicios-con-spring-cloud-y-consul/">Registro y descubrimiento de servicios con Spring Cloud y Consul&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>En este artículo se usa &lt;a href="https://github.com/gliderlabs/registrator">GliderLabs Registrator&lt;/a> como servicio que se encarga de registrar en un servicio de descubrimiento como Consul los servicios que se inicien en &lt;a href="https://www.docker.com/">Docker&lt;/a>, aunque soporta otros como &lt;a href="https://etcd.io/">etcd&lt;/a>.&lt;/p>
&lt;p>Registrator es un contenedor de Docker, su funcionamiento es escuchar los eventos del demonio de Docker y monitorizar cuando se inician nuevos contenedores o cuando se paran. La monitorización la hace a través del &lt;em>socket&lt;/em> del servicio de Docker, para lo que hay que montar un volumen en este contenedor con el archivo &lt;em>/var/run/docker.sock&lt;/em> del &lt;em>host&lt;/em>.&lt;/p>
&lt;p>Primero se inicia el servicio de Consul.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ consul agent -dev
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/consul.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/consul.sh" target="_blank">consul.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Luego se inicia el contenedor Registrator indicando la ubicación con dirección IP y puerto del servicio de Consul.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ docker run --rm --name&lt;span class="o">=&lt;/span>registrator --net&lt;span class="o">=&lt;/span>host --volume&lt;span class="o">=&lt;/span>/var/run/docker.sock:/tmp/docker.sock gliderlabs/registrator:latest consul://localhost:8500
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/docker-registrator.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/docker-registrator.sh" target="_blank">docker-registrator.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Iniciados estos dos servicios en la interfaz de estado de Consul se observa que no hay ningún servicio pero cuando se inicie un nuevo contenedor será registrado en Consul por Registrator.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/images/consul_hudf2f8b03877264bacf83a564e5686ede_36482_2560x1440_fit_box_2.png" title="Dirección" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/images/consul_hudf2f8b03877264bacf83a564e5686ede_36482_300x200_fit_box_2.png" width="287"/>&lt;/a>
&lt;/figure>
&lt;/div>
&lt;p>En este caso se utiliza como servicio una base de datos &lt;a href="https://www.postgresql.org/">PostgreSQL&lt;/a>. Dado que el puerto en el que esté disponible el servicio de PostgreSQL es indiferente al utilizar un servicio de registro y descubrimiento se indica el &lt;em>-p&lt;/em> sin indicar el puerto del &lt;em>host&lt;/em>, de este modo Docker le asigna un puerto público aleatorio.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ docker run --rm --name postgres -e &lt;span class="nv">POSTGRES_USER&lt;/span>&lt;span class="o">=&lt;/span>user -e &lt;span class="nv">POSTGRES_PASSWORD&lt;/span>&lt;span class="o">=&lt;/span>password -e &lt;span class="nv">POSTGRES_DB&lt;/span>&lt;span class="o">=&lt;/span>database -p &lt;span class="m">5432&lt;/span> postgres:alpine
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/docker-postgres.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/docker-postgres.sh" target="_blank">docker-postgres.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
cb7602605725 postgres:alpine &lt;span class="s2">&amp;#34;docker-entrypoint.s…&amp;#34;&lt;/span> &lt;span class="m">54&lt;/span> seconds ago Up &lt;span class="m">53&lt;/span> seconds 0.0.0.0:32777-&amp;gt;5432/tcp postgres
d286341148cb gliderlabs/registrator:latest &lt;span class="s2">&amp;#34;/bin/registrator co…&amp;#34;&lt;/span> About a minute ago Up About a minute registrator&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/docker-ps.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/docker-ps.sh" target="_blank">docker-ps.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>En la salida del contenedor de Registrator se emite una traza indicando que el servicio de postgres ha sido registrado en Consul.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">2019/05/26 11:05:29 Starting registrator v7 ...
2019/05/26 11:05:29 Using consul adapter: consul://localhost:8500
2019/05/26 11:05:29 Connecting to backend (0/0)
2019/05/26 11:05:29 consul: current leader 127.0.0.1:8300
2019/05/26 11:05:29 Listening for Docker events ...
2019/05/26 11:05:29 Syncing services on 1 containers
2019/05/26 11:05:29 ignored: d286341148cb no published ports
2019/05/26 11:05:50 added: cb7602605725 archlinux:postgres:5432&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/docker-registrator.out" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/docker-registrator.out" target="_blank">docker-registrator.out&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Una vez iniciado el servicio de postgres en la consola de Consul se muestra con su dirección y puerto en el que se encuentra, en el contenedor utiliza su puerto por defecto &lt;em>5432&lt;/em> pero hacia el exterior en este caso al no haber especificado uno Docker le asigna un puerto aleatorio en este caso el &lt;em>32777&lt;/em>. Este puerto aleatorio es con el que los clientes acceden a la base de datos.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/images/consul-postgres-1_hu5336dadbc35299bcca8969f84d373cf0_39850_2560x1440_fit_box_2.png" title="Servicio de postgres registrado en Consul" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/images/consul-postgres-1_hu5336dadbc35299bcca8969f84d373cf0_39850_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/images/consul-postgres-2_huf0df6f6a3d2138a93d9a38f4927788b0_43545_2560x1440_fit_box_2.png" title="Servicio de postgres registrado en Consul" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/images/consul-postgres-2_huf0df6f6a3d2138a93d9a38f4927788b0_43545_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;figcaption>Servicio de postgres registrado en Consul por Registrator&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>En vez de iniciar los servicios individualmente con comandos de Docker creando un archivo de &lt;a href="https://docs.docker.com/compose/">Docker Compose&lt;/a> con la definición de todos los contenedores se facilita iniciar todos los contenedores con un comando.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ docker-compose up&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/docker-compose-up.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/docker-compose-up.sh" target="_blank">docker-compose-up.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-YAML" data-lang="YAML">version&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;3.7&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>services&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>consul&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>image&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>consul&lt;span class="p">:&lt;/span>latest&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>container_name&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>consul&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>network_mode&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;host&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>command&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;consul&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;agent&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;-dev&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;-ui&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>registrator&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>image&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>gliderlabs/registrator&lt;span class="p">:&lt;/span>latest&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>container_name&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>registrator&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>network_mode&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;host&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>volumes&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>/var/run/docker.sock&lt;span class="p">:&lt;/span>/tmp/docker.sock&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>entrypoint&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>/bin/registrator&lt;span class="w"> &lt;/span>consul&lt;span class="p">:&lt;/span>//localhost&lt;span class="p">:&lt;/span>&lt;span class="m">8500&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>depends_on&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>consul&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>postgres&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>image&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>postgres&lt;span class="p">:&lt;/span>alpine&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>container_name&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>postgres&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>ports&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;5432&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>environment&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>POSTGRES_USER=user&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>POSTGRES_PASSWORD=password&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>POSTGRES_DB=database&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>depends_on&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>registrator&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/docker-compose.yml" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/code/docker-compose.yml" target="_blank">docker-compose.yml&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>El proyecto de &lt;a href="https://projects.spring.io/spring-cloud/">Spring Cloud&lt;/a> ofrece soporte para ambas tareas de registrar y descubrir servicios, aunque perfectamente la tarea de registro se puede delegar como en este caso a Registrator y utilizar en los servicios de Spring Boot únicamente la parte de descubrimiento.&lt;/p>
&lt;p>
El &lt;a href="https://github.com/picodotdev/blog-ejemplos/tree/master/Registrator">código fuente completo del ejemplo&lt;/a> puedes descargarlo del repositorio de ejemplos de Blog Bitix alojado en &lt;a href="https://github.com/">GitHub&lt;/a> y probarlo en tu equipo ejecutando el comando &lt;code>./docker-compose-up.sh&lt;/code>.
&lt;/p></content><category term="planeta-codigo"/><category term="programacion"/><category term="software"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/</id><title>Crear de forma sencilla y rápida máquinas virtuales de VirtualBox con Vagrant</title><updated>2019-05-10T17:00:00+02:00</updated><published>2019-05-10T17:00:00+02:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/"/><author><name>picodotdev</name></author><content type="html">
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/vagrant.svg" class="right " width="200" alt="Vagrant" title="Vagrant"/>
&lt;/div>
&lt;div class="logotypes" style="float: right; clear: right;">
&lt;img src="assets/images/logotipos/hashicorp.svg" class="right " width="200" alt="HashiCorp" title="HashiCorp"/>
&lt;/div>
&lt;p>&lt;a href="https://www.virtualbox.org/">VirtualBox&lt;/a> es una de las herramientas que permiten virtualizar un sistema operativo completo y sus aplicaciones dentro de otra máquina. Como es un sistema operativo completo requiere que el sistema que la alberga tenga RAM suficiente para sí mismo y RAM suficiente para el sistema virtualizado, se puede configurar la cantidad de RAM y almacenamiento persistente de la máquina virtual. En el proceso de virtualización se pierde algo de rendimiento por la sobrecarga que añade virtualizar un sistema operativo completo, los procesadores modernos ofrecen soporte para que el rendimiento sea lo mayor posible pero no es igual a ejecutar el sistema de forma nativa en el sistema, sobre todo en el aspecto de interfaces gráficas y aceleración 2D y 3D.&lt;/p>
&lt;p>La virtualización es una buena forma de probar una distribución &lt;a href="https://www.gnu.org/">GNU&lt;/a>/&lt;a href="https://www.linux.com/">Linux&lt;/a> para evaluarla o ejecutar &lt;a href="https://www.microsoft.com/es-es/windows/">Windows&lt;/a> en un Linux. Hay otras herramientas de virtualización como &lt;a href="https://www.qemu.org/">QEMU&lt;/a> y &lt;a href="https://www.linux-kvm.org/page/Main_Page">KVM&lt;/a> pero la virtud de VirtualBox es que es muy sencilla y está disponible para Windows, GNU/Linux y &lt;a href="https://www.apple.com/macos/">macOS&lt;/a>.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/images/virtualbox_hu714198bdeca98f2fa85206e0a2e30ff9_109657_2560x1440_fit_box_2.png" title="VirtualBox" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/images/virtualbox_hu714198bdeca98f2fa85206e0a2e30ff9_109657_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;figcaption>VirtualBox&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>Para tener una máquina virtual el proceso se puede hacer desde el principio desde el medio de instalación ofrecido siguiendo los de su instalador. Pero para hacer alguna prueba de desarrollo y si se necesitan virtualizar varias máquinas el proceso manual es incómodo además de repetitivo. &lt;a href="https://www.vagrantup.com/">Vagrant&lt;/a> es una de las herramientas ofrecidas por &lt;a href="https://www.hashicorp.com/">HashiCorp&lt;/a> que permite automatizar la creación y aprovisionamiento de máquinas virtuales en VirtualBox mediante la especificación de un archivo de configuración. Permite replicar entornos y crear un cluster de máquinas que resulta muy útil al desarrollar o probar cierto software.&lt;/p>
&lt;p>En este ejemplo se configura una máquina virtual usando como sistema operativo base Ubuntu 18.04, y se aprovisiona configurando ella &lt;a href="https://www.docker.com/">Docker&lt;/a>. El aprovisionamiento se realiza mediante una serie de comandos y archivos que se añaden del &lt;em>host&lt;/em> al sistema virtualizado tal como se hace en un sistema Ubuntu desde su estado de instalación inicial. Entre las opciones de configuración permitidas están el nombre de la máquina virtual, su sistema operativo, la cantidad de memoria que se le asigna, propiedades de red, asignar direcciones IP estáticas, &amp;hellip;&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="err">#&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="o">-&lt;/span> &lt;span class="n">mode&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">ruby&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="o">-&lt;/span>
&lt;span class="err">#&lt;/span> &lt;span class="n">vi&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">set&lt;/span> &lt;span class="n">ft&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">ruby&lt;/span> &lt;span class="o">:&lt;/span>
&lt;span class="n">Vagrant&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">configure&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;2&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">|&lt;/span>
&lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">define&lt;/span> &lt;span class="s">&amp;#34;ubuntu-docker&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">instance&lt;/span>&lt;span class="o">|&lt;/span>
&lt;span class="n">instance&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">box&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;ubuntu/bionic64&amp;#34;&lt;/span>
&lt;span class="n">instance&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">provider&lt;/span> &lt;span class="o">:&lt;/span>&lt;span class="n">virtualbox&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">vb&lt;/span>&lt;span class="o">|&lt;/span>
&lt;span class="n">vb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;Ubuntu Docker (Vagrant)&amp;#34;&lt;/span>
&lt;span class="n">end&lt;/span>
&lt;span class="n">instance&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">network&lt;/span> &lt;span class="s">&amp;#34;private_network&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ip&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s">&amp;#34;192.168.33.10&amp;#34;&lt;/span>
&lt;span class="n">instance&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">provider&lt;/span> &lt;span class="s">&amp;#34;virtualbox&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">vb&lt;/span>&lt;span class="o">|&lt;/span>
&lt;span class="n">vb&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">memory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;1024&amp;#34;&lt;/span>
&lt;span class="n">instance&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">provision&lt;/span> &lt;span class="s">&amp;#34;file&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">source&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s">&amp;#34;docker-compose.yml&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">destination&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s">&amp;#34;/home/vagrant/docker-compose.yml&amp;#34;&lt;/span>
&lt;span class="n">instance&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">vm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">provision&lt;/span> &lt;span class="s">&amp;#34;shell&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">inline&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="n">$docker_role_script&lt;/span>
&lt;span class="n">end&lt;/span>
&lt;span class="n">end&lt;/span>
&lt;span class="n">$docker_role_script&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">SCRIPT&lt;/span>
&lt;span class="n">echo&lt;/span> &lt;span class="s">&amp;#34;Updating...&amp;#34;&lt;/span>
&lt;span class="n">sudo&lt;/span> &lt;span class="n">apt&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">get&lt;/span> &lt;span class="n">update&lt;/span>
&lt;span class="n">sudo&lt;/span> &lt;span class="n">apt&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">get&lt;/span> &lt;span class="n">upgrade&lt;/span>
&lt;span class="n">echo&lt;/span> &lt;span class="s">&amp;#34;Installing docker...&amp;#34;&lt;/span>
&lt;span class="n">sudo&lt;/span> &lt;span class="n">apt&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">get&lt;/span> &lt;span class="n">install&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="n">apt&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">transport&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">https&lt;/span> &lt;span class="n">ca&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">certificates&lt;/span> &lt;span class="n">curl&lt;/span> &lt;span class="n">gnupg&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">agent&lt;/span> &lt;span class="n">software&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">properties&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">common&lt;/span>
&lt;span class="n">curl&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">fsSL&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="o">:&lt;/span>&lt;span class="c1">//download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">sudo&lt;/span> &lt;span class="n">apt&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">key&lt;/span> &lt;span class="n">fingerprint&lt;/span> &lt;span class="n">0EBFCD88&lt;/span>
&lt;span class="n">sudo&lt;/span> &lt;span class="n">add&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">apt&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">repository&lt;/span> &lt;span class="s">&amp;#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&amp;#34;&lt;/span>
&lt;span class="n">sudo&lt;/span> &lt;span class="n">apt&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">get&lt;/span> &lt;span class="n">update&lt;/span>
&lt;span class="n">sudo&lt;/span> &lt;span class="n">apt&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">get&lt;/span> &lt;span class="n">install&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="n">docker&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">ce&lt;/span> &lt;span class="n">docker&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">ce&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">cli&lt;/span> &lt;span class="n">containerd&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">io&lt;/span>
&lt;span class="n">sudo&lt;/span> &lt;span class="n">usermod&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">aG&lt;/span> &lt;span class="n">docker&lt;/span> &lt;span class="n">vagrant&lt;/span>
&lt;span class="n">sudo&lt;/span> &lt;span class="n">curl&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">L&lt;/span> &lt;span class="s">&amp;#34;https://github.com/docker/compose/releases/download/1.24.0/docker-compose-$(uname -s)-$(uname -m)&amp;#34;&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">o&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">compose&lt;/span>
&lt;span class="n">sudo&lt;/span> &lt;span class="n">chmod&lt;/span> &lt;span class="o">+&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">docker&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">compose&lt;/span>
&lt;span class="n">echo&lt;/span> &lt;span class="s">&amp;#34;Starting Docker service...&amp;#34;&lt;/span>
&lt;span class="n">sudo&lt;/span> &lt;span class="n">systemctl&lt;/span> &lt;span class="n">daemon&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reload&lt;/span>
&lt;span class="n">sudo&lt;/span> &lt;span class="n">systemctl&lt;/span> &lt;span class="n">enable&lt;/span> &lt;span class="n">docker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">service&lt;/span>
&lt;span class="n">sudo&lt;/span> &lt;span class="n">systemctl&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="n">docker&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">service&lt;/span>
&lt;span class="n">SCRIPT&lt;/span>
&lt;span class="n">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/code/Vagrantfile" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/code/Vagrantfile" target="_blank">Vagrantfile&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Se puede crear un archivo inicia con comentarios para empezar a configurar la máquina virtual.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ vagrant init ubuntu/bionic64
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/code/vagrant-init.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/code/vagrant-init.sh" target="_blank">vagrant-init.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Definido el archivo de configuración para Vagrant se inician las máquina virtual con un comando. Y se detienen con otro. Si hay necesidad en el mismo archivo se pueden definir varias máquinas virtuales.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ vagrant up
$ vagrant halt&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/code/vagrant-up.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/code/vagrant-up.sh" target="_blank">vagrant-up.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/images/virtualbox-vagrant-vm_hu714198bdeca98f2fa85206e0a2e30ff9_116254_2560x1440_fit_box_2.png" title="VirtualBox Vagrant VM" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/images/virtualbox-vagrant-vm_hu714198bdeca98f2fa85206e0a2e30ff9_116254_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;figcaption>VirtualBox Vagrant VM&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>Una vez iniciada la máquina virtual Vagrant configura SSH para tener acceso a su terminal, hay que especificar el nombre de la máquina virtual.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ vagrant ssh ubuntu-docker
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/code/vagrant-ssh.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/code/vagrant-ssh.sh" target="_blank">vagrant-ssh.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/images/vagrant-ssh_huf84e0a9edfdc6e443883ef5a755439df_64066_2560x1440_fit_box_2.png" title="Vagrant SSH" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/images/vagrant-ssh_huf84e0a9edfdc6e443883ef5a755439df_64066_300x200_fit_box_2.png" width="244"/>&lt;/a>
&lt;figcaption>Vagrant SSH&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>La máquina en el ejemplo ha sido aprovisionada con Docker mediante un &lt;em>script&lt;/em> con los comandos para instalarlo y un archivo de &lt;a href="https://docs.docker.com/compose/">Docker Compose&lt;/a> con un servicio del servidor web &lt;a href="https://nginx.org/">nginx&lt;/a>. Desde la terminal de la máquina virtual se inicia el servicio con Docker que queda accesible tanto desde la pripia máquina virtual como desde el &lt;em>host&lt;/em> indicando la dirección IP que se le ha asignado.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/images/docker-compose-up_huee84648a7050cd57115fd67bb683562f_66997_2560x1440_fit_box_2.png" title="docker-compose up y curl (desde la MV)" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/images/docker-compose-up_huee84648a7050cd57115fd67bb683562f_66997_300x200_fit_box_2.png" width="281"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/images/curl_hu26f710045e8e9b42060c9d2ccd60a851_58845_2560x1440_fit_box_2.png" title="curl (desde el host)" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/images/curl_hu26f710045e8e9b42060c9d2ccd60a851_58845_300x200_fit_box_2.png" width="244"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/images/firefox_hue938310a76fc8e72c31d7b54d72579d5_35132_2560x1440_fit_box_2.png" title="Página devuelta por nginx" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/images/firefox_hue938310a76fc8e72c31d7b54d72579d5_35132_300x200_fit_box_2.png" width="300"/>&lt;/a>
&lt;figcaption>docker-compose up y curl desde la MV y desde el host&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>Vagrant tiene un &lt;a href="https://app.vagrantup.com/boxes/search">repositorio de imágenes&lt;/a> entre las que elegir para el sistema, están las más populares como &lt;a href="https://www.ubuntu.com/">Ubuntu&lt;/a>, &lt;a href="https://fedoraproject.org/">Fedora&lt;/a>, &lt;a href="https://www.debian.org/">Debian&lt;/a> y &lt;a href="https://www.centos.org/">CentOS&lt;/a>. Es un repositorio en donde los usuarios pueden subir sus propias imágenes aunque por defecto es mejor usar las oficiales de cada sistema.&lt;/p>
&lt;p>Posee varias &lt;a href="https://www.vagrantup.com/docs/index.html">páginas de documentación&lt;/a> bastante completas donde conocer los todos los detalles de uso de Vagrant.&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.vagrantup.com/docs/vagrantfile/">Vagrantfile&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vagrantup.com/docs/cli/">Commands&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vagrantup.com/docs/networking/">Networking&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vagrantup.com/docs/provisioning/">Provisioning&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vagrantup.com/docs/multi-machine/">Multi-machine&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vagrantup.com/docs/providers/">Providers&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vagrantup.com/docs/synced-folders/">Synced folders&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>
El &lt;a href="https://github.com/picodotdev/blog-ejemplos/tree/master/Vagrant">código fuente completo del ejemplo&lt;/a> puedes descargarlo del repositorio de ejemplos de Blog Bitix alojado en &lt;a href="https://github.com/">GitHub&lt;/a> y probarlo en tu equipo ejecutando el comando &lt;code>vagrant up&lt;/code>.
&lt;/p></content><category term="planeta-codigo"/><category term="programacion"/><category term="software"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/</id><title>Servicios con persistencia en el orquestador de microservicos Nomad</title><updated>2019-04-26T20:00:00+02:00</updated><published>2019-04-26T19:00:00+02:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/"/><author><name>picodotdev</name></author><content type="html">
&lt;p>&lt;strong>Los servicios que necesitan almacenar datos como las bases de datos o un sistema de archivos tienen más restricciones que los servicios sin estado por la necesidad de tener acceso a esos datos. Esto hace que los contenedores puedan no tener tantan libertad para iniciarse en cualquier nodo. En Nomad una estategia es imponer ciertas restricciones a los servicios que almacenen estado para que solo se puedan iniciar en el nodo que donde estén almacenados.&lt;/strong>&lt;/p>
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/nomad.svg" class="right " width="200" alt="Nomad" title="Nomad"/>
&lt;/div>
&lt;div class="logotypes" style="float: right; clear: right;">
&lt;img src="assets/images/logotipos/hashicorp.svg" class="right " width="200" alt="HashiCorp" title="HashiCorp"/>
&lt;/div>
&lt;p>Algunos servicios no necesitan almacenar ningún estado porque no lo necesitan o porque el estado se mantiene en otro servicio. Que un servicio no necesite mantener estado es bueno porque de esta manera el servicio se puede escalar al número de instancias adecuadas para prestar el servicio, también porque si falla una instancia la petición puede ser reenviada a otra instancia, una instancia que falla puede ser reemplazada sin problema en otro &lt;em>host&lt;/em>. Sin embargo, hay otro tipo de instancias que si almacenan estado como las bases de datos ya sea &lt;a href="https://www.postgresql.org/">PostgreSQL&lt;/a>, &lt;a href="https://www.mysql.com/">MySQL&lt;/a>, &lt;a href="https://redis.io/">Redis&lt;/a>, &lt;a href="https://www.mongodb.com/">MongoDB&lt;/a>, otra o simplemente archivos en el sistema de archivos.&lt;/p>
&lt;p>Las instancias que tienen estado no son tan fáciles de reemplazar dado que los datos son necesarios para su funcionamiento, una instancia de un servicio con estado como no puede iniciarse en otro nodo libremente solo se puede iniciar en el nodo que contenga los datos. Eso o cuando el servicio se inicia en otro nodo los datos son trasladados o por algún mechanismo transparente a los servicios están disponibles en el nuevo nodo.&lt;/p>
&lt;p>En &lt;a href="https://docs.docker.com/swarm/">Docker Swarm&lt;/a> ciertos &lt;em>drivers&lt;/em> de volúmenes pueden proporcionar volúmenes accesibles desde cualquier &lt;em>host&lt;/em> del &lt;em>cluster&lt;/em> pero por defecto &lt;em>Swarm&lt;/em> no lo ofrece. En &lt;a href="https://kubernetes.io/">Kubernetes&lt;/a> los volúmenes pueden ser dispositivos de almacenamiento provenientes de &lt;a href="https://aws.amazon.com/es/ebs/">EBS&lt;/a> de modo que si un &lt;em>pod&lt;/em> es movido a otro &lt;em>host&lt;/em> basta con que el &lt;em>pod&lt;/em> sea conectado de nuevo al EBS anterior y los datos están accesibles en el nuevo nodo.&lt;/p>
&lt;p>&lt;a href="https://www.nomadproject.io/">Nomad&lt;/a> no proporciona soporte para que el almacenamiento persistente sea migrado a un nuevo nodo de Nomad si el servicio cambiado de ubicación. Para solventar esta limitación en el caso de los servicios con estado estos pueden ser tratados en cierta forma como animales de compañía o &lt;em>pets&lt;/em> haciendo que siempre se ubiquen en el mismo nodo, una vez tiene siempre la misma ubicación basta con proporcionar el almacenamiento en el &lt;em>host&lt;/em> ya sea en su sistema de archivos o para externalizarlo montando un almacenamiento &lt;em>EBS&lt;/em>.&lt;/p>
&lt;p>Para conseguir que un &lt;em>job&lt;/em> de Nomad se ubique siempre en un mismo nodo hay que usar &lt;a href="https://www.nomadproject.io/docs/job-specification/constraint.html">restricciones o &lt;em>costraints&lt;/em> en la especificación del &lt;em>job&lt;/em>&lt;/a>. Las restricciones son las reglas que utiliza Nomad para elegir como candidatos los posibles nodos en los que ubicar el &lt;em>job&lt;/em>, &lt;em>task group&lt;/em> o &lt;em>task&lt;/em>. Se pueden utilizar varios operadores entre los que está el de igualdad utilizado en el ejemplo. Una de las variables utilizables es el identificativo del nodo de Nomad, con él es posible conseguir que el &lt;em>job&lt;/em> se ubique siempre en el mismo nodo. Los identificativos de los nodos son asignados por Nomad cuando se unen al &lt;em>cluster&lt;/em>.&lt;/p>
&lt;p>Con los siguientes comandos se inspecciona los nodos que forman parte del cluster de Nomad, entre sus datos está el identificativo de cada nodo formado por una cadena de 36 caracteres. En el modo verboso se emite el identificativo completo y una lista de propiedades del nodo entre los que están detalles de Consul, la CPU, &lt;em>driver&lt;/em> que soporta, kernel, sistema operativo, &amp;hellip; En documentación sobre &lt;a href="https://www.nomadproject.io/docs/runtime/interpolation.html">interpolación de variables&lt;/a> hay una lista de variables disponibles.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ nomad node status
ID DC Name Class Drain Eligibility Status
44511e01 localhost archlinux &amp;lt;none&amp;gt; &lt;span class="nb">false&lt;/span> eligible ready
$ nomad node status 44511e01
&lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> 44511e01
&lt;span class="nv">Name&lt;/span> &lt;span class="o">=&lt;/span> archlinux
&lt;span class="nv">Class&lt;/span> &lt;span class="o">=&lt;/span> &amp;lt;none&amp;gt;
&lt;span class="nv">DC&lt;/span> &lt;span class="o">=&lt;/span> localhost
&lt;span class="nv">Drain&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">false&lt;/span>
&lt;span class="nv">Eligibility&lt;/span> &lt;span class="o">=&lt;/span> eligible
&lt;span class="nv">Status&lt;/span> &lt;span class="o">=&lt;/span> ready
&lt;span class="nv">Uptime&lt;/span> &lt;span class="o">=&lt;/span> 1h40m31s
Driver &lt;span class="nv">Status&lt;/span> &lt;span class="o">=&lt;/span> docker,exec,java,qemu,raw_exec
Node Events
Time Subsystem Message
2019-04-26T17:57:41+02:00 Cluster Node registered
Allocated Resources
CPU Memory Disk
0/30400 MHz &lt;span class="m">0&lt;/span> B/31 GiB &lt;span class="m">0&lt;/span> B/16 GiB
Allocation Resource Utilization
CPU Memory
0/30400 MHz &lt;span class="m">0&lt;/span> B/31 GiB
Host Resource Utilization
CPU Memory Disk
3288/30400 MHz 5.2 GiB/31 GiB &lt;span class="o">(&lt;/span>tmpfs&lt;span class="o">)&lt;/span>
Allocations
No allocations placed
$ nomad node status -verbose 44511e01
&lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> 44511e01-34b8-c1e6-7fe5-60be0ff35d0e
&lt;span class="nv">Name&lt;/span> &lt;span class="o">=&lt;/span> archlinux
&lt;span class="nv">Class&lt;/span> &lt;span class="o">=&lt;/span> &amp;lt;none&amp;gt;
&lt;span class="nv">DC&lt;/span> &lt;span class="o">=&lt;/span> localhost
&lt;span class="nv">Drain&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">false&lt;/span>
&lt;span class="nv">Eligibility&lt;/span> &lt;span class="o">=&lt;/span> eligible
&lt;span class="nv">Status&lt;/span> &lt;span class="o">=&lt;/span> ready
&lt;span class="nv">Uptime&lt;/span> &lt;span class="o">=&lt;/span> 1h44m39s
Drivers
Driver Detected Healthy Message Time
docker &lt;span class="nb">true&lt;/span> &lt;span class="nb">true&lt;/span> Healthy 2019-04-26T17:57:41+02:00
&lt;span class="nb">exec&lt;/span> &lt;span class="nb">true&lt;/span> &lt;span class="nb">true&lt;/span> Healthy 2019-04-26T17:57:41+02:00
java &lt;span class="nb">true&lt;/span> &lt;span class="nb">true&lt;/span> Healthy 2019-04-26T17:57:41+02:00
qemu &lt;span class="nb">true&lt;/span> &lt;span class="nb">true&lt;/span> Healthy 2019-04-26T17:57:41+02:00
raw_exec &lt;span class="nb">true&lt;/span> &lt;span class="nb">true&lt;/span> Healthy 2019-04-26T17:57:41+02:00
rkt &lt;span class="nb">false&lt;/span> &lt;span class="nb">false&lt;/span> Failed to execute rkt version: exec: &lt;span class="s2">&amp;#34;rkt&amp;#34;&lt;/span>: executable file not found in &lt;span class="nv">$PATH&lt;/span> 2019-04-26T17:57:41+02:00
Node Events
Time Subsystem Message Details
2019-04-26T17:57:41+02:00 Cluster Node registered &amp;lt;none&amp;gt;
Allocated Resources
CPU Memory Disk
100/30400 MHz 1.0 GiB/31 GiB &lt;span class="m">300&lt;/span> MiB/16 GiB
Allocation Resource Utilization
CPU Memory
19/30400 MHz &lt;span class="m">38&lt;/span> MiB/31 GiB
Host Resource Utilization
CPU Memory Disk
4564/30400 MHz 5.5 GiB/31 GiB &lt;span class="o">(&lt;/span>tmpfs&lt;span class="o">)&lt;/span>
Allocations
ID Eval ID Node ID Task Group Version Desired Status Created Modified
cd45371d-501a-1373-dfde-bb16c4ff20d3 ab9f5675-b5cb-9e5f-8e20-cb308dbfba32 44511e01-34b8-c1e6-7fe5-60be0ff35d0e services &lt;span class="m">3&lt;/span> run running 2019-04-26T18:14:28+02:00 2019-04-26T18:16:32+02:00
Attributes
consul.datacenter &lt;span class="o">=&lt;/span> localhost
consul.revision &lt;span class="o">=&lt;/span> ea5210a30
consul.server &lt;span class="o">=&lt;/span> &lt;span class="nb">true&lt;/span>
consul.version &lt;span class="o">=&lt;/span> 1.4.4
cpu.arch &lt;span class="o">=&lt;/span> amd64
cpu.frequency &lt;span class="o">=&lt;/span> &lt;span class="m">3800&lt;/span>
cpu.modelname &lt;span class="o">=&lt;/span> Intel&lt;span class="o">(&lt;/span>R&lt;span class="o">)&lt;/span> Core&lt;span class="o">(&lt;/span>TM&lt;span class="o">)&lt;/span> i5-8259U CPU @ 2.30GHz
cpu.numcores &lt;span class="o">=&lt;/span> &lt;span class="m">8&lt;/span>
cpu.totalcompute &lt;span class="o">=&lt;/span> &lt;span class="m">30400&lt;/span>
driver.docker &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
driver.docker.bridge_ip &lt;span class="o">=&lt;/span> 172.17.0.1
driver.docker.os_type &lt;span class="o">=&lt;/span> linux
driver.docker.runtimes &lt;span class="o">=&lt;/span> runc
driver.docker.version &lt;span class="o">=&lt;/span> 18.09.4-ce
driver.docker.volumes.enabled &lt;span class="o">=&lt;/span> &lt;span class="nb">true&lt;/span>
driver.exec &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
driver.java &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
driver.java.runtime &lt;span class="o">=&lt;/span> OpenJDK Runtime Environment &lt;span class="o">(&lt;/span>build 1.8.0_212-b01&lt;span class="o">)&lt;/span>
driver.java.version &lt;span class="o">=&lt;/span> 1.8.0_212
driver.java.vm &lt;span class="o">=&lt;/span> OpenJDK 64-Bit Server VM &lt;span class="o">(&lt;/span>build 25.212-b01, mixed mode&lt;span class="o">)&lt;/span>
driver.qemu &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
driver.qemu.version &lt;span class="o">=&lt;/span> 3.1.0
driver.raw_exec &lt;span class="o">=&lt;/span> &lt;span class="m">1&lt;/span>
kernel.name &lt;span class="o">=&lt;/span> linux
kernel.version &lt;span class="o">=&lt;/span> 5.0.7-arch1-1-ARCH
memory.totalbytes &lt;span class="o">=&lt;/span> &lt;span class="m">33592107008&lt;/span>
nomad.advertise.address &lt;span class="o">=&lt;/span> 127.0.0.1:4646
nomad.revision &lt;span class="o">=&lt;/span> 18dd59056ee1d7b2df51256fe900a98460d3d6b9
nomad.version &lt;span class="o">=&lt;/span> 0.9.0
os.name &lt;span class="o">=&lt;/span> arch
os.signals &lt;span class="o">=&lt;/span> SIGQUIT,SIGTTOU,SIGFPE,SIGTRAP,SIGTSTP,SIGINT,SIGURG,SIGTTIN,SIGUSR1,SIGIO,SIGIOT,SIGKILL,SIGSTOP,SIGCONT,SIGILL,SIGPROF,SIGSEGV,SIGSYS,SIGTERM,SIGXFSZ,SIGHUP,SIGWINCH,SIGABRT,SIGBUS,SIGCHLD,SIGPIPE,SIGUSR2,SIGXCPU,SIGALRM
unique.cgroup.mountpoint &lt;span class="o">=&lt;/span> /sys/fs/cgroup
unique.consul.name &lt;span class="o">=&lt;/span> archlinux
unique.hostname &lt;span class="o">=&lt;/span> archlinux
unique.network.ip-address &lt;span class="o">=&lt;/span> 127.0.0.1
unique.storage.bytesfree &lt;span class="o">=&lt;/span> &lt;span class="m">16795955200&lt;/span>
unique.storage.bytestotal &lt;span class="o">=&lt;/span> &lt;span class="m">16796053504&lt;/span>
unique.storage.volume &lt;span class="o">=&lt;/span> tmpfs
Meta&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/code/nomad-status.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/code/nomad-status.sh" target="_blank">nomad-status.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>En este caso solo hay un nodo registrado en Nomad, la siguiente definición de &lt;em>job&lt;/em> en el fragmento &lt;em>constraint&lt;/em> hace que Nomad lo ubique siempre en él.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">job &amp;#34;mongodb&amp;#34; {
datacenters = [&amp;#34;localhost&amp;#34;]
type = &amp;#34;service&amp;#34;
constraint {
attribute = &amp;#34;${node.unique.id}&amp;#34;
value = &amp;#34;44511e01-34b8-c1e6-7fe5-60be0ff35d0e&amp;#34;
}
group &amp;#34;services&amp;#34; {
count = 1
task &amp;#34;mongodb&amp;#34; {
driver = &amp;#34;docker&amp;#34;
config {
image = &amp;#34;mongo:latest&amp;#34;
port_map {
port = 27017
}
volumes = [
&amp;#34;/home/picodotdev/Software/nomad/mongodb:/data/db/&amp;#34;
]
}
resources {
memory = 1024 # MB
network {
port &amp;#34;port&amp;#34; {}
}
}
}
}
}
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/code/mongodb.nomad" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/code/mongodb.nomad" target="_blank">mongodb.nomad&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Como el &lt;em>job&lt;/em> se ubica en el mismo nodo siempre montando un directorio del nodo como un volumen de datos en el &lt;em>job&lt;/em> y contenedor de &lt;a href="https://www.docker.com/">Docker&lt;/a>, los datos se persisten en el sistema de archivos y transcienden al tiempo de vida del &lt;em>job&lt;/em>, se puede iniciar el &lt;em>job&lt;/em>, insertar datos en la base de datos en este caso de MongoDB, eliminar el &lt;em>job&lt;/em>, volverlo a iniciar y los mismos datos están presentes en MongoDB.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ nomad job run mongodb.nomad
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/code/nomad-job-run.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/code/nomad-job-run.sh" target="_blank">nomad-job-run.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
b0d3f42c92fc mongo:latest &lt;span class="s2">&amp;#34;docker-entrypoint.s…&amp;#34;&lt;/span> &lt;span class="m">3&lt;/span> minutes ago Up &lt;span class="m">3&lt;/span> minutes 127.0.0.1:20180-&amp;gt;27017/tcp, 127.0.0.1:20180-&amp;gt;27017/udp mongodb-ea10d440-1176-3bfb-5301-7ccd17af0281
$ docker &lt;span class="nb">exec&lt;/span> -it b0d3f42c92fc bash
root@b0d3f42c92fc:/# mongo
MongoDB shell version v4.0.9
connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName&lt;span class="o">=&lt;/span>mongodb
Implicit session: session &lt;span class="o">{&lt;/span> &lt;span class="s2">&amp;#34;id&amp;#34;&lt;/span> : UUID&lt;span class="o">(&lt;/span>&lt;span class="s2">&amp;#34;ba120679-b965-49d0-a774-dff39d6b630a&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">}&lt;/span>
MongoDB server version: 4.0.9
Server has startup warnings:
2019-04-26T16:47:49.308+0000 I STORAGE &lt;span class="o">[&lt;/span>initandlisten&lt;span class="o">]&lt;/span>
2019-04-26T16:47:49.308+0000 I STORAGE &lt;span class="o">[&lt;/span>initandlisten&lt;span class="o">]&lt;/span> ** WARNING: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine
2019-04-26T16:47:49.308+0000 I STORAGE &lt;span class="o">[&lt;/span>initandlisten&lt;span class="o">]&lt;/span> ** See http://dochub.mongodb.org/core/prodnotes-filesystem
2019-04-26T16:47:50.133+0000 I CONTROL &lt;span class="o">[&lt;/span>initandlisten&lt;span class="o">]&lt;/span>
2019-04-26T16:47:50.133+0000 I CONTROL &lt;span class="o">[&lt;/span>initandlisten&lt;span class="o">]&lt;/span> ** WARNING: Access control is not enabled &lt;span class="k">for&lt;/span> the database.
2019-04-26T16:47:50.133+0000 I CONTROL &lt;span class="o">[&lt;/span>initandlisten&lt;span class="o">]&lt;/span> ** Read and write access to data and configuration is unrestricted.
2019-04-26T16:47:50.133+0000 I CONTROL &lt;span class="o">[&lt;/span>initandlisten&lt;span class="o">]&lt;/span>
---
Enable MongoDB&lt;span class="s1">&amp;#39;s free cloud-based monitoring service, which will then receive and display
&lt;/span>&lt;span class="s1">metrics about your deployment (disk utilization, CPU, operation statistics, etc).
&lt;/span>&lt;span class="s1">
&lt;/span>&lt;span class="s1">The monitoring data will be available on a MongoDB website with a unique URL accessible to you
&lt;/span>&lt;span class="s1">and anyone you share the URL with. MongoDB may use this information to make product
&lt;/span>&lt;span class="s1">improvements and to suggest MongoDB products and deployment options to you.
&lt;/span>&lt;span class="s1">
&lt;/span>&lt;span class="s1">To enable free monitoring, run the following command: db.enableFreeMonitoring()
&lt;/span>&lt;span class="s1">To permanently disable this reminder, run the following command: db.disableFreeMonitoring()
&lt;/span>&lt;span class="s1">---
&lt;/span>&lt;span class="s1">
&lt;/span>&lt;span class="s1">&amp;gt; db.articles.insert({title: &amp;#34;Introducción a la base de datos NoSQL MongoDB&amp;#34;, author: &amp;#34;picodotdev&amp;#34;, date: new Date(2017,05,18,12,30), tags: [&amp;#39;&lt;/span>mongodb&lt;span class="s1">&amp;#39;, &amp;#39;&lt;/span>database&lt;span class="s1">&amp;#39;, &amp;#39;&lt;/span>NoSQL&lt;span class="s1">&amp;#39;], comments: [{user: &amp;#34;jones&amp;#34;, message: &amp;#34;MongoDB is great!&amp;#34;}, {user: &amp;#34;lina&amp;#34;, message: &amp;#34;MongoDB is great!&amp;#34;}]})
&lt;/span>&lt;span class="s1">WriteResult({ &amp;#34;nInserted&amp;#34; : 1 })
&lt;/span>&lt;span class="s1">&amp;gt; db.articles.insert({title: &amp;#34;Introducción a la base de datos relacional PostgreSQL&amp;#34;, author: &amp;#34;picodotdev&amp;#34;, date: new Date(2017,05,17,12,00), likes: 100, tags: [&amp;#39;&lt;/span>postgresql&lt;span class="s1">&amp;#39;, &amp;#39;&lt;/span>database&lt;span class="s1">&amp;#39;, &amp;#39;&lt;/span>SQL&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="o">]&lt;/span>, comments: &lt;span class="o">[&lt;/span>&lt;span class="o">{&lt;/span>user: &lt;span class="s2">&amp;#34;katy&amp;#34;&lt;/span>, message: &lt;span class="s2">&amp;#34;PostgreSQL rocks!&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>, &lt;span class="o">{&lt;/span>user: &lt;span class="s2">&amp;#34;smith&amp;#34;&lt;/span>, message: &lt;span class="s2">&amp;#34;SQL language is powerful!&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>&lt;span class="o">]&lt;/span>&lt;span class="o">}&lt;/span>&lt;span class="o">)&lt;/span>
WriteResult&lt;span class="o">(&lt;/span>&lt;span class="o">{&lt;/span> &lt;span class="s2">&amp;#34;nInserted&amp;#34;&lt;/span> : &lt;span class="m">1&lt;/span> &lt;span class="o">}&lt;/span>&lt;span class="o">)&lt;/span>
&amp;gt; db.articles.find&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">{&lt;/span> &lt;span class="s2">&amp;#34;_id&amp;#34;&lt;/span> : ObjectId&lt;span class="o">(&lt;/span>&lt;span class="s2">&amp;#34;5cc335873b17081f2ca1d4d5&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>, &lt;span class="s2">&amp;#34;title&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;Introducción a la base de datos NoSQL MongoDB&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;author&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;picodotdev&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;date&amp;#34;&lt;/span> : ISODate&lt;span class="o">(&lt;/span>&lt;span class="s2">&amp;#34;2017-06-18T12:30:00Z&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>, &lt;span class="s2">&amp;#34;tags&amp;#34;&lt;/span> : &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;mongodb&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;database&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;NoSQL&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>, &lt;span class="s2">&amp;#34;comments&amp;#34;&lt;/span> : &lt;span class="o">[&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="s2">&amp;#34;user&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;jones&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;message&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;MongoDB is great!&amp;#34;&lt;/span> &lt;span class="o">}&lt;/span>, &lt;span class="o">{&lt;/span> &lt;span class="s2">&amp;#34;user&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;lina&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;message&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;MongoDB is great!&amp;#34;&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="o">{&lt;/span> &lt;span class="s2">&amp;#34;_id&amp;#34;&lt;/span> : ObjectId&lt;span class="o">(&lt;/span>&lt;span class="s2">&amp;#34;5cc335993b17081f2ca1d4d6&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>, &lt;span class="s2">&amp;#34;title&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;Introducción a la base de datos relacional PostgreSQL&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;author&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;picodotdev&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;date&amp;#34;&lt;/span> : ISODate&lt;span class="o">(&lt;/span>&lt;span class="s2">&amp;#34;2017-06-17T12:00:00Z&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>, &lt;span class="s2">&amp;#34;likes&amp;#34;&lt;/span> : 100, &lt;span class="s2">&amp;#34;tags&amp;#34;&lt;/span> : &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;postgresql&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;database&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;SQL&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>, &lt;span class="s2">&amp;#34;comments&amp;#34;&lt;/span> : &lt;span class="o">[&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="s2">&amp;#34;user&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;katy&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;message&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;PostgreSQL rocks!&amp;#34;&lt;/span> &lt;span class="o">}&lt;/span>, &lt;span class="o">{&lt;/span> &lt;span class="s2">&amp;#34;user&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;smith&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;message&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;SQL language is powerful!&amp;#34;&lt;/span> &lt;span class="o">}&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">}&lt;/span>
&amp;gt; db.articles.count&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="m">2&lt;/span>
&amp;gt; &lt;span class="nb">exit&lt;/span>
bye
root@b0d3f42c92fc:/# &lt;span class="nb">exit&lt;/span>
&lt;span class="nb">exit&lt;/span>
$ nomad job stop --purge &lt;span class="nv">mongodb&lt;/span>
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Monitoring evaluation &lt;span class="s2">&amp;#34;f10589c6&amp;#34;&lt;/span>
Evaluation triggered by job &lt;span class="s2">&amp;#34;mongodb&amp;#34;&lt;/span>
Evaluation status changed: &lt;span class="s2">&amp;#34;pending&amp;#34;&lt;/span> -&amp;gt; &lt;span class="s2">&amp;#34;complete&amp;#34;&lt;/span>
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Evaluation &lt;span class="s2">&amp;#34;f10589c6&amp;#34;&lt;/span> finished with status &lt;span class="s2">&amp;#34;complete&amp;#34;&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/code/mongodb.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/code/mongodb.sh" target="_blank">mongodb.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ nomad job stop --prune mongodb
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/code/nomad-job-stop.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/code/nomad-job-stop.sh" target="_blank">nomad-job-stop.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Para iniciar &lt;a href="https://www.consul.io/">Consul&lt;/a> y Nomad hay que utilizar los siguientes comandos y para el ejecutar &lt;em>job&lt;/em> es requisito haber instalado Docker dado que en este ejemplo lo utiliza.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ consul agent -dev -datacenter &lt;span class="nv">localhost&lt;/span>
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Starting Consul agent...
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Consul agent running!
Version: &lt;span class="s1">&amp;#39;v1.4.4&amp;#39;&lt;/span>
Node ID: &lt;span class="s1">&amp;#39;34294bf0-5802-0d94-4acd-cf8c9d090205&amp;#39;&lt;/span>
Node name: &lt;span class="s1">&amp;#39;archlinux&amp;#39;&lt;/span>
Datacenter: &lt;span class="s1">&amp;#39;localhost&amp;#39;&lt;/span> &lt;span class="o">(&lt;/span>Segment: &lt;span class="s1">&amp;#39;&amp;lt;all&amp;gt;&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
Server: &lt;span class="nb">true&lt;/span> &lt;span class="o">(&lt;/span>Bootstrap: &lt;span class="nb">false&lt;/span>&lt;span class="o">)&lt;/span>
Client Addr: &lt;span class="o">[&lt;/span>127.0.0.1&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>HTTP: 8500, HTTPS: -1, gRPC: 8502, DNS: 8600&lt;span class="o">)&lt;/span>
Cluster Addr: 127.0.0.1 &lt;span class="o">(&lt;/span>LAN: 8301, WAN: 8302&lt;span class="o">)&lt;/span>
Encrypt: Gossip: false, TLS-Outgoing: false, TLS-Incoming: &lt;span class="nb">false&lt;/span>
$ sudo nomad agent -dev -dc localhost
&lt;span class="o">[&lt;/span>sudo&lt;span class="o">]&lt;/span> password &lt;span class="k">for&lt;/span> picodotdev:
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; No configuration files &lt;span class="nv">loaded&lt;/span>
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Starting Nomad agent...
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Nomad agent configuration:
Advertise Addrs: HTTP: 127.0.0.1:4646&lt;span class="p">;&lt;/span> RPC: 127.0.0.1:4647&lt;span class="p">;&lt;/span> Serf: 127.0.0.1:4648
Bind Addrs: HTTP: 127.0.0.1:4646&lt;span class="p">;&lt;/span> RPC: 127.0.0.1:4647&lt;span class="p">;&lt;/span> Serf: 127.0.0.1:4648
Client: &lt;span class="nb">true&lt;/span>
Log Level: DEBUG
Region: global &lt;span class="o">(&lt;/span>DC: localhost&lt;span class="o">)&lt;/span>
Server: &lt;span class="nb">true&lt;/span>
Version: 0.9.0&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/code/consul-nomad.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/code/consul-nomad.sh" target="_blank">consul-nomad.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Las restricciones se han de cumplir para elegir un nodo, por otro lado está también la afinidad. La &lt;a href="https://www.nomadproject.io/docs/job-specification/affinity.html">afinidad&lt;/a> es una preferencia utilizada por Nomad al seleccionar los nodos que tratará de cumplir si hay algún nodo disponible con las propiedades de afinidad deseadas pero si no hay un nodo disponible se elige algún otro.&lt;/p>
&lt;div class="reference">
Referencia:&lt;br>
&lt;ul>
&lt;li>&lt;a href="https://picodotdev.github.io/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/">Introducción a Nomad para gestionar aplicaciones y microservicios&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://picodotdev.github.io/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/">Estrategias de despliegue para microservicios con Nomad&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.nomadproject.io/guides/stateful-workloads/portworx.html">Portworx&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.nomadproject.io/docs/job-specification/ephemeral_disk.html">Ephemeral Disk&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tech.trivago.com/2019/01/25/nomad-our-experiences-and-best-practices/">Nomad - our experiences and best practices&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://picodotdev.github.io/blog-bitix/series/docker/">Serie de artículos sobre Docker&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div></content><category term="planeta-codigo"/><category term="programacion"/><category term="software"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/</id><title>Estrategias de despliegue para microservicios con Nomad</title><updated>2019-04-18T11:30:00+02:00</updated><published>2019-04-18T10:00:00+02:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/"/><author><name>picodotdev</name></author><content type="html">
&lt;p>&lt;strong>Ciertos servicios requieren que al hacer un despliegue el servicio continue funcionando. Para esto no es posible parar todas las instancias de un servicio a la vez, actualizarlar y volverlas a iniciar porque durante este proceso se dejaría de prestar el servicio durante un corto periodo de tiempo en el mejor de los casos. Hay que hacer el despliegue de forma progresiva en las instancias. Algunas estrategias son &lt;em>Rolling Update&lt;/em>, &lt;em>Blue/Green&lt;/em> y &lt;em>Canary&lt;/em>, el orquestador de servicios Nomad soporta y realiza de forma automatizada los despliegues usando una de estas estrategias.&lt;/strong>&lt;/p>
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/nomad.svg" class="right " width="200" alt="Nomad" title="Nomad"/>
&lt;/div>
&lt;div class="logotypes" style="float: right; clear: right;">
&lt;img src="assets/images/logotipos/hashicorp.svg" class="right " width="200" alt="HashiCorp" title="HashiCorp"/>
&lt;/div>
&lt;p>El ciclo de vida de una aplicación no consiste solo en desarrollarla, incluye también su puesta en producción o despliegue en un entorno de pruebas, pero también una vez la aplicación está desplegada en algún momento será necesario actualizarla con una nueva versión.&lt;/p>
&lt;p>Las aplicaciones monolíticas tienen otros problemas pero en el aspecto de despliegue es sencillo ya que solo hay una aplicación, basta con desplegar la nueva versión. En una aplicación con arquitectura de microservicios es un reto mayor debido a que hay múltiples aplicaciones.&lt;/p>
&lt;p>En cualquiera de ellas puede darse el caso de que para ganar en escalabilidad o para aumentar la disponibilidad o tolerancia a fallos es posible que haya varias instancias, las cuales han de ser actualizadas con el requisito si es necesario de que el servicio no deje de prestar su servicio, es decir que el despliegue no suponga una caída del servicio.&lt;/p>
&lt;p>Hay varias estrategias para desplegar una nueva versión de una aplicación:&lt;/p>
&lt;ul>
&lt;li>&lt;em>Rolling update&lt;/em>: actualizar todas las instancias de forma progresiva. Una vez se termina de actualizar una se espera un tiempo y se actualiza la siguiente hasta que todas estén actualizadas.&lt;/li>
&lt;li>&lt;em>Blue/Green&lt;/em>: manteniendo en funcionamiento las instancias con la versión antigua se crea el mismo número de instancias con la nueva versión y se redirige tráfico hacia ellas. Una vez se ha comprobado que la nueva versión funciona correctamente se promociona la nueva versión y se eliminan las instancias de con la versión antigua. Esta estrategia permite volver a la versión anterior rápidamente si se detecta algún problema.&lt;/li>
&lt;li>&lt;em>Canary&lt;/em>: se siguen manteniendo las instancias con la versión antigua, a diferencia de la estrategia &lt;em>blue/green&lt;/em> se crea un número menor de instancias con la versión nueva que el número de instancias con la versión antigua. Una vez comprobado que la nueva versión es correcta se promociona la nueva versión y se actualizan todas las instancias restantes mediante &lt;em>rolling update&lt;/em> a la nueva versión. También permite volver a la versión antigua si se detecta algún problema.&lt;/li>
&lt;/ul>
&lt;p>&lt;a href="https://docs.docker.com/swarm/">Docker Swarm&lt;/a> permite la estrategia de despliegue &lt;em>rolling update&lt;/em> sin embargo las estrategias &lt;em>blue/green&lt;/em> y &lt;em>canary&lt;/em> son interesante para tratar de que un error en una versión nueva no afecte al funcionamiento de la aplicación y obligue hacer un &lt;em>rollback&lt;/em> que posiblemente tarde más tiempo durante el cual el servicio funcionará con el defecto descubierto. &lt;a href="https://www.nomadproject.io/">Nomad&lt;/a> permite despliegues con las estrategias &lt;em>blue/gree&lt;/em> y &lt;em>canary&lt;/em>.&lt;/p>
&lt;p>Para actualizar un servicio en Nomad basta con modificar la definición del &lt;em>job&lt;/em> y enviarlo a &lt;em>Nomad&lt;/em>, y este se encarga de orquestar la actualización en las instancias según la estrategia de despliegue
configurada. En este caso se actualiza la versión de &lt;em>nginx&lt;/em> de la versión &lt;em>nginx:stable-alpine&lt;/em> a &lt;em>nginx:alpine&lt;/em> usando una estrategia &lt;em>rolling update&lt;/em> para las cinco instancias del servicio.&lt;/p>
&lt;p>La estrategia de despliegue en &lt;em>Nomad&lt;/em> se define en la &lt;a href="https://www.nomadproject.io/docs/job-specification/update.html">sección de configuración &lt;em>update&lt;/em>&lt;/a>. El parámetro &lt;em>min_healthy_time&lt;/em> es el tiempo que se espera cuando se hace un &lt;em>rolling update&lt;/em> para considerar una instancia como sana y continuar la actualización con la siguiente, &lt;em>max_parallel&lt;/em> indica el número de instancias que se migran al mismo tiempo. El parámetro &lt;em>canary&lt;/em> indica el número de instancias que se crean en las estrategias &lt;em>blue/green&lt;/em> y &lt;em>canary&lt;/em>, en la primera el número de instancias coincidirá con el parámetro &lt;em>canary&lt;/em> que indica el número de instancias de un servicio. Nomad con los parámetros &lt;em>health_check&lt;/em>, &lt;em>min_healthy_time&lt;/em>, &lt;em>healthy_deadline&lt;/em>, &lt;em>progress_deadline&lt;/em>, &lt;em>stagger&lt;/em> y &lt;em>auto_revert&lt;/em> se puede poner unos límites para considerar válido un despliegue y en caso de no serlo realizar un &lt;em>rollback&lt;/em> de forma autmática.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">job &amp;#34;nginx&amp;#34; {
datacenters = [&amp;#34;localhost&amp;#34;]
type = &amp;#34;service&amp;#34;
update {
min_healthy_time = &amp;#34;15s&amp;#34;
max_parallel = 1
}
group &amp;#34;services&amp;#34; {
count = 5
task &amp;#34;nginx&amp;#34; {
driver = &amp;#34;docker&amp;#34;
config {
image = &amp;#34;nginx:stable-alpine&amp;#34;
port_map {
http = 80
}
}
resources {
memory = 1024 # MB
network {
port &amp;#34;http&amp;#34; {}
}
}
}
}
}
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/nginx.nomad" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/nginx.nomad" target="_blank">nginx.nomad&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ nomad job run nginx.nomad
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/nomad-job-run.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/nomad-job-run.sh" target="_blank">nomad-job-run.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>En el caso de los despliegues &lt;em>blue/green&lt;/em> y &lt;em>canary&lt;/em> una vez comprobado que la versión de los nuevos servicios funcionan correctamente se promocionan y actualizan el resto de instancias en el caso de &lt;em>canary&lt;/em> o se detienen las instancias antiguas en el caso de &lt;em>blue/green&lt;/em>.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ nomad job promote nginx
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/nomad-promote.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/nomad-promote.sh" target="_blank">nomad-promote.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Desde la línea de comandos se puede observar el estado del servicio y el proceso de actualización, el primero es el estado previo a realizar el despliegue, el segundo durante el proceso de actualización con &lt;em>rolling update&lt;/em> y el tercero una vez finalizado el proceso de despliegue y marcado como exitoso en el que todas las instancias han pasado de la versión 0 a la 1.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ nomad job status nginx
&lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> nginx
&lt;span class="nv">Name&lt;/span> &lt;span class="o">=&lt;/span> nginx
Submit &lt;span class="nv">Date&lt;/span> &lt;span class="o">=&lt;/span> 2019-04-18T19:13:07+02:00
&lt;span class="nv">Type&lt;/span> &lt;span class="o">=&lt;/span> service
&lt;span class="nv">Priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">50&lt;/span>
&lt;span class="nv">Datacenters&lt;/span> &lt;span class="o">=&lt;/span> localhost
&lt;span class="nv">Status&lt;/span> &lt;span class="o">=&lt;/span> running
&lt;span class="nv">Periodic&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">false&lt;/span>
&lt;span class="nv">Parameterized&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">false&lt;/span>
Summary
Task Group Queued Starting Running Failed Complete Lost
services &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
Latest Deployment
&lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> 81f57b6d
&lt;span class="nv">Status&lt;/span> &lt;span class="o">=&lt;/span> successful
&lt;span class="nv">Description&lt;/span> &lt;span class="o">=&lt;/span> Deployment completed successfully
Deployed
Task Group Desired Placed Healthy Unhealthy Progress Deadline
services &lt;span class="m">5&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">0&lt;/span> 2019-04-18T19:23:23+02:00
Allocations
ID Node ID Task Group Version Desired Status Created Modified
3747eb07 d18851d5 services &lt;span class="m">0&lt;/span> run running 29s ago 13s ago
500575e9 d18851d5 services &lt;span class="m">0&lt;/span> run running 29s ago 13s ago
c8094cf3 d18851d5 services &lt;span class="m">0&lt;/span> run running 29s ago 13s ago
ea58300c d18851d5 services &lt;span class="m">0&lt;/span> run running 29s ago 13s ago
ead6d23f d18851d5 services &lt;span class="m">0&lt;/span> run running 29s ago 13s ago
$ nomad alloc status 3747eb07
&lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> 3747eb07
Eval &lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> 781fb5f2
&lt;span class="nv">Name&lt;/span> &lt;span class="o">=&lt;/span> nginx.services&lt;span class="o">[&lt;/span>3&lt;span class="o">]&lt;/span>
Node &lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> d18851d5
Job &lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> nginx
Job &lt;span class="nv">Version&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span>
Client &lt;span class="nv">Status&lt;/span> &lt;span class="o">=&lt;/span> running
Client &lt;span class="nv">Description&lt;/span> &lt;span class="o">=&lt;/span> Tasks are running
Desired &lt;span class="nv">Status&lt;/span> &lt;span class="o">=&lt;/span> run
Desired &lt;span class="nv">Description&lt;/span> &lt;span class="o">=&lt;/span> &amp;lt;none&amp;gt;
&lt;span class="nv">Created&lt;/span> &lt;span class="o">=&lt;/span> 56s ago
&lt;span class="nv">Modified&lt;/span> &lt;span class="o">=&lt;/span> 40s ago
Deployment &lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> 81f57b6d
Deployment &lt;span class="nv">Health&lt;/span> &lt;span class="o">=&lt;/span> healthy
Task &lt;span class="s2">&amp;#34;nginx&amp;#34;&lt;/span> is &lt;span class="s2">&amp;#34;running&amp;#34;&lt;/span>
Task Resources
CPU Memory Disk Addresses
0/100 MHz &lt;span class="m">788&lt;/span> KiB/1.0 GiB &lt;span class="m">300&lt;/span> MiB http: 127.0.0.1:29939
Task Events:
Started &lt;span class="nv">At&lt;/span> &lt;span class="o">=&lt;/span> 2019-04-18T17:13:08Z
Finished &lt;span class="nv">At&lt;/span> &lt;span class="o">=&lt;/span> N/A
Total &lt;span class="nv">Restarts&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span>
Last &lt;span class="nv">Restart&lt;/span> &lt;span class="o">=&lt;/span> N/A
Recent Events:
Time Type Description
2019-04-18T19:13:08+02:00 Started Task started by client
2019-04-18T19:13:07+02:00 Task Setup Building Task Directory
2019-04-18T19:13:07+02:00 Received Task received by client&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/nomad-status-before.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/nomad-status-before.sh" target="_blank">nomad-status-before.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ nomad job status nginx
&lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> nginx
&lt;span class="nv">Name&lt;/span> &lt;span class="o">=&lt;/span> nginx
Submit &lt;span class="nv">Date&lt;/span> &lt;span class="o">=&lt;/span> 2019-04-18T19:17:54+02:00
&lt;span class="nv">Type&lt;/span> &lt;span class="o">=&lt;/span> service
&lt;span class="nv">Priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">50&lt;/span>
&lt;span class="nv">Datacenters&lt;/span> &lt;span class="o">=&lt;/span> localhost
&lt;span class="nv">Status&lt;/span> &lt;span class="o">=&lt;/span> running
&lt;span class="nv">Periodic&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">false&lt;/span>
&lt;span class="nv">Parameterized&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">false&lt;/span>
Summary
Task Group Queued Starting Running Failed Complete Lost
services &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">0&lt;/span>
Latest Deployment
&lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> ba20066a
&lt;span class="nv">Status&lt;/span> &lt;span class="o">=&lt;/span> successful
&lt;span class="nv">Description&lt;/span> &lt;span class="o">=&lt;/span> Deployment completed successfully
Deployed
Task Group Desired Placed Healthy Unhealthy Progress Deadline
services &lt;span class="m">5&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">5&lt;/span> &lt;span class="m">0&lt;/span> 2019-04-18T19:29:19+02:00
Allocations
ID Node ID Task Group Version Desired Status Created Modified
fabcf384 d18851d5 services &lt;span class="m">1&lt;/span> run running 2m36s ago 2m20s ago
ccb57008 d18851d5 services &lt;span class="m">1&lt;/span> run running 2m53s ago 2m37s ago
b06c743d d18851d5 services &lt;span class="m">1&lt;/span> run running 3m10s ago 2m54s ago
&lt;span class="m">56733896&lt;/span> d18851d5 services &lt;span class="m">1&lt;/span> run running 3m28s ago 3m12s ago
71c8bb5b d18851d5 services &lt;span class="m">1&lt;/span> run running 3m45s ago 3m29s ago
500575e9 d18851d5 services &lt;span class="m">0&lt;/span> stop &lt;span class="nb">complete&lt;/span> 8m31s ago 3m44s ago
c8094cf3 d18851d5 services &lt;span class="m">0&lt;/span> stop &lt;span class="nb">complete&lt;/span> 8m31s ago 3m10s ago
3747eb07 d18851d5 services &lt;span class="m">0&lt;/span> stop &lt;span class="nb">complete&lt;/span> 8m31s ago 2m53s ago
ea58300c d18851d5 services &lt;span class="m">0&lt;/span> stop &lt;span class="nb">complete&lt;/span> 8m31s ago 3m27s ago
ead6d23f d18851d5 services &lt;span class="m">0&lt;/span> stop &lt;span class="nb">complete&lt;/span> 8m31s ago 2m35s ago&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/nomad-status-after.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/nomad-status-after.sh" target="_blank">nomad-status-after.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;script type="text/javascript" src="https://asciinema.org/a/241669.js" id="asciicast-241669" async>&lt;/script>
&lt;noscript>&lt;a href="https://asciinema.org/a/241669" target="_blank">&lt;img src="https://asciinema.org/a/241669.png" width="734"/>&lt;/a>&lt;/noscript>
&lt;figcaption>Progreso del despliegue rolling update en Nomad&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>El proceso de despliegue también se puede monitorizar desde la interfaz web que ofrece Nomad.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/images/nomad-rolling-update-before_hu67a332684efae6ed992319050f36f296_119290_2560x1440_fit_box_2.png" title="Antes del proceso de despliegue rolling update en Nomad" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/images/nomad-rolling-update-before_hu67a332684efae6ed992319050f36f296_119290_300x200_fit_box_2.png" width="197"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/images/nomad-rolling-update-while_hu1bb43ff17075cacd6588f52ea91a2b44_119731_2560x1440_fit_box_2.png" title="Durante el proceso de despliegue rolling update en Nomad" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/images/nomad-rolling-update-while_hu1bb43ff17075cacd6588f52ea91a2b44_119731_300x200_fit_box_2.png" width="197"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/images/nomad-rolling-update-after_hu07bde1516a5a8318da3a99b05cb30d02_122603_2560x1440_fit_box_2.png" title="Después del proceso de despliegue rolling update en Nomad" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/images/nomad-rolling-update-after_hu07bde1516a5a8318da3a99b05cb30d02_122603_300x200_fit_box_2.png" width="197"/>&lt;/a>
&lt;figcaption>Progreso del despliegue rolling update en Nomad&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>En este ejemplo los servicios están en contenedores docker, también se observa que la versión de los contenedores en ejecución pasan de la versión &lt;em>stable-alpine&lt;/em> a &lt;em>alpine&lt;/em>.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
476d2063b64b nginx:stable-alpine &lt;span class="s2">&amp;#34;nginx -g &amp;#39;daemon of…&amp;#34;&lt;/span> About a minute ago Up About a minute 127.0.0.1:29939-&amp;gt;80/tcp, 127.0.0.1:29939-&amp;gt;80/udp nginx-3747eb07-f9da-a9f5-0720-1b2314baac12
e0a533348f44 nginx:stable-alpine &lt;span class="s2">&amp;#34;nginx -g &amp;#39;daemon of…&amp;#34;&lt;/span> About a minute ago Up About a minute 127.0.0.1:21085-&amp;gt;80/tcp, 127.0.0.1:21085-&amp;gt;80/udp nginx-ea58300c-c4a1-cc3d-46a0-d5b30c276ede
4da9babdd549 nginx:stable-alpine &lt;span class="s2">&amp;#34;nginx -g &amp;#39;daemon of…&amp;#34;&lt;/span> About a minute ago Up About a minute 127.0.0.1:30061-&amp;gt;80/tcp, 127.0.0.1:30061-&amp;gt;80/udp nginx-c8094cf3-5c3c-eaaa-1bcf-9368100bb0ef
068c6db6a86c nginx:stable-alpine &lt;span class="s2">&amp;#34;nginx -g &amp;#39;daemon of…&amp;#34;&lt;/span> About a minute ago Up About a minute 127.0.0.1:26606-&amp;gt;80/tcp, 127.0.0.1:26606-&amp;gt;80/udp nginx-ead6d23f-abdd-8b33-7b61-c2ad64dede5c
19190e778a5a nginx:stable-alpine &lt;span class="s2">&amp;#34;nginx -g &amp;#39;daemon of…&amp;#34;&lt;/span> About a minute ago Up About a minute 127.0.0.1:29835-&amp;gt;80/tcp, 127.0.0.1:29835-&amp;gt;80/udp nginx-500575e9-62ce-868a-f142-869475aacde5&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/docker-ps-before.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/docker-ps-before.sh" target="_blank">docker-ps-before.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ docker ps
CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
03faf7ed4467 nginx:alpine &lt;span class="s2">&amp;#34;nginx -g &amp;#39;daemon of…&amp;#34;&lt;/span> About a minute ago Up About a minute 127.0.0.1:27212-&amp;gt;80/tcp, 127.0.0.1:27212-&amp;gt;80/udp nginx-fabcf384-5675-fe7f-4c61-5fa7385c54d2
4185977fbddb nginx:alpine &lt;span class="s2">&amp;#34;nginx -g &amp;#39;daemon of…&amp;#34;&lt;/span> &lt;span class="m">2&lt;/span> minutes ago Up &lt;span class="m">2&lt;/span> minutes 127.0.0.1:26686-&amp;gt;80/tcp, 127.0.0.1:26686-&amp;gt;80/udp nginx-ccb57008-e426-1684-fd39-97cb0f3b51f7
c6586d22406e nginx:alpine &lt;span class="s2">&amp;#34;nginx -g &amp;#39;daemon of…&amp;#34;&lt;/span> &lt;span class="m">2&lt;/span> minutes ago Up &lt;span class="m">2&lt;/span> minutes 127.0.0.1:23508-&amp;gt;80/tcp, 127.0.0.1:23508-&amp;gt;80/udp nginx-b06c743d-d2b3-0be3-d82b-762184dda4ec
046253c1972b nginx:alpine &lt;span class="s2">&amp;#34;nginx -g &amp;#39;daemon of…&amp;#34;&lt;/span> &lt;span class="m">2&lt;/span> minutes ago Up &lt;span class="m">2&lt;/span> minutes 127.0.0.1:31800-&amp;gt;80/tcp, 127.0.0.1:31800-&amp;gt;80/udp nginx-56733896-ab20-ab8f-36c9-ac1d13b0f1a2
88788b4133ea nginx:alpine &lt;span class="s2">&amp;#34;nginx -g &amp;#39;daemon of…&amp;#34;&lt;/span> &lt;span class="m">3&lt;/span> minutes ago Up &lt;span class="m">3&lt;/span> minutes 127.0.0.1:30844-&amp;gt;80/tcp, 127.0.0.1:30844-&amp;gt;80/udp nginx-71c8bb5b-a23b-7edc-cbb3-f9d0b6bdffe6&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/docker-ps-after.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/docker-ps-after.sh" target="_blank">docker-ps-after.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Nomad y &lt;a href="https://www.consul.io/">Consul&lt;/a> se inician con los siguientes comandos en modo desarrollo comentados en el artículo &lt;a href="https://picodotdev.github.io/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/">Introducción a Nomad para gestionar aplicaciones y microservicios&lt;/a>.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ consul agent -dev -datacenter localhost
$ sudo nomad agent -dev -dc localhost&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/consul-nomad.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/code/consul-nomad.sh" target="_blank">consul-nomad.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="reference">
Referencia:&lt;br>
&lt;ul>
&lt;li>&lt;a href="https://picodotdev.github.io/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/">Introducción a Nomad para gestionar aplicaciones y microservicios&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://picodotdev.github.io/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/">Servicios con persistencia en el orquestador Nomad&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div></content><category term="planeta-codigo"/><category term="programacion"/><category term="software"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/</id><title>Introducción a Nomad para gestionar aplicaciones y microservicios</title><updated>2019-04-17T23:00:00+02:00</updated><published>2019-04-14T13:00:00+02:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/"/><author><name>picodotdev</name></author><content type="html">
&lt;p>&lt;strong>En las aplicaciones basadas en microservicios dado el número de ellos y de instancias tienen han de gestionarse como si fuesen ganado en vez como si fuesen animales de compañía. Nomad es un orquestador de servicios que a diferencia de Docker Swarm permite gestionar servicios con otros sistemas de ejecución además de contenedores docker y a diferencia de Kubernetes es más sencillo.&lt;/strong>&lt;/p>
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/nomad.svg" class="right " width="200" alt="Nomad" title="Nomad"/>
&lt;/div>
&lt;div class="logotypes" style="float: right; clear: right;">
&lt;img src="assets/images/logotipos/consul.svg" class="right " width="200" alt="Consul" title="Consul"/>
&lt;/div>
&lt;div class="logotypes" style="float: right; clear: right;">
&lt;img src="assets/images/logotipos/hashicorp.svg" class="right " width="200" alt="HashiCorp" title="HashiCorp"/>
&lt;/div>
&lt;p>En las arquitecturas de aplicaciones basadas en microservicios cada microservicio o simplemente servicio es una aplicación distinta e independiente, son varias aplicaciones que hay que gestionar y desplegar de forma individual o de forma coordinada.&lt;/p>
&lt;p>Dado su número hay que automatizar todas las tareas para tratar de conseguir la menor intervención manual, ningún proceso manual si es posible. Para que no sean inmanejables han de tratarse como ganado de forma masiva en vez de como animales de compañía que requieran atención individual para continuar generando valor en un proyecto con el tiempo disponible en vez de dedicarlo a tareas que no lo aportan.&lt;/p>
&lt;p>Dado que cada microservicio puede emplear una tecnología diferente es necesario algo que permita tratarlos a todos por igual, esta tecnología son los contenedores que hacen un papel similar al que hacen en el transporte de mercancías en barcos.&lt;/p>
&lt;p>Hay varias tecnologías para orquestar o gestionar los microservicios y crear &lt;em>clusters&lt;/em> de máquinas en las que desplegarlos, una de ellas es &lt;a href="https://docs.docker.com/swarm/">Docker Swarm&lt;/a> sencilla e integrada con &lt;a href="https://www.docker.com/">Docker&lt;/a> pero no con tantas funcionalidades como otra de las populares que es &lt;a href="https://kubernetes.io/">Kubernetes&lt;/a> y para usarlo en una máquina local &lt;a href="https://kubernetes.io/docs/setup/minikube/">minikube&lt;/a>, ofrece mas funcionalidad pero añade una complejidad significativa que para algunos casos de uso no compensa además requiere mas tiempo para dominarla. Una solución intermedia conservando la sencillez pero con mas funcionalidad es &lt;a href="https://www.nomadproject.io/">Nomad&lt;/a> de &lt;a href="https://www.hashicorp.com/">HashiCorp&lt;/a>. Otra de sus características destacadas es que el &lt;em>cluster&lt;/em> de Nomad puede estar formado en diferentes centros de datos y proveedores de la nube al mismo tiempo, por ejemplo en &lt;a href="https://aws.amazon.com/es/">AWS&lt;/a>, &lt;a href="https://cloud.google.com/">GCP&lt;/a> entre otros o centros de datos híbridos en la nube y propios. En la sección &lt;a href="https://www.nomadproject.io/intro/vs/index.html">Nomad vs. Other Software&lt;/a> de su documentación se compara con otras opciones.&lt;/p>
&lt;p>Nomad es distribuido, con alta disponibilidad y escalable a cientos de nodos en múltiples centros de datos y regiones. No es una solución completa por si sola pero se integra con otras. No ofrece descubrimiento de servicios pero se integra muy bien con &lt;a href="https://www.consul.io/">Consul&lt;/a>. No es un balanceador de carga pero se integra con &lt;a href="https://nginx.org/">Nginx&lt;/a>, &lt;a href="https://fabiolb.net/">Fabio&lt;/a>, &lt;a href="https://traefik.io/">Traefik&lt;/a> y &lt;a href="https://www.haproxy.org/">HAproxy&lt;/a> automatizando su configuración desde Consul. No integra un gestor de secretos pero se integra con &lt;a href="https://www.vaultproject.io/">Vault&lt;/a>. No soporta escalado y no integra de por sí varias de estas funcionalidades como Kubernetes pero es más simple.&lt;/p>
&lt;p>Nomad a diferencia Docker no solo puede gestionar contenedores docker sino también tareas del sistema y otras como máquinas virtuales &lt;a href="https://www.qemu.org/">qemu&lt;/a> o contenedores con &lt;a href="https://coreos.com/rkt/">rkt&lt;/a>, a diferencia de Kubernetes es mucho mas sencilla pero conservando funcionalidad suficiente para muchos casos de uso. Nomad requiere de otra de las herramientas de HashiCorp que es Consul para el registro y descubrimiento y para la configuración del &lt;em>cluster&lt;/em>, también se integra con otras de sus herramientas como Vault para guardar cifrados datos sensibles como contraseñas y certificados. Con &lt;a href="https://www.consul.io/docs/connect/platform/nomad.html">Connect&lt;/a> es capaz de proporcionar conexión TLS con autenticación mutua de forma transparente para los servicios.&lt;/p>
&lt;p>Los &lt;em>jobs&lt;/em> son la unidad de trabajo que contienen la definición de los servicios, se definen en un &lt;a href="https://www.nomadproject.io/docs/job-specification/index.html">archivo de configuración&lt;/a> donde los elementos son el nombre, los grupos de tareas, las tareas y en cada tarea el &lt;em>driver&lt;/em> que usa dependiendo del cual se proporciona la configuración apropiada. El &lt;em>driver&lt;/em> determina como es gestionada el tipo de tarea puede ser un conteendor de docker, un proceso del sistema, una máquina virtual de &lt;em>qemu&lt;/em> o un contenedor &lt;em>rkt&lt;/em>, a diferencia de Docker Swarm que solo puede gestionar contenedores docker. Se pueden configurar variables de entorno, memoria asignada a cada tarea, propiedades de red y CPU.&lt;/p>
&lt;p>Nomad y Nomad cada uno son un binario ejecutable sin ninguna otra dependencia. Basta con descargarlos e incluirlos en el &lt;em>path&lt;/em> del sistema. En este ejemplo hay definido un &lt;em>job&lt;/em> compuesto por una tarea de un contenedor docker de &lt;a href="https://nginx.org/">nginx&lt;/a> configurado en un puerto aleatorio y con 1 GB de memoria para cada una de las dos instancias del servicio. Dado que lo usa es necesario &lt;a href="https://picodotdev.github.io/blog-bitix/2014/11/inicio-basico-de-docker/">instalar Docker&lt;/a>.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-plaintext" data-lang="plaintext">job &amp;#34;nginx&amp;#34; {
datacenters = [&amp;#34;localhost&amp;#34;]
type = &amp;#34;service&amp;#34;
update {
stagger = &amp;#34;30s&amp;#34;
canary = 2
max_parallel = 2
}
group &amp;#34;services&amp;#34; {
count = 2
task &amp;#34;nginx&amp;#34; {
driver = &amp;#34;docker&amp;#34;
config {
image = &amp;#34;nginx:alpine&amp;#34;
port_map {
http = 80
}
}
resources {
memory = 1024 # MB
network {
port &amp;#34;http&amp;#34; {}
}
}
}
}
}
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/code/nginx.nomad" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/code/nginx.nomad" target="_blank">nginx.nomad&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Nomad y Nomad se ejecutan con los siguientes comandos en modo desarrollo.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ consul agent -dev -datacenter &lt;span class="nv">localhost&lt;/span>
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Starting Consul agent...
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Consul agent running!
Version: &lt;span class="s1">&amp;#39;v1.4.4&amp;#39;&lt;/span>
Node ID: &lt;span class="s1">&amp;#39;1934d5b2-0f3f-ffdd-8378-7ab8a6207bb1&amp;#39;&lt;/span>
Node name: &lt;span class="s1">&amp;#39;archlinux&amp;#39;&lt;/span>
Datacenter: &lt;span class="s1">&amp;#39;localhost&amp;#39;&lt;/span> &lt;span class="o">(&lt;/span>Segment: &lt;span class="s1">&amp;#39;&amp;lt;all&amp;gt;&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
Server: &lt;span class="nb">true&lt;/span> &lt;span class="o">(&lt;/span>Bootstrap: &lt;span class="nb">false&lt;/span>&lt;span class="o">)&lt;/span>
Client Addr: &lt;span class="o">[&lt;/span>127.0.0.1&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>HTTP: 8500, HTTPS: -1, gRPC: 8502, DNS: 8600&lt;span class="o">)&lt;/span>
Cluster Addr: 127.0.0.1 &lt;span class="o">(&lt;/span>LAN: 8301, WAN: 8302&lt;span class="o">)&lt;/span>
Encrypt: Gossip: false, TLS-Outgoing: false, TLS-Incoming: &lt;span class="nb">false&lt;/span>
$ sudo nomad agent -dev -dc localhost
&lt;span class="o">[&lt;/span>sudo&lt;span class="o">]&lt;/span> password &lt;span class="k">for&lt;/span> picodotdev:
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; No configuration files &lt;span class="nv">loaded&lt;/span>
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Starting Nomad agent...
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Nomad agent configuration:
Advertise Addrs: HTTP: 127.0.0.1:4646&lt;span class="p">;&lt;/span> RPC: 127.0.0.1:4647&lt;span class="p">;&lt;/span> Serf: 127.0.0.1:4648
Bind Addrs: HTTP: 127.0.0.1:4646&lt;span class="p">;&lt;/span> RPC: 127.0.0.1:4647&lt;span class="p">;&lt;/span> Serf: 127.0.0.1:4648
Client: &lt;span class="nb">true&lt;/span>
Log Level: DEBUG
Region: global &lt;span class="o">(&lt;/span>DC: localhost&lt;span class="o">)&lt;/span>
Server: &lt;span class="nb">true&lt;/span>
Version: 0.9.0&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/code/nomad-consul.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/code/nomad-consul.sh" target="_blank">nomad-consul.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Iniciados se pueden enviar &lt;em>jobs&lt;/em> y ver su estado, dirección y puerto asignado así como los &lt;em>logs&lt;/em> generados.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ nomad job plan nginx.nomad
$ nomad job run nginx.nomad
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Monitoring evaluation &lt;span class="s2">&amp;#34;b2b07746&amp;#34;&lt;/span>
Evaluation triggered by job &lt;span class="s2">&amp;#34;nginx&amp;#34;&lt;/span>
Allocation &lt;span class="s2">&amp;#34;60f3d102&amp;#34;&lt;/span> created: node &lt;span class="s2">&amp;#34;58823be1&amp;#34;&lt;/span>, group &lt;span class="s2">&amp;#34;services&amp;#34;&lt;/span>
Allocation &lt;span class="s2">&amp;#34;6e12ae8f&amp;#34;&lt;/span> created: node &lt;span class="s2">&amp;#34;58823be1&amp;#34;&lt;/span>, group &lt;span class="s2">&amp;#34;services&amp;#34;&lt;/span>
Evaluation within deployment: &lt;span class="s2">&amp;#34;0dddab79&amp;#34;&lt;/span>
Allocation &lt;span class="s2">&amp;#34;6e12ae8f&amp;#34;&lt;/span> status changed: &lt;span class="s2">&amp;#34;pending&amp;#34;&lt;/span> -&amp;gt; &lt;span class="s2">&amp;#34;running&amp;#34;&lt;/span> &lt;span class="o">(&lt;/span>Tasks are running&lt;span class="o">)&lt;/span>
Allocation &lt;span class="s2">&amp;#34;60f3d102&amp;#34;&lt;/span> status changed: &lt;span class="s2">&amp;#34;pending&amp;#34;&lt;/span> -&amp;gt; &lt;span class="s2">&amp;#34;running&amp;#34;&lt;/span> &lt;span class="o">(&lt;/span>Tasks are running&lt;span class="o">)&lt;/span>
Evaluation status changed: &lt;span class="s2">&amp;#34;pending&amp;#34;&lt;/span> -&amp;gt; &lt;span class="s2">&amp;#34;complete&amp;#34;&lt;/span>
&lt;span class="o">=&lt;/span>&lt;span class="o">=&lt;/span>&amp;gt; Evaluation &lt;span class="s2">&amp;#34;b2b07746&amp;#34;&lt;/span> finished with status &lt;span class="s2">&amp;#34;complete&amp;#34;&lt;/span>
$ nomad job status nginx
&lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> nginx
&lt;span class="nv">Name&lt;/span> &lt;span class="o">=&lt;/span> nginx
Submit &lt;span class="nv">Date&lt;/span> &lt;span class="o">=&lt;/span> 2019-04-14T13:31:53+02:00
&lt;span class="nv">Type&lt;/span> &lt;span class="o">=&lt;/span> service
&lt;span class="nv">Priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">50&lt;/span>
&lt;span class="nv">Datacenters&lt;/span> &lt;span class="o">=&lt;/span> localhost
&lt;span class="nv">Status&lt;/span> &lt;span class="o">=&lt;/span> running
&lt;span class="nv">Periodic&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">false&lt;/span>
&lt;span class="nv">Parameterized&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">false&lt;/span>
Summary
Task Group Queued Starting Running Failed Complete Lost
services &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
Latest Deployment
&lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> 0dddab79
&lt;span class="nv">Status&lt;/span> &lt;span class="o">=&lt;/span> running
&lt;span class="nv">Description&lt;/span> &lt;span class="o">=&lt;/span> Deployment is running
Deployed
Task Group Desired Placed Healthy Unhealthy Progress Deadline
services &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">2&lt;/span> &lt;span class="m">0&lt;/span> 2019-04-14T13:42:04+02:00
Allocations
ID Node ID Task Group Version Desired Status Created Modified
60f3d102 58823be1 services &lt;span class="m">0&lt;/span> run running 12s ago 1s ago
6e12ae8f 58823be1 services &lt;span class="m">0&lt;/span> run running 12s ago 1s ago
$ nomad alloc status 60f3d102
&lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> 60f3d102
Eval &lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> b2b07746
&lt;span class="nv">Name&lt;/span> &lt;span class="o">=&lt;/span> nginx.services&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>
Node &lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> 58823be1
Job &lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> nginx
Job &lt;span class="nv">Version&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span>
Client &lt;span class="nv">Status&lt;/span> &lt;span class="o">=&lt;/span> running
Client &lt;span class="nv">Description&lt;/span> &lt;span class="o">=&lt;/span> Tasks are running
Desired &lt;span class="nv">Status&lt;/span> &lt;span class="o">=&lt;/span> run
Desired &lt;span class="nv">Description&lt;/span> &lt;span class="o">=&lt;/span> &amp;lt;none&amp;gt;
&lt;span class="nv">Created&lt;/span> &lt;span class="o">=&lt;/span> 56s ago
&lt;span class="nv">Modified&lt;/span> &lt;span class="o">=&lt;/span> 45s ago
Deployment &lt;span class="nv">ID&lt;/span> &lt;span class="o">=&lt;/span> 0dddab79
Deployment &lt;span class="nv">Health&lt;/span> &lt;span class="o">=&lt;/span> healthy
Task &lt;span class="s2">&amp;#34;nginx&amp;#34;&lt;/span> is &lt;span class="s2">&amp;#34;running&amp;#34;&lt;/span>
Task Resources
CPU Memory Disk Addresses
0/100 MHz &lt;span class="m">820&lt;/span> KiB/1.0 GiB &lt;span class="m">300&lt;/span> MiB http: 127.0.0.1:28421
Task Events:
Started &lt;span class="nv">At&lt;/span> &lt;span class="o">=&lt;/span> 2019-04-14T11:31:54Z
Finished &lt;span class="nv">At&lt;/span> &lt;span class="o">=&lt;/span> N/A
Total &lt;span class="nv">Restarts&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">0&lt;/span>
Last &lt;span class="nv">Restart&lt;/span> &lt;span class="o">=&lt;/span> N/A
Recent Events:
Time Type Description
2019-04-14T13:31:54+02:00 Started Task started by client
2019-04-14T13:31:53+02:00 Task Setup Building Task Directory
2019-04-14T13:31:53+02:00 Received Task received by client
$ nomad alloc logs 60f3d102
172.17.0.1 - - &lt;span class="o">[&lt;/span>14/Apr/2019:11:33:17 +0000&lt;span class="o">]&lt;/span> &lt;span class="s2">&amp;#34;GET / HTTP/1.1&amp;#34;&lt;/span> &lt;span class="m">200&lt;/span> &lt;span class="m">612&lt;/span> &lt;span class="s2">&amp;#34;-&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;Mozilla/5.0 (X11; Linux x86_64; rv:66.0) Gecko/20100101 Firefox/66.0&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;-&amp;#34;&lt;/span>
172.17.0.1 - - &lt;span class="o">[&lt;/span>14/Apr/2019:11:33:17 +0000&lt;span class="o">]&lt;/span> &lt;span class="s2">&amp;#34;GET /favicon.ico HTTP/1.1&amp;#34;&lt;/span> &lt;span class="m">404&lt;/span> &lt;span class="m">154&lt;/span> &lt;span class="s2">&amp;#34;-&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;Mozilla/5.0 (X11; Linux x86_64; rv:66.0) Gecko/20100101 Firefox/66.0&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;-&amp;#34;&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/code/nomad.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/code/nomad.sh" target="_blank">nomad.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>También poseen una interfaz web integrada en la que consultar la misma información, la de Consul está en el puerto &lt;em>8500&lt;/em> y la de Nomad en el &lt;em>4646&lt;/em> donde ver el estado de los &lt;em>jobs&lt;/em> y el progreso de los despliegues.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/images/consul_hu04dfd0a784258ffab8de29ae08a6fa53_49981_2560x1440_fit_box_2.png" title="Consul" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/images/consul_hu04dfd0a784258ffab8de29ae08a6fa53_49981_200x150_fit_box_2.png" width="200"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/images/nomad-1_hu543e80f6165a80d0eda612b240feaa6b_34563_2560x1440_fit_box_2.png" title="Nomad" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/images/nomad-1_hu543e80f6165a80d0eda612b240feaa6b_34563_200x150_fit_box_2.png" width="200"/>&lt;/a>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/images/nomad-2_hu78cafc3dc4ae78de08bf9c5133a990a6_67847_2560x1440_fit_box_2.png" title="Nomad" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/images/nomad-2_hu78cafc3dc4ae78de08bf9c5133a990a6_67847_200x150_fit_box_2.png" width="200"/>&lt;/a>
&lt;figcaption>Interfaces web de Consul y Nomad&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;p>Nomad permite varias estrategias para actualizar los &lt;em>jobs&lt;/em> a una nueva versión de un servicio, basta modificar la configuración del &lt;em>job&lt;/em>, volverlo a enviar a Nomad y este se encarga de &lt;a href="https://picodotdev.github.io/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/">actualizar las instancias siguiendo la estrategia &lt;em>rolling&lt;/em>, &lt;em>blue/green&lt;/em> o &lt;em>canary&lt;/em>&lt;/a> definida en el &lt;em>job&lt;/em>, pero eso lo muestro mas detalladamente en otro artículo.&lt;/p>
&lt;p>La &lt;a href="https://www.nomadproject.io/docs/index.html">documentación de Nomad&lt;/a>, Nomad y otros productos de HashiCorp dedicados a la infraestructura en la nube esta muy bien explicada y detallada, este artículo solo es un resumen de las partes básicas para conocer como empezar a usarlo. En el siguiente vídeo se hace una pequeña explicación y demostración.&lt;/p>
&lt;div class="media media-video" style="text-align: center;">
&lt;iframe width="640" height="360" src="https://www.youtube.com/embed/A6CuZUoINX0?rel=0" frameborder="0" allowfullscreen>&lt;/iframe>
&lt;/div>
&lt;div class="reference">
Referencia:&lt;br>
&lt;ul>
&lt;li>&lt;a href="https://picodotdev.github.io/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/">Estrategias de despliegue para microservicios con Nomad&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://picodotdev.github.io/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/">Servicios con persistencia en el orquestador Nomad&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://targetveb.com/nomad-simple-deployment-monitoring-applications.html">Nomad – Simple deployment and monitoring of applications&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div></content><category term="planeta-codigo"/><category term="programacion"/><category term="software"/></entry><entry><id>https://picodotdev.github.io/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/</id><title>Servidor OAuth, gateway y servicio REST utilizando tokens JWT con Spring</title><updated>2019-02-08T20:00:00+01:00</updated><published>2019-02-08T20:00:00+01:00</published><link rel="alternate" href="https://picodotdev.github.io/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/"/><author><name>picodotdev</name></author><content type="html">
&lt;div class="logotypes" style="float: right;">
&lt;img src="assets/images/logotipos/spring.svg" class="right " width="200" alt="Spring" title="Spring"/>
&lt;/div>
&lt;div class="logotypes" style="float: right; clear: right;">
&lt;img src="assets/images/logotipos/java.svg" class="right " width="200" alt="Java" title="Java"/>
&lt;/div>
&lt;p>Hace unos días encontré un &lt;a href="https://www.idealista.com/labs/blog/spring-framework/autenticando-el-api-de-idealista-hipotecas-con-spring-oauth2-y-zuul/">articulo del blog técnido de los desarrolladores de Idealista&lt;/a>. En él comentaban que tenían una API para realizar simulaciones hipotecarias usando &lt;a href="https://spring.io/">Spring&lt;/a> como &lt;em>framework&lt;/em>, &lt;a href="https://spring.io/projects/spring-security-oauth">Spring Security OAuth&lt;/a> como forma de autenticación y autorización y JWT como forma de codificar el &lt;em>token&lt;/em> que otorga el servidor OAuth y contiene la información necesaria para que el servidor de recursos permita o no el acceso al recurso que aloja.&lt;/p>
&lt;p>Ya había oído mencionar JWT pero este artículo me ha permitido conocer su utilidad, y no es poca. Como se menciona en el artículo JWT tiene la ventaja de que que no es necesario persistirlo en una base de datos y contiene toda la información que el servidor de recursos necesita para realizar la autorización ya que es capaz de cargar con información arbitraria que el servicio desee en el momento de la emisión, la autenticación y comprobación de que ha sido emitido por el servidor OAuth la realiza sabiendo que el &lt;em>token&lt;/em> está firmado.&lt;/p>
&lt;p>Los &lt;em>tokens&lt;/em> son una serie de caracteres aparentemente sin sentido al estar &lt;em>hasheados&lt;/em> y firmados con una clave compartida entre servidor OAuth y el servidor de recurso o para mayor seguridad mediante clave privada en el servidor OAuth y su clave pública asociada en el servidor de recursos, con la firma el servidor de recursos el capaz de comprobar la autenticidad del &lt;em>token&lt;/em> sin necesidad de comunicarse con él. Los &lt;em>tokens&lt;/em> de OAuth son más cortos, los &lt;em>tokens&lt;/em> JWT con más largos ya que contienen información adicional. Se componen de tres partes separadas por un punto, una cabecera con el algoritmo &lt;em>hash&lt;/em> utilizado y tipo de &lt;em>token&lt;/em>, un documento JSON con datos y una firma de verificación.&lt;/p>
&lt;p>El hecho de que los &lt;em>tokens&lt;/em> JWT no sea necesario persistirlos en base de datos elimina la necesidad de tener su infraestructura, como desventaja es que no es tan fácil de revocar el acceso a un &lt;em>token&lt;/em> JWT y por ello se les concede un tiempo de expiración corto. En el articulo se analizaba su infraestructura y hay varios elementos configurables de diferentes formas, son:&lt;/p>
&lt;ul>
&lt;li>El servidor OAuth que proporciona los tokens, realiza la autenticación y proporciona las autorizaciones.&lt;/li>
&lt;li>El servidor del recurso al que se le envía el &lt;em>token&lt;/em>, en base a las autorizaciones otorgadas por el servidor OAuth al token y las autorizaciones necesarias para acceder al recurso concedo o no acceso al recurso.&lt;/li>
&lt;li>En el caso de múltiples servicios con múltiples recursos es conveniente un &lt;em>gateway&lt;/em> para que sea el punto de entrada de todos los servicios, de esta forma los clientes solo necesitarán conocer el &lt;em>gateway&lt;/em> en vez de los múltiples servicios individuales. El &lt;em>gateway&lt;/em> se encarga de hacer de &lt;em>proxy&lt;/em> en base a información en la petición como ruta, &lt;em>host&lt;/em>, parámetros, cabeceras, &amp;hellip; de redirigir la petición al servicio encargado de atenderla y devolver la respuesta. Un ejemplo de &lt;em>gateway&lt;/em> es &lt;a href="https://github.com/Netflix/zuul">Zuul&lt;/a> como ya he mostrado en el artículo &lt;a href="https://picodotdev.github.io/blog-bitix/2018/10/proxy-para-microservicios-con-spring-cloud-netflix-y-zuul/">Proxy para microservicios con Spring Cloud Netflix y Zuul&lt;/a>.&lt;/li>
&lt;/ul>
&lt;p>Puede haber más elementos en la infraestructura y quizá sea el caso de un sistema real como sería un servidor de descubrimiento con &lt;a href="https://github.com/Netflix/eureka">Eureka&lt;/a> o un servidor de configuración con &lt;a href="https://cloud.spring.io/spring-cloud-config/">Spring Cloud Config&lt;/a>, en la &lt;a href="https://picodotdev.github.io/blog-bitix/series/spring-cloud/">serie de artículos sobre Spring Cloud&lt;/a> los muestro. Para este ejemplo obvio estos otros servidores y me centro en los más relacionados con el artículo. Aunque lógicamente son diferentes servicios se puede crear uno que proporcione varios de ellos al mismo tiempo, por ejemplo, un servicio que haga al mismo tiempo de servidor de OAuth y de &lt;em>gateway&lt;/em> que es una de las posibles cambios que dejan al final en el artículo de Idealista.&lt;/p>
&lt;p>Spring ha creado su propio proyecto de &lt;em>gateway&lt;/em> para sustituir a Zuul, &lt;a href="https://spring.io/projects/spring-cloud-gateway">Spring Cloud Gateway&lt;/a> y será el que use en este artículo. Soporta &lt;a href="https://projects.spring.io/spring-boot/">Spring Boot&lt;/a> 2, &lt;a href="https://projects.spring.io/spring-framework/">Spring Framework&lt;/a> 5, coincidencia por cualquier parámetro de la petición, filtros y transformaciones o predicados, el patrón &lt;em>circuit breaker&lt;/em>, limitación de peticiones y reescritura de rutas.&lt;/p>
&lt;p>Los servicios los mantengo separados ya que al combinarlos pueden surgir problemas de integración al usar diferentes versiones de librerías de Spring aún cuando todos los proyectos son de Spring. Por ejemplo, Spring Cloud Gateway utiliza Spring WebFlux que puede ser diferente del lo que utilice Spring Security OAuth y la integración puede no estar exenta de problemas.&lt;/p>
&lt;div class="media" style="text-align: center;">
&lt;img src="assets/images/logotipos/oauth.svg" alt="OAuth" title="OAuth" width="200"/>
&lt;img src="assets/images/logotipos/jwt.svg" alt="JWT" title="JWT" width="300"/>
&lt;/div>
&lt;h3 id="servidor-oauth">Servidor OAuth&lt;/h3>
&lt;p>Empezando por el servidor OAuth y las dependencias que necesita, son &lt;em>spring-security-oauth2&lt;/em> y para generar &lt;em>tokens&lt;/em> JWT &lt;em>spring-security-jwt&lt;/em>, el resto son dependencias necesarias de Spring Boot&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Groovy" data-lang="Groovy">&lt;span class="n">plugins&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">id&lt;/span> &lt;span class="s1">&amp;#39;application&amp;#39;&lt;/span>
&lt;span class="n">id&lt;/span> &lt;span class="s1">&amp;#39;org.springframework.boot&amp;#39;&lt;/span> &lt;span class="n">version&lt;/span> &lt;span class="s1">&amp;#39;2.0.8.RELEASE&amp;#39;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">mainClassName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;io.github.picodotdev.blogbitix.springoauth.oauth.Main&amp;#39;&lt;/span>
&lt;span class="n">dependencies&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">implementation&lt;/span> &lt;span class="nf">platform&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.boot:spring-boot-dependencies:2.0.8.RELEASE&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">implementation&lt;/span> &lt;span class="nf">platform&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.cloud:spring-cloud-dependencies:Finchley.SR2&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kt">def&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="n">exclude&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nl">group:&lt;/span> &lt;span class="s1">&amp;#39;org.springframework.boot&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="nl">module:&lt;/span> &lt;span class="s1">&amp;#39;spring-boot-starter-logging&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.boot:spring-boot-starter&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.boot:spring-boot-starter-web&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.boot:spring-boot-starter-security&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.boot:spring-boot-starter-log4j2&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.security.oauth:spring-security-oauth2:2.3.4.RELEASE&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.security:spring-security-jwt:1.0.10.RELEASE&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;com.google.code.gson:gson:2.8.5&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;com.fasterxml.jackson.core:jackson-databind:2.9.6&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;com.fasterxml.jackson.dataformat:jackson-dataformat-yaml:2.9.6&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;javax.xml.bind:jaxb-api:2.3.0&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;com.sun.xml.bind:jaxb-impl:2.3.0&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.glassfish.jaxb:jaxb-runtime:2.3.0&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;javax.activation:activation:1.1.1&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/build.gradle" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/build.gradle" target="_blank">oauth/build.gradle&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>La clase principal de Spring Boot y que inicia la aplicación no tiene nada especial salvo la necesaria anotación &lt;em>@EnableAuthorizationServer&lt;/em> para habilitar el servidor OAuth.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">package&lt;/span> &lt;span class="nn">io.github.picodotdev.blogbitix.springoauth.oauth&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="o">.&lt;/span>
&lt;span class="nd">@SpringBootApplication&lt;/span>
&lt;span class="nd">@EnableAuthorizationServer&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">Main&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">SpringApplication&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">run&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">Main&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">class&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/Main.java" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/Main.java" target="_blank">oauth/Main.java&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>La parte importante está en la clase de configuración. La clase &lt;em>JwtAccessTokenConverter&lt;/em> se encarga de codificar el token, la clase &lt;em>TokenStore&lt;/em> de generarlos, &lt;em>DefaultTokenServices&lt;/em> contiene referencias a ambos, los métodos heredados &lt;em>configure()&lt;/em> configuran diferentes aspectos del servicio como los requisitos para acceder a los &lt;em>endpoint&lt;/em> para ver el contenido de un &lt;em>token&lt;/em> o los clientes OAuth que reconoce. Para cada cliente se necesita proporcionar el identificativo del cliente, su clave privada o &lt;em>secret&lt;/em>, identificativo del recurso, que tipos de concesiones, &lt;em>grants&lt;/em>, formas o flujos de obtener el &lt;em>token&lt;/em>, que autoridades y ámbitos o &lt;em>scopes&lt;/em> se le asigna al token.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">package&lt;/span> &lt;span class="nn">io.github.picodotdev.blogbitix.springoauth.oauth&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="o">.&lt;/span>
&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="nd">@EnableAuthorizationServer&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">AuthorizationServerConfiguration&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">AuthorizationServerConfigurerAdapter&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">ClientDetailsService&lt;/span> &lt;span class="n">clientDetailsService&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">JwtAccessTokenConverter&lt;/span> &lt;span class="n">tokenConverter&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">TokenStore&lt;/span> &lt;span class="n">tokenStore&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">DefaultTokenServices&lt;/span> &lt;span class="n">tokenServices&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">JwtAccessTokenConverter&lt;/span> &lt;span class="nf">tokenConverter&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">JwtAccessTokenConverter&lt;/span> &lt;span class="n">converter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">JwtAccessTokenConverter&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">converter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setSigningKey&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;1234567890&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">converter&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">TokenStore&lt;/span> &lt;span class="nf">tokenStore&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">JwtAccessTokenConverter&lt;/span> &lt;span class="n">tokenConverter&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">JwtTokenStore&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tokenConverter&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="n">DefaultTokenServices&lt;/span> &lt;span class="nf">tokenServices&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">TokenStore&lt;/span> &lt;span class="n">tokenStore&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">JwtAccessTokenConverter&lt;/span> &lt;span class="n">tokenConverter&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">DefaultTokenServices&lt;/span> &lt;span class="n">tokenServices&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">DefaultTokenServices&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">tokenServices&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setTokenStore&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tokenStore&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">tokenServices&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setTokenEnhancer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tokenConverter&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">tokenServices&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">TokenStoreUserApprovalHandler&lt;/span> &lt;span class="nf">userApprovalHandler&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">TokenStore&lt;/span> &lt;span class="n">tokenStore&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">ClientDetailsService&lt;/span> &lt;span class="n">clientDetailsService&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">TokenStoreUserApprovalHandler&lt;/span> &lt;span class="n">handler&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">TokenStoreUserApprovalHandler&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">handler&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setTokenStore&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tokenStore&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">handler&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setRequestFactory&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="n">DefaultOAuth2RequestFactory&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">clientDetailsService&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">handler&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setClientDetailsService&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">clientDetailsService&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">handler&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">ApprovalStore&lt;/span> &lt;span class="nf">approvalStore&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">TokenStore&lt;/span> &lt;span class="n">tokenStore&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">TokenApprovalStore&lt;/span> &lt;span class="n">store&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">TokenApprovalStore&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">store&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setTokenStore&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tokenStore&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">store&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">configure&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">AuthorizationServerSecurityConfigurer&lt;/span> &lt;span class="n">security&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">security&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">allowFormAuthenticationForClients&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">tokenKeyAccess&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;isAuthenticated()&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">checkTokenAccess&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;isAuthenticated()&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">configure&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">AuthorizationServerEndpointsConfigurer&lt;/span> &lt;span class="n">endpoints&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">endpoints&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">tokenServices&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tokenServices&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">configure&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ClientDetailsServiceConfigurer&lt;/span> &lt;span class="n">clients&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">clients&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">inMemory&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">withClient&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;client&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">secret&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;{noop}1234567890&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">resourceIds&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;service&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">authorizedGrantTypes&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;client_credentials&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">authorities&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;CLIENT&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="na">scopes&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;read&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/AuthorizationServerConfiguration.java" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/AuthorizationServerConfiguration.java" target="_blank">oauth/AuthorizationServerConfiguration.java&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>El servidor OAuth de ejemplo se inicia con el comando &lt;em>./gradlew oauth:run&lt;/em>. Para obtener un &lt;em>token&lt;/em> se realiza con las siguientes peticiones. Por defecto, se solicita autenticación &lt;em>basic&lt;/em> pero la invocación al método &lt;em>allowFormAuthenticationForClients()&lt;/em> hace que los parámetros de las credenciales se puedan indicar por parámetros.&lt;/p>
&lt;p>Con el &lt;em>endpoint&lt;/em> &lt;em>/oauth/check_token&lt;/em> se decodifica el &lt;em>token&lt;/em>. En la página de JWT hay una herramienta para decodificar el token y verificar de la firma introduciendo clave de firma en la casilla.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ curl -X POST -u &lt;span class="s2">&amp;#34;client:1234567890&amp;#34;&lt;/span> -d &lt;span class="s2">&amp;#34;grant_type=client_credentials&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;http://localhost:8095/oauth/token&amp;#34;&lt;/span>
&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;access_token&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ0MSwiYXV0aG9yaXRpZXMiOlsiQ0xJRU5UIl0sImp0aSI6IjEwMzE0NTk4LTRjZDctNDRmNi1hMmM4LTNjYjA5MGE1MjUxZSIsImNsaWVudF9pZCI6ImNsaWVudCJ9.n8Dwcd8YTms2Hl0YgTho9QdBWD1hAnOEmkcS-Wefy6c&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;token_type&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;bearer&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;expires_in&amp;#34;&lt;/span>:43199,&lt;span class="s2">&amp;#34;scope&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;read&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;jti&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;10314598-4cd7-44f6-a2c8-3cb090a5251e&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
$ curl -X POST &lt;span class="s2">&amp;#34;http://localhost:8095/oauth/token?grant_type=client_credentials&amp;amp;client_id=client&amp;amp;client_secret=1234567890&amp;#34;&lt;/span>
&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;access_token&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ1OCwiYXV0aG9yaXRpZXMiOlsiQ0xJRU5UIl0sImp0aSI6IjEzYjM1M2Q2LTQwODUtNDdiMS1hYzkyLTRiZDJhNDg3MzFhOCIsImNsaWVudF9pZCI6ImNsaWVudCJ9.CueMcwrD7pTp3pj37_BzzcUODG7PcjCacSa14-l5_Hw&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;token_type&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;bearer&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;expires_in&amp;#34;&lt;/span>:43199,&lt;span class="s2">&amp;#34;scope&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;read&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;jti&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;13b353d6-4085-47b1-ac92-4bd2a48731a8&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
$ curl -X POST -u &lt;span class="s2">&amp;#34;client:1234567890&amp;#34;&lt;/span> -d &lt;span class="s2">&amp;#34;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ1OCwiYXV0aG9yaXRpZXMiOlsiQ0xJRU5UIl0sImp0aSI6IjEzYjM1M2Q2LTQwODUtNDdiMS1hYzkyLTRiZDJhNDg3MzFhOCIsImNsaWVudF9pZCI6ImNsaWVudCJ9.CueMcwrD7pTp3pj37_BzzcUODG7PcjCacSa14-l5_Hw&amp;#34;&lt;/span> http://localhost:8095/oauth/check_token
&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;aud&amp;#34;&lt;/span>:&lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;service&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>,&lt;span class="s2">&amp;#34;scope&amp;#34;&lt;/span>:&lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;read&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>,&lt;span class="s2">&amp;#34;active&amp;#34;&lt;/span>:true,&lt;span class="s2">&amp;#34;exp&amp;#34;&lt;/span>:1549692458,&lt;span class="s2">&amp;#34;authorities&amp;#34;&lt;/span>:&lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;CLIENT&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>,&lt;span class="s2">&amp;#34;jti&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;13b353d6-4085-47b1-ac92-4bd2a48731a8&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;client_id&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;client&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/curl.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/oauth/curl.sh" target="_blank">oauth/curl.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="media" style="text-align: center;">
&lt;figure>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/images/encoded-decoded-jwt_hu1ab378b072a97342bd947994d891fa06_108022_2560x1440_fit_box_2.png" title="Token JWT codificado y decodificado" data-gallery>&lt;img src="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/images/encoded-decoded-jwt_hu1ab378b072a97342bd947994d891fa06_108022_600x450_fit_box_2.png" width="494"/>&lt;/a>
&lt;figcaption>Token JWT codificado y decodificado&lt;/figcaption>
&lt;/figure>
&lt;/div>
&lt;h3 id="servidor-gateway">Servidor Gateway&lt;/h3>
&lt;p>El servidor &lt;em>gateway&lt;/em> en realidad no interviene en la lógica de OAuth porque la autorización se delega en cada servicio que contiene el recurso. Como se indicaba en Idealista estaría bien que el &lt;em>gateway&lt;/em> librase de la responsabilidad de autorización a los servicios de los recursos para hacerlos más sencillos, creo que Spring Security en el momento del artículo no está soportado en Spring WebFlux que utiliza el &lt;em>gateway&lt;/em>.&lt;/p>
&lt;p>Lo único necesario par definir el &lt;em>gateway&lt;/em> son las dependencias del proyecto, poco más que &lt;em>spring-cloud-starter-gateway&lt;/em>, y la configuración de enrutado que &lt;em>matchea&lt;/em> peticiones según el parámetro &lt;em>predicates&lt;/em>, reescribe la URL hacia el servicio según el filtro &lt;em>RewritePath&lt;/em> y finalmente redirige la petición a la ubicación del servicio indicada en &lt;em>uri&lt;/em>. Se inicia con &lt;em>./gradlew gateway:run&lt;/em>.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Groovy" data-lang="Groovy">&lt;span class="n">plugins&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">id&lt;/span> &lt;span class="s1">&amp;#39;application&amp;#39;&lt;/span>
&lt;span class="n">id&lt;/span> &lt;span class="s1">&amp;#39;org.springframework.boot&amp;#39;&lt;/span> &lt;span class="n">version&lt;/span> &lt;span class="s1">&amp;#39;2.0.8.RELEASE&amp;#39;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">mainClassName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;io.github.picodotdev.blogbitix.springoauth.gateway.Main&amp;#39;&lt;/span>
&lt;span class="n">dependencies&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">implementation&lt;/span> &lt;span class="nf">platform&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.boot:spring-boot-dependencies:2.0.8.RELEASE&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">implementation&lt;/span> &lt;span class="nf">platform&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.cloud:spring-cloud-dependencies:Finchley.SR2&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kt">def&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="n">exclude&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nl">group:&lt;/span> &lt;span class="s1">&amp;#39;org.springframework.boot&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="nl">module:&lt;/span> &lt;span class="s1">&amp;#39;spring-boot-starter-logging&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.boot:spring-boot-starter&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.boot:spring-boot-starter-log4j2&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.cloud:spring-cloud-starter-gateway&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;com.google.code.gson:gson:2.8.5&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;com.fasterxml.jackson.core:jackson-databind:2.9.6&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;com.fasterxml.jackson.dataformat:jackson-dataformat-yaml:2.9.6&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/gateway/build.gradle" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/gateway/build.gradle" target="_blank">gateway/build.gradle&lt;/a>
&lt;/div>
&lt;/div>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Yaml" data-lang="Yaml">server.port&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8090&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>spring&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>cloud&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>gateway&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>routes&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>id&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>path_route&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>uri&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>http&lt;span class="p">:&lt;/span>//localhost&lt;span class="p">:&lt;/span>&lt;span class="m">8080&lt;/span>/&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>predicates&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>Path=/service/&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>filters&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>-&lt;span class="w"> &lt;/span>RewritePath=/service/&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>/&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/gateway/application.yml" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/gateway/application.yml" target="_blank">gateway/application.yml&lt;/a>
&lt;/div>
&lt;/div>
&lt;h3 id="servicio-servidor-de-recurso">Servicio, servidor de recurso&lt;/h3>
&lt;p>Dado que el servicio interpreta los &lt;em>tokens&lt;/em> JWT y aplica reglas de seguridad necesita las mismas dependencias que utiliza el servidor OAuth.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-Groovy" data-lang="Groovy">&lt;span class="n">plugins&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">id&lt;/span> &lt;span class="s1">&amp;#39;application&amp;#39;&lt;/span>
&lt;span class="n">id&lt;/span> &lt;span class="s1">&amp;#39;org.springframework.boot&amp;#39;&lt;/span> &lt;span class="n">version&lt;/span> &lt;span class="s1">&amp;#39;2.0.8.RELEASE&amp;#39;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="n">mainClassName&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;io.github.picodotdev.blogbitix.springoauth.service.Main&amp;#39;&lt;/span>
&lt;span class="n">dependencies&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">implementation&lt;/span> &lt;span class="nf">platform&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.boot:spring-boot-dependencies:2.0.8.RELEASE&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">implementation&lt;/span> &lt;span class="nf">platform&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.cloud:spring-cloud-dependencies:Finchley.SR2&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kt">def&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">{&lt;/span> &lt;span class="n">exclude&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="nl">group:&lt;/span> &lt;span class="s1">&amp;#39;org.springframework.boot&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="nl">module:&lt;/span> &lt;span class="s1">&amp;#39;spring-boot-starter-logging&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">}&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.boot:spring-boot-starter&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.boot:spring-boot-starter-web&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.boot:spring-boot-starter-log4j2&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.boot:spring-boot-starter-security&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.cloud:spring-cloud-starter-oauth2&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.security.oauth:spring-security-oauth2:2.3.4.RELEASE&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">compile&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.springframework.security:spring-security-jwt:1.0.10.RELEASE&amp;#39;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">excludeSpringBootStarterLogging&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;com.google.code.gson:gson:2.8.5&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;com.fasterxml.jackson.core:jackson-databind:2.9.6&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;com.fasterxml.jackson.dataformat:jackson-dataformat-yaml:2.9.6&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;javax.xml.bind:jaxb-api:2.3.0&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;com.sun.xml.bind:jaxb-impl:2.3.0&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;org.glassfish.jaxb:jaxb-runtime:2.3.0&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="n">runtime&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;javax.activation:activation:1.1.1&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/build.gradle" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/build.gradle" target="_blank">service/build.gradle&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>El recurso es muy simple, solo devuelve un mensaje.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">package&lt;/span> &lt;span class="nn">io.github.picodotdev.blogbitix.springoauth.service&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="o">.&lt;/span>
&lt;span class="nd">@RestController&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">DefaultController&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">Random&lt;/span> &lt;span class="n">random&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="nf">DefaultController&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">this&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">random&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">Random&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@RequestMapping&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">String&lt;/span> &lt;span class="nf">home&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">HttpServletRequest&lt;/span> &lt;span class="n">request&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">String&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">format&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;Hello world (%s)&amp;#34;&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">getRequestURL&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/DefaultController.java" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/DefaultController.java" target="_blank">service/DefaultController.java&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>El servicio comparte configuración similar al servidor de Ouath par el &lt;em>JwtAccessTokenConverter&lt;/em>, &lt;em>TokenStore&lt;/em> y &lt;em>DefaultTokenServices&lt;/em>. En el método configure se define que el &lt;em>endpoint&lt;/em> &lt;em>/&lt;/em> requiere el rol &lt;em>CLIENT&lt;/em> que se obtiene del token JWT enviado. Hay que utilizar la anotación &lt;em>@EnableResourceServer&lt;/em>, se inicia con el comando &lt;em>./gradlew service:run&lt;/em>.&lt;/p>
&lt;p>Hay que recalcar que el servicio para verificar el &lt;em>token&lt;/em> y comprobar la autorización no necesita comunicarse con el servidor OAuth toda la información que necesita está en el &lt;em>token&lt;/em>.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kn">package&lt;/span> &lt;span class="nn">io.github.picodotdev.blogbitix.springoauth.service&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">.&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="o">.&lt;/span>
&lt;span class="nd">@Configuration&lt;/span>
&lt;span class="nd">@EnableResourceServer&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">ResourceServerConfiguration&lt;/span> &lt;span class="kd">extends&lt;/span> &lt;span class="n">ResourceServerConfigurerAdapter&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">JwtAccessTokenConverter&lt;/span> &lt;span class="n">tokenConverter&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">TokenStore&lt;/span> &lt;span class="n">tokenStore&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Autowired&lt;/span>
&lt;span class="kd">private&lt;/span> &lt;span class="n">DefaultTokenServices&lt;/span> &lt;span class="n">tokenServices&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">JwtAccessTokenConverter&lt;/span> &lt;span class="nf">tokenConverter&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">JwtAccessTokenConverter&lt;/span> &lt;span class="n">converter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">JwtAccessTokenConverter&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">converter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setSigningKey&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;1234567890&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">converter&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="n">TokenStore&lt;/span> &lt;span class="nf">tokenStore&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">JwtAccessTokenConverter&lt;/span> &lt;span class="n">tokenConverter&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">JwtTokenStore&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tokenConverter&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Bean&lt;/span>
&lt;span class="n">DefaultTokenServices&lt;/span> &lt;span class="nf">tokenServices&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">TokenStore&lt;/span> &lt;span class="n">tokenStore&lt;/span>&lt;span class="o">,&lt;/span> &lt;span class="n">JwtAccessTokenConverter&lt;/span> &lt;span class="n">tokenConverter&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">DefaultTokenServices&lt;/span> &lt;span class="n">tokenServices&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="n">DefaultTokenServices&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">tokenServices&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setTokenStore&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tokenStore&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="n">tokenServices&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">setTokenEnhancer&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tokenConverter&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">tokenServices&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">configure&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">ResourceServerSecurityConfigurer&lt;/span> &lt;span class="n">resources&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">resources&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">tokenServices&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">tokenServices&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">resourceId&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;service&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="nd">@Override&lt;/span>
&lt;span class="kd">public&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">configure&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="n">HttpSecurity&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="kd">throws&lt;/span> &lt;span class="n">Exception&lt;/span> &lt;span class="o">{&lt;/span>
&lt;span class="n">http&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">authorizeRequests&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">antMatchers&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">hasAuthority&lt;/span>&lt;span class="o">(&lt;/span>&lt;span class="s">&amp;#34;CLIENT&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="o">;&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/ResourceServerConfiguration.java" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/ResourceServerConfiguration.java" target="_blank">service/ResourceServerConfiguration.java&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Si no se envía el &lt;em>token&lt;/em> JWT se produce un error de autenticación con código de error &lt;em>401 Unauthorized&lt;/em>, si se envía un token correcto y la autoridad requerida del recurso la petición se devuelve el mensaje u el código de estado &lt;em>200 OK&lt;/em>, si se envía un &lt;em>token&lt;/em> JWT con una autoridad que no corresponde con la necesaria para el recurso, en el ejemplo una autoridad &lt;em>DUMMY&lt;/em>, se devuelve un código de estado &lt;em>403 Forbbiden&lt;/em>.&lt;/p>
&lt;div class="code">
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">$ curl -v http://localhost:8090/service/
* Trying ::1...
* TCP_NODELAY &lt;span class="nb">set&lt;/span>
* Connected to localhost &lt;span class="o">(&lt;/span>::1&lt;span class="o">)&lt;/span> port &lt;span class="m">8090&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="c1">#0)&lt;/span>
&amp;gt; GET /service/ HTTP/1.1
&amp;gt; Host: localhost:8090
&amp;gt; User-Agent: curl/7.63.0
&amp;gt; Accept: */*
&amp;gt;
&amp;lt; HTTP/1.1 &lt;span class="m">401&lt;/span> Unauthorized
&amp;lt; transfer-encoding: chunked
&amp;lt; Cache-Control: no-store
&amp;lt; Pragma: no-cache
&amp;lt; WWW-Authenticate: Bearer &lt;span class="nv">realm&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;service&amp;#34;&lt;/span>, &lt;span class="nv">error&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;unauthorized&amp;#34;&lt;/span>, &lt;span class="nv">error_description&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Full authentication is required to access this resource&amp;#34;&lt;/span>
&amp;lt; X-Content-Type-Options: nosniff
&amp;lt; X-XSS-Protection: 1&lt;span class="p">;&lt;/span> &lt;span class="nv">mode&lt;/span>&lt;span class="o">=&lt;/span>block
&amp;lt; X-Frame-Options: DENY
&amp;lt; Content-Type: application/json&lt;span class="p">;&lt;/span>&lt;span class="nv">charset&lt;/span>&lt;span class="o">=&lt;/span>UTF-8
&amp;lt; Date: Fri, &lt;span class="m">08&lt;/span> Feb &lt;span class="m">2019&lt;/span> 18:58:03 GMT
&amp;lt;
* Connection &lt;span class="c1">#0 to host localhost left intact&lt;/span>
&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;error&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;unauthorized&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;error_description&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;Full authentication is required to access this resource&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
$ curl -H &lt;span class="s2">&amp;#34;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ1OCwiYXV0aG9yaXRpZXMiOlsiQ0xJRU5UIl0sImp0aSI6IjEzYjM1M2Q2LTQwODUtNDdiMS1hYzkyLTRiZDJhNDg3MzFhOCIsImNsaWVudF9pZCI6ImNsaWVudCJ9.CueMcwrD7pTp3pj37_BzzcUODG7PcjCacSa14-l5_Hw&amp;#34;&lt;/span> http://localhost:8090/service/
Hello world &lt;span class="o">(&lt;/span>http://localhost:8080/&lt;span class="o">)&lt;/span>
$ curl -X POST -u &lt;span class="s2">&amp;#34;client:1234567890&amp;#34;&lt;/span> -d &lt;span class="s2">&amp;#34;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ1OCwiYXV0aG9yaXRpZXMiOlsiRFVNTVkiXSwianRpIjoiMTNiMzUzZDYtNDA4NS00N2IxLWFjOTItNGJkMmE0ODczMWE4IiwiY2xpZW50X2lkIjoiY2xpZW50In0.RaeQYdukn8Xr8S9ld5Vy2UnYboUjPyMkutNgyfVN-Bc&amp;#34;&lt;/span> http://localhost:8095/oauth/check_token
&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;aud&amp;#34;&lt;/span>:&lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;service&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>,&lt;span class="s2">&amp;#34;scope&amp;#34;&lt;/span>:&lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;read&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>,&lt;span class="s2">&amp;#34;active&amp;#34;&lt;/span>:true,&lt;span class="s2">&amp;#34;exp&amp;#34;&lt;/span>:1549692458,&lt;span class="s2">&amp;#34;authorities&amp;#34;&lt;/span>:&lt;span class="o">[&lt;/span>&lt;span class="s2">&amp;#34;DUMMY&amp;#34;&lt;/span>&lt;span class="o">]&lt;/span>,&lt;span class="s2">&amp;#34;jti&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;13b353d6-4085-47b1-ac92-4bd2a48731a8&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;client_id&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;client&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
$ curl -v -H &lt;span class="s2">&amp;#34;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ1OCwiYXV0aG9yaXRpZXMiOlsiRFVNTVkiXSwianRpIjoiMTNiMzUzZDYtNDA4NS00N2IxLWFjOTItNGJkMmE0ODczMWE4IiwiY2xpZW50X2lkIjoiY2xpZW50In0.RaeQYdukn8Xr8S9ld5Vy2UnYboUjPyMkutNgyfVN-Bc&amp;#34;&lt;/span> http://localhost:8090/service/
&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;error&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;access_denied&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;error_description&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;Access is denied&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
* Trying ::1...
* TCP_NODELAY &lt;span class="nb">set&lt;/span>
* Connected to localhost &lt;span class="o">(&lt;/span>::1&lt;span class="o">)&lt;/span> port &lt;span class="m">8090&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="c1">#0)&lt;/span>
&amp;gt; GET /service/ HTTP/1.1
&amp;gt; Host: localhost:8090
&amp;gt; User-Agent: curl/7.63.0
&amp;gt; Accept: */*
&amp;gt; Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsic2VydmljZSJdLCJzY29wZSI6WyJyZWFkIl0sImV4cCI6MTU0OTY5MjQ1OCwiYXV0aG9yaXRpZXMiOlsiRFVNTVkiXSwianRpIjoiMTNiMzUzZDYtNDA4NS00N2IxLWFjOTItNGJkMmE0ODczMWE4IiwiY2xpZW50X2lkIjoiY2x
pZW50In0.RaeQYdukn8Xr8S9ld5Vy2UnYboUjPyMkutNgyfVN-Bc
&amp;gt;
&amp;lt; HTTP/1.1 &lt;span class="m">403&lt;/span> Forbidden
&amp;lt; transfer-encoding: chunked
&amp;lt; Cache-Control: no-store
&amp;lt; Pragma: no-cache
&amp;lt; X-Content-Type-Options: nosniff
&amp;lt; X-XSS-Protection: 1&lt;span class="p">;&lt;/span> &lt;span class="nv">mode&lt;/span>&lt;span class="o">=&lt;/span>block
&amp;lt; X-Frame-Options: DENY
&amp;lt; Content-Type: application/json&lt;span class="p">;&lt;/span>&lt;span class="nv">charset&lt;/span>&lt;span class="o">=&lt;/span>UTF-8
&amp;lt; Date: Fri, &lt;span class="m">08&lt;/span> Feb &lt;span class="m">2019&lt;/span> 19:02:14 GMT
&amp;lt;
* Connection &lt;span class="c1">#0 to host localhost left intact&lt;/span>
&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;error&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;access_denied&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;error_description&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;Access is denied&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>
&lt;div class="highlight-meta">
&lt;span class="raw">&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/curl.sh" target="_blank">view raw&lt;/a>&lt;/span>
&lt;a href="https://picodotdev.github.io/blog-bitix/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/code/service/curl.sh" target="_blank">service/curl.sh&lt;/a>
&lt;/div>
&lt;/div>
&lt;p>Los &lt;em>tokens&lt;/em> JWT además de firmar se pueden cifrar, en el ejemplo se usa una conexión no segura con el protocolo HTTP usando una conexión segura HTTPS ya se proporcionaría confidencialidad para los &lt;em>tokens&lt;/em> y es lo recomendado.&lt;/p>
&lt;p>
El &lt;a href="https://github.com/picodotdev/blog-ejemplos/tree/master/SpringOauth">código fuente completo del ejemplo&lt;/a> puedes descargarlo del repositorio de ejemplos de Blog Bitix alojado en &lt;a href="https://github.com/">GitHub&lt;/a> y probarlo en tu equipo ejecutando el comando &lt;code>./gradlew oauth:run, ./gradlew gateway:run, ./gradlew service:run&lt;/code>.
&lt;/p>
&lt;div class="reference">
Referencia:&lt;br>
&lt;ul>
&lt;li>&lt;a href="https://www.baeldung.com/spring-security-oauth-jwt">Using JWT with Spring Security OAuth&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://websystique.com/spring-security/secure-spring-rest-api-using-oauth2/">Secure Spring REST API using OAuth2&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.devglan.com/spring-security/spring-boot-oauth2-jwt-example">Spring Boot Security OAuth2 Jwt Auth Example&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.jorgehernandezramirez.com/2017/04/17/spring-boot-oauth-server/">Spring Boot – OAuth Server&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stackoverflow.com/questions/23950068/spring-oauth2-full-authentication-is-required-to-access-this-resource">Spring OAuth2 &amp;ldquo;Full authentication is required to access this resource&amp;rdquo;&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stackoverflow.com/questions/52606720/issue-with-having-multiple-websecurityconfigureradapter-in-spring-boot">Issue with having multiple WebSecurityConfigurerAdapter in spring-boot&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stackoverflow.com/questions/49654143/spring-security-5-there-is-no-passwordencoder-mapped-for-the-id-null">Spring Security 5: There is no PasswordEncoder mapped for the id &amp;ldquo;null&amp;rdquo;&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div></content><category term="java"/><category term="planeta-codigo"/><category term="programacion"/><category term="software"/><category term="spring"/></entry></feed>