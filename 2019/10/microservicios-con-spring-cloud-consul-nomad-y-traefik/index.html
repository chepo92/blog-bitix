<!doctype html><html lang=es><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="picodotdev"><meta name=keywords content="java,programacion,software,hardware,tapestry,software libre,gnu,linux,gnu/linux,unix,arch,arch linux,html,css,javascript"><meta name=description content="Sin entrar a si los microservicios son adecuados o no son adecuados en una aplicación, está claro que si se utilizan estos tienen varias necesidades. Un servicio de registro y descubrimiento, configuración centralizada, tolerancia a fallos, gateway/load balancer/reverse proxy, trazabilidad y métricas, autenticación, orquestación, &mldr; Los microservicios quiza no sean un gran monolito, quizá mas pequeños y con funcinalidad más acotada, pero el hecho de que se comuniquen a través de un medio más complejo y menos fiable como la red en vez de una llamada a un método y sean más numerosos hacen que la complejidad sea incluso mayor. Este artículo propone un ejemplo con Spring Cloud para los servicios, Consul para el registro y descubrimiento, Nomad para la orquestación y Traefik como gateway. &mldr;"><base href=https://picodotdev.github.io/blog-bitix/><title>Microservicios con Spring Cloud, Consul, Nomad y Traefik</title><link rel=author type=text/plain href=humans.txt><link rel="shortcut icon" href=assets/favicon.ico><link rel=apple-touch-icon-precomposed sizes=144x144 href=assets/apple-touch-icon-144-precomposed.png><link rel=canonical href=https://picodotdev.github.io/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/><link href=index.xml rel=alternate type=application/rss+xml title="Blog Bitix"><link rel=stylesheet type=text/css href=assets/css/font.css><link rel=stylesheet type=text/css href=assets/libs/bootstrap-4.3.1/css/bootstrap.min.css><link rel=stylesheet type=text/css href=assets/libs/Gallery-2.33.0/css/blueimp-gallery.min.css><link rel=stylesheet type=text/css href=assets/css/syntax.css><link rel=stylesheet type=text/css href=assets/css/main.css><script type=text/javascript src=assets/js/require-config.js data-main=js/main defer></script><script type=text/javascript src=assets/libs/require.js data-main=js/main defer></script><script src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js defer></script><script type=text/javascript defer>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:'ca-pub-3533636310991304',enable_page_level_ads:true});</script><script type=text/javascript defer>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-12874075-4','picodotdev.github.io');ga('send','pageview');</script><script type=text/javascript src="//platform-api.sharethis.com/js/sharethis.js#property=5920c4ce1bd0670011e06acd&product=inline-share-buttons" defer></script><script type=text/javascript src=assets/js/app.js defer></script></head><body><div class=container><div class=row><div class=col-12><header><div class=row><div class="col-12 col-lg-4"></div><div class="col-12 col-lg-4"><h2 class=title><a href=https://picodotdev.github.io/blog-bitix/>Blog Bitix</a></h2><div class=links><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class="col-12 col-lg-4 text-center"><form name=query class="form-inline search" onsubmit="return false;"><div class=input-group><input type=text name=q class=form-control placeholder="Buscar en Blog Bitix">
<span class=input-group-btn><button class="btn btn-secondary" type=submit>Buscar</button></span></div></form><form name=search action=https://duckduckgo.com/ method=get class=hidden data-site=https://picodotdev.github.io/blog-bitix/><input type=hidden name=q></form></div></div><div class=row><div class=col-12><nav class="nav nav-pills nav-fill"><a href=/blog-bitix/tags/java/ class="nav-item nav-link">Java</a>
<a href=/blog-bitix/tags/gnu-linux/ class="nav-item nav-link">GNU/Linux</a>
<a href=/blog-bitix/tags/javascript/ class="nav-item nav-link">JavaScript</a>
<a href=/blog-bitix/tags/tapestry/ class="nav-item nav-link">Tapestry</a>
<a href=/blog-bitix/archive/ class="nav-item nav-link">Archivo y hemeroteca</a>
<a href=/blog-bitix/pages/links/ class="nav-item nav-link">Enlaces</a>
<a href=/blog-bitix/pages/about/ class="nav-item nav-link">Acerca de...</a></nav></div></div></header></div></div><div class=row><div class="col-12 text-center"><ins class=adsbygoogle style=display:inline-block;width:970px;height:250px data-ad-client=ca-pub-3533636310991304 data-ad-slot=2975854584 data-type=billboard></ins></div></div><div class=row><div class=col-12><div class="adblock-sidebar adblock-sidebar-right"><div class=adblock-sidebar-container><ins class="adsbygoogle adblock-sidebar-vertical" style=display:block data-ad-client=ca-pub-3533636310991304 data-ad-slot=9933840986 data-ad-format="vertical, rectangle" data-type=auto></ins></div></div><article itemprop=mainEntity itemscope itemtype=http://schema.org/BlogPosting><meta itemprop=inLanguage content="es"><meta itemprop=keywords content="java, planeta-codigo, programacion, software, software-libre"><h1 itemprop=name>Microservicios con Spring Cloud, Consul, Nomad y Traefik</h1><p class=information>Escrito por
<span itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>picodotdev</span></span> el <time itemprop=datePublished datetime=2019-10-12>12/10/2019</time>.<br><a href=tags/java/>java</a> <a href=tags/planeta-codigo/>planeta-codigo</a> <a href=tags/programacion/>programacion</a> <a href=tags/software/>software</a> <a href=tags/software-libre/>software-libre</a><br><a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/ itemprop=url>Enlace permanente</a>
<a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/#comments>Comentarios</a></p><p class=summary itemprop=about>Sin entrar a si los microservicios son adecuados o no son adecuados en una aplicación, está claro que si se utilizan estos tienen varias necesidades. Un servicio de registro y descubrimiento, configuración centralizada, tolerancia a fallos, <em>gateway/load balancer/reverse proxy</em>, trazabilidad y métricas, autenticación, orquestación, &mldr; Los microservicios quiza no sean un gran monolito, quizá mas pequeños y con funcinalidad más acotada, pero el hecho de que se comuniquen a través de un medio más complejo y menos fiable como la red en vez de una llamada a un método y sean más numerosos hacen que la complejidad sea incluso mayor. Este artículo propone un ejemplo con Spring Cloud para los servicios, Consul para el registro y descubrimiento, Nomad para la orquestación y Traefik como <em>gateway</em>.</p><div><ins class=adsbygoogle style=display:inline-block;width:728px;height:90px data-ad-client=ca-pub-3533636310991304 data-ad-slot=5966819782 data-type=leaderboard></ins></div><div class=content itemprop=articleBody><meta itemprop=wordCount content="2168"><div class=logotypes style=float:right><img src=/blog-bitix/assets/images/logotipos/java.svg class=right width=200 alt=Java title=Java></div><div class=logotypes style=float:right;clear:right><img src=/blog-bitix/assets/images/logotipos/spring.svg class=right width=200 alt=Spring title=Spring></div><p>En otro artículo mostraba un ejemplo de <a href=https://picodotdev.github.io/blog-bitix/2018/09/registro-y-descubrimiento-de-servicios-con-spring-cloud-netflix/>microservicios con Spring Cloud</a> usando únicamente herramientas de <a href=https://spring.io/>Spring</a>. Cada una de esas herramientas cubren una funcionalidad que necesitan los microservicios. Entre ellas:</p><ul><li>Registro y descubrimiento, con <a href=https://github.com/Netflix/eureka>Eureka</a>. Los microservicios son numerosos, de vida efímera creándose y destruyéndose en diferentes ubicaciones por lo tanto necesitan una forma de localizarse unos a otros, la forma para encontrarse es acudiendo a un servicio donde se registran cuando se inician y se descubren cuando necesitan la ubicación de otro servicio.</li><li>Configuración centralizada, con <a href=https://cloud.spring.io/spring-cloud-config/>Spring Cloud Config</a>. Dado el número de microservicios actualizar la configuración de cada uno de ellos puede ser un problema, además dado que se pueden iniciar en diferentes ubicaciones aprovisionarles la configuración adecuada es un reto. En vez de aprovisionar la configuración otra técnica es hacer que cuando se inicien la obtengan de un servicio donde queda centralizada la configuración.</li><li>Tolerancia a fallos, con <a href=https://github.com/Netflix/Hystrix>Hyxtrix</a> y <a href=https://github.com/resilience4j/resilience4j>Resilience4j</a>. El medio de comunicación de los microservicios es a través de la red un medio mucho menos confiable que una llamada a un método en un lenguaje de programación en una aplicación monolítica. De modo que los microservicios han de estar preparados para tolerar fallos en sus comunicaciones con otros servicios.</li><li><em>Gateway</em>, <em>load balancer</em> y <em>reverse proxy</em> con tolerancia a fallos, con <a href=https://github.com/Netflix/zuul>Zuul</a>. Para aumentar la disponibilidad, escalabilidad y tolerar fallos en algunos servicios se suelen crear varias instancias de cada microservicio pero tener varias instancias hace que sea necesario balancear la carga entre cada una de las instancias. Para que los clientes sean agnósticos del número de instancias se emplea un <em>gateway</em> que proporciona balanceo de carga e implementa a su vez patrones de tolerancia a fallos.</li><li>Trazabilidad y correlación de trazas entre diferentes servicios, con <a href=https://spring.io/projects/spring-cloud-sleuth>Spring Cloud Sleuth</a>. Una petición puede desencadenar una cadena de peticiones entre diferentes servicios ubicados en múltiples nodos, para tareas de diagnóstico en caso de querer investigar un <em>bug</em> o que ha ocurrido es necesario correlacionar todas las trazas que ha desencadenado una petición, se implementa asignado un identificativo global a la petición que es transmitido en las llamadas de microservicio a microservicio.</li></ul><p>En otro <a href=https://picodotdev.github.io/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/>ejemplo sobre OAuth con Spring</a> mostraba otra funcionalidad:</p><ul><li><em>Gateway</em>, con <a href=https://spring.io/projects/spring-cloud-gateway>Spring Cloud Gateway</a>.</li><li>Autenticación y autorización, con <a href=https://spring.io/projects/spring-security-oauth>Spring Security OAuth</a>.</li></ul><p>Los microservicios también necesitan monitorización y métricas, en el ejemplo <a href=https://picodotdev.github.io/blog-bitix/2018/12/monitorizar-una-aplicacion-java-de-spring-boot-con-micrometer-prometheus-y-grafana/>Monitorizar una aplicación Java de Spring Boot con Micrometer, Prometheus y Grafana</a>:</p><ul><li>Con <a href=https://prometheus.io/>Prometheus</a> y <a href=https://grafana.com/>Grafana</a>. Nuevamente el número de instancias que requiere una arquitectura orientada a microservicios origina la necesidad en mayor medida de conocer el estado del sistema, ya sean métricas de los sistemas como uso de CPU, memoria o almacenamiento o de la aplicación como peticiones por segundo y porcentaje de correctas e incorrectas.</li></ul><p>En esta lista falta un orquestador para el despliegue de los microservicios, que se encargue de su ciclo de vida, escalado de instancias y despliegue con estrategias <em>rolling</em>, <em>blue/green</em> y <em>canary</em>. Es una cosa que le faltaba al ejemplo de microservicios con Spring Cloud.</p><ul><li>Orquestador de servicios, con <a href=https://www.nomadproject.io/>Nomad</a>. <a href=https://picodotdev.github.io/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/>Introducción a Nomad para gestionar aplicaciones y microservicios</a>, <a href=https://picodotdev.github.io/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/>Estrategias de despliegue para microservicios con Nomad</a>.</li></ul><p>Además, en este ejemplo reemplazo varias de estas herramientas de Spring. Sustituyo el servicio de registro y descubrimiento proporcionado por Eureka por <a href=https://www.consul.io/>Consul</a>, el <em>gateway</em>, <em>load balancer</em> y <em>reverse proxy</em> proporcionado por Zuul por <a href=https://traefik.io/>Traefik</a> y añado el orquestador de microservicios <a href=https://www.nomadproject.io/>Nomad</a>.</p><div class=media><img src=assets/images/logotipos/consul.svg alt=Consul title=Consul width=200>
<img src=assets/images/logotipos/nomad.svg alt=Nomad title=Nomad width=200>
<img src=assets/images/logotipos/traefik.svg alt=Traefik title=Traefik width=200></div><p>Traefik se configura con los servicios iniciados en los contenedores de Docker utilizando junto con los bloques o <em>stanzas</em> de <em>config</em> y <em>labels</em> en la definición de los servicios de Nomad. Según el criterio definido por el servicio Traefik es capaz de redirigir el tráfico que le llegue al servicio apropiado, entre las posibilidades que puede realizar Traefik es balanceo de carga entre las múltiples instancias que se hayan definido pero también implementa patrones de tolerancia a fallos con reintentos, el patrón <em>circuit breaker</em> o limitar el tráfico para evitar saturar a un servicio con demasiadas peticiones.</p><p>El esquema de servicios sería el siguiente. Los <em>job</em> son enviados a Nomad desde la linea de comandos que inicia los contenedores en Docker y registra los servicios en Consul, Traefik monitoriza los contenedores que se inician en Docker y se autoconfigura según las propiedades de los <em>labels</em> definidos para los contenedores. Una vez iniciados los servicios desde la terminal con un <em>curl</em> o desde la aplicación cliente que accede a Consul para conocer la ubicación del servicio de Traefik envían una petición a Traefik que haciendo balanceo de carga la reenvía a una de las instancias del servicio, el servicio responde y Traefik envía la respuesta al cliente. Para ser más funcional Traefik debería configurarse a partir de Consul en vez de Docker para posibilitar que los contenedores pudieran estar en varios nodos.</p><div class=media><figure><a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/esquema-arquitectura_hud9745ca4e3e6c708b4af1c72fc0d4ff7_167252_2560x1440_fit_box_2.png title="Esquema arquitectura" data-gallery=data-gallery><img src=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/esquema-arquitectura_hud9745ca4e3e6c708b4af1c72fc0d4ff7_167252_600x450_fit_box_2.png width=600></a><figcaption>Esquema arquitectura</figcaption></figure></div><p>La ejecución del ejemplo requiere <a href=https://www.docker.com/>Docker</a> ya que es en este caso el <em>driver</em> empleado en Nomad para ejecutar los servicios del servicio de configuración, el <em>gateway</em>, el servicio y el cliente del servicio. Nomad además se encarga de registrar los servicios en el servicio de registro y descubrimiento de Consul.</p><p>Los contenedores de Docker se añade a una misma red para que puedan comunicarse entre ellos, ha de ser así hasta que no se resuelva una <a href=https://github.com/docker/for-linux/issues/264>petición de Docker para que los contenedores puedan comunicarse con la máquina <em>host</em></a> que los alberga.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ docker network create --subnet 172.30.0.0/16 nomad
</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/docker-network-create.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/docker-network-create.sh target=_blank>docker-network-create.sh</a></div></div><p>Poteriormente hay que ejecutar Consul y Nomad tras lo cual se puede acceder a sus consolas de estado.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ consul agent -dev -ui -client<span class=o>=</span>0.0.0.0
$ nomad agent -dev</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/nomad-consul-run.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/nomad-consul-run.sh target=_blank>nomad-consul-run.sh</a></div></div><p>Enviar a Nomad los <em>job</em> de Traefik tras lo cual se puede acceder a su consola de estado. El siguiente paso es enviar el <em>job</em> del servicio que proporciona la configuración a los microservicios. Lo anterior únicamente es infraestructura aún no hay ningún servicio que proporcione alguna funcionalidad, la funcionalidad que proporciona el servicio implementado con Spring es simplemente devolver un mensaje como respuesta a la petición que se le realice, se envía el <em>job</em> del servicio a Nomad. Finalmente, el servicio es consumido por un cliente que realiza una petición al servicio cada 1 segundo.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ ./gradlew assemble

$ nomad job run nomad/traefik.nomad
$ nomad job run nomad/configserver.nomad
$ nomad job run nomad/service.nomad
$ nomad job run nomad/client.nomad</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/nomad-job-run.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/nomad-job-run.sh target=_blank>nomad-job-run.sh</a></div></div><p>Definición de un servicio en un <em>job</em> para Nomad. <em>count</em> define cuantas instancias del servicio se inicia, la <em>stanza</em> <em>update</em> define como será la actualización cuando se actualice el servicio, la <em>stanza</em> <em>labels</em> contiene la configuración para Traefik, <em>check</em> define los parámetros para la monitorización.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-HCL data-lang=HCL><span class=k>job</span> <span class=s2>&#34;service&#34;</span> {
<span class=n>  datacenters</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;dc1&#34;</span><span class=p>]</span>

  <span class=k>group</span> <span class=s2>&#34;service&#34;</span> {
<span class=n>    count</span> <span class=o>=</span> <span class=m>2</span>

    <span class=k>update</span> {
<span class=n>      max_parallel</span>      <span class=o>=</span> <span class=m>1</span>
<span class=n>      health_check</span>      <span class=o>=</span> <span class=s2>&#34;checks&#34;</span>
<span class=n>      min_healthy_time</span>  <span class=o>=</span> <span class=s2>&#34;20s&#34;</span>
<span class=n>      healthy_deadline</span>  <span class=o>=</span> <span class=s2>&#34;10m&#34;</span>
<span class=n>      progress_deadline</span> <span class=o>=</span> <span class=s2>&#34;20m&#34;</span>
<span class=n>      canary</span>            <span class=o>=</span> <span class=m>1</span>
<span class=n>      stagger</span>           <span class=o>=</span> <span class=s2>&#34;15s&#34;</span>
    }

    <span class=k>task</span> <span class=s2>&#34;service&#34;</span> {
<span class=n>      driver</span> <span class=o>=</span> <span class=s2>&#34;docker&#34;</span>
      <span class=k>config</span> {
<span class=n>        image</span> <span class=o>=</span> <span class=s2>&#34;openjdk:11-jdk&#34;</span>
<span class=n>        args</span> <span class=o>=</span> <span class=p>[</span>
          <span class=s2>&#34;bash&#34;</span><span class=p>,</span>
          <span class=s2>&#34;-c&#34;</span><span class=p>,</span>
<span class=n>          &#34;(cd /app &amp;&amp; java -jar /app/service/build/libs/service-1.0.jar --port</span><span class=o>=</span><span class=m>8080</span><span class=p>)</span><span class=err>&#34;</span>
        <span class=p>]</span>
        <span class=k>port_map</span> {
<span class=n>          http</span> <span class=o>=</span> <span class=s2>&#34;8080&#34;</span>
        }
<span class=n>        network_mode</span> <span class=o>=</span> <span class=s2>&#34;nomad&#34;</span>
<span class=n>        extra_hosts</span> <span class=o>=</span> <span class=p>[</span>
          <span class=s2>&#34;traefik:172.30.0.3&#34;</span>
        <span class=p>]</span>
<span class=n>        volumes</span> <span class=o>=</span> <span class=p>[</span>
          <span class=s2>&#34;/home/picodotdev/Software/personal/blog-ejemplos/SpringCloudConsulNomadTraefik/:/app&#34;</span>
        <span class=p>]</span>
        <span class=k>labels</span> {
<span class=n>          traefik.http.middlewares.service1-stripprefix.stripprefix.prefixes</span><span class=o>=</span><span class=s2>&#34;/service&#34;</span><span class=p>,</span>
<span class=n>          traefik.http.middlewares.service1-retry.retry.attempts</span><span class=o>=</span><span class=s2>&#34;10&#34;</span><span class=p>,</span>
<span class=n>          traefik.http.routers.service1.middlewares</span><span class=o>=</span><span class=s2>&#34;service1-stripprefix,service1-retry&#34;</span><span class=p>,</span>
<span class=n>          traefik.http.routers.service1.rule</span><span class=o>=</span><span class=s2>&#34;PathPrefix(`/service`)&#34;</span><span class=p>,</span>
<span class=n>          traefik.http.services.service1.loadbalancer.server.port</span><span class=o>=</span><span class=s2>&#34;8080&#34;</span>
        }
      }

      <span class=k>service</span> {
<span class=n>        name</span> <span class=o>=</span> <span class=s2>&#34;service&#34;</span>
<span class=n>        port</span> <span class=o>=</span> <span class=s2>&#34;http&#34;</span>

        <span class=k>check</span> {
<span class=n>          type</span>     <span class=o>=</span> <span class=s2>&#34;http&#34;</span>
<span class=n>          port</span>     <span class=o>=</span> <span class=s2>&#34;http&#34;</span>
<span class=n>          path</span>     <span class=o>=</span> <span class=s2>&#34;/actuator/health&#34;</span>
<span class=n>          interval</span> <span class=o>=</span> <span class=s2>&#34;5s&#34;</span>
<span class=n>          timeout</span>  <span class=o>=</span> <span class=s2>&#34;2s&#34;</span>
        }
      }

      <span class=k>resources</span> {
<span class=n>        cpu</span>    <span class=o>=</span> <span class=m>200</span>
<span class=n>        memory</span> <span class=o>=</span> <span class=m>1024</span>
        <span class=k>network</span> {
<span class=n>          mbits</span> <span class=o>=</span> <span class=m>20</span>
          <span class=k>port</span> <span class=s2>&#34;http&#34;</span> {}
        }
      }
    }
  }
}</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/service.nomad target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/service.nomad target=_blank>service.nomad</a></div></div><p>Tanto Consul, Nomad como Traefik ofrecen una consola para ver su estado ubicadas en las siguientes direcciones respectivamente accesibles con el navegador <em>http://127.0.0.1:8500</em>, <em>http://127.0.0.1:4646</em>, <em>http://127.0.0.1:8092</em>.</p><div class=media><figure><a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/consul_hudc42d06e92419bb68cedcf920ffbb9e1_66952_2560x1440_fit_box_2.png title=Consul data-gallery=data-gallery><img src=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/consul_hudc42d06e92419bb68cedcf920ffbb9e1_66952_200x150_fit_box_2.png width=200></a>
<a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/nomad-1_hu236530498253a3dba6bcdeea43b58303_63779_2560x1440_fit_box_2.png title=Nomad data-gallery=data-gallery><img src=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/nomad-1_hu236530498253a3dba6bcdeea43b58303_63779_200x150_fit_box_2.png width=200></a>
<a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/nomad-2_huf614ca5d87e91f36d0a6f0dc0f7e1da1_112167_2560x1440_fit_box_2.png title=Nomad data-gallery=data-gallery><img src=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/nomad-2_huf614ca5d87e91f36d0a6f0dc0f7e1da1_112167_200x150_fit_box_2.png width=200></a></figure><figure><a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/traefik-1_hu752c6a0b248029866df45cca04eee0f1_104793_2560x1440_fit_box_2.png title=Traefik data-gallery=data-gallery><img src=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/traefik-1_hu752c6a0b248029866df45cca04eee0f1_104793_200x150_fit_box_2.png width=200></a>
<a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/traefik-2_hu3d23c9c51ffc17299ed33c1319107a0c_130051_2560x1440_fit_box_2.png title=Traefik data-gallery=data-gallery><img src=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/images/traefik-2_hu3d23c9c51ffc17299ed33c1319107a0c_130051_200x150_fit_box_2.png width=200></a><figcaption>Consolas de administración de Consul, Nomad y Traefik</figcaption></figure></div><p>El código del servicio, del cliente implementados con Spring y la salida del cliente son los siguientes.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>io.github.picodotdev.blogbitix.springcloud.service</span><span class=o>;</span>

<span class=o>.</span><span class=o>.</span><span class=o>.</span>

<span class=nd>@RestController</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>DefaultController</span> <span class=o>{</span>

    <span class=nd>@Autowired</span>
    <span class=kd>private</span> <span class=n>DefaultConfiguration</span> <span class=n>configuration</span><span class=o>;</span>

    <span class=nd>@Autowired</span>
    <span class=kd>private</span> <span class=n>Tracing</span> <span class=n>tracing</span><span class=o>;</span>

    <span class=nd>@Autowired</span>
    <span class=kd>private</span> <span class=n>Tracer</span> <span class=n>tracer</span><span class=o>;</span>

    <span class=kd>private</span> <span class=n>Random</span> <span class=n>random</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>Counter</span> <span class=n>counter</span><span class=o>;</span>

    <span class=kd>public</span> <span class=nf>DefaultController</span><span class=o>(</span><span class=n>MeterRegistry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>this</span><span class=o>.</span><span class=na>random</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>
        <span class=k>this</span><span class=o>.</span><span class=na>counter</span> <span class=o>=</span> <span class=n>Counter</span><span class=o>.</span><span class=na>builder</span><span class=o>(</span><span class=s>&#34;service.invocations&#34;</span><span class=o>)</span><span class=o>.</span><span class=na>description</span><span class=o>(</span><span class=s>&#34;Total service invocations&#34;</span><span class=o>)</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=n>registry</span><span class=o>)</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=nd>@RequestMapping</span><span class=o>(</span><span class=s>&#34;/&#34;</span><span class=o>)</span>
    <span class=kd>public</span> <span class=n>String</span> <span class=nf>home</span><span class=o>(</span><span class=n>HttpServletRequest</span> <span class=n>request</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
        <span class=n>counter</span><span class=o>.</span><span class=na>increment</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>

        <span class=c1>// Timeout simulation
</span><span class=c1></span>        <span class=c1>//Thread.sleep(random.nextInt(4000));
</span><span class=c1></span>
        <span class=n>TraceContext</span><span class=o>.</span><span class=na>Extractor</span><span class=o>&lt;</span><span class=n>HttpServletRequest</span><span class=o>&gt;</span> <span class=n>extractor</span> <span class=o>=</span> <span class=n>tracing</span><span class=o>.</span><span class=na>propagation</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>extractor</span><span class=o>(</span><span class=o>(</span><span class=n>HttpServletRequest</span> <span class=n>carrier</span><span class=o>,</span> <span class=n>String</span> <span class=n>key</span><span class=o>)</span> <span class=o>-</span><span class=o>&gt;</span> <span class=o>{</span> <span class=k>return</span> <span class=n>carrier</span><span class=o>.</span><span class=na>getHeader</span><span class=o>(</span><span class=n>key</span><span class=o>)</span><span class=o>;</span> <span class=o>}</span><span class=o>)</span><span class=o>;</span>
        <span class=n>Span</span> <span class=n>span</span> <span class=o>=</span> <span class=n>tracer</span><span class=o>.</span><span class=na>nextSpan</span><span class=o>(</span><span class=n>extractor</span><span class=o>.</span><span class=na>extract</span><span class=o>(</span><span class=n>request</span><span class=o>)</span><span class=o>)</span><span class=o>;</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;Service Span (traceId: %s, spanId: %s)%n&#34;</span><span class=o>,</span> <span class=n>span</span><span class=o>.</span><span class=na>context</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>traceIdString</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>span</span><span class=o>.</span><span class=na>context</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>spanIdString</span><span class=o>(</span><span class=o>)</span><span class=o>)</span><span class=o>;</span>

        <span class=k>return</span> <span class=n>String</span><span class=o>.</span><span class=na>format</span><span class=o>(</span><span class=s>&#34;Hello world (url: %s, remoteAddress_%s, localAddress: %s, traceId: %s, spanId: %s, key: %s)&#34;</span><span class=o>,</span> <span class=n>request</span><span class=o>.</span><span class=na>getRequestURL</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> 
        <span class=n>request</span><span class=o>.</span><span class=na>getRemoteAddr</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>request</span><span class=o>.</span><span class=na>getLocalAddr</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>span</span><span class=o>.</span><span class=na>context</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>traceIdString</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>span</span><span class=o>.</span><span class=na>context</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>spanIdString</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>configuration</span><span class=o>.</span><span class=na>getKey</span><span class=o>(</span><span class=o>)</span><span class=o>)</span><span class=o>;</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/DefaultController.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/DefaultController.java target=_blank>DefaultController.java</a></div></div><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>io.github.picodotdev.blogbitix.springcloud.client</span><span class=o>;</span>

<span class=o>.</span><span class=o>.</span><span class=o>.</span>

<span class=nd>@Component</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>ProxyService</span> <span class=o>{</span>

    <span class=nd>@Autowired</span>
    <span class=kd>private</span> <span class=n>LoadBalancerClient</span> <span class=n>loadBalancer</span><span class=o>;</span>

    <span class=nd>@Autowired</span>
    <span class=kd>private</span> <span class=n>Tracing</span> <span class=n>tracing</span><span class=o>;</span>

    <span class=nd>@Autowired</span>
    <span class=kd>private</span> <span class=n>Tracer</span> <span class=n>tracer</span><span class=o>;</span>

    <span class=kd>private</span> <span class=n>CircuitBreakerConfig</span> <span class=n>circuitBreakerConfiguration</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>TimeLimiterConfig</span> <span class=n>timeLimiterConfiguration</span><span class=o>;</span>
    <span class=kd>private</span> <span class=n>HttpClient</span> <span class=n>client</span><span class=o>;</span>

    <span class=kd>public</span> <span class=nf>ProxyService</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>circuitBreakerConfiguration</span> <span class=o>=</span> <span class=n>CircuitBreakerConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>(</span><span class=o>)</span>
                <span class=o>.</span><span class=na>failureRateThreshold</span><span class=o>(</span><span class=n>50</span><span class=o>)</span>
                <span class=o>.</span><span class=na>recordExceptions</span><span class=o>(</span><span class=n>IOException</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>TimeoutException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
                <span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>

        <span class=n>timeLimiterConfiguration</span> <span class=o>=</span> <span class=n>TimeLimiterConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>(</span><span class=o>)</span>
                <span class=o>.</span><span class=na>timeoutDuration</span><span class=o>(</span><span class=n>Duration</span><span class=o>.</span><span class=na>ofMillis</span><span class=o>(</span><span class=n>2500</span><span class=o>)</span><span class=o>)</span>
                <span class=o>.</span><span class=na>cancelRunningFuture</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span>
                <span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>

        <span class=n>client</span> <span class=o>=</span> <span class=n>HttpClient</span><span class=o>.</span><span class=na>newBuilder</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>version</span><span class=o>(</span><span class=n>HttpClient</span><span class=o>.</span><span class=na>Version</span><span class=o>.</span><span class=na>HTTP_2</span><span class=o>)</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=kd>public</span> <span class=n>String</span> <span class=nf>get</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>ServiceInstance</span> <span class=n>instance</span> <span class=o>=</span> <span class=n>loadBalancer</span><span class=o>.</span><span class=na>choose</span><span class=o>(</span><span class=s>&#34;traefik&#34;</span><span class=o>)</span><span class=o>;</span>
        <span class=n>URI</span> <span class=n>uri</span> <span class=o>=</span> <span class=n>instance</span><span class=o>.</span><span class=na>getUri</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>
        <span class=n>String</span> <span class=n>resource</span> <span class=o>=</span> <span class=n>String</span><span class=o>.</span><span class=na>format</span><span class=o>(</span><span class=s>&#34;%s%s&#34;</span><span class=o>,</span> <span class=n>uri</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>replace</span><span class=o>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=o>,</span> <span class=s>&#34;traefik&#34;</span><span class=o>)</span><span class=o>,</span> <span class=s>&#34;/service&#34;</span><span class=o>)</span><span class=o>;</span>        
        <span class=n>HttpRequest</span><span class=o>.</span><span class=na>Builder</span> <span class=n>r</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
        <span class=k>try</span> <span class=o>{</span> 
            <span class=n>r</span> <span class=o>=</span> <span class=n>HttpRequest</span><span class=o>.</span><span class=na>newBuilder</span><span class=o>(</span><span class=k>new</span> <span class=n>URI</span><span class=o>(</span><span class=n>resource</span><span class=o>)</span><span class=o>)</span><span class=o>.</span><span class=na>GET</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>
        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
            <span class=k>return</span> <span class=n>getFallback</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>
        <span class=o>}</span>
        <span class=kd>final</span> <span class=n>HttpRequest</span><span class=o>.</span><span class=na>Builder</span> <span class=n>request</span> <span class=o>=</span> <span class=n>r</span><span class=o>;</span>

        <span class=n>Span</span> <span class=n>span</span> <span class=o>=</span> <span class=n>tracer</span><span class=o>.</span><span class=na>newTrace</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>start</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>
        <span class=n>TraceContext</span><span class=o>.</span><span class=na>Injector</span><span class=o>&lt;</span><span class=n>HttpRequest</span><span class=o>.</span><span class=na>Builder</span><span class=o>&gt;</span> <span class=n>injector</span> <span class=o>=</span> <span class=n>tracing</span><span class=o>.</span><span class=na>propagation</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>injector</span><span class=o>(</span><span class=o>(</span><span class=n>HttpRequest</span><span class=o>.</span><span class=na>Builder</span> <span class=n>carrier</span><span class=o>,</span> <span class=n>String</span> <span class=n>key</span><span class=o>,</span> <span class=n>String</span> <span class=n>value</span><span class=o>)</span> <span class=o>-</span><span class=o>&gt;</span> <span class=o>{</span> <span class=n>carrier</span><span class=o>.</span><span class=na>header</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>)</span><span class=o>;</span> <span class=o>}</span><span class=o>)</span><span class=o>;</span>
        <span class=n>injector</span><span class=o>.</span><span class=na>inject</span><span class=o>(</span><span class=n>span</span><span class=o>.</span><span class=na>context</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>request</span><span class=o>)</span><span class=o>;</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>printf</span><span class=o>(</span><span class=s>&#34;Client Span (traceId: %s, spanId: %s)%n&#34;</span><span class=o>,</span> <span class=n>span</span><span class=o>.</span><span class=na>context</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>traceIdString</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>span</span><span class=o>.</span><span class=na>context</span><span class=o>(</span><span class=o>)</span><span class=o>.</span><span class=na>spanIdString</span><span class=o>(</span><span class=o>)</span><span class=o>)</span><span class=o>;</span>

        <span class=n>CircuitBreaker</span> <span class=n>circuitBreaker</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=s>&#34;resilience4jCircuitBreakerProxyService&#34;</span><span class=o>,</span> <span class=n>circuitBreakerConfiguration</span><span class=o>)</span><span class=o>;</span>
        <span class=n>TimeLimiter</span> <span class=n>timeLimiter</span> <span class=o>=</span> <span class=n>TimeLimiter</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>timeLimiterConfiguration</span><span class=o>)</span><span class=o>;</span>

        <span class=n>Supplier</span><span class=o>&lt;</span><span class=n>CompletableFuture</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=o>&gt;</span> <span class=n>get</span> <span class=o>=</span> <span class=o>(</span><span class=o>)</span> <span class=o>-</span><span class=o>&gt;</span> <span class=o>{</span>
            <span class=k>return</span> <span class=n>CompletableFuture</span><span class=o>.</span><span class=na>supplyAsync</span><span class=o>(</span><span class=o>(</span><span class=o>)</span> <span class=o>-</span><span class=o>&gt;</span> <span class=o>{</span>
                <span class=k>try</span> <span class=o>{</span> 
                    <span class=n>HttpResponse</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=na>send</span><span class=o>(</span><span class=n>request</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=o>)</span><span class=o>,</span> <span class=n>HttpResponse</span><span class=o>.</span><span class=na>BodyHandlers</span><span class=o>.</span><span class=na>ofString</span><span class=o>(</span><span class=o>)</span><span class=o>)</span><span class=o>;</span>
                    <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=na>body</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>
                <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
                    <span class=k>return</span> <span class=n>getFallback</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>
                <span class=o>}</span>
            <span class=o>}</span><span class=o>)</span><span class=o>;</span>
        <span class=o>}</span><span class=o>;</span>
        <span class=n>Callable</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>getLimiter</span> <span class=o>=</span> <span class=n>TimeLimiter</span><span class=o>.</span><span class=na>decorateFutureSupplier</span><span class=o>(</span><span class=n>timeLimiter</span><span class=o>,</span> <span class=n>get</span><span class=o>)</span><span class=o>;</span>
        <span class=n>Callable</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>getCircuitBreaker</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=o>.</span><span class=na>decorateCallable</span><span class=o>(</span><span class=n>circuitBreaker</span><span class=o>,</span> <span class=n>getLimiter</span><span class=o>)</span><span class=o>;</span>

        <span class=k>return</span> <span class=n>Try</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>getCircuitBreaker</span><span class=o>:</span><span class=o>:</span><span class=n>call</span><span class=o>)</span><span class=o>.</span><span class=na>recover</span><span class=o>(</span><span class=o>(</span><span class=n>throwable</span><span class=o>)</span> <span class=o>-</span><span class=o>&gt;</span> <span class=n>getFallback</span><span class=o>(</span><span class=o>)</span><span class=o>)</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=o>)</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=kd>private</span> <span class=n>String</span> <span class=nf>getFallback</span><span class=o>(</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>return</span> <span class=s>&#34;Fallback&#34;</span><span class=o>;</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/ProxyService.java target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/ProxyService.java target=_blank>ProxyService.java</a></div></div><p>Como hay 2 instancias del servicio y Traefik realiza balanceo de carga utilizando el algoritmo <em>round robbin</em> se observa en la salida con las respuestas que la dirección IP que ha atendido la petición es alternativamente una de las dos instancias del servicio.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-plaintext data-lang=plaintext>...
Service response: Hello world (url: http://172.30.0.3/, remoteAddress_172.30.0.3, localAddress: 172.30.0.4, traceId: 63afa4d0cd4f466c, spanId: 4719dfcc16b6104e, key: value)
Client Span (traceId: 57eeaa436aa09238, spanId: 57eeaa436aa09238)
Service response: Hello world (url: http://172.30.0.3/, remoteAddress_172.30.0.3, localAddress: 172.30.0.5, traceId: 57eeaa436aa09238, spanId: 26dc213be2d933ac, key: value)
Client Span (traceId: 23c748bf222052a6, spanId: 23c748bf222052a6)
Service response: Hello world (url: http://172.30.0.3/, remoteAddress_172.30.0.3, localAddress: 172.30.0.4, traceId: 23c748bf222052a6, spanId: 0404d949c6e04c18, key: value)
Client Span (traceId: c45d66a4ec9cf14c, spanId: c45d66a4ec9cf14c)
Service response: Hello world (url: http://172.30.0.3/, remoteAddress_172.30.0.3, localAddress: 172.30.0.5, traceId: c45d66a4ec9cf14c, spanId: e7f6ccf2efb8234b, key: value)
Client Span (traceId: 2fdb3b71a682d2e6, spanId: 2fdb3b71a682d2e6)
Service response: Hello world (url: http://172.30.0.3/, remoteAddress_172.30.0.3, localAddress: 172.30.0.4, traceId: 2fdb3b71a682d2e6, spanId: 24ac2a8d2bfb1e6e, key: value)
Client Span (traceId: a33b010e02709c6a, spanId: a33b010e02709c6a)
Service response: Hello world (url: http://172.30.0.3/, remoteAddress_172.30.0.3, localAddress: 172.30.0.5, traceId: a33b010e02709c6a, spanId: 0abe6074fc277af6, key: value)
...</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/System.out target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/System.out target=_blank>System.out</a></div></div><p>En un momento posterior si surge la necesidad de querer desplegar una nueva versión del microservicio basta con generar de nuevo el artefacto del microservicio, cambiando la versión en el archivo <em>build.gradle</em>. El despliegue de la nueva versión se realizan mediante la estrategia <em>canary</em>, manteniendo las instancias con la versión anterior del servicio y añadiendo una nueva con la nueva versión. Si se descubre algún error en la instancia <em>canary</em> se puede revertir el estado a la versión anterior, que consiste en detener la instancia <em>canary</em>. Una vez se comprueba que la instancia con la nueva versión funciona correctamente analizando sus trazas y métricas se envía la order a Nomad de promocionar las instancias de forma progresiva con la versión antigua a la nueva versión.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ nomad job run nomad/service.nomad
$ nomad job promote service
$ nomad job revert service <span class=m>0</span></code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/nomad-job-promote.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/nomad-job-promote.sh target=_blank>nomad-job-promote.sh</a></div></div><p>El servicio exporta métricas en formato para Prometheus que con Grafana. Según se realizan peticiones al servicio el valor de métrica de contador de llamadas al servicio aumenta de forma progresiva.</p><div class=code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ curl http://127.0.0.1:8093/service/actuator/prometheus <span class=p>|</span> grep <span class=s2>&#34;service.invocations&#34;</span>
<span class=c1># HELP service_invocations_total Total service invocations</span>
<span class=c1># TYPE service_invocations_total counter</span>
service_invocations_total 20.0
</code></pre></td></tr></table></div></div><div class=highlight-meta><span class=raw><a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/service-prometheus.sh target=_blank>view raw</a></span>
<a href=/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/code/service-prometheus.sh target=_blank>service-prometheus.sh</a></div></div><p>El <a href=https://github.com/picodotdev/blog-ejemplos/tree/master/SpringCloudConsulNomadTraefik>código fuente completo del ejemplo</a> puedes descargarlo del repositorio de ejemplos de Blog Bitix alojado en <a href=https://github.com/>GitHub</a> y probarlo en tu equipo ejecutando el comando <code>./run.sh</code>.</p></div></article><div class="row serie"><div class=col-md-12><h3>Este artículo forma parte de la serie <strong>hashicorp</strong>:</h3><ol class=serie-articles><li><a href=https://picodotdev.github.io/blog-bitix/2019/04/introduccion-a-nomad-para-gestionar-aplicaciones-y-microservicios/>Introducción a Nomad para gestionar aplicaciones y microservicios</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/04/estrategias-de-despliegue-para-microservicios-con-nomad/>Estrategias de despliegue para microservicios con Nomad</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/04/servicios-con-persistencia-en-el-orquestador-de-microservicos-nomad/>Servicios con persistencia en el orquestador de microservicos Nomad</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/05/crear-de-forma-sencilla-y-rapida-maquinas-virtuales-de-virtualbox-con-vagrant/>Crear de forma sencilla y rápida máquinas virtuales de VirtualBox con Vagrant</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/05/registro-y-descubrimiento-de-servicios-en-contenedores-de-docker-con-consul-y-registrator/>Registro y descubrimiento de servicios en contenedores de Docker con Consul y Registrator</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/07/administrar-secretos-y-proteger-datos-sensibles-con-vault/>Administrar secretos y proteger datos sensibles con Vault</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/generar-credenciales-de-conexion-a-base-de-datos-bajo-demanda-con-vault/>Generar credenciales de conexión a base de datos bajo demanda con Vault</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/>Utilizar credenciales de conexión a la base de datos generadas por Vault en una aplicación de Spring</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/>Microservicios con Spring Cloud, Consul, Nomad y Traefik</a></li></ol><h3>Este artículo forma parte de la serie <strong>spring-cloud</strong>:</h3><ol class=serie-articles><li><a href=https://picodotdev.github.io/blog-bitix/2015/03/datos-de-sesion-externalizados-con-spring-session/>Datos de sesión externalizados con Spring Session</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2015/10/aplicacion-java-autocontenida-con-spring-boot/>Aplicación Java autocontenida con Spring Boot</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2015/11/configuracion-de-una-aplicacion-en-diferentes-entornos-con-spring-cloud-config/>Configuración de una aplicación en diferentes entornos con Spring Cloud Config</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2015/12/informacion-y-metricas-de-la-aplicacion-con-spring-boot-actuator/>Información y métricas de la aplicación con Spring Boot Actuator</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2017/01/registro-y-descubrimiento-de-servicios-con-spring-cloud-y-consul/>Registro y descubrimiento de servicios con Spring Cloud y Consul</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/08/aplicaciones-basadas-en-microservicios/>Aplicaciones basadas en microservicios</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/09/registro-y-descubrimiento-de-servicios-con-spring-cloud-netflix/>Registro y descubrimiento de servicios con Spring Cloud Netflix</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/09/servicio-de-configuracion-para-microservicios-con-spring-cloud-config/>Servicio de configuración para microservicios con Spring Cloud Config</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/09/recargar-sin-reiniciar-la-configuracion-de-una-aplicacion-spring-boot-con-spring-cloud-config/>Recargar sin reiniciar la configuración de una aplicación Spring Boot con Spring Cloud Config</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/09/almacenar-cifrados-los-valores-de-configuracion-sensibles-en-spring-cloud-config/>Almacenar cifrados los valores de configuración sensibles en Spring Cloud Config</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/10/tolerancia-a-fallos-en-un-cliente-de-microservicio-con-spring-cloud-netflix-y-hystrix/>Tolerancia a fallos en un cliente de microservicio con Spring Cloud Netflix y Hystrix</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/10/balanceo-de-carga-y-resilencia-en-un-microservicio-con-spring-cloud-netflix-y-ribbon/>Balanceo de carga y resilencia en un microservicio con Spring Cloud Netflix y Ribbon</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/10/proxy-para-microservicios-con-spring-cloud-netflix-y-zuul/>Proxy para microservicios con Spring Cloud Netflix y Zuul</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/12/monitorizar-una-aplicacion-java-de-spring-boot-con-micrometer-prometheus-y-grafana/>Monitorizar una aplicación Java de Spring Boot con Micrometer, Prometheus y Grafana</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2018/12/exponer-las-metricas-de-hystrix-en-grafana-con-prometheus-de-una-aplicacion-spring-boot/>Exponer las métricas de Hystrix en Grafana con Prometheus de una aplicación Spring Boot</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/02/servidor-oauth-gateway-y-servicio-rest-utilizando-tokens-jwt-con-spring/>Servidor OAuth, gateway y servicio REST utilizando tokens JWT con Spring</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/04/trazabilidad-en-microservicios-con-spring-cloud-sleuth/>Trazabilidad en microservicios con Spring Cloud Sleuth</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/implementar-tolerancia-a-fallos-con-resilience4j/>Implementar tolerancia a fallos con Resilience4j</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/iniciar-una-aplicacion-de-spring-boot-en-un-puerto-aleatorio/>Iniciar una aplicación de Spring Boot en un puerto aleatorio</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/08/utilizar-credenciales-de-conexion-a-la-base-de-datos-generadas-por-vault-en-una-aplicacion-de-spring/>Utilizar credenciales de conexión a la base de datos generadas por Vault en una aplicación de Spring</a></li><li><a href=https://picodotdev.github.io/blog-bitix/2019/10/microservicios-con-spring-cloud-consul-nomad-y-traefik/>Microservicios con Spring Cloud, Consul, Nomad y Traefik</a></li></ol></div></div><div class=row><div class=col-md-12><div class=sharethis-inline-share-buttons></div></div></div><div class=row><div class="col-12 text-center"><ins class=adsbygoogle style=display:inline-block;width:970px;height:250px data-ad-client=ca-pub-3533636310991304 data-ad-slot=2975854584 data-type=billboard></ins></div></div><a id=comments></a><div class=row><div class=col-md-12><div id=disqus_thread></div></div></div><script type=text/javascript async>var disqus_shortname='blog-bitix';var disqus_identifier='blog-bitix-436';var disqus_url='https:\/\/picodotdev.github.io\/blog-bitix\/2019\/10\/microservicios-con-spring-cloud-consul-nomad-y-traefik\/';var disqus_script='embed.js';(function(){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/'+disqus_script;(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);}());</script></div></div><div class=row><div class=col-12><hr></div></div><footer><div class=row><div class="col-12 col-sm-4"><p><strong>Blog Bitix</strong></p><p>Blog dedicado a la distribución GNU/Linux que uso habitualmente, Arch Linux, a mis andanzas alrededor del software libre, la programación y a otros temas relacionados con la tecnología y la informática.</p><p>Publicando de uno a tres artículos únicos a la semana desde el año 2010.</p></div><div class="col-12 col-sm-4 text-center menu"><ul class=list-unstyled><li><a href=/blog-bitix/tags/java/>Java</a></li><li><a href=/blog-bitix/tags/gnu-linux/>GNU/Linux</a></li><li><a href=/blog-bitix/tags/javascript/>JavaScript</a></li><li><a href=/blog-bitix/tags/tapestry/>Tapestry</a></li><li><a href=/blog-bitix/archive/>Archivo y hemeroteca</a></li><li><a href=/blog-bitix/pages/links/>Enlaces</a></li><li><a href=/blog-bitix/pages/advertising/>Publicidad</a></li><li><a href=/blog-bitix/pages/donate/>Donaciones</a></li><li><a href=/blog-bitix/pages/about/>Acerca de...</a></li></ul></div><div class="col-12 col-sm-4 text-center links"><a href=index.xml title="¡Suscríbete a Blog Bitix!"><img src=assets/images/rss.png class=icon></a>
<a href=https://twitter.com/picodotdev/ title="¡Sígueme en twitter!"><img src=assets/images/twitter.svg class=icon></a>
<a href=https://github.com/picodotdev/blog-ejemplos/ title="¡Obtén el código fuente de los ejemplos!"><img src=assets/images/github.svg class=icon></a></div></div><div class=row><div class=col-12>Copyleft <span class=copyleft>&copy;</span> 2019 - <a href=https://creativecommons.org/licenses/by-sa/4.0/ rel=nofollow rel=license><img alt="Licencia de Creative Commons" title="Licencia de Creative Commons" style=border-width:0 src=https://licensebuttons.net/l/by-sa/4.0/80x15.png class=licencia></a><br><a href=https://twitter.com/blogstackinfo rel=nofollow><img src=https://picodotdev.github.io/blog-bitix/assets/images/blog-stack.png alt="Blog Stack" title="Blog Stack"></a>
<a href=https://www.planetacodigo.com/ rel=nofollow><img src=https://picodotdev.github.io/blog-bitix/assets/images/planeta-codigo.png alt="Planeta código" title="Planeta código"></a><br><span xmlns:dct=http://purl.org/dc/terms/ property="dct:title"><a href=https://picodotdev.github.io/blog-bitix/ rel=nofollow>Blog Bitix</a></span> by <a xmlns:cc=https://creativecommons.org/ns# href=https://picodotdev.github.io/blog-bitix/ property="cc:attributionName" rel=cc:attributionurl>pico.dev</a> is licensed under a <a rel=license href=https://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Reconocimiento-CompartirIgual 4.0 Internacional License</a>.<br><span class=credit>Powered by <a href=https://gohugo.io/ rel=nofollow title="A fast and modern static website engine">Hugo</a> and <a href=https://pages.github.com/ title="Websites for you and your projects">GitHub Pages</a>.</span>
<span class=credit>Background patterns from <a href=https://www.toptal.com/designers/subtlepatterns/ rel=nofollow>Subtle Patterns</a>.</span></div></div></footer></div><div class=blueimp-gallery-container><div id=blueimp-gallery class="blueimp-gallery blueimp-gallery-controls" data-use-bootstrap-modal=false><div class=slides></div><h3 class=title></h3><a class=prev>‹</a>
<a class=next>›</a>
<a class=close>×</a>
<a class=play-pause></a><ol class=indicator></ol><div class="modal fade"><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close aria-hidden=true>&#215;</button><h4 class=modal-title></h4></div><div class="modal-body next"></div><div class=modal-footer><button type=button class="btn btn-default pull-left prev">
<i class="glyphicon glyphicon-chevron-left"></i>Anterior</button>
<button type=button class="btn btn-primary next">
Siguiente
<i class="glyphicon glyphicon-chevron-right"></i></button></div></div></div></div></div></div><script type=text/javascript>window.cookieconsent_options={"message":"Esta bitácora te informa de la obviedad de que utiliza «cookies», propias y de servicios como Google Analytics y Google AdSense entre otros.","dismiss":"Aceptar","learnMore":"Más información","link":null,"theme":"dark-bottom"};</script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/1.0.9/cookieconsent.min.js async></script></body></html>